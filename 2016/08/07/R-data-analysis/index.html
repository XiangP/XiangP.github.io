<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Xiang"><meta name="description" content="RDataAnalysisCookbookbyViswaViswanathan&amp;amp;ShanthiViswanathan.Frominternet."><meta name="keywords" content=""><title>R data analysis · Eric</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2016/08/07/R-data-analysis/"><link rel="alternate" href="/atom.xml" title="Eric"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Eric</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/categories/" target="_self">Categories</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">R data analysis</h1><span class="post-time">Aug 7, 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Preface"><span class="toc-text">Preface</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-this-book-covers"><span class="toc-text">What this book covers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-you-need-for-this-book"><span class="toc-text">What you need for this book</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Who-this-book-is-for"><span class="toc-text">Who this book is for</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Downloading-the-example-code-and-data"><span class="toc-text">Downloading the example code and data</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#About-the-data-files-used-in-this-book"><span class="toc-text">About the data files used in this book</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-1-Acquire-and-Prepare-the-Ingredients-–-Your-Data"><span class="toc-text">Chapter 1. Acquire and Prepare the Ingredients – Your Data</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reading-data-from-CSV-files"><span class="toc-text">Reading data from CSV files</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…"><span class="toc-text">There’s more…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handling-different-column-delimiters"><span class="toc-text">Handling different column delimiters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handling-column-headers-variable-names"><span class="toc-text">Handling column headers/variable names</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handling-missing-values"><span class="toc-text">Handling missing values</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reading-strings-as-characters-and-not-as-factors"><span class="toc-text">Reading strings as characters and not as factors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reading-data-directly-from-a-website"><span class="toc-text">Reading data directly from a website</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reading-XML-data"><span class="toc-text">Reading XML data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-1"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-1"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-1"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-1"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Extracting-HTML-table-data-from-a-web-page"><span class="toc-text">Extracting HTML table data from a web page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extracting-a-single-HTML-table-from-a-web-page"><span class="toc-text">Extracting a single HTML table from a web page</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reading-JSON-data"><span class="toc-text">Reading JSON data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-2"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-2"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-2"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reading-data-from-fixed-width-formatted-files"><span class="toc-text">Reading data from fixed-width formatted files</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-3"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-3"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-3"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-2"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Files-with-headers"><span class="toc-text">Files with headers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Excluding-columns-from-data"><span class="toc-text">Excluding columns from data</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reading-data-from-R-files-and-R-libraries"><span class="toc-text">Reading data from R files and R libraries</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-4"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-4"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-4"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-3"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#To-save-all-objects-in-a-session"><span class="toc-text">To save all objects in a session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#To-selectively-save-objects-in-a-session"><span class="toc-text">To selectively save objects in a session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Attaching-detaching-R-data-files-to-an-environment"><span class="toc-text">Attaching/detaching R data files to an environment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Listing-all-datasets-in-loaded-packages"><span class="toc-text">Listing all datasets in loaded packages</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Removing-cases-with-missing-values"><span class="toc-text">Removing cases with missing values</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-5"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-5"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-5"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-4"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Eliminating-cases-with-NA-for-selected-variables"><span class="toc-text">Eliminating cases with NA for selected variables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Converting-specific-values-to-NA"><span class="toc-text">Converting specific values to NA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Excluding-NA-values-from-computations"><span class="toc-text">Excluding NA values from computations</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replacing-missing-values-with-the-mean"><span class="toc-text">Replacing missing values with the mean</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-6"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-6"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-6"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-5"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Imputing-random-values-sampled-from-nonmissing-values"><span class="toc-text">Imputing random values sampled from nonmissing values</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Removing-duplicate-cases"><span class="toc-text">Removing duplicate cases</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-7"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-7"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-7"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-6"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Identifying-duplicates-without-deleting-them"><span class="toc-text">Identifying duplicates (without deleting them)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rescaling-a-variable-to-0-1"><span class="toc-text">Rescaling a variable to [0,1]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-8"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-8"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-8"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-7"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rescaling-many-variables-at-once"><span class="toc-text">Rescaling many variables at once</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Normalizing-or-standardizing-data-in-a-data-frame"><span class="toc-text">Normalizing or standardizing data in a data frame</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-9"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-9"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-9"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-8"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Standardizing-several-variables-simultaneously"><span class="toc-text">Standardizing several variables simultaneously</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-1"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binning-numerical-data"><span class="toc-text">Binning numerical data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-10"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-10"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-10"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-9"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Creating-a-specified-number-of-intervals-automatically"><span class="toc-text">Creating a specified number of intervals automatically</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-dummies-for-categorical-variables"><span class="toc-text">Creating dummies for categorical variables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-11"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-11"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-11"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-10"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Choosing-which-variables-to-create-dummies-for"><span class="toc-text">Choosing which variables to create dummies for</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-2-What’s-in-There-–-Exploratory-Data-Analysis"><span class="toc-text">Chapter 2. What’s in There? – Exploratory Data Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-1"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-standard-data-summaries"><span class="toc-text">Creating standard data summaries</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-12"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-12"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-12"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-11"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Computing-the-summary-for-a-single-variable"><span class="toc-text">Computing the summary for a single variable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Finding-the-mean-and-standard-deviation"><span class="toc-text">Finding the mean and standard deviation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Extracting-a-subset-of-a-dataset"><span class="toc-text">Extracting a subset of a dataset</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-13"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-13"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-13"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-12"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Excluding-columns"><span class="toc-text">Excluding columns</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Selecting-based-on-multiple-values"><span class="toc-text">Selecting based on multiple values</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Selecting-using-logical-vector"><span class="toc-text">Selecting using logical vector</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Splitting-a-dataset"><span class="toc-text">Splitting a dataset</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-14"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-14"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-14"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-random-data-partitions"><span class="toc-text">Creating random data partitions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-15"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-15"><span class="toc-text">How to do it…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Case-1-–-numerical-target-variable-and-two-partitions"><span class="toc-text">Case 1 – numerical target variable and two partitions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Case-2-–-numerical-target-variable-and-three-partitions"><span class="toc-text">Case 2 – numerical target variable and three partitions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Case-4-–-categorical-target-variable-and-three-partitions"><span class="toc-text">Case 4 – categorical target variable and three partitions</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-15"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-13"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-a-convenience-function-for-partitioning"><span class="toc-text">Using a convenience function for partitioning</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sampling-from-a-set-of-values"><span class="toc-text">Sampling from a set of values</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generating-standard-plots-such-as-histograms-boxplots-and-scatterplots"><span class="toc-text">Generating standard plots such as histograms, boxplots, and scatterplots</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-16"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-16"><span class="toc-text">How to do it…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Histograms"><span class="toc-text">Histograms</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Boxplots"><span class="toc-text">Boxplots</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Scatterplots"><span class="toc-text">Scatterplots</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Scatterplot-matrices"><span class="toc-text">Scatterplot matrices</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-16"><span class="toc-text">How it works…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Histograms-1"><span class="toc-text">Histograms</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Boxplots-1"><span class="toc-text">Boxplots</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-14"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Overlay-a-density-plot-on-a-histogram"><span class="toc-text">Overlay a density plot on a histogram</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Overlay-a-regression-line-on-a-scatterplot"><span class="toc-text">Overlay a regression line on a scatterplot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Color-specific-points-on-a-scatterplot"><span class="toc-text">Color specific points on a scatterplot</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generating-multiple-plots-on-a-grid"><span class="toc-text">Generating multiple plots on a grid</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-17"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-17"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-17"><span class="toc-text">How it works…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Graphics-parameters"><span class="toc-text">Graphics parameters</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-2"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Selecting-a-graphics-device"><span class="toc-text">Selecting a graphics device</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-18"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-18"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-18"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-3"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-plots-with-the-lattice-package"><span class="toc-text">Creating plots with the lattice package</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-19"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-19"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-19"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-15"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-flair-to-your-graphs"><span class="toc-text">Adding flair to your graphs</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-4"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-plots-with-the-ggplot2-package"><span class="toc-text">Creating plots with the ggplot2 package</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-20"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-20"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-20"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-16"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Graph-using-qplot"><span class="toc-text">Graph using qplot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Condition-plots-on-continuous-numeric-variables"><span class="toc-text">Condition plots on continuous numeric variables</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-5"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-charts-that-facilitate-comparisons"><span class="toc-text">Creating charts that facilitate comparisons</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-21"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-21"><span class="toc-text">How to do it…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-base-plotting-system"><span class="toc-text">Using base plotting system</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-ggplot2"><span class="toc-text">Using ggplot2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-21"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-17"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Creating-boxplots-with-ggplot2"><span class="toc-text">Creating boxplots with ggplot2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-6"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-charts-that-help-visualize-a-possible-causality"><span class="toc-text">Creating charts that help visualize a possible causality</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-22"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-22"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-7"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-multivariate-plots"><span class="toc-text">Creating multivariate plots</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-23"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-23"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-22"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-8"><span class="toc-text">See also…</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-3-Where-Does-It-Belong-–-Classification"><span class="toc-text">Chapter 3. Where Does It Belong? – Classification</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-2"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generating-error-classification-confusion-matrices"><span class="toc-text">Generating error/classification-confusion matrices</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-24"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-24"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-23"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-18"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Visualizing-the-error-classification-confusion-matrix"><span class="toc-text">Visualizing the error/classification confusion matrix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Comparing-the-model’s-performance-for-different-classes"><span class="toc-text">Comparing the model’s performance for different classes</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generating-ROC-charts"><span class="toc-text">Generating ROC charts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-25"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-25"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-24"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-19"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-arbitrary-class-labels"><span class="toc-text">Using arbitrary class labels</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-plotting-and-evaluating-–-classification-trees"><span class="toc-text">Building, plotting, and evaluating – classification trees</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-26"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-26"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-25"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-20"><span class="toc-text">There’s more…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Computing-raw-probabilities"><span class="toc-text">Computing raw probabilities</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Create-the-ROC-Chart"><span class="toc-text">Create the ROC Chart</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also"><span class="toc-text">See also</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-random-forest-models-for-classification"><span class="toc-text">Using random forest models for classification</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-27"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-27"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-26"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-21"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Computing-raw-probabilities-1"><span class="toc-text">Computing raw probabilities</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Generating-the-ROC-chart"><span class="toc-text">Generating the ROC chart</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Specifying-cutoffs-for-classification"><span class="toc-text">Specifying cutoffs for classification</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-9"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Classifying-using-Support-Vector-Machine"><span class="toc-text">Classifying using Support Vector Machine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-28"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-28"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-27"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-22"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controlling-scaling-of-variables"><span class="toc-text">Controlling scaling of variables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Determining-the-type-of-SVM-model"><span class="toc-text">Determining the type of SVM model</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Assigning-weights-to-the-classes"><span class="toc-text">Assigning weights to the classes</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-10"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Classifying-using-the-Naive-Bayes-approach"><span class="toc-text">Classifying using the Naïve Bayes approach</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-29"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-29"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-28"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-11"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Classifying-using-the-KNN-approach"><span class="toc-text">Classifying using the KNN approach</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-30"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-30"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-29"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-23"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Automating-the-process-of-running-KNN-for-many-k-values"><span class="toc-text">Automating the process of running KNN for many k values</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-KNN-to-compute-raw-probabilities-instead-of-classifications"><span class="toc-text">Using KNN to compute raw probabilities instead of classifications</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-neural-networks-for-classification"><span class="toc-text">Using neural networks for classification</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-31"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-31"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-30"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-24"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exercising-greater-control-over-nnet"><span class="toc-text">Exercising greater control over nnet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Generating-raw-probabilities"><span class="toc-text">Generating raw probabilities</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Classifying-using-linear-discriminant-function-analysis"><span class="toc-text">Classifying using linear discriminant function analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-32"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-32"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-31"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-25"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-the-formula-interface-for-lda"><span class="toc-text">Using the formula interface for lda</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also-…"><span class="toc-text">See also …</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Classifying-using-logistic-regression"><span class="toc-text">Classifying using logistic regression</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-33"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-33"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-32"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-AdaBoost-to-combine-classification-tree-models"><span class="toc-text">Using AdaBoost to combine classification tree models</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-34"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-34"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-33"><span class="toc-text">How it works…</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-4-Give-Me-a-Number-–-Regression"><span class="toc-text">Chapter 4. Give Me a Number – Regression</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-3"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Computing-the-root-mean-squared-error"><span class="toc-text">Computing the root mean squared error</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-35"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-35"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-34"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-26"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-a-convenience-function-to-compute-the-RMS-error"><span class="toc-text">Using a convenience function to compute the RMS error</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-KNN-models-for-regression"><span class="toc-text">Building KNN models for regression</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-36"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-36"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-35"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-27"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Running-KNN-with-cross-validation-in-place-of-validation-partition"><span class="toc-text">Running KNN with cross-validation in place of validation partition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-a-convenience-function-to-run-KNN"><span class="toc-text">Using a convenience function to run KNN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-a-convenience-function-to-run-KNN-for-multiple-k-values"><span class="toc-text">Using a convenience function to run KNN for multiple k values</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-12"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performing-linear-regression"><span class="toc-text">Performing linear regression</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-37"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-37"><span class="toc-text">How to do it…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-other-options-in-the-formula-expression-for-linear-models"><span class="toc-text">Using other options in the formula expression for linear models</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-13"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performing-variable-selection-in-linear-regression"><span class="toc-text">Performing variable selection in linear regression</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-38"><span class="toc-text">Getting ready</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-do-it…-38"><span class="toc-text">How to do it…</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-14"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-regression-trees"><span class="toc-text">Building regression trees</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-39"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-39"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-36"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-28"><span class="toc-text">There’s more…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-15"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-random-forest-models-for-regression"><span class="toc-text">Building random forest models for regression</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-40"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-40"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-37"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-29"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controlling-forest-generation"><span class="toc-text">Controlling forest generation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-16"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-neural-networks-for-regression"><span class="toc-text">Using neural networks for regression</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-41"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-41"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-38"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-17"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performing-k-fold-cross-validation"><span class="toc-text">Performing k-fold cross-validation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-42"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-42"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-39"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-18"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performing-leave-one-out-cross-validation-to-limit-overfitting"><span class="toc-text">Performing leave-one-out-cross-validation to limit overfitting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-43"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-40"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-19"><span class="toc-text">See also…</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-5-Can-You-Simplify-That-–-Data-Reduction-Techniques"><span class="toc-text">Chapter 5. Can You Simplify That? – Data Reduction Techniques</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-4"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performing-cluster-analysis-using-K-means-clustering"><span class="toc-text">Performing cluster analysis using K-means clustering</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-43"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-44"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-41"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-30"><span class="toc-text">There’s more…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Use-a-convenience-function-to-choose-a-value-for-K"><span class="toc-text">Use a convenience function to choose a value for K</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-20"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performing-cluster-analysis-using-hierarchical-clustering"><span class="toc-text">Performing cluster analysis using hierarchical clustering</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-44"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-45"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-42"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-21"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reducing-dimensionality-with-principal-component-analysis"><span class="toc-text">Reducing dimensionality with principal component analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-45"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-46"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-43"><span class="toc-text">How it works…</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-6-Lessons-from-History-–-Time-Series-Analysis"><span class="toc-text">Chapter 6. Lessons from History – Time Series Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-5"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-and-examining-date-objects"><span class="toc-text">Creating and examining date objects</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-46"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-47"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-44"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-22"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Operating-on-date-objects"><span class="toc-text">Operating on date objects</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-47"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-48"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-45"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-23"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Performing-preliminary-analyses-on-time-series-data"><span class="toc-text">Performing preliminary analyses on time series data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-48"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-49"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-46"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-24"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-time-series-objects"><span class="toc-text">Using time series objects</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-49"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-50"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-47"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-25"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Decomposing-time-series"><span class="toc-text">Decomposing time series</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-50"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-51"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-48"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-26"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Filtering-time-series-data"><span class="toc-text">Filtering time series data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-51"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-52"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-49"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-27"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Smoothing-and-forecasting-using-the-Holt-Winters-method"><span class="toc-text">Smoothing and forecasting using the Holt-Winters method</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-52"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-53"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-50"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-28"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-an-automated-ARIMA-model"><span class="toc-text">Building an automated ARIMA model</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-53"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-54"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-51"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-29"><span class="toc-text">See also…</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-7-It’s-All-About-Your-Connections-–-Social-Network-Analysis"><span class="toc-text">Chapter 7. It’s All About Your Connections – Social Network Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-6"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Downloading-social-network-data-using-public-APIs"><span class="toc-text">Downloading social network data using public APIs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-54"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-55"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-52"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-30"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-adjacency-matrices-and-edge-lists"><span class="toc-text">Creating adjacency matrices and edge lists</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-55"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-56"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-53"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-31"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plotting-social-network-data"><span class="toc-text">Plotting social network data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-56"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-57"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-54"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-31"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Specifying-plotting-preferences"><span class="toc-text">Specifying plotting preferences</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Plotting-directed-graphs"><span class="toc-text">Plotting directed graphs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Creating-a-graph-object-with-weights"><span class="toc-text">Creating a graph object with weights</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extracting-the-network-as-an-adjacency-matrix-from-the-graph-object"><span class="toc-text">Extracting the network as an adjacency matrix from the graph object</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extracting-an-adjacency-matrix-with-weights"><span class="toc-text">Extracting an adjacency matrix with weights</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extracting-edge-list-from-graph-object"><span class="toc-text">Extracting edge list from graph object</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Creating-bipartite-network-graph"><span class="toc-text">Creating bipartite network graph</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Generating-projections-of-a-bipartite-network"><span class="toc-text">Generating projections of a bipartite network</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#See-also…-32"><span class="toc-text">See also…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Computing-important-network-metrics"><span class="toc-text">Computing important network metrics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-57"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-58"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-55"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-32"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Getting-edge-sequences"><span class="toc-text">Getting edge sequences</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Getting-immediate-and-distant-neighbors"><span class="toc-text">Getting immediate and distant neighbors</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-vertices-or-nodes"><span class="toc-text">Adding vertices or nodes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-edges"><span class="toc-text">Adding edges</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Deleting-isolates-from-a-graph"><span class="toc-text">Deleting isolates from a graph</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Creating-subgraphs"><span class="toc-text">Creating subgraphs</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-8-Put-Your-Best-Foot-Forward-–-Document-and-Present-Your-Analysis"><span class="toc-text">Chapter 8. Put Your Best Foot Forward – Document and Present Your Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-7"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generating-reports-of-your-data-analysis-with-R-Markdown-and-knitr"><span class="toc-text">Generating reports of your data analysis with R Markdown and knitr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-58"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-59"><span class="toc-text">How to do it…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-output-options"><span class="toc-text">Adding output options</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-interactive-web-applications-with-shiny"><span class="toc-text">Creating interactive web applications with shiny</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-59"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-60"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-56"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-33"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-images"><span class="toc-text">Adding images</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-HTML"><span class="toc-text">Adding HTML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-tab-sets"><span class="toc-text">Adding tab sets</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-a-dynamic-UI"><span class="toc-text">Adding a dynamic UI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Creating-single-file-web-application"><span class="toc-text">Creating single file web application</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-PDF-presentations-of-your-analysis-with-R-Presentation"><span class="toc-text">Creating PDF presentations of your analysis with R Presentation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-60"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-61"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-57"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-34"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-hyperlinks"><span class="toc-text">Using hyperlinks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Controlling-the-display"><span class="toc-text">Controlling the display</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-9-Work-Smarter-Not-Harder-–-Efficient-and-Elegant-R-Code"><span class="toc-text">Chapter 9. Work Smarter, Not Harder – Efficient and Elegant R Code</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-8"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-vectorized-operations"><span class="toc-text">Exploiting vectorized operations</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-61"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-62"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-58"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-35"><span class="toc-text">There’s more…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Processing-entire-rows-or-columns-using-the-apply-function"><span class="toc-text">Processing entire rows or columns using the apply function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-62"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-63"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-59"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-36"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-apply-on-a-three-dimensional-array"><span class="toc-text">Using apply on a three-dimensional array</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Applying-a-function-to-all-elements-of-a-collection-with-lapply-and-sapply"><span class="toc-text">Applying a function to all elements of a collection with lapply and sapply</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-63"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-64"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-60"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-37"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Dynamic-output"><span class="toc-text">Dynamic output</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#One-caution"><span class="toc-text">One caution</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Applying-functions-to-subsets-of-a-vector"><span class="toc-text">Applying functions to subsets of a vector</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-64"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-65"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-61"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-38"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Applying-a-function-on-groups-from-a-data-frame"><span class="toc-text">Applying a function on groups from a data frame</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-the-split-apply-combine-strategy-with-plyr"><span class="toc-text">Using the split-apply-combine strategy with plyr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-65"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-66"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-62"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-39"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-a-new-column-using-transform"><span class="toc-text">Adding a new column using transform</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-summarize-along-with-the-plyr-function"><span class="toc-text">Using summarize along with the plyr function</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Concatenating-the-list-of-data-frames-into-a-big-data-frame"><span class="toc-text">Concatenating the list of data frames into a big data frame</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Slicing-dicing-and-combining-data-with-data-tables"><span class="toc-text">Slicing, dicing, and combining data with data tables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-66"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-67"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-63"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-40"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-multiple-aggregated-columns"><span class="toc-text">Adding multiple aggregated columns</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Counting-groups"><span class="toc-text">Counting groups</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Deleting-a-column"><span class="toc-text">Deleting a column</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Joining-data-tables"><span class="toc-text">Joining data tables</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-10-Where-in-the-World-–-Geospatial-Analysis"><span class="toc-text">Chapter 10. Where in the World? – Geospatial Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction-9"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Downloading-and-plotting-a-Google-map-of-an-area"><span class="toc-text">Downloading and plotting a Google map of an area</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-67"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-68"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-64"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-41"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Saving-the-downloaded-map-as-an-image-file"><span class="toc-text">Saving the downloaded map as an image file</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Getting-a-satellite-image"><span class="toc-text">Getting a satellite image</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overlaying-data-on-the-downloaded-Google-map"><span class="toc-text">Overlaying data on the downloaded Google map</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-68"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-69"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-65"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Importing-ESRI-shape-files-into-R"><span class="toc-text">Importing ESRI shape files into R</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-69"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-70"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-66"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-the-sp-package-to-plot-geographic-data"><span class="toc-text">Using the sp package to plot geographic data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-70"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-71"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-67"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Getting-maps-from-the-maps-package"><span class="toc-text">Getting maps from the maps package</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-71"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-72"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-68"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-spatial-data-frames-from-regular-data-frames-containing-spatial-and-other-data"><span class="toc-text">Creating spatial data frames from regular data frames containing spatial and other data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-72"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-73"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-69"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-spatial-data-frames-by-combining-regular-data-frames-with-spatial-objects"><span class="toc-text">Creating spatial data frames by combining regular data frames with spatial objects</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-73"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-74"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-70"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Adding-variables-to-an-existing-spatial-data-frame"><span class="toc-text">Adding variables to an existing spatial data frame</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-74"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-75"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-71"><span class="toc-text">How it works…</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-11-Playing-Nice-–-Connecting-to-Other-Systems"><span class="toc-text">Chapter 11. Playing Nice – Connecting to Other Systems</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-Java-objects-in-R"><span class="toc-text">Using Java objects in R</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-75"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-76"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-72"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-42"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Checking-JVM-properties"><span class="toc-text">Checking JVM properties</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Displaying-available-methods"><span class="toc-text">Displaying available methods</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-JRI-to-call-R-functions-from-Java"><span class="toc-text">Using JRI to call R functions from Java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-76"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-77"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-73"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-43"><span class="toc-text">There’s more…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-Rserve-to-call-R-functions-from-Java"><span class="toc-text">Using Rserve to call R functions from Java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-77"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-78"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-74"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-44"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Retrieving-an-array-from-R"><span class="toc-text">Retrieving an array from R</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Executing-R-scripts-from-Java"><span class="toc-text">Executing R scripts from Java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-78"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-79"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-75"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-the-xlsx-package-to-connect-to-Excel"><span class="toc-text">Using the xlsx package to connect to Excel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-79"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-80"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-76"><span class="toc-text">How it works…</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reading-data-from-relational-databases-–-MySQL"><span class="toc-text">Reading data from relational databases – MySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-80"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-81"><span class="toc-text">How to do it…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-RODBC"><span class="toc-text">Using RODBC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-RMySQL"><span class="toc-text">Using RMySQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-RJDBC"><span class="toc-text">Using RJDBC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-77"><span class="toc-text">How it works…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-RODBC-1"><span class="toc-text">Using RODBC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-RMySQL-1"><span class="toc-text">Using RMySQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-RJDBC-1"><span class="toc-text">Using RJDBC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-45"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fetching-all-rows"><span class="toc-text">Fetching all rows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#When-the-SQL-query-is-long"><span class="toc-text">When the SQL query is long</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reading-data-from-NoSQL-databases-–-MongoDB"><span class="toc-text">Reading data from NoSQL databases – MongoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Getting-ready-81"><span class="toc-text">Getting ready</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-do-it…-82"><span class="toc-text">How to do it…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-it-works…-78"><span class="toc-text">How it works…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#There’s-more…-46"><span class="toc-text">There’s more…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Validating-your-JSON"><span class="toc-text">Validating your JSON</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="post-content"><p>R Data Analysis Cookbook by Viswa Viswanathan &amp; Shanthi Viswanathan. From internet. <a id="more"></a></p>
<hr>
<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>Since the release of version 1.0 in 2000, R’s popularity as an environment for statistical computing, data analytics, and graphing has grown exponentially. People who have been using spreadsheets and need to perform things that spreadsheet packages cannot readily do, or need to handle larger data volumes than what a spreadsheet program can comfortably handle, are looking to R. Analogously, people using powerful commercial analytics packages are also intrigued by this free and powerful option. As a result, a large number of people are now looking to quickly get things done in R.</p>
<p>Being an extensible system, R’s functionality is divided across numerous packages with each one exposing large numbers of functions. Even experienced users cannot expect to remember all the details off the top of their head. This cookbook, aimed at users who are already exposed to the fundamentals of R, provides ready recipes to perform many important data analytics tasks. Instead of having to search the Web or delve into numerous books when faced with a specific task, people can find the appropriate recipe and get going in a matter of minutes.</p>
<h2 id="What-this-book-covers"><a href="#What-this-book-covers" class="headerlink" title="What this book covers"></a>What this book covers</h2><ul>
<li><p>Chapter 1, Acquire and Prepare the Ingredients – Your Data, covers the activities that precede the actual data analysis task. It provides recipes to read data from different input file formats. Furthermore, prior to actually analyzing the data, we perform several preparatory and data cleansing steps and the chapter also provides recipes for these: handling missing values and duplicates, scaling or standardizing values, converting between numerical and categorical variables, and creating dummy variables.</p>
</li>
<li><p>Chapter 2, What’s in There? – Exploratory Data Analysis, talks about several activities that analysts typically use to understand their data before zeroing in on specific techniques to apply. The chapter presents recipes to summarize data, split data, extract subsets, and create random data partitions, as well as several recipes to plot data to reveal underlying patters using standard plots as well as the lattice and ggplot2 packages.</p>
</li>
<li><p>Chapter 3, Where Does It Belong? – Classification, covers recipes for applying classification techniques. It includes classification trees, random forests, support vector machines, Naïve Bayes, K-nearest neighbors, neural networks, linear and quadratic discriminant analysis, and logistic regression.</p>
</li>
<li><p>Chapter 4, Give Me a Number – Regression, is about recipes for regression techniques. It includes K-nearest neighbors, linear regression, regression trees, random forests, and neural networks.</p>
</li>
<li><p>Chapter 5, Can You Simplify That? – Data Reduction Techniques, covers recipes for data reduction. It presents cluster analysis through K-means and hierarchical clustering. It also covers principal component analysis.</p>
</li>
<li><p>Chapter 6, Lessons from History – Time Series Analysis, covers recipes to work with date and date/time objects, create and plot time-series objects, decompose, filter and smooth time series, and perform ARIMA analysis.</p>
</li>
<li><p>Chapter 7, It’s All About Your Connections – Social Network Analysis, is about social networks. It includes recipes to acquire social network data using public APIs, create and plot social networks, and compute important network metrics.</p>
</li>
<li><p>Chapter 8, Put Your Best Foot Forward – Document and Present Your Analysis, considers techniques to disseminate your analysis. It includes recipes to use R markdown and KnitR to generate reports, to use shiny to create interactive applications that enable your audience to directly interact with the data, and to create presentations with RPres.</p>
</li>
<li><p>Chapter 9, Work Smarter, Not Harder – Efficient and Elegant R Code, addresses the issue of writing efficient and elegant R code in the context of handling large data. It covers recipes to use the apply family of functions, to use the plyr package, and to use data tables to slice and dice data.</p>
</li>
<li><p>Chapter 10, Where in the World? – Geospatial Analysis, covers the topic of exploiting R’s powerful features to handle spatial data. It covers recipes to use RGoogleMaps to get GoogleMaps and to superimpose our own data on them, to import ESRI shape files into R and plot them, to import maps from the maps package, and to use the sp package to create and plot spatial data frame objects.</p>
</li>
<li><p>Chapter 11, Playing Nice – Connecting to Other Systems, covers the topic of interconnecting R to other systems. It includes recipes for interconnecting R with Java, Excel and with relational and NoSQL databases (MySQL and MongoDB respectively).</p>
</li>
</ul>
<h2 id="What-you-need-for-this-book"><a href="#What-you-need-for-this-book" class="headerlink" title="What you need for this book"></a>What you need for this book</h2><p>We have tested all the code in this book for R versions 3.0.2 (Frisbee Sailing) and 3.1.0 (Spring Dance). When you install or load some of the packages, you may get a warning message to the effect that the code was compiled for a different version, but this will not impact any of the code in this book.</p>
<h2 id="Who-this-book-is-for"><a href="#Who-this-book-is-for" class="headerlink" title="Who this book is for"></a>Who this book is for</h2><p>This book is ideal for those who are already exposed to R, but have not yet used it extensively for data analytics and are seeking to get up and running quickly for analytics tasks. This book will help people who aspire to enhance their skills in any of the following ways:</p>
<ul>
<li>perform advanced analyses and create informative and professional charts</li>
<li>become proficient in acquiring data from many sources</li>
<li>apply supervised and unsupervised data mining techniques</li>
<li>use R’s features to present analyses professionally</li>
</ul>
<h2 id="Downloading-the-example-code-and-data"><a href="#Downloading-the-example-code-and-data" class="headerlink" title="Downloading the example code and data"></a>Downloading the example code and data</h2><p>You can download the example code files from your account at <a href="http://www.packtpub.com" target="_blank" rel="external">http://www.packtpub.com</a> for all the Packt Publishing books you have purchased. If you purchased this book elsewhere, you can visit <a href="http://www.packtpub.com/support" target="_blank" rel="external">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p>
<h2 id="About-the-data-files-used-in-this-book"><a href="#About-the-data-files-used-in-this-book" class="headerlink" title="About the data files used in this book"></a>About the data files used in this book</h2><p>We have generated many of the data files used in this book. We have also used some publicly available data sets. The table below lists the sources of these public data sets. We downloaded most of the public data sets from the University of California at Irvine (UCI) Machine Learning Repository at <a href="http://archive.ics.uci.edu/ml/" target="_blank" rel="external">http://archive.ics.uci.edu/ml/</a>. In the table below we have indicated this as “Downloaded from UCI-MLR.”</p>
<p>|Data file name|Source|<br>|:=———–|——-|<br>|auto-mpg.csv |Quinlan, R. Combining Instance-Based and Model-Based Learning, Machine Learning Proceedings on the Tenth International Conference 1993, 236-243, held at University of Massachusetts, Amherst published by Morgan Kaufmann.(Downloaded from UCI-MLR).|<br>|BostonHousing.csv|D. Harrison and D.L. Rubinfeld, Hedonic prices and the demand for clean air, Journal for Environmental Economics a Management, pages 81–102, 1978. (Downloaded from UCI-MLR)|<br>|daily-bike-rentals.csv|Fanaee-T, Hadi, and Gama, Joao, Event labeling combining ensemble detectors and background knowledge, Progress in Artificial Intelligence (2013): pp. 1-15, Springer Berlin Heidelberg. (Downloaded from UCI-MLR)|<br>|banknote-authentication.csv|Owner of database: Volker Lohweg, University of Applied Sciences, Ostwestfalen-Lippe Donor of database: Helene Darksen, University of Applied Sciences, Ostwestfalen-Lippe. (Downloaded from UCI-MLR)|<br>|education.csv|Robust Regression and Outlier Detection, P. J. Rouseeuw and A. M. Leroy, Wiley, 1987.(Downloaded from UCI-MLR)|<br>|walmart.csv and walmart-monthly.csv|Downloaded from Yahoo! Finance|<br>|prices.csv|Downloaded from the US Bureau of Labor Statistics.|<br>|infy.csv, infy-monthly.csv|Downloaded from Yahoo! Finance.|<br>|nj-wages.csv|NJ Department of Education’s website and <a href="http://federalgovernmentzipcodes.us.|" target="_blank" rel="external">http://federalgovernmentzipcodes.us.|</a><br>|nj-county-data.csv|Adapted from Wikipedia: <a href="http://en.wikipedia.org/wiki/List_of_counties_in_New_Jersey|" target="_blank" rel="external">http://en.wikipedia.org/wiki/List_of_counties_in_New_Jersey|</a></p>
<p>Downloading the color images of this book<br>We also provide you with a PDF file that has color images of the screenshots/diagrams used in this book. The color images will help you better understand the changes in the output. You can download this file from: <a href="https://www.packtpub.com/sites/default/files/downloads/9065OS_ColorImages.pdf" target="_blank" rel="external">https://www.packtpub.com/sites/default/files/downloads/9065OS_ColorImages.pdf</a>.</p>
<hr>
<h1 id="Chapter-1-Acquire-and-Prepare-the-Ingredients-–-Your-Data"><a href="#Chapter-1-Acquire-and-Prepare-the-Ingredients-–-Your-Data" class="headerlink" title="Chapter 1. Acquire and Prepare the Ingredients – Your Data"></a>Chapter 1. Acquire and Prepare the Ingredients – Your Data</h1><p>In this chapter, we will cover:</p>
<ul>
<li>Reading data from CSV files</li>
<li>Reading XML data</li>
<li>Reading JSON data</li>
<li>Reading data from fixed-width formatted files</li>
<li>Reading data from R data files and R libraries</li>
<li>Removing cases with missing values</li>
<li>Replacing missing values with the mean</li>
<li>Removing duplicate cases</li>
<li>Rescaling a variable to [0,1]</li>
<li>Normalizing or standardizing data in a data frame</li>
<li>Binning numerical data</li>
<li>Creating dummies for categorical variables</li>
</ul>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Data analysts need to load data from many different input formats into R. Although R has its own native data format, data usually exists in text formats, such as CSV (Comma Separated Values), JSON (JavaScript Object Notation), and XML (Extensible Markup Language). This chapter provides recipes to load such data into your R system for processing.</p>
<p>Very rarely can we start analyzing data immediately after loading it. Often, we will need to preprocess the data to clean and transform it before embarking on analysis. This chapter provides recipes for some common cleaning and preprocessing steps.</p>
<h2 id="Reading-data-from-CSV-files"><a href="#Reading-data-from-CSV-files" class="headerlink" title="Reading data from CSV files"></a>Reading data from CSV files</h2><p>CSV formats are best used to represent sets or sequences of records in which each record has an identical list of fields. This corresponds to a single relation in a relational database, or to data (though not calculations) in a typical spreadsheet.</p>
<h3 id="Getting-ready"><a href="#Getting-ready" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and ensure that the auto-mpg.csv file is in your R working directory.</p>
<h3 id="How-to-do-it…"><a href="#How-to-do-it…" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Reading data from <code>.csv</code> files can be done using the following commands:</p>
<ol>
<li><p>Read the data from <code>auto-mpg.csv</code>, which includes a header row:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, header=<span class="literal">TRUE</span>, sep = <span class="string">","</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Verify the results:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; names(auto)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…"><a href="#How-it-works…" class="headerlink" title="How it works…"></a>How it works…</h3><p>The <code>read.csv()</code> function creates a data frame from the data in the <code>.csv</code> file. If we pass <code>header=TRUE</code>, then the function uses the very first row to name the variables in the resulting data frame:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; names(auto)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"No"</span>           <span class="string">"mpg"</span>          <span class="string">"cylinders"</span></span><br><span class="line">[<span class="number">4</span>] <span class="string">"displacement"</span> <span class="string">"horsepower"</span>   <span class="string">"weight"</span></span><br><span class="line">[<span class="number">7</span>] <span class="string">"acceleration"</span> <span class="string">"model_year"</span>   <span class="string">"car_name"</span></span><br></pre></td></tr></table></figure>
<p>The <code>header</code> and <code>sep</code> parameters allow us to specify whether the <code>.csv</code> file has headers and the character used in the file to separate fields. The <code>header=TRUE</code> and <code>sep=&quot;,&quot;</code> parameters are the defaults for the <code>read.csv()</code> function—we can omit these in the code example.</p>
<h3 id="There’s-more…"><a href="#There’s-more…" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The <code>read.csv()</code> function is a specialized form of <code>read.table()</code>. The latter uses whitespace as the default field separator. We discuss a few important optional arguments to these functions.</p>
<h3 id="Handling-different-column-delimiters"><a href="#Handling-different-column-delimiters" class="headerlink" title="Handling different column delimiters"></a>Handling different column delimiters</h3><p>In regions where a comma is used as the decimal separator, <code>.csv</code> files use “;” as the field delimiter. While dealing with such data files, use <code>read.csv2()</code> to load data into R.</p>
<p>Alternatively, you can use the <code>read.csv(&quot;&lt;file name&gt;&quot;, sep=&quot;;&quot;, dec=&quot;,&quot;)</code> command.</p>
<p>Use <code>sep=&quot;\t&quot;</code> for tab-delimited files.</p>
<h3 id="Handling-column-headers-variable-names"><a href="#Handling-column-headers-variable-names" class="headerlink" title="Handling column headers/variable names"></a>Handling column headers/variable names</h3><p>If your data file does not have column headers, set <code>header=FALSE</code>.</p>
<p>The <code>auto-mpg-noheader.csv</code> file does not include a header row. The first command in the following snippet reads this file. In this case, R assigns default variable names V1, V2, and so on:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto  &lt;- read.csv(<span class="string">"auto-mpg-noheader.csv"</span>, header=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; head(auto,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  V1 V2 V3  V4 V5   V6   V7 V8                  V9</span><br><span class="line"><span class="number">1</span>  <span class="number">1</span> <span class="number">28</span>  <span class="number">4</span> <span class="number">140</span> <span class="number">90</span> <span class="number">2264</span> <span class="number">15.5</span> <span class="number">71</span> chevrolet vega <span class="number">2300</span></span><br><span class="line"><span class="number">2</span>  <span class="number">2</span> <span class="number">19</span>  <span class="number">3</span>  <span class="number">70</span> <span class="number">97</span> <span class="number">2330</span> <span class="number">13.5</span> <span class="number">72</span>     mazda rx2 coupe</span><br></pre></td></tr></table></figure>
<p>If your file does not have a header row, and you omit the <code>header=FALSE</code> optional argument, the <code>read.csv()</code> function uses the first row for variable names and ends up constructing variable names by adding X to the actual data values in the first row. Note the meaningless variable names in the following fragment:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto  &lt;- read.csv(<span class="string">"auto-mpg-noheader.csv"</span>)</span><br><span class="line">&gt; head(auto,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  X1 X28 X4 X140 X90 X2264 X15.5 X71 chevrolet.vega.2300</span><br><span class="line"><span class="number">1</span>  <span class="number">2</span>  <span class="number">19</span>  <span class="number">3</span>   <span class="number">70</span>  <span class="number">97</span>  <span class="number">2330</span>  <span class="number">13.5</span>  <span class="number">72</span>     mazda rx2 coupe</span><br><span class="line"><span class="number">2</span>  <span class="number">3</span>  <span class="number">36</span>  <span class="number">4</span>  <span class="number">107</span>  <span class="number">75</span>  <span class="number">2205</span>  <span class="number">14.5</span>  <span class="number">82</span>        honda accord</span><br></pre></td></tr></table></figure>
<p>We can use the optional <code>col.names</code> argument to specify the column names. If <code>col.names</code> is given explicitly, the names in the header row are ignored even if <code>header=TRUE</code> is specified:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg-noheader.csv"</span>, header=<span class="literal">FALSE</span>, col.names = c(<span class="string">"No"</span>, <span class="string">"mpg"</span>, <span class="string">"cyl"</span>, <span class="string">"dis"</span>,<span class="string">"hp"</span>, <span class="string">"wt"</span>, <span class="string">"acc"</span>, <span class="string">"year"</span>, <span class="string">"car_name"</span>))</span><br><span class="line"></span><br><span class="line">&gt; head(auto,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  No mpg cyl dis hp   wt  acc year            car_name</span><br><span class="line"><span class="number">1</span>  <span class="number">1</span>  <span class="number">28</span>   <span class="number">4</span> <span class="number">140</span> <span class="number">90</span> <span class="number">2264</span> <span class="number">15.5</span>   <span class="number">71</span> chevrolet vega <span class="number">2300</span></span><br><span class="line"><span class="number">2</span>  <span class="number">2</span>  <span class="number">19</span>   <span class="number">3</span>  <span class="number">70</span> <span class="number">97</span> <span class="number">2330</span> <span class="number">13.5</span>   <span class="number">72</span>     mazda rx2 coupe</span><br></pre></td></tr></table></figure>
<h3 id="Handling-missing-values"><a href="#Handling-missing-values" class="headerlink" title="Handling missing values"></a>Handling missing values</h3><p>When reading data from text files, R treats blanks in numerical variables as <code>NA</code> (signifying missing data). By default, it reads blanks in categorical attributes just as blanks and not as NA. To treat blanks as NA for categorical and character variables, set <code>na.strings=&quot;&quot;:</code></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto  &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, na.strings=<span class="string">""</span>)</span><br></pre></td></tr></table></figure>
<p>If the data file uses a specified string (such as “N/A” or “NA” for example) to indicate the missing values, you can specify that string as the na.strings argument, as in na.strings= “N/A” or na.strings = “NA”.</p>
<h3 id="Reading-strings-as-characters-and-not-as-factors"><a href="#Reading-strings-as-characters-and-not-as-factors" class="headerlink" title="Reading strings as characters and not as factors"></a>Reading strings as characters and not as factors</h3><p>By default, R treats strings as factors (categorical variables). In some situations, you may want to leave them as character strings. Use stringsAsFactors=FALSE to achieve this:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>,stringsAsFactors=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
<p>However, to selectively treat variables as characters, you can load the file with the defaults (that is, read all strings as factors) and then use as.character() to convert the requisite factor variables to characters.</p>
<h3 id="Reading-data-directly-from-a-website"><a href="#Reading-data-directly-from-a-website" class="headerlink" title="Reading data directly from a website"></a>Reading data directly from a website</h3><p>If the data file is available on the Web, you can load it into R directly instead of downloading and saving it locally before loading it into R:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat &lt;- read.csv(<span class="string">"http://www.exploredata.net/ftp/WHO.csv"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Reading-XML-data"><a href="#Reading-XML-data" class="headerlink" title="Reading XML data"></a>Reading XML data</h2><p>You may sometimes need to extract data from websites. Many providers also supply data in XML and JSON formats. In this recipe, we learn about reading XML data.</p>
<h3 id="Getting-ready-1"><a href="#Getting-ready-1" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If the XML package is not already installed in your R environment, install the package now as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"XML"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-1"><a href="#How-to-do-it…-1" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>XML data can be read by following these steps:</p>
<ol>
<li><p>Load the library and initialize:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(XML)</span><br><span class="line">&gt; url &lt;- <span class="string">"http://www.w3schools.com/xml/cd_catalog.xml"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Parse the XML file and get the root node:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; xmldoc &lt;- xmlParse(url)</span><br><span class="line">&gt; rootNode &lt;- xmlRoot(xmldoc)</span><br><span class="line">&gt; rootNode[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Extract XML data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; data &lt;- xmlSApply(rootNode,<span class="keyword">function</span>(x) xmlSApply(x, xmlValue))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the extracted data into a data frame:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; cd.catalog &lt;- data.frame(t(data),row.names=<span class="literal">NULL</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Verify the results:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; cd.catalog[<span class="number">1</span>:<span class="number">2</span>,]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-1"><a href="#How-it-works…-1" class="headerlink" title="How it works…"></a>How it works…</h3><p>The xmlParse function returns an object of the XMLInternalDocument class, which is a C-level internal data structure.</p>
<p>The xmlRoot() function gets access to the root node and its elements. We check the first element of the root node:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; rootNode[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">$CD</span><br><span class="line">&lt;CD&gt;</span><br><span class="line">  &lt;TITLE&gt;Empire Burlesque&lt;/TITLE&gt;</span><br><span class="line">  &lt;ARTIST&gt;Bob Dylan&lt;/ARTIST&gt;</span><br><span class="line">  &lt;COUNTRY&gt;USA&lt;/COUNTRY&gt;</span><br><span class="line">  &lt;COMPANY&gt;Columbia&lt;/COMPANY&gt;</span><br><span class="line">  &lt;PRICE&gt;<span class="number">10.90</span>&lt;/PRICE&gt;</span><br><span class="line">  &lt;YEAR&gt;<span class="number">1985</span>&lt;/YEAR&gt;</span><br><span class="line">&lt;/CD&gt;</span><br><span class="line">attr(,<span class="string">"class"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"XMLInternalNodeList"</span> <span class="string">"XMLNodeList"</span></span><br></pre></td></tr></table></figure>
<p>To extract data from the root node, we use the xmlSApply() function iteratively over all the children of the root node. The xmlSApply function returns a matrix.</p>
<p>To convert the preceding matrix into a data frame, we transpose the matrix using the t() function. We then extract the first two rows from the cd.catalog data frame:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; cd.catalog[<span class="number">1</span>:<span class="number">2</span>,]</span><br><span class="line">             TITLE       ARTIST COUNTRY     COMPANY PRICE YEAR</span><br><span class="line"><span class="number">1</span> Empire Burlesque    Bob Dylan     USA    Columbia <span class="number">10.90</span> <span class="number">1985</span></span><br><span class="line"><span class="number">2</span>  Hide your heart Bonnie Tyler      UK CBS Records  <span class="number">9.90</span> <span class="number">1988</span></span><br></pre></td></tr></table></figure>
<h3 id="There’s-more…-1"><a href="#There’s-more…-1" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>XML data can be deeply nested and hence can become complex to extract. Knowledge of XPath will be helpful to access specific XML tags. R provides several functions such as xpathSApply and getNodeSet to locate specific elements.</p>
<h4 id="Extracting-HTML-table-data-from-a-web-page"><a href="#Extracting-HTML-table-data-from-a-web-page" class="headerlink" title="Extracting HTML table data from a web page"></a>Extracting HTML table data from a web page</h4><p>Though it is possible to treat HTML data as a specialized form of XML, R provides specific functions to extract data from HTML tables as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; url &lt;- <span class="string">"http://en.wikipedia.org/wiki/World_population"</span></span><br><span class="line">&gt; tables &lt;- readHTMLTable(url)</span><br><span class="line">&gt; world.pop &lt;- tables[[<span class="number">5</span>]]</span><br></pre></td></tr></table></figure>
<p>The readHTMLTable() function parses the web page and returns a list of all tables that are found on the page. For tables that have an id attribute, the function uses the id attribute as the name of that list element.</p>
<p>We are interested in extracting the “10 most populous countries,” which is the fifth table; hence we use tables[[5]].</p>
<h4 id="Extracting-a-single-HTML-table-from-a-web-page"><a href="#Extracting-a-single-HTML-table-from-a-web-page" class="headerlink" title="Extracting a single HTML table from a web page"></a>Extracting a single HTML table from a web page</h4><p>A single table can be extracted using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; table &lt;- readHTMLTable(url,which=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>Specify which to get data from a specific table. R returns a data frame.</p>
<h2 id="Reading-JSON-data"><a href="#Reading-JSON-data" class="headerlink" title="Reading JSON data"></a>Reading JSON data</h2><p>Several RESTful web services return data in JSON format—in some ways simpler and more efficient than XML. This recipe shows you how to read JSON data.</p>
<h3 id="Getting-ready-2"><a href="#Getting-ready-2" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>R provides several packages to read JSON data, but we use the jsonlite package. Install the package in your R environment as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"jsonlite"</span>)</span><br></pre></td></tr></table></figure>
<p>If you have not already downloaded the files for this chapter, do it now and ensure that the students.json files and student-courses.json files are in your R working directory.</p>
<h3 id="How-to-do-it…-2"><a href="#How-to-do-it…-2" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Once the files are ready and load the jsonlite package and read the files as follows:</p>
<ol>
<li><p>Load the library:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(jsonlite)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Load the JSON data from files:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat.1 &lt;- fromJSON(<span class="string">"students.json"</span>)</span><br><span class="line">&gt; dat.2 &lt;- fromJSON(<span class="string">"student-courses.json"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Load the JSON document from the Web:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; url &lt;- <span class="string">"http://finance.yahoo.com/webservice/v1/symbols/allcurrencies/quote?format=json"</span></span><br><span class="line">&gt; jsonDoc &lt;- fromJSON(url)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Extract data into data frames:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat &lt;- jsonDoc$list$resources$resource$fields</span><br></pre></td></tr></table></figure>
</li>
<li><p>Verify the results:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat[<span class="number">1</span>:<span class="number">2</span>,]</span><br><span class="line">&gt; dat.1[<span class="number">1</span>:<span class="number">3</span>,]</span><br><span class="line">&gt; dat.2[,c(<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>:<span class="number">5</span>)]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-2"><a href="#How-it-works…-2" class="headerlink" title="How it works…"></a>How it works…</h3><p>The jsonlite package provides two key functions: fromJSON and toJSON.</p>
<p>The fromJSON function can load data either directly from a file or from a web page as the preceding steps 2 and 3 show. If you get errors in downloading content directly from the Web, install and load the httr package.</p>
<p>Depending on the structure of the JSON document, loading the data can vary in complexity.</p>
<p>If given a URL, the fromJSON function returns a list object. In the preceding list, in step 4, we see how to extract the enclosed data frame.</p>
<h2 id="Reading-data-from-fixed-width-formatted-files"><a href="#Reading-data-from-fixed-width-formatted-files" class="headerlink" title="Reading data from fixed-width formatted files"></a>Reading data from fixed-width formatted files</h2><p>In fixed-width formatted files, columns have fixed widths; if a data element does not use up the entire allotted column width, then the element is padded with spaces to make up the specified width. To read fixed-width text files, specify columns by column widths or by starting positions.</p>
<h3 id="Getting-ready-3"><a href="#Getting-ready-3" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the student-fwf.txt file in your R working directory.</p>
<h3 id="How-to-do-it…-3"><a href="#How-to-do-it…-3" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Read the fixed-width formatted file as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; student  &lt;- read.fwf(<span class="string">"student-fwf.txt"</span>, widths=c(<span class="number">4</span>,<span class="number">15</span>,<span class="number">20</span>,<span class="number">15</span>,<span class="number">4</span>), col.names=c(<span class="string">"id"</span>,<span class="string">"name"</span>,<span class="string">"email"</span>,<span class="string">"major"</span>,<span class="string">"year"</span>))</span><br></pre></td></tr></table></figure>
<h3 id="How-it-works…-3"><a href="#How-it-works…-3" class="headerlink" title="How it works…"></a>How it works…</h3><p>In the student-fwf.txt file, the first column occupies 4 character positions, the second 15, and so on. The c(4,15,20,15,4) expression specifies the widths of the five columns in the data file.</p>
<p>We can use the optional col.names argument to supply our own variable names.</p>
<h3 id="There’s-more…-2"><a href="#There’s-more…-2" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The read.fwf() function has several optional arguments that come in handy. We discuss a few of these as follows:</p>
<h4 id="Files-with-headers"><a href="#Files-with-headers" class="headerlink" title="Files with headers"></a>Files with headers</h4><p>Files with headers use the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; student  &lt;- read.fwf(<span class="string">"student-fwf-header.txt"</span>, widths=c(<span class="number">4</span>,<span class="number">15</span>,<span class="number">20</span>,<span class="number">15</span>,<span class="number">4</span>), header=<span class="literal">TRUE</span>, sep=<span class="string">"\t"</span>,skip=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>If header=TRUE, the first row of the file is interpreted as having the column headers. Column headers, if present, need to be separated by the specified sep argument. The sep argument only applies to the header row.</p>
<p>The skip argument denotes the number of lines to skip; in this recipe, the first two lines are skipped.</p>
<h4 id="Excluding-columns-from-data"><a href="#Excluding-columns-from-data" class="headerlink" title="Excluding columns from data"></a>Excluding columns from data</h4><p>To exclude a column, make the column width negative. Thus, to exclude the e-mail column, we will specify its width as -20 and also remove the column name from the col.names vector as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; student &lt;- read.fwf(<span class="string">"student-fwf.txt"</span>,widths=c(<span class="number">4</span>,<span class="number">15</span>,-<span class="number">20</span>,<span class="number">15</span>,<span class="number">4</span>), col.names=c(<span class="string">"id"</span>,<span class="string">"name"</span>,<span class="string">"major"</span>,<span class="string">"year"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Reading-data-from-R-files-and-R-libraries"><a href="#Reading-data-from-R-files-and-R-libraries" class="headerlink" title="Reading data from R files and R libraries"></a>Reading data from R files and R libraries</h2><p>During data analysis, you will create several R objects. You can save these in the native R data format and retrieve them later as needed.</p>
<h3 id="Getting-ready-4"><a href="#Getting-ready-4" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>First, create and save R objects interactively as shown in the following code. Make sure you have write access to the R working directory:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; customer &lt;- c(<span class="string">"John"</span>, <span class="string">"Peter"</span>, <span class="string">"Jane"</span>)</span><br><span class="line">&gt; orderdate &lt;- as.Date(c(<span class="string">'2014-10-1'</span>,<span class="string">'2014-1-2'</span>,<span class="string">'2014-7-6'</span>))</span><br><span class="line">&gt; orderamount &lt;- c(<span class="number">280</span>, <span class="number">100.50</span>, <span class="number">40.25</span>)</span><br><span class="line">&gt; order &lt;- data.frame(customer,orderdate,orderamount)</span><br><span class="line">&gt; names &lt;- c(<span class="string">"John"</span>, <span class="string">"Joan"</span>)</span><br><span class="line">&gt; save(order, names, file=<span class="string">"test.Rdata"</span>)</span><br><span class="line">&gt; saveRDS(order,file=<span class="string">"order.rds"</span>)</span><br><span class="line">&gt; remove(order)</span><br></pre></td></tr></table></figure>
<p>After saving the preceding code, the remove() function deletes the object from the current session.</p>
<h3 id="How-to-do-it…-4"><a href="#How-to-do-it…-4" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To be able to read data from R files and libraries, follow these steps:</p>
<ol>
<li><p>Load data from R data files into memory:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; load(<span class="string">"test.Rdata"</span>)</span><br><span class="line">&gt; ord &lt;- readRDS(<span class="string">"order.rds"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>The datasets package is loaded in the R environment by default and contains the iris and cars datasets. To load these datasets’ data into memory, use the following code:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; data(iris)</span><br><span class="line">&gt; data(c(cars,iris))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>The first command loads only the iris dataset, and the second loads the cars and iris datasets.</p>
<h3 id="How-it-works…-4"><a href="#How-it-works…-4" class="headerlink" title="How it works…"></a>How it works…</h3><p>The save() function saves the serialized version of the objects supplied as arguments along with the object name. The subsequent load() function restores the saved objects with the same object names they were saved with, to the global environment by default. If there are existing objects with the same names in that environment, they will be replaced without any warnings.</p>
<p>The saveRDS() function saves only one object. It saves the serialized version of the object and not the object name. Hence, with the readRDS() function the saved object can be restored into a variable with a different name from when it was saved.</p>
<h3 id="There’s-more…-3"><a href="#There’s-more…-3" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The preceding recipe has shown you how to read saved R objects. We see more options in this section.</p>
<h4 id="To-save-all-objects-in-a-session"><a href="#To-save-all-objects-in-a-session" class="headerlink" title="To save all objects in a session"></a>To save all objects in a session</h4><p>The following command can be used to save all objects:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; save.image(file = <span class="string">"all.RData"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="To-selectively-save-objects-in-a-session"><a href="#To-selectively-save-objects-in-a-session" class="headerlink" title="To selectively save objects in a session"></a>To selectively save objects in a session</h4><p>To save objects selectively use the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; odd &lt;- c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>)</span><br><span class="line">&gt; even &lt;- c(<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>)</span><br><span class="line">&gt; save(list=c(<span class="string">"odd"</span>,<span class="string">"even"</span>),file=<span class="string">"OddEven.Rdata"</span>)</span><br></pre></td></tr></table></figure>
<p>The list argument specifies a character vector containing the names of the objects to be saved. Subsequently, loading data from the OddEven.Rdata file creates both odd and even objects. The saveRDS() function can save only one object at a time.</p>
<h4 id="Attaching-detaching-R-data-files-to-an-environment"><a href="#Attaching-detaching-R-data-files-to-an-environment" class="headerlink" title="Attaching/detaching R data files to an environment"></a>Attaching/detaching R data files to an environment</h4><p>While loading Rdata files, if we want to be notified whether objects with the same name already exist in the environment, we can use:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">attach</span>(<span class="string">"order.Rdata"</span>)</span><br></pre></td></tr></table></figure>
<p>The order.Rdata file contains an object named order. If an object named order already exists in the environment, we will get the following error:</p>
<p>The following object is masked <code>_by_ .GlobalEnv</code>:</p>
<pre><code>order
</code></pre><h4 id="Listing-all-datasets-in-loaded-packages"><a href="#Listing-all-datasets-in-loaded-packages" class="headerlink" title="Listing all datasets in loaded packages"></a>Listing all datasets in loaded packages</h4><p>All the loaded packages can be listed using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; data()</span><br></pre></td></tr></table></figure>
<h2 id="Removing-cases-with-missing-values"><a href="#Removing-cases-with-missing-values" class="headerlink" title="Removing cases with missing values"></a>Removing cases with missing values</h2><p>Datasets come with varying amounts of missing data. When we have abundant data, we sometimes (not always) want to eliminate the cases that have missing values for one or more variables. This recipe applies when we want to eliminate cases that have any missing values, as well as when we want to selectively eliminate cases that have missing values for a specific variable alone.</p>
<h3 id="Getting-ready-5"><a href="#Getting-ready-5" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the missing-data.csv file from the code files for this chapter to your R working directory. Read the data from the missing-data.csv file while taking care to identify the string used in the input file for missing values. In our file, missing values are shown with empty strings:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat &lt;- read.csv(<span class="string">"missing-data.csv"</span>, na.strings=<span class="string">""</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-5"><a href="#How-to-do-it…-5" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To get a data frame that has only the cases with no missing values for any variable, use the na.omit() function:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat.cleaned &lt;- na.omit(dat)</span><br></pre></td></tr></table></figure>
<p>Now, dat.cleaned contains only those cases from dat, which have no missing values in any of the variables.</p>
<h3 id="How-it-works…-5"><a href="#How-it-works…-5" class="headerlink" title="How it works…"></a>How it works…</h3><p>The na.omit() function internally uses the is.na() function that allows us to find whether its argument is NA. When applied to a single value, it returns a boolean value. When applied to a collection, it returns a vector:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; is.na(dat[<span class="number">4</span>,<span class="number">2</span>])</span><br><span class="line">[<span class="number">1</span>] <span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">&gt; is.na(dat$Income)</span><br><span class="line">[<span class="number">1</span>] <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span></span><br><span class="line">[<span class="number">10</span>] <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span></span><br><span class="line">[<span class="number">19</span>] <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span></span><br></pre></td></tr></table></figure>
<h3 id="There’s-more…-4"><a href="#There’s-more…-4" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>You will sometimes need to do more than just eliminate cases with any missing values. We discuss some options in this section.</p>
<h4 id="Eliminating-cases-with-NA-for-selected-variables"><a href="#Eliminating-cases-with-NA-for-selected-variables" class="headerlink" title="Eliminating cases with NA for selected variables"></a>Eliminating cases with NA for selected variables</h4><p>We might sometimes want to selectively eliminate cases that have NA only for a specific variable. The example data frame has two missing values for Income. To get a data frame with only these two cases removed, use:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat.income.cleaned &lt;- dat[!is.na(dat$Income),]</span><br><span class="line">&gt; nrow(dat.income.cleaned)</span><br><span class="line">[<span class="number">1</span>] <span class="number">25</span></span><br></pre></td></tr></table></figure>
<p>Finding cases that have no missing values</p>
<p>The complete.cases() function takes a data frame or table as its argument and returns a boolean vector with TRUE for rows that have no missing values and FALSE otherwise:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; complete.cases(dat)</span><br><span class="line"></span><br><span class="line"> [<span class="number">1</span>]  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span></span><br><span class="line">[<span class="number">10</span>]  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span></span><br><span class="line">[<span class="number">19</span>]  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span></span><br></pre></td></tr></table></figure>
<p>Rows 4, 6, 13, and 17 have at least one missing value. Instead of using the na.omit() function, we could have done the following as well:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat.cleaned &lt;- dat[complete.cases(dat),]</span><br><span class="line">&gt; nrow(dat.cleaned)</span><br><span class="line">[<span class="number">1</span>] <span class="number">23</span></span><br></pre></td></tr></table></figure>
<h4 id="Converting-specific-values-to-NA"><a href="#Converting-specific-values-to-NA" class="headerlink" title="Converting specific values to NA"></a>Converting specific values to NA</h4><p>Sometimes, we might know that a specific value in a data frame actually means that data was not available. For example, in the dat data frame a value of 0 for income may mean that the data is missing. We can convert these to NA by a simple assignment:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat$Income[dat$Income==<span class="number">0</span>] &lt;- <span class="literal">NA</span></span><br></pre></td></tr></table></figure>
<h4 id="Excluding-NA-values-from-computations"><a href="#Excluding-NA-values-from-computations" class="headerlink" title="Excluding NA values from computations"></a>Excluding NA values from computations</h4><p>Many R functions return NA when some parts of the data they work on are NA. For example, computing the mean or sd on a vector with at least one NA value returns NA as the result. To remove NA from consideration, use the na.rm parameter:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; mean(dat$Income)</span><br><span class="line">[<span class="number">1</span>] <span class="literal">NA</span></span><br><span class="line"></span><br><span class="line">&gt; mean(dat$Income, na.rm = <span class="literal">TRUE</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="number">65763.64</span></span><br></pre></td></tr></table></figure>
<h2 id="Replacing-missing-values-with-the-mean"><a href="#Replacing-missing-values-with-the-mean" class="headerlink" title="Replacing missing values with the mean"></a>Replacing missing values with the mean</h2><p>When you disregard cases with any missing variables, you lose useful information that the nonmissing values in that case convey. You may sometimes want to impute reasonable values (those that will not skew the results of analyses very much) for the missing values.</p>
<h3 id="Getting-ready-6"><a href="#Getting-ready-6" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the missing-data.csv file and store it in your R environment’s working directory.</p>
<h3 id="How-to-do-it…-6"><a href="#How-to-do-it…-6" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Read data and replace missing values:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat &lt;- read.csv(<span class="string">"missing-data.csv"</span>, na.strings = <span class="string">""</span>)</span><br><span class="line">&gt; dat$Income.imp.mean &lt;- ifelse(is.na(dat$Income), mean(dat$Income, na.rm=<span class="literal">TRUE</span>), dat$Income)</span><br></pre></td></tr></table></figure>
<p>After this, all the NA values for Income will now be the mean value prior to imputation.</p>
<h3 id="How-it-works…-6"><a href="#How-it-works…-6" class="headerlink" title="How it works…"></a>How it works…</h3><p>The preceding ifelse() function returns the imputed mean value if its first argument is NA. Otherwise, it returns the first argument.</p>
<h3 id="There’s-more…-5"><a href="#There’s-more…-5" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>You cannot impute the mean when a categorical variable has missing values, so you need a different approach. Even for numeric variables, we might sometimes not want to impute the mean for missing values. We discuss an often used approach here.</p>
<h4 id="Imputing-random-values-sampled-from-nonmissing-values"><a href="#Imputing-random-values-sampled-from-nonmissing-values" class="headerlink" title="Imputing random values sampled from nonmissing values"></a>Imputing random values sampled from nonmissing values</h4><p>If you want to impute random values sampled from the nonmissing values of the variable, you can use the following two functions:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rand.impute &lt;- <span class="keyword">function</span>(a) &#123;</span><br><span class="line">  missing &lt;- is.na(a)</span><br><span class="line">  n.missing &lt;- sum(missing)</span><br><span class="line">  a.obs &lt;- a[!missing]</span><br><span class="line">  imputed &lt;- a</span><br><span class="line">  imputed[missing] &lt;- sample (a.obs, n.missing, replace=<span class="literal">TRUE</span>)</span><br><span class="line">  <span class="keyword">return</span> (imputed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">random.impute.data.frame &lt;- <span class="keyword">function</span>(dat, cols) &#123;</span><br><span class="line">  nms &lt;- names(dat)</span><br><span class="line">  <span class="keyword">for</span>(col <span class="keyword">in</span> cols) &#123;</span><br><span class="line">    name &lt;- paste(nms[col],<span class="string">".imputed"</span>, sep = <span class="string">""</span>)</span><br><span class="line">    dat[name] &lt;- rand.impute(dat[,col])</span><br><span class="line">  &#125;</span><br><span class="line">  dat</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With these two functions in place, you can use the following to impute random values for both Income and Phone_type:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat &lt;- read.csv(<span class="string">"missing-data.csv"</span>, na.strings=<span class="string">""</span>)</span><br><span class="line">&gt; random.impute.data.frame(dat, c(<span class="number">1</span>,<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Removing-duplicate-cases"><a href="#Removing-duplicate-cases" class="headerlink" title="Removing duplicate cases"></a>Removing duplicate cases</h2><p>We sometimes end up with duplicate cases in our datasets and want to retain only one among the duplicates.</p>
<h3 id="Getting-ready-7"><a href="#Getting-ready-7" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Create a sample data frame:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; salary &lt;- c(<span class="number">20000</span>, <span class="number">30000</span>, <span class="number">25000</span>, <span class="number">40000</span>, <span class="number">30000</span>, <span class="number">34000</span>, <span class="number">30000</span>)</span><br><span class="line">&gt; family.size &lt;- c(<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">3</span>)</span><br><span class="line">&gt; car &lt;- c(<span class="string">"Luxury"</span>, <span class="string">"Compact"</span>, <span class="string">"Midsize"</span>, <span class="string">"Luxury"</span>, <span class="string">"Compact"</span>, <span class="string">"Compact"</span>, <span class="string">"Compact"</span>)</span><br><span class="line">&gt; prospect &lt;- data.frame(salary, family.size, car)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-7"><a href="#How-to-do-it…-7" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>The unique() function can do the job. It takes a vector or data frame as an argument and returns an object of the same type as its argument but with duplicates removed.</p>
<p>Get unique values:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; prospect.cleaned &lt;- unique(prospect)</span><br><span class="line">&gt; nrow(prospect)</span><br><span class="line">[<span class="number">1</span>] <span class="number">7</span></span><br><span class="line">&gt; nrow(prospect.cleaned)</span><br><span class="line">[<span class="number">1</span>] <span class="number">5</span></span><br></pre></td></tr></table></figure>
<h3 id="How-it-works…-7"><a href="#How-it-works…-7" class="headerlink" title="How it works…"></a>How it works…</h3><p>The unique() function takes a vector or data frame as an argument and returns a like object with the duplicate eliminated. It returns the nonduplicated cases as is. For repeated cases, the unique() function includes one copy in the returned result.</p>
<h3 id="There’s-more…-6"><a href="#There’s-more…-6" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>Sometimes we just want to identify duplicated values without necessarily removing them.</p>
<h4 id="Identifying-duplicates-without-deleting-them"><a href="#Identifying-duplicates-without-deleting-them" class="headerlink" title="Identifying duplicates (without deleting them)"></a>Identifying duplicates (without deleting them)</h4><p>For this, use the duplicated() function:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; duplicated(prospect)</span><br><span class="line">[<span class="number">1</span>] <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span></span><br></pre></td></tr></table></figure>
<p>From the data, we know that cases 2, 5, and 7 are duplicates. Note that only cases 5 and 7 are shown as duplicates. In the first occurrence, case 2 is not flagged as a duplicate.</p>
<p>To list the duplicate cases, use the following code:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; prospect[duplicated(prospect), ]</span><br><span class="line"></span><br><span class="line">  salary family.size     car</span><br><span class="line"><span class="number">5</span>  <span class="number">30000</span>           <span class="number">3</span> Compact</span><br><span class="line"><span class="number">7</span>  <span class="number">30000</span>           <span class="number">3</span> Compact</span><br></pre></td></tr></table></figure>
<h2 id="Rescaling-a-variable-to-0-1"><a href="#Rescaling-a-variable-to-0-1" class="headerlink" title="Rescaling a variable to [0,1]"></a>Rescaling a variable to [0,1]</h2><p>Distance computations play a big role in many data analytics techniques. We know that variables with higher values tend to dominate distance computations and you may want to rescale the values to be in the range 0 - 1.</p>
<h3 id="Getting-ready-8"><a href="#Getting-ready-8" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the scales package and read the data-conversion.csv file from the book’s data for this chapter into your R environment’s working directory:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"scales"</span>)</span><br><span class="line">&gt; <span class="keyword">library</span>(scales)</span><br><span class="line">&gt; students &lt;- read.csv(<span class="string">"data-conversion.csv"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-8"><a href="#How-to-do-it…-8" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To rescale the Income variable to the range [0,1]:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; students$Income.rescaled &lt;- rescale(students$Income)</span><br></pre></td></tr></table></figure>
<h3 id="How-it-works…-8"><a href="#How-it-works…-8" class="headerlink" title="How it works…"></a>How it works…</h3><p>By default, the rescale() function makes the lowest value(s) zero and the highest value(s) one. It rescales all other values proportionately. The following two expressions provide identical results:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; rescale(students$Income)</span><br><span class="line">&gt; (students$Income - min(students$Income)) / (max(students$Income) - min(students$Income))</span><br></pre></td></tr></table></figure>
<p>To rescale a different range than [0,1], use the to argument. The following rescales students$Income to the range (0,100):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; rescale(students$Income, to = c(<span class="number">1</span>, <span class="number">100</span>))</span><br></pre></td></tr></table></figure>
<h3 id="There’s-more…-7"><a href="#There’s-more…-7" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>When using distance-based techniques, you may need to rescale several variables. You may find it tedious to scale one variable at a time.</p>
<h4 id="Rescaling-many-variables-at-once"><a href="#Rescaling-many-variables-at-once" class="headerlink" title="Rescaling many variables at once"></a>Rescaling many variables at once</h4><p>Use the following function:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rescale.many &lt;- <span class="keyword">function</span>(dat, column.nos) &#123;</span><br><span class="line">  nms &lt;- names(dat)</span><br><span class="line">  <span class="keyword">for</span>(col <span class="keyword">in</span> column.nos) &#123;</span><br><span class="line">    name &lt;- paste(nms[col],<span class="string">".rescaled"</span>, sep = <span class="string">""</span>)</span><br><span class="line">    dat[name] &lt;- rescale(dat[,col])</span><br><span class="line">  &#125;</span><br><span class="line">  cat(paste(<span class="string">"Rescaled "</span>, length(column.nos), <span class="string">" variable(s)\n"</span>))</span><br><span class="line">  dat</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With the preceding function defined, we can do the following to rescale the first and fourth variables in the data frame:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; rescale.many(students, c(<span class="number">1</span>,<span class="number">4</span>))</span><br></pre></td></tr></table></figure>
<h3 id="See-also…"><a href="#See-also…" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Recipe: Normalizing or standardizing data in a data frame in this chapter</li>
</ul>
<h2 id="Normalizing-or-standardizing-data-in-a-data-frame"><a href="#Normalizing-or-standardizing-data-in-a-data-frame" class="headerlink" title="Normalizing or standardizing data in a data frame"></a>Normalizing or standardizing data in a data frame</h2><p>Distance computations play a big role in many data analytics techniques. We know that variables with higher values tend to dominate distance computations and you may want to use the standardized (or Z) values.</p>
<h3 id="Getting-ready-9"><a href="#Getting-ready-9" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the BostonHousing.csv data file and store it in your R environment’s working directory. Then read the data:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; housing &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-9"><a href="#How-to-do-it…-9" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To standardize all the variables in a data frame containing only numeric variables, use:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; housing.z &lt;- scale(housing)</span><br></pre></td></tr></table></figure>
<p>You can only use the scale() function on data frames containing all numeric variables. Otherwise, you will get an error.</p>
<h3 id="How-it-works…-9"><a href="#How-it-works…-9" class="headerlink" title="How it works…"></a>How it works…</h3><p>When invoked as above, the scale() function computes the standard Z score for each value (ignoring NAs) of each variable. That is, from each value it subtracts the mean and divides the result by the standard deviation of the associated variable.</p>
<p>The scale() function takes two optional arguments, center and scale, whose default values are TRUE. The following table shows the effect of these arguments:</p>
<p>|Argument|Effect|<br>|:=——-|——|<br>|center = TRUE, scale = TRUE|Default behavior described earlier|<br>|center = TRUE, scale = FALSE|From each value, subtract the mean of the concerned variable|<br>|center = FALSE, scale = TRUE|Divide each value by the root mean square of the associated variable, where root mean square is sqrt(sum(x^2)/(n-1))|<br>|center = FALSE, scale = FALSE|Return the original values unchanged|</p>
<h3 id="There’s-more…-8"><a href="#There’s-more…-8" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>When using distance-based techniques, you may need to rescale several variables. You may find it tedious to standardize one variable at a time.</p>
<h4 id="Standardizing-several-variables-simultaneously"><a href="#Standardizing-several-variables-simultaneously" class="headerlink" title="Standardizing several variables simultaneously"></a>Standardizing several variables simultaneously</h4><p>If you have a data frame with some numeric and some non-numeric variables, or want to standardize only some of the variables in a fully numeric data frame, then you can either handle each variable separately—which would be cumbersome—or use a function such as the following to handle a subset of variables:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scale.many &lt;- <span class="keyword">function</span>(dat, column.nos) &#123;</span><br><span class="line">  nms &lt;- names(dat)</span><br><span class="line">  <span class="keyword">for</span>(col <span class="keyword">in</span> column.nos) &#123;</span><br><span class="line">    name &lt;- paste(nms[col],<span class="string">".z"</span>, sep = <span class="string">""</span>)</span><br><span class="line">    dat[name] &lt;- scale(dat[,col])</span><br><span class="line">  &#125;</span><br><span class="line">  cat(paste(<span class="string">"Scaled "</span>, length(column.nos), <span class="string">" variable(s)\n"</span>))</span><br><span class="line">  dat</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With this function, you can now do things like:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; housing &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br><span class="line">&gt; housing &lt;- scale.many(housing, c(<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>:<span class="number">7</span>))</span><br></pre></td></tr></table></figure>
<p>This will add the z values for variables 1, 3, 5, 6, and 7 with .z appended to the original column names:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; names(housing)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"CRIM"</span>    <span class="string">"ZN"</span>      <span class="string">"INDUS"</span>   <span class="string">"CHAS"</span>    <span class="string">"NOX"</span>     <span class="string">"RM"</span></span><br><span class="line">[<span class="number">7</span>] <span class="string">"AGE"</span>     <span class="string">"DIS"</span>     <span class="string">"RAD"</span>     <span class="string">"TAX"</span>     <span class="string">"PTRATIO"</span> <span class="string">"B"</span></span><br><span class="line">[<span class="number">13</span>] <span class="string">"LSTAT"</span>   <span class="string">"MEDV"</span>    <span class="string">"CRIM.z"</span>  <span class="string">"INDUS.z"</span> <span class="string">"NOX.z"</span>   <span class="string">"RM.z"</span></span><br><span class="line">[<span class="number">19</span>] <span class="string">"AGE.z"</span></span><br></pre></td></tr></table></figure>
<h3 id="See-also…-1"><a href="#See-also…-1" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li><p>Recipe: Rescaling a variable to [0,1] in this chapter</p>
<p>  Tip: Downloading the example code and data<br>  You can download the example code files from your account at <a href="http://www.packtpub.com" target="_blank" rel="external">http://www.packtpub.com</a> for all the Packt Publishing books you have purchased. If you purchased this book elsewhere, you can visit <a href="http://www.packtpub.com/support" target="_blank" rel="external">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p>
</li>
</ul>
<h2 id="Binning-numerical-data"><a href="#Binning-numerical-data" class="headerlink" title="Binning numerical data"></a>Binning numerical data</h2><p>Sometimes, we need to convert numerical data to categorical data or a factor. For example, Naïve Bayes classification requires all variables (independent and dependent) to be categorical. In other situations, we may want to apply a classification method to a problem where the dependent variable is numeric but needs to be categorical.</p>
<h3 id="Getting-ready-10"><a href="#Getting-ready-10" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>From the code files for this chapter, store the data-conversion.csv file in the working directory of your R environment. Then read the data:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; students &lt;- read.csv(<span class="string">"data-conversion.csv"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-10"><a href="#How-to-do-it…-10" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Income is a numeric variable, and you may want to create a categorical variable from it by creating bins. Suppose you want to label incomes of $10,000 or below as Low, incomes between $10,000 and $31,000 as Medium, and the rest as High. We can do the following:</p>
<ol>
<li><p>Create a vector of break points:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; b &lt;- c(-<span class="literal">Inf</span>, <span class="number">10000</span>, <span class="number">31000</span>, <span class="literal">Inf</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a vector of names for break points:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; names &lt;- c(<span class="string">"Low"</span>, <span class="string">"Medium"</span>, <span class="string">"High"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Cut the vector using the break points:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; students$Income.cat &lt;- cut(students$Income, breaks = b, labels = names)</span><br><span class="line">&gt; students</span><br><span class="line"></span><br><span class="line">    Age State Gender Height Income Income.cat</span><br><span class="line"><span class="number">1</span>   <span class="number">23</span>    NJ      <span class="literal">F</span>     <span class="number">61</span>   <span class="number">5000</span>        Low</span><br><span class="line"><span class="number">2</span>   <span class="number">13</span>    NY      M     <span class="number">55</span>   <span class="number">1000</span>        Low</span><br><span class="line"><span class="number">3</span>   <span class="number">36</span>    NJ      M     <span class="number">66</span>   <span class="number">3000</span>        Low</span><br><span class="line"><span class="number">4</span>   <span class="number">31</span>    VA      <span class="literal">F</span>     <span class="number">64</span>   <span class="number">4000</span>        Low</span><br><span class="line"><span class="number">5</span>   <span class="number">58</span>    NY      <span class="literal">F</span>     <span class="number">70</span>  <span class="number">30000</span>     Medium</span><br><span class="line"><span class="number">6</span>   <span class="number">29</span>    TX      <span class="literal">F</span>     <span class="number">63</span>  <span class="number">10000</span>        Low</span><br><span class="line"><span class="number">7</span>   <span class="number">39</span>    NJ      M     <span class="number">67</span>  <span class="number">50000</span>       High</span><br><span class="line"><span class="number">8</span>   <span class="number">50</span>    VA      M     <span class="number">70</span>  <span class="number">55000</span>       High</span><br><span class="line"><span class="number">9</span>   <span class="number">23</span>    TX      <span class="literal">F</span>     <span class="number">61</span>   <span class="number">2000</span>        Low</span><br><span class="line"><span class="number">10</span>  <span class="number">36</span>    VA      M     <span class="number">66</span>  <span class="number">20000</span>     Medium</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-10"><a href="#How-it-works…-10" class="headerlink" title="How it works…"></a>How it works…</h3><p>The cut() function uses the ranges implied by the breaks argument to infer the bins, and names them according to the strings provided in the labels argument. In our example, the function places incomes less than or equal to 10,000 in the first bin, incomes greater than 10,000 and less than or equal to 31,000 in the second bin, and incomes greater than 31,000 in the third bin. In other words, the first number in the interval is not included and the second one is. The number of bins will be one less than the number of elements in breaks. The strings in names become the factor levels of the bins.</p>
<p>If we leave out names, cut() uses the numbers in the second argument to construct interval names as you can see here:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; b &lt;- c(-<span class="literal">Inf</span>, <span class="number">10000</span>, <span class="number">31000</span>, <span class="literal">Inf</span>)</span><br><span class="line">&gt; students$Income.cat1 &lt;- cut(students$Income, breaks = b)</span><br><span class="line">&gt; students</span><br><span class="line"></span><br><span class="line">   Age State Gender Height Income Income.cat     Income.cat1</span><br><span class="line"><span class="number">1</span>   <span class="number">23</span>    NJ      <span class="literal">F</span>     <span class="number">61</span>   <span class="number">5000</span>        Low    (-<span class="literal">Inf</span>,<span class="number">1e+04</span>]</span><br><span class="line"><span class="number">2</span>   <span class="number">13</span>    NY      M     <span class="number">55</span>   <span class="number">1000</span>        Low    (-<span class="literal">Inf</span>,<span class="number">1e+04</span>]</span><br><span class="line"><span class="number">3</span>   <span class="number">36</span>    NJ      M     <span class="number">66</span>   <span class="number">3000</span>        Low    (-<span class="literal">Inf</span>,<span class="number">1e+04</span>]</span><br><span class="line"><span class="number">4</span>   <span class="number">31</span>    VA      <span class="literal">F</span>     <span class="number">64</span>   <span class="number">4000</span>        Low    (-<span class="literal">Inf</span>,<span class="number">1e+04</span>]</span><br><span class="line"><span class="number">5</span>   <span class="number">58</span>    NY      <span class="literal">F</span>     <span class="number">70</span>  <span class="number">30000</span>     Medium (<span class="number">1e+04</span>,<span class="number">3.1e+04</span>]</span><br><span class="line"><span class="number">6</span>   <span class="number">29</span>    TX      <span class="literal">F</span>     <span class="number">63</span>  <span class="number">10000</span>        Low    (-<span class="literal">Inf</span>,<span class="number">1e+04</span>]</span><br><span class="line"><span class="number">7</span>   <span class="number">39</span>    NJ      M     <span class="number">67</span>  <span class="number">50000</span>       High  (<span class="number">3.1e+04</span>, <span class="literal">Inf</span>]</span><br><span class="line"><span class="number">8</span>   <span class="number">50</span>    VA      M     <span class="number">70</span>  <span class="number">55000</span>       High  (<span class="number">3.1e+04</span>, <span class="literal">Inf</span>]</span><br><span class="line"><span class="number">9</span>   <span class="number">23</span>    TX      <span class="literal">F</span>     <span class="number">61</span>   <span class="number">2000</span>        Low    (-<span class="literal">Inf</span>,<span class="number">1e+04</span>]</span><br><span class="line"><span class="number">10</span>  <span class="number">36</span>    VA      M     <span class="number">66</span>  <span class="number">20000</span>     Medium (<span class="number">1e+04</span>,<span class="number">3.1e+04</span>]</span><br></pre></td></tr></table></figure>
<h3 id="There’s-more…-9"><a href="#There’s-more…-9" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>You might not always be in a position to identify the breaks manually and may instead want to rely on R to do this automatically.</p>
<h4 id="Creating-a-specified-number-of-intervals-automatically"><a href="#Creating-a-specified-number-of-intervals-automatically" class="headerlink" title="Creating a specified number of intervals automatically"></a>Creating a specified number of intervals automatically</h4><p>Rather than determining the breaks and hence the intervals manually as above, we can specify the number of bins we want, say n, and let the cut() function handle the rest automatically. In this case, cut() creates n intervals of approximately equal width as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; students$Income.cat2 &lt;- cut(students$Income, breaks = <span class="number">4</span>, labels = c(<span class="string">"Level1"</span>, <span class="string">"Level2"</span>, <span class="string">"Level3"</span>,<span class="string">"Level4"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Creating-dummies-for-categorical-variables"><a href="#Creating-dummies-for-categorical-variables" class="headerlink" title="Creating dummies for categorical variables"></a>Creating dummies for categorical variables</h2><p>In situations where we have categorical variables (factors) but need to use them in analytical methods that require numbers (for example, K nearest neighbors (KNN), Linear Regression), we need to create dummy variables.</p>
<h3 id="Getting-ready-11"><a href="#Getting-ready-11" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Read the data-conversion.csv file and store it in the working directory of your R environment. Install the dummies package. Then read the data:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"dummies"</span>)</span><br><span class="line">&gt; <span class="keyword">library</span>(dummies)</span><br><span class="line">&gt; students &lt;- read.csv(<span class="string">"data-conversion.csv"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-11"><a href="#How-to-do-it…-11" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Create dummies for all factors in the data frame:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; students.new &lt;- dummy.data.frame(students, sep = <span class="string">"."</span>)</span><br><span class="line">&gt; names(students.new)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"Age"</span>      <span class="string">"State.NJ"</span> <span class="string">"State.NY"</span> <span class="string">"State.TX"</span> <span class="string">"State.VA"</span></span><br><span class="line">[<span class="number">6</span>] <span class="string">"Gender.F"</span> <span class="string">"Gender.M"</span> <span class="string">"Height"</span>   <span class="string">"Income"</span></span><br></pre></td></tr></table></figure>
<p>The students.new data frame now contains all the original variables and the newly added dummy variables. The dummy.data.frame() function has created dummy variables for all four levels of the State and two levels of Gender factors. However, we will generally omit one of the dummy variables for State and one for Gender when we use machine-learning techniques.</p>
<p>We can use the optional argument all = FALSE to specify that the resulting data frame should contain only the generated dummy variables and none of the original variables.</p>
<h3 id="How-it-works…-11"><a href="#How-it-works…-11" class="headerlink" title="How it works…"></a>How it works…</h3><p>The dummy.data.frame() function creates dummies for all the factors in the data frame supplied. Internally, it uses another dummy() function which creates dummy variables for a single factor. The dummy() function creates one new variable for every level of the factor for which we are creating dummies. It appends the variable name with the factor level name to generate names for the dummy variables. We can use the sep argument to specify the character that separates them—an empty string is the default:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; dummy(students$State, sep = <span class="string">"."</span>)</span><br><span class="line"></span><br><span class="line">      State.NJ State.NY State.TX State.VA</span><br><span class="line"> [<span class="number">1</span>,]        <span class="number">1</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span></span><br><span class="line"> [<span class="number">2</span>,]        <span class="number">0</span>        <span class="number">1</span>        <span class="number">0</span>        <span class="number">0</span></span><br><span class="line"> [<span class="number">3</span>,]        <span class="number">1</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span></span><br><span class="line"> [<span class="number">4</span>,]        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">1</span></span><br><span class="line"> [<span class="number">5</span>,]        <span class="number">0</span>        <span class="number">1</span>        <span class="number">0</span>        <span class="number">0</span></span><br><span class="line"> [<span class="number">6</span>,]        <span class="number">0</span>        <span class="number">0</span>        <span class="number">1</span>        <span class="number">0</span></span><br><span class="line"> [<span class="number">7</span>,]        <span class="number">1</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span></span><br><span class="line"> [<span class="number">8</span>,]        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">1</span></span><br><span class="line"> [<span class="number">9</span>,]        <span class="number">0</span>        <span class="number">0</span>        <span class="number">1</span>        <span class="number">0</span></span><br><span class="line">[<span class="number">10</span>,]        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="There’s-more…-10"><a href="#There’s-more…-10" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>In situations where a data frame has several factors, and you plan on using only a subset of these, you will create dummies only for the chosen subset.</p>
<h4 id="Choosing-which-variables-to-create-dummies-for"><a href="#Choosing-which-variables-to-create-dummies-for" class="headerlink" title="Choosing which variables to create dummies for"></a>Choosing which variables to create dummies for</h4><p>To create dummies only for one variable or a subset of variables, we can use the names argument to specify the column names of the variables we want dummies for:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; students.new1 &lt;- dummy.data.frame(students, names = c(<span class="string">"State"</span>,<span class="string">"Gender"</span>) , sep = <span class="string">"."</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Chapter-2-What’s-in-There-–-Exploratory-Data-Analysis"><a href="#Chapter-2-What’s-in-There-–-Exploratory-Data-Analysis" class="headerlink" title="Chapter 2. What’s in There? – Exploratory Data Analysis"></a>Chapter 2. What’s in There? – Exploratory Data Analysis</h1><p>In this chapter, you will cover:</p>
<ul>
<li>Creating standard data summaries</li>
<li>Extracting a subset of a dataset</li>
<li>Splitting a dataset</li>
<li>Creating random data partitions</li>
<li>Generating standard plots such as histograms, boxplots, and scatterplots</li>
<li>Generating multiple plots on a grid</li>
<li>Selecting a graphics device</li>
<li>Creating plots with the lattice package</li>
<li>Creating plots with the ggplot2 package</li>
<li>Creating charts that facilitate comparisons</li>
<li>Creating charts that help visualize a possible causality</li>
<li>Creating multivariate plots</li>
</ul>
<h2 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h2><p>Before getting around to applying some of the more advanced analytics and machine learning techniques, analysts face the challenge of becoming familiar with the large datasets that they often deal with. Increasingly, analysts rely on visualization techniques to tease apart hidden patterns. This chapter equips you with the necessary recipes to incisively explore large datasets.</p>
<h2 id="Creating-standard-data-summaries"><a href="#Creating-standard-data-summaries" class="headerlink" title="Creating standard data summaries"></a>Creating standard data summaries</h2><p>In this recipe we summarize the data using the summary function.</p>
<h3 id="Getting-ready-12"><a href="#Getting-ready-12" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and ensure that the auto-mpg.csv file is in your R working directory.</p>
<h3 id="How-to-do-it…-12"><a href="#How-to-do-it…-12" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Read the data from auto-mpg.csv, which includes a header row and columns separated by the default “,” symbol.</p>
<ol>
<li><p>Read the data from auto-mpg.csv and convert cylinders to factor:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto  &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, header = <span class="literal">TRUE</span>, stringsAsFactors = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; <span class="comment"># Convert cylinders to factor</span></span><br><span class="line">&gt; auto$cylinders &lt;- factor(auto$cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get the summary statistics:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">summary(auto)</span><br><span class="line"></span><br><span class="line">   No             mpg        cylinders   displacement</span><br><span class="line"> Min.   :  <span class="number">1.0</span>   Min.   : <span class="number">9.00</span>   3cyl:  <span class="number">4</span>   Min.   : <span class="number">68.0</span></span><br><span class="line">1st Qu.:<span class="number">100.2</span>   1st Qu.:<span class="number">17.50</span>   4cyl:<span class="number">204</span>   1st Qu.:<span class="number">104.2</span></span><br><span class="line">Median :<span class="number">199.5</span>   Median :<span class="number">23.00</span>   5cyl:  <span class="number">3</span>   Median :<span class="number">148.5</span></span><br><span class="line">Mean   :<span class="number">199.5</span>   Mean   :<span class="number">23.51</span>   6cyl: <span class="number">84</span>   Mean   :<span class="number">193.4</span></span><br><span class="line">3rd Qu.:<span class="number">298.8</span>   3rd Qu.:<span class="number">29.00</span>   8cyl:<span class="number">103</span>   3rd Qu.:<span class="number">262.0</span></span><br><span class="line">Max.   :<span class="number">398.0</span>   Max.   :<span class="number">46.60</span>              Max.   :<span class="number">455.0</span></span><br><span class="line">horsepower        weight      acceleration     model_year</span><br><span class="line">Min.   : <span class="number">46.0</span>   Min.   :<span class="number">1613</span>   Min.   : <span class="number">8.00</span>   Min.   :<span class="number">70.00</span></span><br><span class="line">1st Qu.: <span class="number">76.0</span>   1st Qu.:<span class="number">2224</span>   1st Qu.:<span class="number">13.82</span>   1st Qu.:<span class="number">73.00</span></span><br><span class="line">Median : <span class="number">92.0</span>   Median :<span class="number">2804</span>   Median :<span class="number">15.50</span>   Median :<span class="number">76.00</span></span><br><span class="line">Mean   :<span class="number">104.1</span>   Mean   :<span class="number">2970</span>   Mean   :<span class="number">15.57</span>   Mean   :<span class="number">76.01</span></span><br><span class="line">3rd Qu.:<span class="number">125.0</span>   3rd Qu.:<span class="number">3608</span>   3rd Qu.:<span class="number">17.18</span>   3rd Qu.:<span class="number">79.00</span></span><br><span class="line">Max.   :<span class="number">230.0</span>   Max.   :<span class="number">5140</span>   Max.   :<span class="number">24.80</span>   Max.   :<span class="number">82.00</span></span><br><span class="line">car_name</span><br><span class="line">Length:<span class="number">398</span></span><br><span class="line">Class :character</span><br><span class="line">Mode  :character</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-12"><a href="#How-it-works…-12" class="headerlink" title="How it works…"></a>How it works…</h3><p>The summary() function gives a “six number” summary for numerical variables—minimum, first quartile, median, mean, third quartile, and maximum. For factors (or categorical variables), the function shows the counts for each level; for character variables, it just shows the total number of available values.</p>
<h3 id="There’s-more…-11"><a href="#There’s-more…-11" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>R offers several functions to take a quick peek at data, and we discuss a few of those in this section.</p>
<p>Using the str() function for an overview of a data frame</p>
<p>The str() function gives a concise view into a data frame. In fact, we can use it to see the underlying structure of any arbitrary R object. The following commands and results show that the str() function tells us the type of object whose structure we seek. It also tells us about the type of each of its component objects along with an extract of some values. It can be very useful for getting an overview of a data frame:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; str(auto)</span><br><span class="line"></span><br><span class="line"><span class="string">'data.frame'</span>: <span class="number">398</span> obs. of  <span class="number">9</span> variables:</span><br><span class="line">   $ No          : int  <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span> <span class="keyword">...</span></span><br><span class="line">   $ mpg         : num  <span class="number">28</span> <span class="number">19</span> <span class="number">36</span> <span class="number">28</span> <span class="number">21</span> <span class="number">23</span> <span class="number">15.5</span> <span class="number">32.9</span> <span class="number">16</span> <span class="number">13</span> <span class="keyword">...</span></span><br><span class="line">   $ cylinders   : Factor w/ <span class="number">5</span> levels <span class="string">"3cyl"</span>,<span class="string">"4cyl"</span>,..: <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">5</span> <span class="number">2</span> <span class="number">4</span> <span class="number">5</span> <span class="keyword">...</span></span><br><span class="line">   $ displacement: num  <span class="number">140</span> <span class="number">70</span> <span class="number">107</span> <span class="number">97</span> <span class="number">199</span> <span class="number">115</span> <span class="number">304</span> <span class="number">119</span> <span class="number">250</span> <span class="number">318</span> <span class="keyword">...</span></span><br><span class="line">   $ horsepower  : int  <span class="number">90</span> <span class="number">97</span> <span class="number">75</span> <span class="number">92</span> <span class="number">90</span> <span class="number">95</span> <span class="number">120</span> <span class="number">100</span> <span class="number">105</span> <span class="number">150</span> <span class="keyword">...</span></span><br><span class="line">   $ weight      : int  <span class="number">2264</span> <span class="number">2330</span> <span class="number">2205</span> <span class="number">2288</span> <span class="number">2648</span> <span class="number">2694</span> <span class="number">3962</span> <span class="number">2615</span> <span class="number">3897</span> <span class="number">3755</span> <span class="keyword">...</span></span><br><span class="line">   $ acceleration: num  <span class="number">15.5</span> <span class="number">13.5</span> <span class="number">14.5</span> <span class="number">17</span> <span class="number">15</span> <span class="number">15</span> <span class="number">13.9</span> <span class="number">14.8</span> <span class="number">18.5</span> <span class="number">14</span> <span class="keyword">...</span></span><br><span class="line">   $ model_year  : int  <span class="number">71</span> <span class="number">72</span> <span class="number">82</span> <span class="number">72</span> <span class="number">70</span> <span class="number">75</span> <span class="number">76</span> <span class="number">81</span> <span class="number">75</span> <span class="number">76</span> <span class="keyword">...</span></span><br><span class="line">   $ car_name    : chr  <span class="string">"chevrolet vega 2300"</span> <span class="string">"mazda rx2 coupe"</span> <span class="string">"honda accord"</span> <span class="string">"datsun 510 (sw)"</span> ..</span><br></pre></td></tr></table></figure>
<h4 id="Computing-the-summary-for-a-single-variable"><a href="#Computing-the-summary-for-a-single-variable" class="headerlink" title="Computing the summary for a single variable"></a>Computing the summary for a single variable</h4><p>When factor summaries are combined with those for numerical variables (as in the earlier example), summary() gives counts for a maximum of six levels and lumps the other counts under the Other.</p>
<p>You can invoke the summary() function for a single variable as well. In this case, the summary you get for numerical variables remains as before, but for factors, you get counts for many more levels:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; summary(auto$cylinders)</span><br><span class="line">&gt; summary(auto$mpg)</span><br></pre></td></tr></table></figure>
<h4 id="Finding-the-mean-and-standard-deviation"><a href="#Finding-the-mean-and-standard-deviation" class="headerlink" title="Finding the mean and standard deviation"></a>Finding the mean and standard deviation</h4><p>Use the functions mean() and sd() as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; mean(auto$mpg)</span><br><span class="line">&gt; sd(auto$mpg)</span><br></pre></td></tr></table></figure>
<h2 id="Extracting-a-subset-of-a-dataset"><a href="#Extracting-a-subset-of-a-dataset" class="headerlink" title="Extracting a subset of a dataset"></a>Extracting a subset of a dataset</h2><p>In this recipe, we discuss two ways to subset data. The first approach uses the row and column indices/names, and the other uses the subset() function.</p>
<h3 id="Getting-ready-13"><a href="#Getting-ready-13" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the auto-mpg.csv file in your R working directory. Read the data using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
<p>The same subsetting principles apply for vectors, lists, arrays, matrices, and data frames. We illustrate with data frames.</p>
<h3 id="How-to-do-it…-13"><a href="#How-to-do-it…-13" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>The following steps extract a subset of a dataset:</p>
<ol>
<li><p>Index by position. Get <code>model_year</code> and <code>car_name</code> for the first three cars:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[<span class="number">1</span>:<span class="number">3</span>, <span class="number">8</span>:<span class="number">9</span>]</span><br><span class="line">&gt; auto[<span class="number">1</span>:<span class="number">3</span>, c(<span class="number">8</span>,<span class="number">9</span>)]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Index by name. Get <code>model_year</code> and <code>car_name</code> for the first three cars:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[<span class="number">1</span>:<span class="number">3</span>,c(<span class="string">"model_year"</span>, <span class="string">"car_name"</span>)]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Retrieve all details for cars with the highest or lowest mpg, using the following code:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[auto$mpg == max(auto$mpg) | auto$mpg == min(auto$mpg),]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get mpg and car_name for all cars with mpg &gt; 30 and cylinders == 6:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[auto$mpg&gt;<span class="number">30</span> &amp; auto$cylinders==<span class="number">6</span>, c(<span class="string">"car_name"</span>,<span class="string">"mpg"</span>)]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get mpg and car_name for all cars with mpg &gt; 30 and cylinders == 6 using partial name match for cylinders:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[auto$mpg &gt;<span class="number">30</span> &amp; auto$cyl==<span class="number">6</span>, c(<span class="string">"car_name"</span>,<span class="string">"mpg"</span>)]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Using the subset() function, get mpg and car_name for all cars with mpg &gt; 30 and cylinders == 6:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; subset(auto, mpg &gt; <span class="number">30</span> &amp; cylinders == <span class="number">6</span>, select=c(<span class="string">"car_name"</span>,<span class="string">"mpg"</span>))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-13"><a href="#How-it-works…-13" class="headerlink" title="How it works…"></a>How it works…</h3><p>The first index in auto[1:3, 8:9] denotes the rows, and the second denotes the columns or variables. Instead of the column positions, we can also use the variable names. If using the variable names, enclose them in “…”.</p>
<p>If the required rows and columns are not contiguous, use a vector to indicate the needed rows and columns as in auto[c(1,3), c(3,5,7)].</p>
<p><strong>Tip</strong></p>
<p>Use column names instead of column positions, as column positions may change in the data file.</p>
<p>R uses the logical operators &amp; (and), | (or), ! (negative unary), and == (equality check).</p>
<p>The subset function returns all variables (columns) if you omit the select argument. Thus, subset(auto, mpg &gt; 30 &amp; cylinders == 6) retrieves all the cases that match the conditions mpg &gt; 30 and cylinders = 6.</p>
<p>However, while using the indices in a logical expression to select rows of a data frame, you always need to specify the variables needed or indicate all variables with a comma following the logical expression:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># incorrect</span></span><br><span class="line">&gt; auto[auto$mpg &gt; <span class="number">30</span>]</span><br><span class="line">Error <span class="keyword">in</span> `[.data.frame`(auto, auto$mpg &gt; <span class="number">30</span>) : undefined columns selected</span><br><span class="line">&gt;</span><br><span class="line">&gt; <span class="comment"># correct</span></span><br><span class="line">&gt; auto[auto$mpg &gt; <span class="number">30</span>, ]</span><br></pre></td></tr></table></figure>
<p><strong>Tip</strong></p>
<p>If we select a single variable, then subsetting returns a vector instead of a data frame.</p>
<h3 id="There’s-more…-12"><a href="#There’s-more…-12" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We mostly use the indices by name and position to subset data. Hence, we provide some additional details around using indices to subset data. The subset() function is used predominantly in cases when we need to repeatedly apply the subset operation for a set of array, list, or vector elements.</p>
<h4 id="Excluding-columns"><a href="#Excluding-columns" class="headerlink" title="Excluding columns"></a>Excluding columns</h4><p>Use the minus sign for variable positions that you want to exclude from the subset. Also, you cannot mix both positive and negative indexes in the list. Both of the following approaches are correct:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[,c(-<span class="number">1</span>,-<span class="number">9</span>)]</span><br><span class="line">&gt; auto[,-c(<span class="number">1</span>,<span class="number">9</span>)]</span><br></pre></td></tr></table></figure>
<p>However, this subsetting approach does not work while specifying variables using names. For example, we cannot use –c(“No”, “car_name”). Instead, use %in% with ! (negation) to exclude variables:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[, !names(auto) %<span class="keyword">in</span>% c(<span class="string">"No"</span>, <span class="string">"car_name"</span>)]</span><br></pre></td></tr></table></figure>
<h4 id="Selecting-based-on-multiple-values"><a href="#Selecting-based-on-multiple-values" class="headerlink" title="Selecting based on multiple values"></a>Selecting based on multiple values</h4><p>Select all cars with mpg = 15 or mpg = 20:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[auto$mpg %<span class="keyword">in</span>% c(<span class="number">15</span>,<span class="number">20</span>),c(<span class="string">"car_name"</span>,<span class="string">"mpg"</span>)]</span><br></pre></td></tr></table></figure>
<h4 id="Selecting-using-logical-vector"><a href="#Selecting-using-logical-vector" class="headerlink" title="Selecting using logical vector"></a>Selecting using logical vector</h4><p>You can specify the cases (rows) and variables you want to retrieve using boolean vectors.</p>
<p>In the following example, R returns the first and second cases, and for each, we get the third variable alone. R returns the elements corresponding to TRUE:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto[<span class="number">1</span>:<span class="number">2</span>,c(<span class="literal">FALSE</span>,<span class="literal">FALSE</span>,<span class="literal">TRUE</span>)]</span><br></pre></td></tr></table></figure>
<p>You can use the same approach for rows also.</p>
<p>If the lengths do not match, R recycles through the boolean vector. However, it is always a good practice to match the size.</p>
<h2 id="Splitting-a-dataset"><a href="#Splitting-a-dataset" class="headerlink" title="Splitting a dataset"></a>Splitting a dataset</h2><p>When we have categorical variables, we often want to create groups corresponding to each level and to analyze each group separately to reveal some significant similarities and differences between groups.</p>
<p>The split function divides data into groups based on a factor or vector. The unsplit() function reverses the effect of split.</p>
<h3 id="Getting-ready-14"><a href="#Getting-ready-14" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the auto-mpg.csv file in your R working directory. Read the file using the read.csv command and save in the auto variable:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-14"><a href="#How-to-do-it…-14" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Split cylinders using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; carslist &lt;- split(auto, auto$cylinders)</span><br></pre></td></tr></table></figure>
<h3 id="How-it-works…-14"><a href="#How-it-works…-14" class="headerlink" title="How it works…"></a>How it works…</h3><p>The split(auto, auto$cylinders) function returns a list of data frames with each data frame corresponding to the cases for a particular level of cylinders. To reference a data frame from the list, use the [ notation. Here, carslist[1] is a list of length 1 consisting of the first data frame that corresponds to three cylinder cars, and carslist[[1]] is the associated data frame for three cylinder cars.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; str(carslist[<span class="number">1</span>])</span><br><span class="line">List of <span class="number">1</span></span><br><span class="line"> $ <span class="number">3</span>:<span class="string">'data.frame'</span>: <span class="number">4</span> obs. of  <span class="number">9</span> variables:</span><br><span class="line">   ..$ No          : int [<span class="number">1</span>:<span class="number">4</span>] <span class="number">2</span> <span class="number">199</span> <span class="number">251</span> <span class="number">365</span></span><br><span class="line">   ..$ mpg         : num [<span class="number">1</span>:<span class="number">4</span>] <span class="number">19</span> <span class="number">18</span> <span class="number">23.7</span> <span class="number">21.5</span></span><br><span class="line">   ..$ cylinders   : int [<span class="number">1</span>:<span class="number">4</span>] <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span></span><br><span class="line">   ..$ displacement: num [<span class="number">1</span>:<span class="number">4</span>] <span class="number">70</span> <span class="number">70</span> <span class="number">70</span> <span class="number">80</span></span><br><span class="line">   ..$ horsepower  : int [<span class="number">1</span>:<span class="number">4</span>] <span class="number">97</span> <span class="number">90</span> <span class="number">100</span> <span class="number">110</span></span><br><span class="line">   ..$ weight      : int [<span class="number">1</span>:<span class="number">4</span>] <span class="number">2330</span> <span class="number">2124</span> <span class="number">2420</span> <span class="number">2720</span></span><br><span class="line">   ..$ acceleration: num [<span class="number">1</span>:<span class="number">4</span>] <span class="number">13.5</span> <span class="number">13.5</span> <span class="number">12.5</span> <span class="number">13.5</span></span><br><span class="line">   ..$ model_year  : int [<span class="number">1</span>:<span class="number">4</span>] <span class="number">72</span> <span class="number">73</span> <span class="number">80</span> <span class="number">77</span></span><br><span class="line">   ..$ car_name    : chr [<span class="number">1</span>:<span class="number">4</span>] <span class="string">"mazda rx2 coupe"</span> <span class="string">"maxda rx3"</span> <span class="string">"mazda rx-7 gs"</span> <span class="string">"mazda rx-4"</span></span><br><span class="line"></span><br><span class="line">&gt; names(carslist[[<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"No"</span>           <span class="string">"mpg"</span>          <span class="string">"cylinders"</span>    <span class="string">"displacement"</span></span><br><span class="line">[<span class="number">5</span>] <span class="string">"horsepower"</span>   <span class="string">"weight"</span>       <span class="string">"acceleration"</span> <span class="string">"model_year"</span></span><br><span class="line">[<span class="number">9</span>] <span class="string">"car_name"</span></span><br></pre></td></tr></table></figure>
<h2 id="Creating-random-data-partitions"><a href="#Creating-random-data-partitions" class="headerlink" title="Creating random data partitions"></a>Creating random data partitions</h2><p>Analysts need an unbiased evaluation of the quality of their machine learning models. To get this, they partition the available data into two parts. They use one part to build the machine learning model and retain the remaining data as “hold out” data. After building the model, they evaluate the model’s performance on the hold out data. This recipe shows you how to partition data. It separately addresses the situation when the target variable is numeric and when it is categorical. It also covers the process of creating two partitions or three.</p>
<h3 id="Getting-ready-15"><a href="#Getting-ready-15" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, make sure that the BostonHousing.csv and boston-housing-classification.csv files from the code files of this chapter are in your R working directory. You should also install the caret package using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"caret"</span>)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br><span class="line">&gt; bh &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-15"><a href="#How-to-do-it…-15" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>You may want to develop a model using some machine learning technique (like linear regression or KNN) to predict the value of the median of a home in Boston neighborhoods using the data in the BostonHousing.csv file. The MEDV variable will serve as the target variable.</p>
<h4 id="Case-1-–-numerical-target-variable-and-two-partitions"><a href="#Case-1-–-numerical-target-variable-and-two-partitions" class="headerlink" title="Case 1 – numerical target variable and two partitions"></a>Case 1 – numerical target variable and two partitions</h4><p>To create a training partition with 80 percent of the cases and a validation partition with the rest, use the following code:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; trg.idx &lt;- createDataPartition(bh$MEDV, p = <span class="number">0.8</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; trg.part &lt;- bh[trg.idx, ]</span><br><span class="line">&gt; val.part &lt;- bh[-trg.idx, ]</span><br></pre></td></tr></table></figure>
<p>After this, the trg.part and val.part variables contain the training and validation partitions, respectively.</p>
<h4 id="Case-2-–-numerical-target-variable-and-three-partitions"><a href="#Case-2-–-numerical-target-variable-and-three-partitions" class="headerlink" title="Case 2 – numerical target variable and three partitions"></a>Case 2 – numerical target variable and three partitions</h4><p>Some machine learning techniques require three partitions because they use two partitions just for building the model. Therefore, a third (test) partition contains the “hold-out” data for model evaluation.</p>
<p>Suppose we want a training partition with 70 percent of the cases, and the rest divided equally among validation and test partitions, use the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; trg.idx &lt;- createDataPartition(bh$MEDV, p = <span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; trg.part &lt;- bh[trg.idx, ]</span><br><span class="line">&gt; temp &lt;- bh[-trg.idx, ]</span><br><span class="line">&gt; val.idx &lt;- createDataPartition(temp$MEDV, p = <span class="number">0.5</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; val.part &lt;- temp[val.idx, ]</span><br><span class="line">&gt; test.part &lt;- temp[-val.idx, ]</span><br></pre></td></tr></table></figure>
<p>Case 3 – categorical target variable and two partitions</p>
<p>Instead of a model to predict a numerical value like MEDV, you may need to create partitions for a classification application. The boston-housing-classification.csv file has a MEDV_CAT variable that categorizes the median values into HIGH or LOW and is suitable for a classification algorithm.</p>
<p>For a 70–30 split use the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh2 &lt;- read.csv(<span class="string">"boston-housing-classification.csv"</span>)</span><br><span class="line">&gt; trg.idx &lt;- createDataPartition(bh2$MEDV_CAT, p=<span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; trg.part &lt;- bh2[trg.idx, ]</span><br><span class="line">&gt; val.part &lt;- bh2[-trg.idx, ]</span><br></pre></td></tr></table></figure>
<h4 id="Case-4-–-categorical-target-variable-and-three-partitions"><a href="#Case-4-–-categorical-target-variable-and-three-partitions" class="headerlink" title="Case 4 – categorical target variable and three partitions"></a>Case 4 – categorical target variable and three partitions</h4><p>For a 70–15–15 split (training, validation, test) use the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh3 &lt;- read.csv(<span class="string">"boston-housing-classification.csv"</span>)</span><br><span class="line">&gt; trg.idx &lt;- createDataPartition(bh3$MEDV_CAT, p=<span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; trg.part &lt;- bh3[trg.idx, ]</span><br><span class="line">&gt; temp &lt;- bh3[-trg.idx, ]</span><br><span class="line">&gt; val.idx &lt;- createDataPartition(temp$MEDV_CAT, p=<span class="number">0.5</span>,list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; val.part &lt;- temp[val.idx, ]</span><br><span class="line">&gt; test.part &lt;- temp[-val.idx, ]</span><br></pre></td></tr></table></figure>
<h3 id="How-it-works…-15"><a href="#How-it-works…-15" class="headerlink" title="How it works…"></a>How it works…</h3><p>The createDataPartition() function randomly selects row indices from the array supplied as its first argument. Rather than selecting randomly from the entire data frame, it does a more intelligent sampling as we now describe.</p>
<p>If supplied with a numeric vector as the first argument, then createDataPartition() applies the random selection process by percentile groups so as to get a good sampling of rows from the entire range of the target variable. This avoids the situation that can result from a completely random sampling whereby the training partition does not have a good representation from some segments of the target variable’s whole range. By default, it considers five groups, but we can control this through the optional groups argument.</p>
<p>If supplied with a vector of factors, the function randomly samples for each value of the factor from the cases, thereby ensuring a good representation of all factor values in the training partition.</p>
<p>The list argument controls whether we want the output as a list or as a vector.</p>
<p>To avoid keeping duplicate data in both the original data frame as well as in the two data partitions, you can work with just the indices generated and refer to bh[trg.idx,] for the training partition and bh[-trg.idx,] for the validation partition.</p>
<p>When you have large data files, repeated subsetting may be inefficient and you may want to copy the data into the partitions up front.</p>
<h3 id="There’s-more…-13"><a href="#There’s-more…-13" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We discuss some additional information on data partitioning in this section.</p>
<h4 id="Using-a-convenience-function-for-partitioning"><a href="#Using-a-convenience-function-for-partitioning" class="headerlink" title="Using a convenience function for partitioning"></a>Using a convenience function for partitioning</h4><p>Rather than typing out the detailed steps each time, you can simplify the process by creating the following functions:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rda.cb.partition2 &lt;- <span class="keyword">function</span>(ds, target.index, prob) &#123;</span><br><span class="line">  <span class="keyword">library</span>(caret)</span><br><span class="line">  train.idx &lt;- createDataPartition(y=ds[,target.index], p = prob, list = <span class="literal">FALSE</span>)</span><br><span class="line">  list(train =  ds[train.idx, ], val = ds[-train.idx, ])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rda.cb.partition3 &lt;- <span class="keyword">function</span>(ds,</span><br><span class="line">             target.index, prob.train, prob.val) &#123;</span><br><span class="line">  <span class="keyword">library</span>(caret)</span><br><span class="line">  train.idx &lt;- createDataPartition(y=ds[,target.index],</span><br><span class="line">          p = prob.train, list = <span class="literal">FALSE</span>)</span><br><span class="line">  train &lt;- ds[train.idx, ]</span><br><span class="line">  temp &lt;- ds[-train.idx, ]</span><br><span class="line">  val.idx &lt;- createDataPartition(y=temp[,target.index],</span><br><span class="line">          p = prob.val/(<span class="number">1</span>-prob.train), list = <span class="literal">FALSE</span>)</span><br><span class="line">  list(train =  ds[train.idx, ],</span><br><span class="line">          val = temp[val.idx, ], test = temp[-val.idx, ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With the two preceding functions in place, you can write the following single line to create two partitions (80 percent, 20 percent) of a data frame:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dat1 &lt;- rda.cb.partition2(bh, <span class="number">14</span>, <span class="number">0.8</span>)</span><br></pre></td></tr></table></figure>
<p>You can do the following to get three partitions (70 percent, 15 percent, 15 percent):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dat2 &lt;- rda.cb.partition3(bh, <span class="number">14</span>, <span class="number">0.7</span>, <span class="number">0.15</span>)</span><br></pre></td></tr></table></figure>
<p>The <code>rda.cb.partition2()</code> and <code>rda.cb.partition3()</code> functions return a list with two and three components, respectively. To use the training and validation partitions from dat1, you can refer to dat1$train and dat1$val. The same applies to dat2; to get the test partition from dat2, use dat2$test.</p>
<h3 id="Sampling-from-a-set-of-values"><a href="#Sampling-from-a-set-of-values" class="headerlink" title="Sampling from a set of values"></a>Sampling from a set of values</h3><p>To select a random sample of size 50 cases from a bh data frame without replacement, use the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sam.idx &lt;- sample(<span class="number">1</span>:nrow(bh), <span class="number">50</span>, replace = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Generating-standard-plots-such-as-histograms-boxplots-and-scatterplots"><a href="#Generating-standard-plots-such-as-histograms-boxplots-and-scatterplots" class="headerlink" title="Generating standard plots such as histograms, boxplots, and scatterplots"></a>Generating standard plots such as histograms, boxplots, and scatterplots</h2><p>Before even embarking on any numerical analyses, you may want to get a good idea about the data through a few quick plots. Although the base R system supports powerful graphics, we will generally turn to other plotting options like lattice and ggplot for more advanced plots. Therefore, we cover only the simplest forms of basic graphs.</p>
<h3 id="Getting-ready-16"><a href="#Getting-ready-16" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the data files for this chapter and ensure that they are available in your R environment’s working directory and run the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br><span class="line">&gt;</span><br><span class="line">&gt; auto$cylinders &lt;- factor(auto$cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br><span class="line">&gt; <span class="keyword">attach</span>(auto)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-16"><a href="#How-to-do-it…-16" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>In this recipe, we cover histograms, boxplots, scatterplots and scatterplot matrices.</p>
<h4 id="Histograms"><a href="#Histograms" class="headerlink" title="Histograms"></a>Histograms</h4><p>Generate a histogram for acceleration:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; hist(acceleration)</span><br></pre></td></tr></table></figure>
<p>R determines the various properties of the generated graph (like bin sizes, axes scales, axes titles, chart title, bar colors,…) automatically. The following diagram shows the output of the preceding command:</p>
<p><img src="img/2_6_1.jpeg" alt=""></p>
<p>You can customize everything. The following code shows some options:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; hist(acceleration, col=<span class="string">"blue"</span>, xlab = <span class="string">"acceleration"</span>, main = <span class="string">"Histogram of acceleration"</span>, breaks = <span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<p>The histogram of acceleration can be seen in the following diagram:</p>
<p><img src="img/2_6_2.jpeg" alt=""></p>
<h4 id="Boxplots"><a href="#Boxplots" class="headerlink" title="Boxplots"></a>Boxplots</h4><p>Create a boxplot for mpg using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; boxplot(mpg, xlab = <span class="string">"Miles per gallon"</span>)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_6_3.jpeg" alt=""></p>
<p>To generate boxplots for subsets within the whole dataset, you can use:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; boxplot(mpg ~ model_year, xlab = <span class="string">"Miles per gallon"</span>)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_6_4.jpeg" alt=""></p>
<p>Create a boxplot of mpg by cylinders:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; boxplot(mpg ~ cylinders)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_6_5.jpeg" alt=""></p>
<h4 id="Scatterplots"><a href="#Scatterplots" class="headerlink" title="Scatterplots"></a>Scatterplots</h4><p>Create a scatterplot for mpg by horsepower:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(mpg ~ horsepower)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_6_6.jpeg" alt=""></p>
<h4 id="Scatterplot-matrices"><a href="#Scatterplot-matrices" class="headerlink" title="Scatterplot matrices"></a>Scatterplot matrices</h4><p>Create pair wise scatterplots for a set of variables:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pairs(~mpg+displacement+horsepower+weight)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_6_7.jpeg" alt=""></p>
<h3 id="How-it-works…-16"><a href="#How-it-works…-16" class="headerlink" title="How it works…"></a>How it works…</h3><p>Here, we describe how the preceding lines of code work.</p>
<h4 id="Histograms-1"><a href="#Histograms-1" class="headerlink" title="Histograms"></a>Histograms</h4><p>By default, the hist() function automatically determines the number of bars to display based on the data. The breaks argument controls this.</p>
<p>You can also use a palette of colors instead of a single color using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; hist(mpg, col = rainbow(<span class="number">12</span>))</span><br></pre></td></tr></table></figure>
<p><img src="img/2_6_8.jpeg" alt=""></p>
<p>The rainbow() function returns a color palette with the color spectrum broken up into the number of distinct colors specified, and the hist() function uses one color for each bar.</p>
<h4 id="Boxplots-1"><a href="#Boxplots-1" class="headerlink" title="Boxplots"></a>Boxplots</h4><p>You can either give a simple vector or a formula (like auto$mpg ~ auto$cylinders in the preceding example) as the first argument to the boxplot() function. In the latter case, it creates separate boxplots for every distinct level of the right-hand side variable.</p>
<h3 id="There’s-more…-14"><a href="#There’s-more…-14" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>You can overlay plots and color specific points differently. We show some useful options in this section.</p>
<h4 id="Overlay-a-density-plot-on-a-histogram"><a href="#Overlay-a-density-plot-on-a-histogram" class="headerlink" title="Overlay a density plot on a histogram"></a>Overlay a density plot on a histogram</h4><p>Histograms are very sensitive to the number of bins used. Kernel density plots give a smoother and more accurate picture of the distribution. Usually, we overlay a density plot on a histogram using the density() function which creates the density plot.</p>
<p>If invoked by itself, the density() function only produces the density plot. To overlay it on the histogram, we use the lines() function which does not erase the current chart and instead overlays the existing plot. Since the density plot plots relative frequencies (approximating a probability density function), we need to ensure that the histogram also shows relative frequencies. The prob=TRUE argument achieves this:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hist(mpg, prob=<span class="literal">TRUE</span>)</span><br><span class="line">lines(density(mpg))</span><br></pre></td></tr></table></figure>
<p><img src="img/2_6_9.jpeg" alt=""></p>
<h4 id="Overlay-a-regression-line-on-a-scatterplot"><a href="#Overlay-a-regression-line-on-a-scatterplot" class="headerlink" title="Overlay a regression line on a scatterplot"></a>Overlay a regression line on a scatterplot</h4><p>The following code first generates the scatterplot. It then builds the regression model using lm and uses the abline() function to overlay the regression line on the existing scatterplot:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(mpg ~ horsepower)</span><br><span class="line">&gt; reg &lt;- lm(mpg ~ horsepower)</span><br><span class="line">&gt; abline(reg)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_6_10.jpeg" alt=""></p>
<h4 id="Color-specific-points-on-a-scatterplot"><a href="#Color-specific-points-on-a-scatterplot" class="headerlink" title="Color specific points on a scatterplot"></a>Color specific points on a scatterplot</h4><p>Using the following code, you can first generate the scatterplot and then color the points corresponding to different values of cylinders with different colors. Note that mpg and weight are in different orders in the plot and points function invocations. This is because in plot, we ask the system to plot mpg as a function of weight, whereas in the points function, we just supply a set of (x,y) coordinates to plot:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># first generate the empty plot</span></span><br><span class="line">&gt; <span class="comment"># to get the axes for the whole dat</span></span><br><span class="line">&gt; plot(mpg ~ horsepower, type = <span class="string">"n"</span>)</span><br><span class="line">&gt; <span class="comment"># Then plot the points in different colors</span></span><br><span class="line">&gt; with(subset(auto, cylinders == <span class="string">"8cyl"</span>), points(horsepower, mpg, col = <span class="string">"blue"</span>))</span><br><span class="line">&gt; with(subset(auto, cylinders == <span class="string">"6cyl"</span>), points(horsepower, mpg, col = <span class="string">"red"</span>))</span><br><span class="line">&gt; with(subset(auto, cylinders == <span class="string">"5cyl"</span>), points(horsepower, mpg, col = <span class="string">"yellow"</span>))</span><br><span class="line">&gt; with(subset(auto, cylinders == <span class="string">"4cyl"</span>), points(horsepower, mpg, col = <span class="string">"green"</span>))</span><br><span class="line">&gt; with(subset(auto, cylinders == <span class="string">"3cyl"</span>), points(horsepower, mpg))</span><br></pre></td></tr></table></figure>
<p>The preceding commands produce the following output:</p>
<p><img src="img/2_6_11.jpeg" alt=""></p>
<h2 id="Generating-multiple-plots-on-a-grid"><a href="#Generating-multiple-plots-on-a-grid" class="headerlink" title="Generating multiple plots on a grid"></a>Generating multiple plots on a grid</h2><p>We often want to see plots side by side for comparisons. This recipe shows how we can achieve this.</p>
<h3 id="Getting-ready-17"><a href="#Getting-ready-17" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the data files for this chapter and ensure that they are available in your R environment’s working directory. Once this is done, run the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br><span class="line">&gt; cylinders &lt;- factor(cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br><span class="line">&gt; <span class="keyword">attach</span>(auto)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-17"><a href="#How-to-do-it…-17" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>You may want to generate two side-by-side scatterplots from the data in auto-mpg.csv. Run the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># first get old graphical parameter settings</span></span><br><span class="line">&gt; old.par = par()</span><br><span class="line">&gt; <span class="comment"># create a grid of one row and two columns</span></span><br><span class="line">&gt; par(mfrow = c(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line">&gt; with(auto, &#123;</span><br><span class="line">   plot(mpg ~ weight, main = <span class="string">"Weight vs. mpg"</span>)</span><br><span class="line">   plot(mpg ~ acceleration, main = <span class="string">"Acceleration vs. mpg"</span>)</span><br><span class="line">  &#125;</span><br><span class="line"> )</span><br><span class="line">&gt; <span class="comment"># reset par back to old value so that subsequent</span></span><br><span class="line">&gt; <span class="comment"># graphic operations are unaffected by our settings</span></span><br><span class="line">&gt; par(old.par)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_7_1.jpeg" alt=""></p>
<h3 id="How-it-works…-17"><a href="#How-it-works…-17" class="headerlink" title="How it works…"></a>How it works…</h3><p>The par(mfrow = c(1,2)) function call creates a grid with one row and two columns. The subsequent invocations of the plot() function fills the charts into these grid locations row by row. Alternately, you can specify par(mfcol = …) to specify the grid. In this case, the grid is created as in the case of mfrow, but the grid cells get filled in column by column.</p>
<h4 id="Graphics-parameters"><a href="#Graphics-parameters" class="headerlink" title="Graphics parameters"></a>Graphics parameters</h4><p>In addition to creating a grid for graphics, you can use the par() function to specify numerous graphics parameters to control all aspects. Check the documentation if you need something specific.</p>
<h3 id="See-also…-2"><a href="#See-also…-2" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Generating standard plots such as histograms, boxplots and scatterplots</li>
</ul>
<h2 id="Selecting-a-graphics-device"><a href="#Selecting-a-graphics-device" class="headerlink" title="Selecting a graphics device"></a>Selecting a graphics device</h2><p>R can send its output to several different graphic devices to display graphics in different formats. By default, R prints to the screen. However, we can save graphs in the following file formats as well: PostScript, PDF, PNG, JPEG, Windows metafile, Windows BMP, and so on.</p>
<h3 id="Getting-ready-18"><a href="#Getting-ready-18" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the data files for this chapter and ensure that the auto-mpg.csv file is available in your R environment’s working directory and run the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br><span class="line">&gt;</span><br><span class="line">&gt; cylinders &lt;- factor(cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br><span class="line">&gt; <span class="keyword">attach</span>(auto)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-18"><a href="#How-to-do-it…-18" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To send the graphic output to the computer screen, you have to do nothing special. For other devices, you first open the device, send your graphical output to it, and then close the device to close the corresponding file.</p>
<p>To create a PostScript file use:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; postscript(file = <span class="string">"auto-scatter.ps"</span>)</span><br><span class="line">&gt; boxplot(mpg)</span><br><span class="line">&gt; dev.off()</span><br><span class="line"></span><br><span class="line">&gt; pdf(file = <span class="string">"auto-scatter.pdf"</span>)</span><br><span class="line">&gt; boxplot(mpg)</span><br><span class="line">&gt; dev.off()</span><br></pre></td></tr></table></figure>
<h3 id="How-it-works…-18"><a href="#How-it-works…-18" class="headerlink" title="How it works…"></a>How it works…</h3><p>Invoking the function appropriate for the graphics device (like postscript() and pdf()) opens the file for output. The actual plotting operation writes to the device (file), and the dev.off() function closes the device (file).</p>
<h3 id="See-also…-3"><a href="#See-also…-3" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Generating standard plots such as histograms, boxplots and scatterplots</li>
</ul>
<h2 id="Creating-plots-with-the-lattice-package"><a href="#Creating-plots-with-the-lattice-package" class="headerlink" title="Creating plots with the lattice package"></a>Creating plots with the lattice package</h2><p>The lattice package produces Trellis plots to capture multivariate relationships in the data. Lattice plots are useful for looking at complex relationships between variables in a dataset. For example, we may want to see how y changes with x across various levels of z. Using the lattice package, we can draw histograms, boxplots, scatterplots, dot plots and so on. Both plotting and annotation are done in one single call.</p>
<h3 id="Getting-ready-19"><a href="#Getting-ready-19" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the auto-mpg.csv file in your R working directory. Read the file using the read.csv function and save in the auto variable. Convert cylinders into a factor variable:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; cyl.factor &lt;- factor(auto$cylinders,labels=c(<span class="string">"3cyl"</span>,<span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>,<span class="string">"6cyl"</span>,<span class="string">"8cyl"</span>))</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-19"><a href="#How-to-do-it…-19" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To create plots with lattice package, follow these steps:</p>
<ol>
<li><p>Load the lattice package:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(lattice)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Draw a boxplot:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bwplot(~auto$mpg|cyl.factor, main=<span class="string">"MPG by Number of Cylinders"</span>,xlab=<span class="string">"Miles per Gallon"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Draw a scatterplot:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; xyplot(mpg~weight|cyl.factor, data=auto, main=<span class="string">"Weight Vs MPG by Number of Cylinders"</span>, ylab=<span class="string">"Miles per Gallon"</span>, xlab=<span class="string">"Car Weight"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-19"><a href="#How-it-works…-19" class="headerlink" title="How it works…"></a>How it works…</h3><p>Lattice plot commands comprise the following four parts:</p>
<ul>
<li>Graph type: This can be a bwplot, xyplot, densityplot, splom, and so on</li>
<li>Formula: Variables and factor variables separated by |</li>
<li>Data: A data frame containing values</li>
<li>Annotations: These include caption, x axis label, and y axis label</li>
</ul>
<p>In the boxplot step 2, the ~auto$mpg|cyl.factor formula instructs lattice to make the plot with mpg on the x axis grouped by factors representing cylinders. Here, we have not specified any variable for the y axis. For boxplots and density plots, we need not specify the y axis. The output for boxplot resembles the following diagram:</p>
<p><img src="img/2_7_2.jpeg" alt=""></p>
<p>In the scatterplot, the xyplot function and the mpg~weight|cyl.factor formula instructs lattice to make the plot with weight on the x axis and mpg on the y axis grouped by factors representing cylinders. For xyplot, we need to provide two variables; otherwise, R will produce an error. The scatterplot output is seen as follows:</p>
<p><img src="img/2_7_3.jpeg" alt=""></p>
<h3 id="There’s-more…-15"><a href="#There’s-more…-15" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>Lattice plots provide default options to bring out the relationship between multiple variables. More options can be added to these plots to enhance the graphs.</p>
<h4 id="Adding-flair-to-your-graphs"><a href="#Adding-flair-to-your-graphs" class="headerlink" title="Adding flair to your graphs"></a>Adding flair to your graphs</h4><p>By default, lattice assigns the panel height and width based on the screen device. The plots use a default color scheme. However, these can be customized to your needs.</p>
<p>You should change the color scheme of all lattice plots before executing the plot command. The color scheme affects all Trellis plots made with the lattice package:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; trellis.par.set(theme = col.whitebg())</span><br></pre></td></tr></table></figure>
<p>Panels occupy the entire output window. This can be controlled with aspect. The layout determines the number of panels on the x axis and how they are stacked. Add these to the plot function call:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bwplot(~mpg|cyl.factor, data=auto,main=<span class="string">"MPG by Number Of Cylinders"</span>, xlab=<span class="string">"Miles per Gallon"</span>,layout=c(<span class="number">2</span>,<span class="number">3</span>),aspect=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h3 id="See-also…-4"><a href="#See-also…-4" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Generating standard plots such as histograms, boxplots, and scatterplots</li>
</ul>
<h2 id="Creating-plots-with-the-ggplot2-package"><a href="#Creating-plots-with-the-ggplot2-package" class="headerlink" title="Creating plots with the ggplot2 package"></a>Creating plots with the ggplot2 package</h2><p>ggplot2 graphs are built iteratively, starting with the most basic plot. Additional layers are chained with the + sign to generate the final plot.</p>
<p>To construct a plot we need at least data, aesthetics (color, shape, and size), and <code>geoms</code> (points, lines, and smooth). The geoms determine which type of graph is drawn. Facets can be added for conditional plots.</p>
<h3 id="Getting-ready-20"><a href="#Getting-ready-20" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and copy the auto-mpg.csv file to your R working directory. Read the file using the read.csv command and save in the auto variable. Convert cylinders into a factor variable. If you have not done so already, install the ggplot2 package as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"ggplot2"</span>)</span><br><span class="line">&gt; <span class="keyword">library</span>(ggplot2)</span><br><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; auto$cylinders &lt;- factor(auto$cylinders,labels=c(<span class="string">"3cyl"</span>,<span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>,<span class="string">"6cyl"</span>,<span class="string">"8cyl"</span>))</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-20"><a href="#How-to-do-it…-20" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To create plots with the ggplot2 package, follow these steps:</p>
<ol>
<li><p>Draw the initial plot:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot &lt;- ggplot(auto, aes(weight, mpg))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add layers:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot + geom_point()</span><br><span class="line">&gt; plot + geom_point(alpha=<span class="number">1</span>/<span class="number">2</span>, size=<span class="number">5</span>, aes(color=factor(cylinders))) + geom_smooth(method=<span class="string">"lm"</span>, se=<span class="literal">FALSE</span>, col=<span class="string">"green"</span>) + facet_grid(cylinders~.) + theme_bw(base_family = <span class="string">"Calibri"</span>, base_size = <span class="number">10</span>) + labs(x = <span class="string">"Weight"</span>) + labs(y = <span class="string">"Miles Per Gallon"</span>) + labs(title = <span class="string">"MPG Vs Weight"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-20"><a href="#How-it-works…-20" class="headerlink" title="How it works…"></a>How it works…</h3><p>Let’s start from the top and discuss some variations:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot &lt;- ggplot(auto, aes(weight, mpg))</span><br></pre></td></tr></table></figure>
<p>First, we draw the plot. At this point the graph is not printed, since we have not added layers to it. ggplot needs at least one layer to display the graph:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot + geom_point()</span><br></pre></td></tr></table></figure>
<p>This plots the points to produce the scatterplot as follows:</p>
<p><img src="img/2_8_1.jpeg" alt=""></p>
<p>We can use various arguments to control how the points appear—alpha for the intensity of the dots, color of the dots, the size and shape of the dots. We can also use the aes argument to add aesthetics to this layer and this produces the plot as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot + geom_point(alpha=<span class="number">1</span>/<span class="number">2</span>, size=<span class="number">5</span>, aes(color=factor(cylinders)))</span><br></pre></td></tr></table></figure>
<p><img src="img/2_8_2.jpeg" alt=""></p>
<p>Append the following code to the preceding command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ geom_smooth(method=<span class="string">"lm"</span>, se=<span class="literal">FALSE</span>, col=<span class="string">"green"</span>)</span><br></pre></td></tr></table></figure>
<p>Adding <code>geom_smooth</code> helps to see a pattern. The method=lm argument uses a linear model as the smoothing method. The se argument is set to TRUE by default and hence displays the confidence interval around the smoothed line. This supports aesthetics similar to geom_point. In addition, we can also set the linetype. The output obtained resembles the following diagram:</p>
<p><img src="img/2_8_3.jpeg" alt=""></p>
<p>By default, the geom_smooth function uses two different smoothing approaches based on the number of observations. If the number of observations exceeds 1000, it uses gam smoothing, loess otherwise. Given the familiarity with linear models, people mostly use the lm smoothing.</p>
<p>Append the following code to the preceding command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ facet_grid(cylinders~.)</span><br></pre></td></tr></table></figure>
<p>This adds additional dimensions to the graph using facets. We can add cylinders as a new dimension to the graph. Here, we use the simple <code>facet_grid</code> function. If we want to add more dimensions, we can use facet_wrap and specify how to wrap the rows and columns shown as follows:</p>
<p><img src="img/2_8_4.jpeg" alt=""></p>
<p>If we change to facet_grid(~.cylinders), the plots for each level of the cylinder are arranged horizontally.</p>
<p>Appending the following code adds annotations to get the final plot:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ theme_bw(base_family = <span class="string">"Calibri"</span>, base_size = <span class="number">10</span>) + labs(x = <span class="string">"Weight"</span>) + labs(y = <span class="string">"Miles Per Gallon"</span>) + labs(title = <span class="string">"MPG Vs Weight"</span>)</span><br></pre></td></tr></table></figure>
<p>The annotations added to get the final plot can be seen in the following diagram:</p>
<p><img src="img/2_8_5.jpeg" alt=""></p>
<h3 id="There’s-more…-16"><a href="#There’s-more…-16" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The best way to learn ggplot is to try out different options to see how they impact the graph. Here, we describe a few additional variations to ggplot.</p>
<h4 id="Graph-using-qplot"><a href="#Graph-using-qplot" class="headerlink" title="Graph using qplot"></a>Graph using qplot</h4><p>A simplistic version of ggplot is qplot and it uses the same ggplot2 package. qplot can also be chained with + to add additional layers in the plot. The generic form of qplot is as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qplot(x, y, data=, color=, shape=, size=, alpha=, geom=, method=, formula=, facets=, xlim=, ylim= xlab=, ylab=, main=, sub=)</span><br></pre></td></tr></table></figure>
<p>For certain types of graphs such as histograms and bar charts, we need to supply only x (and can therefore omit y):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Boxplots of mpg by number of cylinders</span></span><br><span class="line">&gt; qplot(cylinders, mpg, data=auto, geom=c(<span class="string">"jitter"</span>), color=cylinders, fill=cylinders, main=<span class="string">"Mileage by Number of Cylinders"</span>, xlab=<span class="string">""</span>, ylab=<span class="string">"Miles per Gallon"</span>)</span><br><span class="line">&gt; <span class="comment"># Regression of mpg by weight for each type of cylinders</span></span><br><span class="line">&gt; qplot(weight, mpg, data=auto, geom=c(<span class="string">"point"</span>, <span class="string">"smooth"</span>), method=<span class="string">"lm"</span>, formula=y~x, color=cylinders, main=<span class="string">"Regression of MPG on Weight"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Condition-plots-on-continuous-numeric-variables"><a href="#Condition-plots-on-continuous-numeric-variables" class="headerlink" title="Condition plots on continuous numeric variables"></a>Condition plots on continuous numeric variables</h4><p>Normally, we condition plots on categorical variables. However, to add additional dimensions to an existing plot, you may want to incorporate a numeric variable. Although qplot will do this for us, the numerous values of the condition make the plot useless. You can make it categorical using the cut function as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Cut with desired range</span></span><br><span class="line">&gt; breakpoints &lt;- c(<span class="number">8</span>,<span class="number">13</span>,<span class="number">18</span>,<span class="number">23</span>)</span><br><span class="line">&gt; <span class="comment"># Cut using Quantile function (another approach)</span></span><br><span class="line">&gt; breakpoints &lt;- quantile(auto$acceleration, seq(<span class="number">0</span>, <span class="number">1</span>, length</span><br><span class="line">= <span class="number">4</span>), na.rm = <span class="literal">TRUE</span>)</span><br><span class="line"></span><br><span class="line">&gt; <span class="comment">## create a new factor variable using the breakpoints</span></span><br><span class="line">&gt; auto$accelerate.factor &lt;- cut(auto$acceleration, breakpoints)</span><br></pre></td></tr></table></figure>
<p>Now, we can use auto$accelerate.factor in the qplot function.</p>
<h3 id="See-also…-5"><a href="#See-also…-5" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Generating standard plots such as histograms, boxplots and scatterplots</li>
<li>Creating plots with lattice package</li>
</ul>
<h2 id="Creating-charts-that-facilitate-comparisons"><a href="#Creating-charts-that-facilitate-comparisons" class="headerlink" title="Creating charts that facilitate comparisons"></a>Creating charts that facilitate comparisons</h2><p>In large datasets, we often gain good insights by examining how different segments behave. The similarities and differences can reveal interesting patterns. This recipe shows how to create graphs that enable such comparisons.</p>
<h3 id="Getting-ready-21"><a href="#Getting-ready-21" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the book’s files for this chapter and save the daily-bike-rentals.csv file in your R working directory. Read the data into R using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; bike &lt;- read.csv(<span class="string">"daily-bike-rentals.csv"</span>)</span><br><span class="line">&gt; bike$season &lt;- factor(bike$season, levels = c(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>), labels = c(<span class="string">"Spring"</span>, <span class="string">"Summer"</span>, <span class="string">"Fall"</span>, <span class="string">"Winter"</span>))</span><br><span class="line">&gt; <span class="keyword">attach</span>(bike)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-21"><a href="#How-to-do-it…-21" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>We base this recipe on the task of generating histograms to facilitate the comparison of bike rentals by season.</p>
<h4 id="Using-base-plotting-system"><a href="#Using-base-plotting-system" class="headerlink" title="Using base plotting system"></a>Using base plotting system</h4><p>We first look at how to generate histograms of the count of daily bike rentals by season using R’s base plotting system:</p>
<ol>
<li><p>Set up a 2 X 2 grid for plotting histograms for the four seasons:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; par(mfrow = c(<span class="number">2</span>,<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Extract data for the seasons:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; spring &lt;- subset(bike, season == <span class="string">"Spring"</span>)$cnt</span><br><span class="line">&gt; summer &lt;- subset(bike, season == <span class="string">"Summer"</span>)$cnt</span><br><span class="line">&gt; fall &lt;- subset(bike, season == <span class="string">"Fall"</span>)$cnt</span><br><span class="line">&gt; winter &lt;- subset(bike, season == <span class="string">"Winter"</span>)$cnt</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the histogram and density for each season:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; hist(spring, prob=<span class="literal">TRUE</span>, xlab = <span class="string">"Spring daily rentals"</span>, main = <span class="string">""</span>)</span><br><span class="line">&gt; lines(density(spring))</span><br><span class="line">&gt;</span><br><span class="line">&gt; hist(summer, prob=<span class="literal">TRUE</span>, xlab = <span class="string">"Summer daily rentals"</span>, main = <span class="string">""</span>)</span><br><span class="line">&gt; lines(density(summer))</span><br><span class="line">&gt;</span><br><span class="line">&gt; hist(fall, prob=<span class="literal">TRUE</span>, xlab = <span class="string">"Fall daily rentals"</span>, main = <span class="string">""</span>)</span><br><span class="line">&gt; lines(density(fall))</span><br><span class="line">&gt;</span><br><span class="line">&gt; hist(winter, prob=<span class="literal">TRUE</span>, xlab = <span class="string">"Winter daily rentals"</span>, main = <span class="string">""</span>)</span><br><span class="line">&gt; lines(density(winter))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>You get the following output that facilitates comparisons across the seasons:</p>
<p><img src="img/2_11_1.jpeg" alt=""></p>
<h4 id="Using-ggplot2"><a href="#Using-ggplot2" class="headerlink" title="Using ggplot2"></a>Using ggplot2</h4><p>We can achieve much of the preceding results in a single command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; qplot(cnt, data = bike) + facet_wrap(~ season, nrow=<span class="number">2</span>) + geom_histogram(fill = <span class="string">"blue"</span>)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_11_2.jpeg" alt=""></p>
<p>You can also combine all four into a single histogram and show the seasonal differences through coloring:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; qplot(cnt, data = bike, fill = season)</span><br></pre></td></tr></table></figure>
<p><img src="img/2_11_3.jpeg" alt=""></p>
<h3 id="How-it-works…-21"><a href="#How-it-works…-21" class="headerlink" title="How it works…"></a>How it works…</h3><p>When you plot a single variable with qplot, you get a histogram by default. Adding facet enables you to generate one histogram per level of the chosen facet. By default, the four histograms will be arranged in a single row. Use facet_wrap to change this.</p>
<h3 id="There’s-more…-17"><a href="#There’s-more…-17" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>You can use ggplot2 to generate comparative boxplots as well.</p>
<h4 id="Creating-boxplots-with-ggplot2"><a href="#Creating-boxplots-with-ggplot2" class="headerlink" title="Creating boxplots with ggplot2"></a>Creating boxplots with ggplot2</h4><p>Instead of the default histogram, you can get a boxplot with either of the following two approaches:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; qplot(season, cnt, data = bike, geom = c(<span class="string">"boxplot"</span>), fill = season)</span><br><span class="line">&gt;</span><br><span class="line">&gt; ggplot(bike, aes(x = season, y = cnt)) + geom_boxplot()</span><br></pre></td></tr></table></figure>
<p>The preceding code produces the following output:</p>
<p><img src="img/2_11_4.jpeg" alt=""></p>
<p>The second line of the preceding code produces the following plot:</p>
<p><img src="img/2_11_5.jpeg" alt=""></p>
<h3 id="See-also…-6"><a href="#See-also…-6" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Generating standard plots such as histograms, boxplots and scatterplots</li>
</ul>
<h2 id="Creating-charts-that-help-visualize-a-possible-causality"><a href="#Creating-charts-that-help-visualize-a-possible-causality" class="headerlink" title="Creating charts that help visualize a possible causality"></a>Creating charts that help visualize a possible causality</h2><p>When presenting data, rather than merely present information, we usually want to present an explanation of some phenomenon. Visualizing hypothesized causality helps to communicate our ideas clearly.</p>
<h3 id="Getting-ready-22"><a href="#Getting-ready-22" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the book’s files for this chapter and save the daily-bike-rentals.csv file in your R working directory. Read the data into R as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; bike &lt;- read.csv(<span class="string">"daily-bike-rentals.csv"</span>)</span><br><span class="line">&gt; bike$season &lt;- factor(bike$season, levels = c(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>), labels = c(<span class="string">"Spring"</span>, <span class="string">"Summer"</span>, <span class="string">"Fall"</span>, <span class="string">"Winter"</span>))</span><br><span class="line">&gt; bike$weathersit &lt;- factor(bike$weathersit, levels = c(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>), labels = c(<span class="string">"Clear"</span>, <span class="string">"Misty/cloudy"</span>, <span class="string">"Light snow"</span>))</span><br><span class="line">&gt; <span class="keyword">attach</span>(bike)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-22"><a href="#How-to-do-it…-22" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>With the bike rentals data, you can show a hypothesized causality between the weather situation and the number of rentals by drawing boxplots of rentals under different weather conditions:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; qplot(weathersit, cnt, data = bike, geom = c(<span class="string">"boxplot"</span>), fill = weathersit)</span><br></pre></td></tr></table></figure>
<p>The preceding command produces the following output:</p>
<p><img src="img/2_12_1.jpeg" alt=""></p>
<p>If you choose to, you can overlay the actual points as well; add “jitter” to the geom argument:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; qplot(weathersit, cnt, data = bike, geom = c(<span class="string">"boxplot"</span>, <span class="string">"jitter"</span>), fill = weathersit)</span><br></pre></td></tr></table></figure>
<p>The preceding command produces the following output:</p>
<p><img src="img/2_12_2.jpeg" alt=""></p>
<h3 id="See-also…-7"><a href="#See-also…-7" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Generating standard plots such as histograms, boxplots and scatterplots</li>
</ul>
<h2 id="Creating-multivariate-plots"><a href="#Creating-multivariate-plots" class="headerlink" title="Creating multivariate plots"></a>Creating multivariate plots</h2><p>When exploring data, we want to get a feel for the interaction of as many variables as possible. Although our display and print media can display only two dimensions, by creatively using R’s plotting features, we can bring many more dimensions into play. In this recipe, we show you how you can bring up to five variables into play.</p>
<h3 id="Getting-ready-23"><a href="#Getting-ready-23" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Read the data from file and create factors. We also attach the data to save on keystrokes as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(ggplot2)</span><br><span class="line">&gt; bike &lt;- read.csv(<span class="string">"daily-bike-rentals.csv"</span>)</span><br><span class="line">&gt; bike$season &lt;- factor(bike$season, levels = c(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>), labels = c(<span class="string">"Spring"</span>, <span class="string">"Summer"</span>, <span class="string">"Fall"</span>, <span class="string">"Winter"</span>))</span><br><span class="line">&gt; bike$weathersit &lt;- factor(bike$weathersit, levels = c(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>), labels = c(<span class="string">"Clear"</span>, <span class="string">"Misty/cloudy"</span>, <span class="string">"Light snow"</span>))</span><br><span class="line">&gt; bike$windspeed.fac &lt;- cut(bike$windspeed, breaks=<span class="number">3</span>, labels=c(<span class="string">"Low"</span>, <span class="string">"Medium"</span>, <span class="string">"High"</span>))</span><br><span class="line">&gt; bike$weekday &lt;- factor(bike$weekday, levels = c(<span class="number">0</span>:<span class="number">6</span>), labels = c(<span class="string">"Sun"</span>, <span class="string">"Mon"</span>, <span class="string">"Tue"</span>, <span class="string">"Wed"</span>, <span class="string">"Thur"</span>, <span class="string">"Fri"</span>, <span class="string">"Sat"</span>))</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">attach</span>(bike)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-23"><a href="#How-to-do-it…-23" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Create a multivariate plot using the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot &lt;- ggplot(bike,aes(temp,cnt))</span><br><span class="line">&gt; plot + geom_point(size=<span class="number">3</span>, aes(color=factor(windspeed.fac))) + geom_smooth(method=<span class="string">"lm"</span>, se=<span class="literal">FALSE</span>, col=<span class="string">"red"</span>) + facet_grid(weekday ~ season) + theme(legend.position=<span class="string">"bottom"</span>)</span><br></pre></td></tr></table></figure>
<p>The preceding commands produce the following output:</p>
<p><img src="img/2_13_1.jpeg" alt=""></p>
<h3 id="How-it-works…-22"><a href="#How-it-works…-22" class="headerlink" title="How it works…"></a>How it works…</h3><p>Refer to the recipe Create plots using ggplot2 earlier in this chapter.</p>
<h3 id="See-also…-8"><a href="#See-also…-8" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Generating standard plots such as histograms, boxplots and scatterplots</li>
<li>Creating plots with ggplot2 package</li>
</ul>
<hr>
<h1 id="Chapter-3-Where-Does-It-Belong-–-Classification"><a href="#Chapter-3-Where-Does-It-Belong-–-Classification" class="headerlink" title="Chapter 3. Where Does It Belong? – Classification"></a>Chapter 3. Where Does It Belong? – Classification</h1><p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Generating error/classification-confusion matrices</li>
<li>Generating ROC charts</li>
<li>Building, plotting, and evaluating – classification trees</li>
<li>Using random forest models for classification</li>
<li>Classifying using Support Vector Machine</li>
<li>Classifying using the Naïve-Bayes approach</li>
<li>Classifying using the KNN approach</li>
<li>Using neural networks for classification</li>
<li>Classifying using linear discriminant function analysis</li>
<li>Classifying using logistic regression</li>
<li>Using AdaBoost to combine classification tree models</li>
</ul>
<h2 id="Introduction-2"><a href="#Introduction-2" class="headerlink" title="Introduction"></a>Introduction</h2><p>Analysts often seek to classify or categorize items, for example, to predict whether a given person is a potential buyer or not. Other examples include classifying—a product as defective or not, a tax return as fraudulent or not, a customer as likely to default on a payment or not, and a credit card transaction as genuine or fraudulent. This chapter covers recipes to use R to apply several classification techniques.</p>
<h2 id="Generating-error-classification-confusion-matrices"><a href="#Generating-error-classification-confusion-matrices" class="headerlink" title="Generating error/classification-confusion matrices"></a>Generating error/classification-confusion matrices</h2><p>You might build a classification model and want to evaluate the model by comparing the model’s predictions with the actual outcomes. You will typically do this on the holdout data. Getting an idea of how the model does in training data itself is also useful, but you should never use that as an objective measure.</p>
<h3 id="Getting-ready-24"><a href="#Getting-ready-24" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do so now and ensure that the college-perf.csv file is in your R working directory. The file has data about a set of college students. The Perf variable has their college performance classified as High, Medium, or Low. The Pred variable contains a classification model’s predictions of the performance level. The following code reads the data and converts the factor levels to a meaningful order—by default R orders factors alphabetically:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; cp &lt;- read.csv(<span class="string">"college-perf.csv"</span>)</span><br><span class="line">&gt; cp$Perf &lt;- ordered(cp$Perf, levels =</span><br><span class="line">+             c(<span class="string">"Low"</span>, <span class="string">"Medium"</span>, <span class="string">"High"</span>))</span><br><span class="line"></span><br><span class="line">&gt; cp$Pred &lt;- ordered(cp$Pred, levels =</span><br><span class="line">+             c(<span class="string">"Low"</span>, <span class="string">"Medium"</span>, <span class="string">"High"</span>))</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-24"><a href="#How-to-do-it…-24" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To generate error/classification-confusion matrices, follow these steps:</p>
<ol>
<li><p>First create and display a two-way table based on the actual and predicted values:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; tab &lt;- table(cp$Perf, cp$Pred,</span><br><span class="line">+             dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">&gt; tab</span><br></pre></td></tr></table></figure>
<p> This yields:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        Predicted</span><br><span class="line">Actual    Low Medium High</span><br><span class="line">  Low    <span class="number">1150</span>     <span class="number">84</span>   <span class="number">98</span></span><br><span class="line">  Medium  <span class="number">166</span>   <span class="number">1801</span>  <span class="number">170</span></span><br><span class="line">  High     <span class="number">35</span>     <span class="number">38</span>  <span class="number">458</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Display the raw numbers as proportions or percentages. To get overall table-level proportions use:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; prop.table(tab)</span><br><span class="line"></span><br><span class="line">        Predicted</span><br><span class="line">Actual       Low  Medium    High</span><br><span class="line">  Low    <span class="number">0.28750</span> <span class="number">0.02100</span> <span class="number">0.02450</span></span><br><span class="line">  Medium <span class="number">0.04150</span> <span class="number">0.45025</span> <span class="number">0.04250</span></span><br><span class="line">  High   <span class="number">0.00875</span> <span class="number">0.00950</span> <span class="number">0.11450</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>We often find it more convenient to interpret row-wise or column-wise percentages. To get row-wise percentages rounded to one decimal place, you can pass a second argument as 1:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; round(prop.table(tab, <span class="number">1</span>)*<span class="number">100</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        Predicted</span><br><span class="line">Actual    Low Medium High</span><br><span class="line">  Low    <span class="number">86.3</span>    <span class="number">6.3</span>  <span class="number">7.4</span></span><br><span class="line">  Medium  <span class="number">7.8</span>   <span class="number">84.3</span>  <span class="number">8.0</span></span><br><span class="line">  High    <span class="number">6.6</span>    <span class="number">7.2</span> <span class="number">86.3</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>Tip</strong></p>
<p>Passing 2 as the second argument yields column-wise proportions.</p>
<h3 id="How-it-works…-23"><a href="#How-it-works…-23" class="headerlink" title="How it works…"></a>How it works…</h3><p>The table() function performs s simple two-way cross-tabulation of values. For each unique value of the first variable, it counts the occurrences of different values of the second variable. It works for numeric, factor, and character variables.</p>
<h3 id="There’s-more…-18"><a href="#There’s-more…-18" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>When dealing with more than two or three categories, seeing the error matrix as a chart could be useful to quickly assess the model’s performance within various categories.</p>
<h4 id="Visualizing-the-error-classification-confusion-matrix"><a href="#Visualizing-the-error-classification-confusion-matrix" class="headerlink" title="Visualizing the error/classification confusion matrix"></a>Visualizing the error/classification confusion matrix</h4><p>You can create a barplot using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; barplot(tab, legend = <span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
<p>The following output is the result of the preceding command:</p>
<p><img src="img/3_2_1.jpeg" alt=""></p>
<p>For a mosaicplot the following command is used:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mosaicplot(tab, main = <span class="string">"Prediction performance"</span>)</span><br></pre></td></tr></table></figure>
<p>The following output is obtained on running the command:</p>
<p><img src="img/3_2_2.jpeg" alt=""></p>
<h4 id="Comparing-the-model’s-performance-for-different-classes"><a href="#Comparing-the-model’s-performance-for-different-classes" class="headerlink" title="Comparing the model’s performance for different classes"></a>Comparing the model’s performance for different classes</h4><p>You can check whether the model’s performance on different classes differs significantly by using the summary function:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; summary(tab)</span><br><span class="line"></span><br><span class="line">Number of cases <span class="keyword">in</span> table: <span class="number">4000</span></span><br><span class="line">Number of factors: <span class="number">2</span></span><br><span class="line">Test <span class="keyword">for</span> independence of all factors:</span><br><span class="line">  Chisq = <span class="number">4449</span>, df = <span class="number">4</span>, p-value = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>The low p-value tells us that the proportions for the different classes are significantly different.</p>
<h2 id="Generating-ROC-charts"><a href="#Generating-ROC-charts" class="headerlink" title="Generating ROC charts"></a>Generating ROC charts</h2><p>When using classification techniques, we can rely on the technique to classify cases automatically. Alternately, we can rely on the technique to only generate the probabilities of cases belonging to various classes and then determine the cutoff probabilities ourselves. receiver operating characteristic (ROC) charts help with the latter approach by giving a visual representation of the true and false positives at various cutoff levels. We will use the ROCR package to generate ROC charts.</p>
<h3 id="Getting-ready-25"><a href="#Getting-ready-25" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the ROCR package, install it now. Load the data files for this chapter from the book’s website and ensure that the rocr-example-1.csv and rocr-example-2.csv files are on your R working directory.</p>
<h3 id="How-to-do-it…-25"><a href="#How-to-do-it…-25" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To generate ROC charts, follow these steps:</p>
<ol>
<li><p>Load the package ROCR:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(ROCR)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data file and take a look:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat &lt;- read.csv(<span class="string">"roc-example-1.csv"</span>)</span><br><span class="line">&gt; head(dat)</span><br><span class="line"></span><br><span class="line">       prob class</span><br><span class="line"><span class="number">1</span> <span class="number">0.9917340</span>     <span class="number">1</span></span><br><span class="line"><span class="number">2</span> <span class="number">0.9768288</span>     <span class="number">1</span></span><br><span class="line"><span class="number">3</span> <span class="number">0.9763148</span>     <span class="number">1</span></span><br><span class="line"><span class="number">4</span> <span class="number">0.9601505</span>     <span class="number">1</span></span><br><span class="line"><span class="number">5</span> <span class="number">0.9351574</span>     <span class="number">1</span></span><br><span class="line"><span class="number">6</span> <span class="number">0.9335989</span>     <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create the prediction object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- prediction(dat$prob, dat$class)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create the performance object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; perf &lt;- performance(pred, <span class="string">"tpr"</span>, <span class="string">"fpr"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the chart:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(perf)</span><br><span class="line">&gt; lines( par()$usr[<span class="number">1</span>:<span class="number">2</span>], par()$usr[<span class="number">3</span>:<span class="number">4</span>] )</span><br></pre></td></tr></table></figure>
<p> The following output is obtained:</p>
<p> <img src="img/3_3_1.jpeg" alt=""></p>
</li>
<li><p>Find the cutoff values for various true positive rates. Extract the relevant data from the perf object into a data frame prob.cuts:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; prob.cuts &lt;- data.frame(cut=perf@alpha.values[[<span class="number">1</span>]], fpr=perf@x.values[[<span class="number">1</span>]], tpr=perf@y.values[[<span class="number">1</span>]])</span><br><span class="line">&gt; head(prob.cuts)</span><br><span class="line">        cut fpr        tpr</span><br><span class="line"><span class="number">1</span>       <span class="literal">Inf</span>   <span class="number">0</span> <span class="number">0.00000000</span></span><br><span class="line"><span class="number">2</span> <span class="number">0.9917340</span>   <span class="number">0</span> <span class="number">0.01851852</span></span><br><span class="line"><span class="number">3</span> <span class="number">0.9768288</span>   <span class="number">0</span> <span class="number">0.03703704</span></span><br><span class="line"><span class="number">4</span> <span class="number">0.9763148</span>   <span class="number">0</span> <span class="number">0.05555556</span></span><br><span class="line"><span class="number">5</span> <span class="number">0.9601505</span>   <span class="number">0</span> <span class="number">0.07407407</span></span><br><span class="line"><span class="number">6</span> <span class="number">0.9351574</span>   <span class="number">0</span> <span class="number">0.09259259</span></span><br><span class="line"></span><br><span class="line">&gt; tail(prob.cuts)</span><br><span class="line">           cut       fpr tpr</span><br><span class="line"><span class="number">96</span>  <span class="number">0.10426897</span> <span class="number">0.8913043</span>   <span class="number">1</span></span><br><span class="line"><span class="number">97</span>  <span class="number">0.07292866</span> <span class="number">0.9130435</span>   <span class="number">1</span></span><br><span class="line"><span class="number">98</span>  <span class="number">0.07154785</span> <span class="number">0.9347826</span>   <span class="number">1</span></span><br><span class="line"><span class="number">99</span>  <span class="number">0.04703280</span> <span class="number">0.9565217</span>   <span class="number">1</span></span><br><span class="line"><span class="number">100</span> <span class="number">0.04652589</span> <span class="number">0.9782609</span>   <span class="number">1</span></span><br><span class="line"><span class="number">101</span> <span class="number">0.00112760</span> <span class="number">1.0000000</span>   <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p> From the data frame prob.cuts, we can choose the cutoff corresponding to our desired true positive rate.</p>
</li>
</ol>
<h3 id="How-it-works…-24"><a href="#How-it-works…-24" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the package and step 2 reads in the data file.</p>
<p>Step 3 creates a prediction object based on the probabilities and the class labels passed in as arguments. In the current examples, our class labels are 0 and 1, and by default 0 becomes the “failure” class and 1 becomes the “success” class. We will see in the There’s more… section below how to handle the case of arbitrary class labels.</p>
<p>Step 4 creates a performance object based on the data from the prediction object. We indicate that we want the “true positive rate” and the “false positive rate.”</p>
<p>Step 5 plots the performance object. The plot function does not plot the diagonal line indicating the ROC threshold, and we added a second line of code to get that.</p>
<p>We generally use ROC charts to determine a good cutoff value for classification given the probabilities. Step 6 shows you how to extract from the performance object the cutoff value corresponding to each point on the plot. Armed with this, we can determine the cutoff that yields each of the true positive rates and, given a desired true positive rate, we can find the appropriate cutoff probability.</p>
<h3 id="There’s-more…-19"><a href="#There’s-more…-19" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We discuss in the following a few more of ROCR’s important features.</p>
<h4 id="Using-arbitrary-class-labels"><a href="#Using-arbitrary-class-labels" class="headerlink" title="Using arbitrary class labels"></a>Using arbitrary class labels</h4><p>Unlike in the preceding example, we might have arbitrary class labels for success and failure. The rocr-example-2.csv file has buyer and non-buyer as the class labels, with buyer representing the success case.</p>
<p>In this case, we need to explicitly indicate the failure and success labels by passing in a vector with the failure case as the first element:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat &lt;- read.csv(<span class="string">"roc-example-2.csv"</span>)</span><br><span class="line">&gt; pred &lt;- prediction(dat$prob, dat$class, label.ordering = c(<span class="string">"non-buyer"</span>, <span class="string">"buyer"</span>))</span><br><span class="line">&gt; perf &lt;- performance(pred, <span class="string">"tpr"</span>, <span class="string">"fpr"</span>)</span><br><span class="line">&gt; plot(perf)</span><br><span class="line">&gt; lines( par()$usr[<span class="number">1</span>:<span class="number">2</span>], par()$usr[<span class="number">3</span>:<span class="number">4</span>] )</span><br></pre></td></tr></table></figure>
<h2 id="Building-plotting-and-evaluating-–-classification-trees"><a href="#Building-plotting-and-evaluating-–-classification-trees" class="headerlink" title="Building, plotting, and evaluating – classification trees"></a>Building, plotting, and evaluating – classification trees</h2><p>You can use a couple of R packages to build classification trees. Under the hood, they all do the same thing.</p>
<h3 id="Getting-ready-26"><a href="#Getting-ready-26" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you do not already have the rpart, rpart.plot, and caret packages, install them now. Download the data files for this chapter from the book’s website and place the banknote-authentication.csv file in your R working directory.</p>
<h3 id="How-to-do-it…-26"><a href="#How-to-do-it…-26" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>This recipe shows you how you can use the rpart package to build classification trees and the rpart.plot package to generate nice-looking tree diagrams:</p>
<ol>
<li><p>Load the rpart, rpart.plot, and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(rpart)</span><br><span class="line">&gt; <span class="keyword">library</span>(rpart.plot)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn &lt;- read.csv(<span class="string">"banknote-authentication.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create data partitions. We need two partitions—training and validation. Rather than copying the data into the partitions, we will just keep the indices of the cases that represent the training cases and subset as and when needed:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; train.idx &lt;- createDataPartition(bn$class, p = <span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the tree:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- rpart(class ~ ., data = bn[train.idx, ], method = <span class="string">"class"</span>, control = rpart.control(minsplit = <span class="number">20</span>, cp = <span class="number">0.01</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>View the text output (your result could differ if you did not set the random seed as in step 3):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod</span><br><span class="line">n= <span class="number">961</span></span><br><span class="line"></span><br><span class="line">node), split, n, loss, yval, (yprob)</span><br><span class="line">      * denotes terminal node</span><br><span class="line"></span><br><span class="line"> <span class="number">1</span>) root <span class="number">961</span> <span class="number">423</span> <span class="number">0</span> (<span class="number">0.55983351</span> <span class="number">0.44016649</span>)</span><br><span class="line">   <span class="number">2</span>) variance&gt;=<span class="number">0.321235</span> <span class="number">511</span>  <span class="number">52</span> <span class="number">0</span> (<span class="number">0.89823875</span> <span class="number">0.10176125</span>)</span><br><span class="line">     <span class="number">4</span>) curtosis&gt;=-<span class="number">4.3856</span> <span class="number">482</span>  <span class="number">29</span> <span class="number">0</span> (<span class="number">0.93983402</span> <span class="number">0.06016598</span>)</span><br><span class="line">       <span class="number">8</span>) variance&gt;=<span class="number">0.92009</span> <span class="number">413</span>  <span class="number">10</span> <span class="number">0</span> (<span class="number">0.97578692</span> <span class="number">0.02421308</span>) *</span><br><span class="line">       <span class="number">9</span>) variance&lt; <span class="number">0.92009</span> <span class="number">69</span>  <span class="number">19</span> <span class="number">0</span> (<span class="number">0.72463768</span> <span class="number">0.27536232</span>)</span><br><span class="line">        <span class="number">18</span>) entropy&lt; -<span class="number">0.167685</span> <span class="number">52</span>   <span class="number">6</span> <span class="number">0</span> (<span class="number">0.88461538</span> <span class="number">0.11538462</span>) *</span><br><span class="line">        <span class="number">19</span>) entropy&gt;=-<span class="number">0.167685</span> <span class="number">17</span>   <span class="number">4</span> <span class="number">1</span> (<span class="number">0.23529412</span> <span class="number">0.76470588</span>) *</span><br><span class="line">     <span class="number">5</span>) curtosis&lt; -<span class="number">4.3856</span> <span class="number">29</span>   <span class="number">6</span> <span class="number">1</span> (<span class="number">0.20689655</span> <span class="number">0.79310345</span>)</span><br><span class="line">      <span class="number">10</span>) variance&gt;=<span class="number">2.3098</span> <span class="number">7</span>   <span class="number">1</span> <span class="number">0</span> (<span class="number">0.85714286</span> <span class="number">0.14285714</span>) *</span><br><span class="line">      <span class="number">11</span>) variance&lt; <span class="number">2.3098</span> <span class="number">22</span>   <span class="number">0</span> <span class="number">1</span> (<span class="number">0.00000000</span> <span class="number">1.00000000</span>) *</span><br><span class="line">   <span class="number">3</span>) variance&lt; <span class="number">0.321235</span> <span class="number">450</span>  <span class="number">79</span> <span class="number">1</span> (<span class="number">0.17555556</span> <span class="number">0.82444444</span>)</span><br><span class="line">     <span class="number">6</span>) skew&gt;=<span class="number">6.83375</span> <span class="number">76</span>  <span class="number">18</span> <span class="number">0</span> (<span class="number">0.76315789</span> <span class="number">0.23684211</span>)</span><br><span class="line">      <span class="number">12</span>) variance&gt;=-<span class="number">3.4449</span> <span class="number">57</span>   <span class="number">0</span> <span class="number">0</span> (<span class="number">1.00000000</span> <span class="number">0.00000000</span>) *</span><br><span class="line">      <span class="number">13</span>) variance&lt; -<span class="number">3.4449</span> <span class="number">19</span>   <span class="number">1</span> <span class="number">1</span> (<span class="number">0.05263158</span> <span class="number">0.94736842</span>) *</span><br><span class="line">     <span class="number">7</span>) skew&lt; <span class="number">6.83375</span> <span class="number">374</span>  <span class="number">21</span> <span class="number">1</span> (<span class="number">0.05614973</span> <span class="number">0.94385027</span>)</span><br><span class="line">      <span class="number">14</span>) curtosis&gt;=<span class="number">6.21865</span> <span class="number">106</span>  <span class="number">16</span> <span class="number">1</span> (<span class="number">0.15094340</span> <span class="number">0.84905660</span>)</span><br><span class="line">       <span class="number">28</span>) skew&gt;=-<span class="number">3.16705</span> <span class="number">16</span>   <span class="number">0</span> <span class="number">0</span> (<span class="number">1.00000000</span> <span class="number">0.00000000</span>) *</span><br><span class="line">        <span class="number">29</span>) skew&lt; -<span class="number">3.16705</span> <span class="number">90</span>   <span class="number">0</span> <span class="number">1</span> (<span class="number">0.00000000</span> <span class="number">1.00000000</span>) *</span><br><span class="line">      <span class="number">15</span>) curtosis&lt; <span class="number">6.21865</span> <span class="number">268</span>   <span class="number">5</span> <span class="number">1</span> (<span class="number">0.01865672</span> <span class="number">0.98134328</span>) *</span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate a diagram of the tree (your tree might differ if you did not set the random seed as in step 3):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; prp(mod, type = <span class="number">2</span>, extra = <span class="number">104</span>, nn = <span class="literal">TRUE</span>, fallen.leaves = <span class="literal">TRUE</span>, faclen = <span class="number">4</span>, varlen = <span class="number">8</span>, shadow.col = <span class="string">"gray"</span>)</span><br></pre></td></tr></table></figure>
<p> The following output is obtained as a result of the preceding command:</p>
<p> <img src="img/3_4_1.jpeg" alt=""></p>
</li>
<li><p>Prune the tree:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># First see the cptable</span></span><br><span class="line">&gt; <span class="comment"># !!Note!!: Your table can be different because of the</span></span><br><span class="line">&gt; <span class="comment"># random aspect in cross-validation</span></span><br><span class="line">&gt; mod$cptable</span><br><span class="line"></span><br><span class="line">          CP nsplit  rel error    xerror       xstd</span><br><span class="line"><span class="number">1</span> <span class="number">0.69030733</span>      <span class="number">0</span> <span class="number">1.00000000</span> <span class="number">1.0000000</span> <span class="number">0.03637971</span></span><br><span class="line"><span class="number">2</span> <span class="number">0.09456265</span>      <span class="number">1</span> <span class="number">0.30969267</span> <span class="number">0.3262411</span> <span class="number">0.02570025</span></span><br><span class="line"><span class="number">3</span> <span class="number">0.04018913</span>      <span class="number">2</span> <span class="number">0.21513002</span> <span class="number">0.2387707</span> <span class="number">0.02247542</span></span><br><span class="line"><span class="number">4</span> <span class="number">0.01891253</span>      <span class="number">4</span> <span class="number">0.13475177</span> <span class="number">0.1607565</span> <span class="number">0.01879222</span></span><br><span class="line"><span class="number">5</span> <span class="number">0.01182033</span>      <span class="number">6</span> <span class="number">0.09692671</span> <span class="number">0.1347518</span> <span class="number">0.01731090</span></span><br><span class="line"><span class="number">6</span> <span class="number">0.01063830</span>      <span class="number">7</span> <span class="number">0.08510638</span> <span class="number">0.1323877</span> <span class="number">0.01716786</span></span><br><span class="line"><span class="number">7</span> <span class="number">0.01000000</span>      <span class="number">9</span> <span class="number">0.06382979</span> <span class="number">0.1276596</span> <span class="number">0.01687712</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Choose CP value as the highest value whose</span></span><br><span class="line">&gt; <span class="comment"># xerror is not greater than minimum xerror + xstd</span></span><br><span class="line">&gt; <span class="comment"># With the above data that happens to be</span></span><br><span class="line">&gt; <span class="comment"># the fifth one, 0.01182033</span></span><br><span class="line">&gt; <span class="comment"># Your values could be different because of random</span></span><br><span class="line">&gt; <span class="comment"># sampling</span></span><br><span class="line">&gt; mod.pruned = prune(mod, mod$cptable[<span class="number">5</span>, <span class="string">"CP"</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>View the pruned tree (your tree will look different):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; prp(mod.pruned, type = <span class="number">2</span>, extra = <span class="number">104</span>, nn = <span class="literal">TRUE</span>, fallen.leaves = <span class="literal">TRUE</span>, faclen = <span class="number">4</span>, varlen = <span class="number">8</span>, shadow.col = <span class="string">"gray"</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/3_4_2.jpeg" alt=""></p>
</li>
<li><p>Use the pruned model to predict for the validation partition (note the minus sign before train.idx to consider the cases in the validation partition):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred.pruned &lt;- predict(mod, bn[-train.idx,], type = <span class="string">"class"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate the error/classification-confusion matrix:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; table(bn[-train.idx,]$class, pred.pruned, dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">      Predicted</span><br><span class="line">Actual   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">     <span class="number">0</span> <span class="number">213</span>  <span class="number">11</span></span><br><span class="line">     <span class="number">1</span>  <span class="number">11</span> <span class="number">176</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-25"><a href="#How-it-works…-25" class="headerlink" title="How it works…"></a>How it works…</h3><p>Steps 1 to 3 load the packages, read the data, and identify the cases in the training partition, respectively. See the recipe Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis for more details on partitioning. In step 3, we set the random seed so that your results should match those that we display.</p>
<p>Step 4 builds the classification tree model:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- rpart(class ~ ., data = bn[train.idx, ], method = <span class="string">"class"</span>, control = rpart.control(minsplit = <span class="number">20</span>, cp = <span class="number">0.01</span>))</span><br></pre></td></tr></table></figure>
<p>The <code>rpart()</code> function builds the tree model based on the following:</p>
<ul>
<li>Formula specifying the dependent and independent variables</li>
<li>Dataset to use</li>
<li>A specification through method=”class” that we want to build a classification tree (as opposed to a regression tree)</li>
<li>Control parameters specified through the control = rpart.control() setting; here we have indicated that the tree should only consider nodes with at least 20 cases for splitting and use the complexity parameter value of 0.01—these two values represent the defaults and we have included these just for illustration</li>
</ul>
<p>Step 5 produces a textual display of the results. Step 6 uses the prp() function of the rpart.plot package to produce a nice-looking plot of the tree:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; prp(mod, type = <span class="number">2</span>, extra = <span class="number">104</span>, nn = <span class="literal">TRUE</span>, fallen.leaves = <span class="literal">TRUE</span>, faclen = <span class="number">4</span>, varlen = <span class="number">8</span>, shadow.col = <span class="string">"gray"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>use type=2 to get a plot with every node labeled and with the split label below the node</li>
<li>use extra=4 to display the probability of each class in the node (conditioned on the node and hence summing to 1); add 100 (hence extra=104) to display the number of cases in the node as a percentage of the total number of cases</li>
<li>use nn = TRUE to display the node numbers; the root node is node number 1 and node n has child nodes numbered 2n and 2n+1</li>
<li>use fallen.leaves=TRUE to display all leaf nodes at the bottom of the graph</li>
<li>use faclen to abbreviate class names in the nodes to a specific maximum length</li>
<li>use varlen to abbreviate variable names</li>
<li>use shadow.col to specify the color of the shadow that each node casts</li>
</ul>
<p>Step 7 prunes the tree to reduce the chance that the model too closely models the training data—that is, to reduce overfitting. Within this step, we first look at the complexity table generated through cross-validation. We then use the table to determine the cutoff complexity level as the largest xerror (cross-validation error) value that is not greater than one standard deviation above the minimum cross-validation error.</p>
<p>Steps 8 through 10 display the pruned tree; use the pruned tree to predict the class for the validation partition and then generate the error matrix for the validation partition.</p>
<h3 id="There’s-more…-20"><a href="#There’s-more…-20" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We discuss in the following an important variation on predictions using classification trees.</p>
<h3 id="Computing-raw-probabilities"><a href="#Computing-raw-probabilities" class="headerlink" title="Computing raw probabilities"></a>Computing raw probabilities</h3><p>We can generate probabilities in place of classifications by specifying type=”prob”:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;  pred.pruned &lt;- predict(mod, bn[-train.idx,], type = <span class="string">"prob"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Create-the-ROC-Chart"><a href="#Create-the-ROC-Chart" class="headerlink" title="Create the ROC Chart"></a>Create the ROC Chart</h4><p>Using the preceding raw probabilities and the class labels, we can generate a ROC chart. See the recipe Generating ROC charts earlier in this chapter for more details:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- prediction(pred.pruned[,<span class="number">2</span>], bn[-train.idx,<span class="string">"class"</span>])</span><br><span class="line">&gt; perf &lt;- performance(pred, <span class="string">"tpr"</span>, <span class="string">"fpr"</span>)</span><br><span class="line">&gt; plot(perf)</span><br></pre></td></tr></table></figure>
<p><img src="img/3_4_3.jpeg" alt=""></p>
<h3 id="See-also"><a href="#See-also" class="headerlink" title="See also"></a>See also</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
<li>Generating error/classification-confusion matrices in this chapter.</li>
<li>Building regression trees in Chapter 4, Give Me a Number – Regression</li>
</ul>
<h2 id="Using-random-forest-models-for-classification"><a href="#Using-random-forest-models-for-classification" class="headerlink" title="Using random forest models for classification"></a>Using random forest models for classification</h2><p>The randomForest package can help you to easily apply the very powerful (but computationally intensive) random forest classification technique.</p>
<h3 id="Getting-ready-27"><a href="#Getting-ready-27" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the randomForest and caret packages, install them now. Download the data files for this chapter from the book’s website and place the banknote-authentication.csv file in your R working directory. We will build a random forest model to predict class based on the other variables.</p>
<h3 id="How-to-do-it…-27"><a href="#How-to-do-it…-27" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To use Random Forest models for classification, follow these steps:</p>
<ol>
<li><p>Load the randomForest and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(randomForest)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data and convert the response variable to a factor:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn &lt;- read.csv(<span class="string">"banknote-authentication.csv"</span>)</span><br><span class="line">&gt; bn$class &lt;- factor(bn$class)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Select a subset of the data for building the model. In Random Forests, we do not need to actually partition the data for model evaluation since the tree construction process has partitioning inherent in every step. However, we keep aside some of the data here just to illustrate the process of using the model for prediction and also to get an idea of the model’s performance:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; sub.idx &lt;- createDataPartition(bn$class, p=<span class="number">0.7</span>, list=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the random forest model (since it builds many classification trees, the following command can take a lot of processing time on even moderately large data):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- randomForest(x = bn[sub.idx,<span class="number">1</span>:<span class="number">4</span>], y=bn[sub.idx,<span class="number">5</span>],ntree=<span class="number">500</span>, keep.forest=<span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Use the model to predict for cases that we set aside in step 3:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;  pred &lt;- predict(mod, bn[-sub.idx,])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the error matrix:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; table(bn[-sub.idx,<span class="string">"class"</span>], pred, dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">     Predicted</span><br><span class="line">Actual   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">     <span class="number">0</span> <span class="number">227</span>   <span class="number">1</span></span><br><span class="line">     <span class="number">1</span>   <span class="number">1</span> <span class="number">182</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-26"><a href="#How-it-works…-26" class="headerlink" title="How it works…"></a>How it works…</h3><p>Steps 1 loads the necessary packages and step 2 reads the data and converts the response variable to a factor.</p>
<p>Step 3 sets aside some of the data for later use. Strictly speaking, we do not have to partition the data for random forests because, while building each tree, the method sets aside some of the cases for cross-validation. However, we set aside some of the cases just to illustrate the process of using the model for prediction. (We set the random seed to enable you to match your results with those we display.)</p>
<p>Step 4 uses the randomForest function to build the model. Since the predictor variables are in the first four variables of the data frame and since we want to use only the selected subset for model building, we specify x= bn[sub.idx,1:4]. Since the target variable is in the fifth column, we specify y= bn[sub.idx,5]. We specify the number of trees to build in the forest through the ntree argument (the default value is 500).</p>
<p>Step 5 illustrates how to predict using the model.</p>
<p>Step 6 uses the predictions and the actual values to generate an error matrix.</p>
<p><strong>Tip</strong></p>
<p>The model that the randomForest function produces does not keep information about the trees and hence we cannot use the model for predicting future cases. To force the model to keep the generated forest, specify keep.forest=TRUE.</p>
<h3 id="There’s-more…-21"><a href="#There’s-more…-21" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We discuss in the following a few prominent options.</p>
<h4 id="Computing-raw-probabilities-1"><a href="#Computing-raw-probabilities-1" class="headerlink" title="Computing raw probabilities"></a>Computing raw probabilities</h4><p>As with simple classification tree models, we can generate probabilities in place of classifications by specifying type=”prob” – the default value “response” generates classifications:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;  probs &lt;- predict(mod, bn[-sub.idx,], type = <span class="string">"prob"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Generating-the-ROC-chart"><a href="#Generating-the-ROC-chart" class="headerlink" title="Generating the ROC chart"></a>Generating the ROC chart</h4><p>Using the preceding probabilities, we can generate the ROC chart. For details, refer to Generating ROC charts earlier in this chapter:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- prediction(probs[,<span class="number">2</span>], bn[-sub.idx,<span class="string">"class"</span>])</span><br><span class="line">&gt; perf &lt;- performance(pred, <span class="string">"tpr"</span>, <span class="string">"fpr"</span>)</span><br><span class="line">&gt; plot(perf)</span><br></pre></td></tr></table></figure>
<p>The following output is the result of preceding command:</p>
<p><img src="img/3_5_1.jpeg" alt=""></p>
<h4 id="Specifying-cutoffs-for-classification"><a href="#Specifying-cutoffs-for-classification" class="headerlink" title="Specifying cutoffs for classification"></a>Specifying cutoffs for classification</h4><p>Instead of using the default rule of simple majority for classification, we can specify cutoff probabilities as a vector of length equal to the number of classes. The proportion of the ratio of votes to the cutoff determines the winning class. We can specify this both at the time of tree construction and while using the model for predictions.</p>
<h3 id="See-also…-9"><a href="#See-also…-9" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
<li>Generating error/classification-confusion matrices in this chapter</li>
<li>Building Random Forest models for regression in Chapter 4, Give Me a Number – Regression</li>
</ul>
<h2 id="Classifying-using-Support-Vector-Machine"><a href="#Classifying-using-Support-Vector-Machine" class="headerlink" title="Classifying using Support Vector Machine"></a>Classifying using Support Vector Machine</h2><p>The e1071 package can help you to easily apply the very powerful Support Vector Machine (SVM) classification technique.</p>
<h3 id="Getting-ready-28"><a href="#Getting-ready-28" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the e1071 and caret packages, install them now. Download the data files for this chapter from the book’s website and place the banknote-authentication.csv file in your R working directory. We will build an SVM model to predict class based on the other variables.</p>
<h3 id="How-to-do-it…-28"><a href="#How-to-do-it…-28" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To classify using SVM, follow these steps:</p>
<ol>
<li><p>Load the e1071 and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(e1071)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn &lt;- read.csv(<span class="string">"banknote-authentication.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the outcome variable class to a factor:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn$class &lt;- factor(bn$class)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(bn$class, p=<span class="number">0.7</span>, list=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- svm(class ~ ., data = bn[t.idx,])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Check model performance on training data by generating an error/classification-confusion matrix:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; table(bn[t.idx,<span class="string">"class"</span>], fitted(mod), dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">      Predicted</span><br><span class="line">Actual   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">     <span class="number">0</span> <span class="number">534</span>   <span class="number">0</span></span><br><span class="line">     <span class="number">1</span>   <span class="number">0</span> <span class="number">427</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Check model performance on the validation partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- predict(mod, bn[-t.idx,])</span><br><span class="line">&gt; table(bn[-t.idx, <span class="string">"class"</span>], pred, dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">      Predicted</span><br><span class="line">Actual   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">     <span class="number">0</span> <span class="number">228</span>   <span class="number">0</span></span><br><span class="line">     <span class="number">1</span>   <span class="number">0</span> <span class="number">183</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the model on the training partition. Our data has more than two predictors, but we can only show two in the plot. We have selected skew and variance:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(mod, data=bn[t.idx,], skew ~ variance)</span><br></pre></td></tr></table></figure>
<p> The following plot is the output of the preceding command:</p>
<p> <img src="img/3_5_2.jpeg" alt=""></p>
</li>
<li><p>Plot the model on the validation partition. Our data has more than two predictors, but we can only show two in the plot. We have selected skew and variance:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(mod, data=bn[-t.idx,], skew ~ variance)</span><br></pre></td></tr></table></figure>
<p> The follow plot is the result of the preceding command:</p>
<p> <img src="img/3_5_3.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-27"><a href="#How-it-works…-27" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the necessary packages.</p>
<p>Step 2 reads the data.</p>
<p>Step 3 converts the outcome variable class to a factor.</p>
<p>Step 4 identifies the cases in the training partition (we set the random seed to enable you to match your results with ours).</p>
<p>Step 5 builds the SVM classification model. The svm function determines the type of model (classification or regression) based on the nature of the outcome variable. When the outcome variable is a factor, svm builds a classification model. At a minimum, we need to pass the model formula and the dataset to use as arguments. (Alternately, we can pass the outcome variable and the predictor variables separately as the x and y arguments).</p>
<p>Step 6 uses the resulting svm object mod containing the model to create an error/classification-confusion matrix. The svm model retains the fitted values on the training partition, and hence we do not need to go through the step of creating the predictions. We access the fitted values through fitted(mod). Refer to the recipe Generating error/classification-confusion matrices in this chapter for details on the table function.</p>
<p>Step 7 generates the model’s predictions for the validation partition by using the predict function. We pass as arguments the model and the data for which we need predictions. It then uses these predictions to generate the associated error/classification-confusion matrix.</p>
<p>Steps 8 and 9 use the plot function to plot the model’s results. We pass as arguments the model and the data for which we need the plot. If the data has only two predictors, we can get the complete picture from such a plot. However, our example has four predictors and we have chosen two of them for the plot.</p>
<h3 id="There’s-more…-22"><a href="#There’s-more…-22" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The svm function has several additional arguments through which we can control its behavior.</p>
<h4 id="Controlling-scaling-of-variables"><a href="#Controlling-scaling-of-variables" class="headerlink" title="Controlling scaling of variables"></a>Controlling scaling of variables</h4><p>By default, svm scales all the variables (predictor and outcome) to zero mean and unit variance before building a model as this generally produces better results. We can use the scale argument—a logical vector—to control this. If the length of the vector is 1, then it is recycled as many times as needed.</p>
<h4 id="Determining-the-type-of-SVM-model"><a href="#Determining-the-type-of-SVM-model" class="headerlink" title="Determining the type of SVM model"></a>Determining the type of SVM model</h4><p>By default, when the outcome variable is a factor, svm performs classification. When the outcome is numeric, it performs regression. We can override the default or select other options through these values for type:</p>
<ul>
<li>type = C-classification</li>
<li>type = nu-classification</li>
<li>type = one-classification</li>
<li>type = eps-regression</li>
<li>type = nu-regression</li>
</ul>
<h4 id="Assigning-weights-to-the-classes"><a href="#Assigning-weights-to-the-classes" class="headerlink" title="Assigning weights to the classes"></a>Assigning weights to the classes</h4><p>In cases where the sizes of the classes are highly skewed, the larger class could dominate. To balance this, we might want to weight the classes differently from the default equal weighting. We can use the class.weights argument for this:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- svm(class ~ ., data = bn[t.idx,], class.weights=c(<span class="string">"0"</span>=<span class="number">0.3</span>, <span class="string">"1"</span>=<span class="number">0.7</span> ))</span><br></pre></td></tr></table></figure>
<h3 id="See-also…-10"><a href="#See-also…-10" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
<li>Generating error/classification-confusion matrices in this chapter</li>
</ul>
<h2 id="Classifying-using-the-Naive-Bayes-approach"><a href="#Classifying-using-the-Naive-Bayes-approach" class="headerlink" title="Classifying using the Naïve Bayes approach"></a>Classifying using the Naïve Bayes approach</h2><p>The e1071 package contains the naiveBayes function for the Naïve Bayes classification.</p>
<h3 id="Getting-ready-29"><a href="#Getting-ready-29" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you do not already have the e1071 and caret packages, install them now. Download the data files for this chapter from the book’s website and place the electronics-purchase.csv file in your R working directory. Naïve Bayes requires all the variables to be categorical. So, if needed, you should first convert all variables accordingly—refer to the recipe Binning numerical data in Chapter 1, Acquire and Prepare the Ingredients – Your Data.</p>
<h3 id="How-to-do-it…-29"><a href="#How-to-do-it…-29" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To classify using the Naïve Bayes method, follow these steps:</p>
<ol>
<li><p>Load the e1071 and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(e1071)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; ep &lt;- read.csv(<span class="string">"electronics-purchase.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; train.idx &lt;- createDataPartition(ep$Purchase, p = <span class="number">0.67</span>, list = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; epmod &lt;- naiveBayes(Purchase ~ . , data = ep[train.idx,])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Look at the model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; epmod</span><br></pre></td></tr></table></figure>
</li>
<li><p>Predict for each case of the validation partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- predict(epmod, ep[-train.idx,])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate and view the error matrix/classification confusion matrix for the validation partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; tab &lt;- table(ep[-train.idx,]$Purchase, pred, dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">&gt; tab</span><br><span class="line">      Predicted</span><br><span class="line">Actual No Yes</span><br><span class="line">   No   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line">   Yes  <span class="number">0</span>   <span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-28"><a href="#How-it-works…-28" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the required packages, step 2 reads the data, and step 3 identifies the rows in the training partition (we set the random seed to enable you to match your results with ours).</p>
<p>Step 4 builds the model using the naiveBayes() function and passing the formula and the training partition as the arguments. Step 5 displays the conditional probabilities that the naiveBayes() function generates for use in making predictions.</p>
<p>Step 6 generates the model predictions for the validation partition and step 7 builds the error matrix as follows:</p>
<p><img src="img/3_5_4.jpeg" alt=""></p>
<p>Step 6 generates the predictions for each case of the validation partition using the predict() function and passing the model and the validation partition as arguments. Step 8 generates the error or classification confusion matrix using the table() function.</p>
<h3 id="See-also…-11"><a href="#See-also…-11" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
</ul>
<h2 id="Classifying-using-the-KNN-approach"><a href="#Classifying-using-the-KNN-approach" class="headerlink" title="Classifying using the KNN approach"></a>Classifying using the KNN approach</h2><p>The class package contains the knn function for KNN classification.</p>
<h3 id="Getting-ready-30"><a href="#Getting-ready-30" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the class and caret packages, install them now. Download the data files for this chapter from the book’s website and place the vacation-trip-classification.csv file in your R working directory. KNN requires all the independent/predictor variables to be numeric, and the dependent variable or target to be categorical. So, if needed, you should first convert variables accordingly—refer to the recipes Creating dummies for categorical variables and Binning numerical data in Chapter 1, Acquire and Prepare the Ingredients – Your Data.</p>
<h3 id="How-to-do-it…-30"><a href="#How-to-do-it…-30" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To classify using the K-Nearest Neighbours method, follow the steps below,</p>
<ol>
<li><p>Load the class and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(class)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; vac &lt;- read.csv(<span class="string">"vacation-trip-classification.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Standardize the predictor variables Income and Family_size:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; vac$Income.z &lt;- scale(vac$Income)</span><br><span class="line">&gt; vac$Family_size.z &lt;- scale(vac$Family_size)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data. You need three partitions for KNN:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; train.idx &lt;- createDataPartition(vac$Result, p = <span class="number">0.5</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; train &lt;- vac[train.idx, ]</span><br><span class="line">&gt; temp &lt;- vac[-train.idx, ]</span><br><span class="line">&gt; val.idx &lt;- createDataPartition(temp$Result, p = <span class="number">0.5</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; val &lt;- temp[val.idx, ]</span><br><span class="line">&gt; test &lt;- temp[-val.idx, ]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate predictions for validation cases with k=1:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred1 &lt;- knn(,train[<span class="number">4</span>:<span class="number">5</span>], val[,<span class="number">4</span>:<span class="number">5</span>], train[,<span class="number">3</span>], <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate an error matrix for k=1:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; errmat1 &lt;- table(val$Result, pred1, dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Repeat the preceding process for many values of k and choose the best value for k. Look under the following There’s more… section for a way to automate this process.</p>
</li>
<li><p>Use that value of k to generate predictions and the error matrix for the cases in the test partition (in the following code, we assume that k=1 was preferred):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred.test &lt;- knn(,train[<span class="number">4</span>:<span class="number">5</span>], test[,<span class="number">4</span>:<span class="number">5</span>], train[,<span class="number">3</span>], <span class="number">1</span>)</span><br><span class="line">&gt; errmat.test = table(test$Result, pred.test, dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-29"><a href="#How-it-works…-29" class="headerlink" title="How it works…"></a>How it works…</h3><p>Steps 1 to 3 load the necessary packages and read the data file.</p>
<p>Step 4 creates three partitions (50 %, 25 %, and 25 %). We set the random seed to enable you to match your results with those we display. Refer to the recipe Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis for information on data partitioning.</p>
<p>Step 5 uses the knn function to generate predictions with k=1. It uses only the standardized values of the predictor variables and hence specifies train[,4:5] and val[,4:5].</p>
<p>Step 6 generates the error matrix for k=1.</p>
<h3 id="There’s-more…-23"><a href="#There’s-more…-23" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We now turn to some other ways in which you can use KNN classifications.</p>
<h4 id="Automating-the-process-of-running-KNN-for-many-k-values"><a href="#Automating-the-process-of-running-KNN-for-many-k-values" class="headerlink" title="Automating the process of running KNN for many k values"></a>Automating the process of running KNN for many k values</h4><p>The following convenience function helps to free you from the drudgery of repeatedly running nearly identical commands to run KNN for various values of k:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">knn.automate &lt;- <span class="keyword">function</span> (trg_predictors, val_predictors, trg_target, val_target, start_k, end_k)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> (k <span class="keyword">in</span> start_k:end_k) &#123;</span><br><span class="line">    pred &lt;- knn(trg_predictors, val_predictors,</span><br><span class="line">                               trg_target, k)</span><br><span class="line">    tab &lt;- table(val_target, pred, dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">    cat(paste(<span class="string">"Error matrix for k="</span>, k,<span class="string">"\n"</span>))</span><br><span class="line">    cat(<span class="string">"==========================\n"</span>)</span><br><span class="line">    print(tab)</span><br><span class="line">    cat(<span class="string">"--------------------------\n\n\n"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With the preceding function in place, you can use the following to run knn for k=1 through k=7 for the example in the main recipe:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; knn.automate(train[,<span class="number">4</span>:<span class="number">5</span>], val[,<span class="number">4</span>:<span class="number">5</span>], train[,<span class="number">3</span>], val[,<span class="number">3</span>], <span class="number">1</span>,<span class="number">7</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Using-KNN-to-compute-raw-probabilities-instead-of-classifications"><a href="#Using-KNN-to-compute-raw-probabilities-instead-of-classifications" class="headerlink" title="Using KNN to compute raw probabilities instead of classifications"></a>Using KNN to compute raw probabilities instead of classifications</h4><p>When we use KNN to classify cases, the underlying algorithm uses a simple majority vote to determine the class. In such a case, we implicitly consider all errors to be equally important. However, in situations with asymmetric costs—where we are prepared to make one kind of error more readily than another—we might not want to use a simple majority vote to determine the class. Instead, we might want to get the raw probabilities (proportions) for each class and choose a cutoff probability for classification. For example, it might be 10 times costlier to classify a buyer as a non-buyer than to classify a non-buyer as a buyer. In such cases, we might accept a probability far lower than 0.5 to classify a case as buyer, whereas a simple majority would require a probability slightly greater than 0.5.</p>
<p>To compute raw probabilities instead of classifications, use the prob=TRUE argument. For example:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred5 &lt;- knn(train[<span class="number">4</span>:<span class="number">5</span>], val[,<span class="number">4</span>:<span class="number">5</span>], train[,<span class="number">3</span>], <span class="number">5</span>, prob=<span class="literal">TRUE</span>)</span><br><span class="line">&gt; pred5</span><br><span class="line">[<span class="number">1</span>] <span class="number">1.0000000</span> <span class="number">0.8000000</span> <span class="number">1.0000000</span> <span class="number">0.6000000</span> <span class="number">0.8000000</span></span><br><span class="line">[<span class="number">6</span>] <span class="number">0.6000000</span> <span class="number">0.6000000</span> <span class="number">0.8333333</span> <span class="number">0.6000000</span> <span class="number">0.8333333</span></span><br><span class="line">Levels: Buyer Non-buyer</span><br></pre></td></tr></table></figure>
<h2 id="Using-neural-networks-for-classification"><a href="#Using-neural-networks-for-classification" class="headerlink" title="Using neural networks for classification"></a>Using neural networks for classification</h2><p>The nnet package contains the nnet function for classification using neural networks.</p>
<h3 id="Getting-ready-31"><a href="#Getting-ready-31" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the nnet and caret packages, install them now. Download the data files for this chapter from the book’s website and place the banknote-authentication.csv file in your R working directory. We will use class as our target or outcome variable, and all the remaining variables as predictors. Using Neural Networks requires all the independent/predictor variables to be numeric and the dependent variable or outcomes to be 0-1. However, the nnet function does all the work of generating dummies (contrasts) and correctly handles categorical outcome variables.</p>
<h3 id="How-to-do-it…-31"><a href="#How-to-do-it…-31" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To use Neural networks for classification, follow these steps:</p>
<ol>
<li><p>Load the nnet and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(nnet)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn &lt;- read.csv(<span class="string">"banknote-authentication.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the outcome variable class to a factor:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn$class &lt;- factor(bn$class)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data. The predictor variables are already numeric and the outcome variable class is already 0-1, so we do not have to do any data preparation. Refer to Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis for details on how the following command works:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; train.idx &lt;- createDataPartition(bn$class, p=<span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the neural network model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- nnet(class ~., data=bn[train.idx,],size=<span class="number">3</span>,maxit=<span class="number">10000</span>,decay=<span class="number">.001</span>, rang = <span class="number">0.05</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Use model to predict for validation partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- predict(mod, newdata=bn[-train.idx,], type=<span class="string">"class"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build and display the error/classification-confusion matrix on the validation partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; table(bn[-train.idx,]$class, pred)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-30"><a href="#How-it-works…-30" class="headerlink" title="How it works…"></a>How it works…</h3><p>Steps 1 loads the packages needed and step 2 reads the data.</p>
<p>Step 3 converts the outcome variable class into a factor. For nnet to perform classification, we need the outcome variable to be a factor. If you have predictor variables that are really categorical but have numeric values, convert them to factors so that nnet can treat them appropriately. Since we have only numeric predictor variables, we need not do anything for the predictor variables.</p>
<p>Step 4 partitions the data. See Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis for more details on this step.</p>
<p>Step 5 builds the neural network model. We pass the formula and the dataset as the first two arguments:</p>
<ul>
<li>The size argument specifies the number of units in the internal layer (nnet works with just one hidden layer). One rule of thumb is to set the number of units in the hidden layer close to the mean of the number of units in the input and output layers. Higher values can give slightly better results at the expense of computation time.</li>
<li>maxit specifies the maximum number of iterations to perform to try for convergence. The algorithm stops if convergence is achieved earlier. If not, it stops after maxit iterations.</li>
<li>decay controls overfitting.</li>
</ul>
<p>Step 6 uses the model to generate predictions for the validation partition. We specified type = “class” to generate classifications.</p>
<p>Step 7 generates the error/classification-confusion matrix.</p>
<h3 id="There’s-more…-24"><a href="#There’s-more…-24" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We discuss in the following some ideas for exercising greater control over the model building and prediction steps.</p>
<h4 id="Exercising-greater-control-over-nnet"><a href="#Exercising-greater-control-over-nnet" class="headerlink" title="Exercising greater control over nnet"></a>Exercising greater control over nnet</h4><p>Use the following additional options:</p>
<ul>
<li>na.action: By default, any missing values cause the function to fail. You can specify na.action = na.omit to exclude cases with any missing values.</li>
<li>Use skip = TRUE to add skip level direct connections from input nodes to the output nodes.</li>
<li>Use the rang argument to specify the range for the initial random weights as [-rang, rang]; if the input values are large, select rang such that rang*(max|variable|) is close to 1.</li>
</ul>
<h4 id="Generating-raw-probabilities"><a href="#Generating-raw-probabilities" class="headerlink" title="Generating raw probabilities"></a>Generating raw probabilities</h4><p>Use the type = “raw” option to generate raw probabilities:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- predict(mod, newdata=bn[-train.idx,] type=<span class="string">"raw"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Classifying-using-linear-discriminant-function-analysis"><a href="#Classifying-using-linear-discriminant-function-analysis" class="headerlink" title="Classifying using linear discriminant function analysis"></a>Classifying using linear discriminant function analysis</h2><p>The MASS package contains the lda function for classification using linear discriminant function analysis.</p>
<h3 id="Getting-ready-32"><a href="#Getting-ready-32" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the MASS and caret packages, install them now. Download the data files for this chapter from the book’s website and place the banknote-authentication.csv file in your R working directory. We will use class as our target or outcome variable, and all the remaining variables as predictors.</p>
<h3 id="How-to-do-it…-32"><a href="#How-to-do-it…-32" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To classify using linear discriminant function analysis, follow these steps:</p>
<ol>
<li><p>Load the MASS and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(MASS)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn &lt;- read.csv(<span class="string">"banknote-authentication.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the outcome variable class to a factor:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn$class &lt;- factor(bn$class)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data. The predictor variables are already numeric and the outcome variable class is already 0-1, so we do not have to do any data preparation. Refer to Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis for details on how the following command works:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(bn$class, p = <span class="number">0.7</span>, list=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the Linear Discriminant Function model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; ldamod &lt;- lda(bn[t.idx, <span class="number">1</span>:<span class="number">4</span>], bn[t.idx, <span class="number">5</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Check how the model performs on the training partition (your results could differ because of random partitioning):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn[t.idx,<span class="string">"Pred"</span>] &lt;- predict(ldamod, bn[t.idx, <span class="number">1</span>:<span class="number">4</span>])$class</span><br><span class="line">&gt; table(bn[t.idx, <span class="string">"class"</span>], bn[t.idx, <span class="string">"Pred"</span>], dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">      Predicted</span><br><span class="line">Actual   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">     <span class="number">0</span> <span class="number">511</span>  <span class="number">23</span></span><br><span class="line">     <span class="number">1</span>   <span class="number">0</span> <span class="number">427</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate predictions on the validation partition and check performance (your results could differ):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn[-t.idx,<span class="string">"Pred"</span>] &lt;- predict(ldamod, bn[-t.idx, <span class="number">1</span>:<span class="number">4</span>])$class</span><br><span class="line">&gt; table(bn[-t.idx, <span class="string">"class"</span>], bn[-t.idx, <span class="string">"Pred"</span>], dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">      Predicted</span><br><span class="line">Actual   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">     <span class="number">0</span> <span class="number">219</span>   <span class="number">9</span></span><br><span class="line">     <span class="number">1</span>   <span class="number">0</span> <span class="number">183</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-31"><a href="#How-it-works…-31" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the MASS and caret packages and step 2 reads in the data.</p>
<p>Step 3 converts our outcome variable into a factor.</p>
<p>Step 4 partitions the data. We set the random seed to enable you to match your results with those we display.</p>
<p>Step 5 builds the linear discriminant function model. We pass the predictors as the first argument, and the outcome values as the second argument to the lda function. We can also supply the details as a formula—see the following There’s more… section.</p>
<p>Step 6 uses the predict function to generate the predictions for the training partition. We pass the model and the predictor variables. The class component of the returned object from the predict function contains the predicted class values. We then use the table function to generate a two-way cross-table.</p>
<p>Step 7 evaluates the model on the validation partition by repeating the preceding two steps on that partition.</p>
<h3 id="There’s-more…-25"><a href="#There’s-more…-25" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The lda function has several optional arguments and we have shown the most commonly used ones earlier.</p>
<h4 id="Using-the-formula-interface-for-lda"><a href="#Using-the-formula-interface-for-lda" class="headerlink" title="Using the formula interface for lda"></a>Using the formula interface for lda</h4><p>Instead of specifying the predictors and outcome as two separate arguments, we could have written the preceding step 5 as:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; ldamod &lt;- lda(class ~ ., data = bn[t.idx,])</span><br></pre></td></tr></table></figure>
<h3 id="See-also-…"><a href="#See-also-…" class="headerlink" title="See also …"></a>See also …</h3><p>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</p>
<h2 id="Classifying-using-logistic-regression"><a href="#Classifying-using-logistic-regression" class="headerlink" title="Classifying using logistic regression"></a>Classifying using logistic regression</h2><p>The stats package contains the glm function for classification using logistic regression.</p>
<h3 id="Getting-ready-33"><a href="#Getting-ready-33" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the caret package, install it now. Download the data files for this chapter from the book’s website and place the boston-housing-logistic.csv file in your R working directory. We will use CLASS as our target or outcome variable, and all the remaining variables as predictors. Our outcome variable has values of 0 or 1, with 0 representing neighborhoods with “Low” median home values and 1 representing neighborhoods with “High” median home values. Logistic regression requires all the independent/predictor variables to be numeric, and the dependent variable or outcome to be categorical and binary. However, the glm function does all the work of generating dummies (contrasts) for categorical variables.</p>
<h3 id="How-to-do-it…-33"><a href="#How-to-do-it…-33" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To classify using logistic regression, follow these steps:</p>
<ol>
<li><p>Load the caret package:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh &lt;- read.csv(<span class="string">"boston-housing-logistic.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the outcome variable class to a factor:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh$CLASS &lt;- factor(bh$CLASS, levels = c(<span class="number">0</span>,<span class="number">1</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data. The predictor variables are already numeric and the outcome variable CLASS is already 0-1, so we do not have to do any data preparation. Refer to the recipe Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis, for details on how the following command works:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; train.idx &lt;- createDataPartition(bh$CLASS, p=<span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the logistic regression model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; logit &lt;- glm(CLASS~., data = bh[train.idx,], family=binomial)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Examine the model (your results could differ because of random partitioning):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    &gt; summary(logit)</span><br><span class="line">     Call:</span><br><span class="line">    glm(formula = CLASS ~ ., family = binomial, data = bh[train.idx,</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">    Deviance Residuals:</span><br><span class="line">        Min       1Q   Median       3Q      Max</span><br><span class="line">-<span class="number">2.2629</span>  -<span class="number">0.3431</span>   <span class="number">0.0603</span>   <span class="number">0.3251</span>   <span class="number">3.3310</span></span><br><span class="line"></span><br><span class="line">    Coefficients:</span><br><span class="line">                  Estimate Std. Error z value Pr(&gt;|z|)</span><br><span class="line">    (Intercept)  <span class="number">33.452508</span>   <span class="number">4.947892</span>   <span class="number">6.761</span> <span class="number">1.37e-11</span> ***</span><br><span class="line">    NOX         -<span class="number">31.377153</span>   <span class="number">6.355135</span>  -<span class="number">4.937</span> <span class="number">7.92e-07</span> ***</span><br><span class="line">    DIS          -<span class="number">0.634391</span>   <span class="number">0.196799</span>  -<span class="number">3.224</span>  <span class="number">0.00127</span> **</span><br><span class="line">    RAD           <span class="number">0.259893</span>   <span class="number">0.087275</span>   <span class="number">2.978</span>  <span class="number">0.00290</span> **</span><br><span class="line">    TAX          -<span class="number">0.007966</span>   <span class="number">0.004476</span>  -<span class="number">1.780</span>  <span class="number">0.07513</span> .</span><br><span class="line">    PTRATIO      -<span class="number">0.827576</span>   <span class="number">0.138782</span>  -<span class="number">5.963</span> <span class="number">2.47e-09</span> ***</span><br><span class="line">    B             <span class="number">0.006798</span>   <span class="number">0.003070</span>   <span class="number">2.214</span>  <span class="number">0.02680</span> *</span><br><span class="line"></span><br><span class="line">    Si--------------------------gnif. codes:  <span class="number">0</span> <span class="string">'\*\*\*'</span> <span class="number">0.001</span> <span class="string">'\*\*'</span> <span class="number">0.01</span> <span class="string">'\*'</span> <span class="number">0.05</span> <span class="string">'.'</span> <span class="number">0.1</span> <span class="string">' '</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    (Dispersion parameter <span class="keyword">for</span> binomial family taken to be <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        Null deviance: <span class="number">353.03</span>  on <span class="number">254</span>  degrees of freedom</span><br><span class="line">    Residual deviance: <span class="number">135.08</span>  on <span class="number">248</span>  degrees of freedom</span><br><span class="line">    AIC: <span class="number">149.08</span></span><br><span class="line"></span><br><span class="line">    Number of Fisher Scoring iterations: <span class="number">6</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Compute the probabilities of “success” for cases in the validation partition and store them in a variable called PROB_SUCC:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh[-train.idx,<span class="string">"PROB_SUCC"</span>] &lt;- predict(logit, newdata = bh[-train.idx,], type=<span class="string">"response"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Classify the cases using a cutoff probability of 0.5:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh[-train.idx,<span class="string">"PRED_50"</span>] &lt;- ifelse(bh[-train.idx, <span class="string">"PROB_SUCC"</span>]&gt;= <span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate the error/classification-confusion matrix (your results could differ):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; table(bh[-train.idx, <span class="string">"CLASS"</span>], bh[-train.idx, <span class="string">"PRED_50"</span>], dnn=c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br><span class="line">      Predicted</span><br><span class="line">Actual  <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">     <span class="number">0</span> <span class="number">42</span>  <span class="number">9</span></span><br><span class="line">     <span class="number">1</span> <span class="number">10</span> <span class="number">47</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-32"><a href="#How-it-works…-32" class="headerlink" title="How it works…"></a>How it works…</h3><p>Steps 1 loads the caret package and step 2 reads the data file.</p>
<p>Step 3 converts the outcome variable to a factor. When the outcome variable is a factor, the glm function treats the first factor level as failure and the rest as “success.” In the present case, we wanted it to treat “0” as failure and “1” as success. To force 0 to be the first level (and hence “failure”) we specified levels = c(0,1).</p>
<p>Step 4 creates the data partition, (we set the random seed to enable you to match your results with those we display).</p>
<p>Step 5 builds the logistic regression model, and stores it in the logit variable. Note that we have specified the data to be only the cases in the training partition.</p>
<p>Step 6 displays important information about the model. The Deviance Residuals: section gives us an idea of the spread of the deviation of the log odds and not of the probability. The coefficients section shows us that all the coefficients used are statistically significant.</p>
<p>Step 7 uses logit, our logistic regression model, to generate probabilities for the cases in the validation partition. There is no direct function to make actual classifications using the model. This is why we first generate the probabilities by specifying type = “response”.</p>
<p>Step 8 uses a cutoff probability of 0.5 to classify the cases. You can use a different value depending on the relative costs of misclassification for the different classes.</p>
<p>Step 9 generates the error/classification-confusion matrix for the preceding classification.</p>
<h2 id="Using-AdaBoost-to-combine-classification-tree-models"><a href="#Using-AdaBoost-to-combine-classification-tree-models" class="headerlink" title="Using AdaBoost to combine classification tree models"></a>Using AdaBoost to combine classification tree models</h2><p>R has several libraries that implement boosting where we combine many relatively inaccurate models to get a much more accurate model. The ada package provides boosting functionality on top of classification trees.</p>
<h3 id="Getting-ready-34"><a href="#Getting-ready-34" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the ada and caret package, install them now. Download the data files for this chapter from the book’s website and place the banknote-authentication.csv file in your R working directory. We will use class as our target or outcome variable, and all the remaining variables as predictors.</p>
<h3 id="How-to-do-it…-34"><a href="#How-to-do-it…-34" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To use AdaBoost for combining classification tree models, follow these steps:</p>
<ol>
<li><p>Load the caret and ada packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br><span class="line">&gt; <span class="keyword">library</span>(ada)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn &lt;- read.csv(<span class="string">"banknote-authentication.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the outcome variable class to a factor:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn$class &lt;- factor(bn$class)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create partitions:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(bn$class, p=<span class="number">0.7</span>, list=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create an rpart.control object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; cont &lt;- rpart.control()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- ada(class ~ ., data = bn[t.idx,], iter=<span class="number">50</span>, loss=<span class="string">"e"</span>, type=<span class="string">"discrete"</span>, control = cont)</span><br></pre></td></tr></table></figure>
</li>
<li><p>View the model results—among other things, they show the error/classification-confusion matrix on the training partition (your results could differ because of random partitioning):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod</span><br><span class="line"></span><br><span class="line"> Call:</span><br><span class="line">ada(class ~ ., data = bn[t.idx, ], iter = <span class="number">50</span>, loss = <span class="string">"e"</span>, type = <span class="string">"discrete"</span>,</span><br><span class="line">    control = cont)</span><br><span class="line"></span><br><span class="line">Loss: exponential Method: discrete   Iteration: <span class="number">50</span></span><br><span class="line"></span><br><span class="line">Final Confusion Matrix <span class="keyword">for</span> Data:</span><br><span class="line">          Final Prediction</span><br><span class="line">True value   <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">         <span class="number">0</span> <span class="number">534</span>   <span class="number">0</span></span><br><span class="line">         <span class="number">1</span>   <span class="number">0</span> <span class="number">427</span></span><br><span class="line"></span><br><span class="line">Train Error: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Out-Of-Bag Error:  <span class="number">0.002</span>  iteration= <span class="number">49</span></span><br><span class="line"></span><br><span class="line">Additional Estimates of number of iterations:</span><br><span class="line"></span><br><span class="line">train.err1 train.kap1</span><br><span class="line">        <span class="number">33</span>         <span class="number">33</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate predictions on the validation partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- predict(mod, newdata = bn[-t.idx,], type = <span class="string">"vector"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the error/classification-confusion matrix on the validation partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; table(bn[-t.idx, <span class="string">"class"</span>], pred, dnn = c(<span class="string">"Actual"</span>, <span class="string">"Predicted"</span>))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-33"><a href="#How-it-works…-33" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the necessary caret and ada packages.</p>
<p>Step 2 reads in the data.</p>
<p>Step 3 converts the outcome variable class to a factor because we are applying a classification method.</p>
<p>Step 4 creates the partitions (we set the random seed to enable you to match your results with those we display).</p>
<p>The ada function uses the rpart function to generate many classification trees. To do this, it needs us to supply an rpart.control object. Step 5 creates a default rpart.control() object.</p>
<p>Step 6 builds the AdaBoost model. We pass the formula and the data frame for which we want to build the model and enter type = “discrete” to specify classification as opposed to regression. In addition, we also specify the number of boosting iterations and loss=”e” for boosting under exponential loss.</p>
<p>Step 7 displays the model.</p>
<p>Step 8 builds the predictions on the validation partition and then step 9 builds the error/classification-confusion matrix.</p>
<hr>
<h1 id="Chapter-4-Give-Me-a-Number-–-Regression"><a href="#Chapter-4-Give-Me-a-Number-–-Regression" class="headerlink" title="Chapter 4. Give Me a Number – Regression"></a>Chapter 4. Give Me a Number – Regression</h1><p>In this chapter, you will cover:</p>
<ul>
<li>Computing the root mean squared error</li>
<li>Building KNN models for regression</li>
<li>Performing linear regression</li>
<li>Performing variable selection in linear regression</li>
<li>Building regression trees</li>
<li>Building random forest models for regression</li>
<li>Using neural networks for regression</li>
<li>Performing k-fold cross-validation</li>
<li>Performing leave-one-out-cross-validation</li>
</ul>
<h2 id="Introduction-3"><a href="#Introduction-3" class="headerlink" title="Introduction"></a>Introduction</h2><p>In many situations, data analysts seek to make numerical predictions and use regression techniques to do so. Some examples can be the future sales of a product, the amount of deposits that a bank will receive during the next month, the number of copies that a particular book will sell, and the expected selling price for a used car. This chapter covers recipes to use R to apply several regression techniques.</p>
<h2 id="Computing-the-root-mean-squared-error"><a href="#Computing-the-root-mean-squared-error" class="headerlink" title="Computing the root mean squared error"></a>Computing the root mean squared error</h2><p>You may build a regression model and want to evaluate the model by comparing the model’s predictions with the actual outcomes. You will generally evaluate a model’s performance on the training data, but will rely on the model’s performance on the hold out data to get an objective measure.</p>
<h3 id="Getting-ready-35"><a href="#Getting-ready-35" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do so now and ensure that the rmse.csv file is in your R working directory. The file has data about a set of actual prices and the predicted values from some regression method. We will compute the root mean squared (RMS) error of these predictions.</p>
<h3 id="How-to-do-it…-35"><a href="#How-to-do-it…-35" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>When using any regression technique, you will be able to generate predictions. This recipe shows you how to calculate the RMS error given the predicted and actual numerical values of the outcome variable:</p>
<ol>
<li><p>Compute the RMS error as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; dat &lt;- read.csv(<span class="string">"rmse-example.csv"</span>)</span><br><span class="line">&gt; rmse &lt;- sqrt(mean((dat$price-dat$pred)^<span class="number">2</span>))</span><br><span class="line">&gt; rmse</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">2.934995</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the results and show the 45 degree line:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(dat$price, dat$pred, xlab = <span class="string">"Actual"</span>, ylab = <span class="string">"Predicted"</span>)</span><br><span class="line">&gt; abline(<span class="number">0</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p> The following output is obtained as a reult of the preceding command:</p>
<p> <img src="img/4_2_1.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-34"><a href="#How-it-works…-34" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 computes the RMS error as defined—the square root of the mean squared errors. The dat$price – dat$pred expression computes the vector of errors, and the code surrounding it computes the average of the squared errors and then finds the square root.</p>
<p>Step 2 generates the standard scatterplot and then adds on the 45 degree line.</p>
<h3 id="There’s-more…-26"><a href="#There’s-more…-26" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>Since we compute RMS errors quite often, the following may be useful.</p>
<h4 id="Using-a-convenience-function-to-compute-the-RMS-error"><a href="#Using-a-convenience-function-to-compute-the-RMS-error" class="headerlink" title="Using a convenience function to compute the RMS error"></a>Using a convenience function to compute the RMS error</h4><p>The following function may be handy when we need to compute the RMS error:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rdacb.rmse &lt;- <span class="keyword">function</span>(actual, predicted) &#123;</span><br><span class="line">  <span class="keyword">return</span> (sqrt(mean((actual-predicted)^<span class="number">2</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Armed with the function, we can compute the RMS error as:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; rmse &lt;- rdacb.rmse(dat$price, dat$pred)</span><br></pre></td></tr></table></figure>
<h2 id="Building-KNN-models-for-regression"><a href="#Building-KNN-models-for-regression" class="headerlink" title="Building KNN models for regression"></a>Building KNN models for regression</h2><p>The FNN package provides the necessary functions to apply the KNN technique for regression. In this recipe, we look at the use of the knn.reg function to build the model and then the process of predicting with the model as well. We also show some additional convenience mechanisms to make the process easier.</p>
<h3 id="Getting-ready-36"><a href="#Getting-ready-36" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the FNN, dummies, caret, and scales packages if you do not already have them installed. If you have not already downloaded the data files for this chapter, do so now and ensure that the education.csv file is in R working directory. The file has data about several school districts in the US. The following table describes the variables:</p>
<p>|Variable|Meaning|<br>|:=——|——-|<br>|state|US state code|<br>|region|Region of the country (1 = NE, …)|<br>|urban|Number of residents per thousand residing in urban areas in 1970|<br>|income|Per-capita personal income in 1973|<br>|under18|Number of residents per thousand under 18 years of age in 1974|<br>|expense|Per capita expenditure on public education in a state, projected for 1975|</p>
<p>We will build a knn model to predict expense based on all other predictors except state.</p>
<h3 id="How-to-do-it…-36"><a href="#How-to-do-it…-36" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To build KNN models for regressions, follow these steps:</p>
<ol>
<li><p>Load the dummies, FNN, scales, and caret packages as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(dummies)</span><br><span class="line">&gt; <span class="keyword">library</span>(FNN)</span><br><span class="line">&gt; <span class="keyword">library</span>(scales)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; educ &lt;- read.csv(<span class="string">"education.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate dummies for the categorical variable region and add them to educ as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dums &lt;- dummy(educ$region, sep=<span class="string">"_"</span>)</span><br><span class="line">&gt; educ &lt;- cbind(educ, dums)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Because KNN performs distance computations, we should either rescale or standardize the predictors. In the present example, we have three numeric predictors and a categorical predictor in the form of three dummy variables. Standardizing dummy variables is tricky, and hence we will scale the numeric ones to [0, 1] and leave the dummies alone because they are already in the 0-1 range:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; educ$urban.s &lt;- rescale(educ$urban)</span><br><span class="line">&gt; educ$income.s &lt;- rescale(educ$income)</span><br><span class="line">&gt; educ$under18.s &lt;- rescale(educ$under18)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create three partitions (because we are creating random partitions, your results can differ) as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(educ$expense, p = <span class="number">0.6</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; trg &lt;- educ[t.idx,]</span><br><span class="line">&gt; rest &lt;- educ[-t.idx,]</span><br><span class="line">&gt; set.seed(<span class="number">2000</span>)</span><br><span class="line">&gt; v.idx &lt;- createDataPartition(rest$expense, p=<span class="number">0.5</span>, list=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; val &lt;- rest[v.idx,]</span><br><span class="line">&gt; test &lt;- rest[-v.idx,]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the model for several values of k. In the following code, we show how to compute the RMS error from scratch. You can also use the convenience rdacb.rmse function, which was shown in the recipe Computing the root mean squared error earlier in this chapter:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># for k=1</span></span><br><span class="line">&gt; res1 &lt;- knn.reg(trg[, <span class="number">7</span>:<span class="number">12</span>], val[,<span class="number">7</span>:<span class="number">12</span>], trg[,<span class="number">6</span>], <span class="number">1</span>, algorithm=<span class="string">"brute"</span>)</span><br><span class="line">&gt; rmse1 = sqrt(mean((res1$pred-val[,<span class="number">6</span>])^<span class="number">2</span>))</span><br><span class="line">&gt; rmse1</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">59.66909</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Alternately you could use the following to</span></span><br><span class="line">&gt; <span class="comment"># compute the RMS error. See the recipe</span></span><br><span class="line">&gt; <span class="comment"># "Compute the Root Mean Squared error" earlier</span></span><br><span class="line">&gt; <span class="comment"># in this chapter</span></span><br><span class="line">&gt; rmse1 = rdacb.rmse(res1$pred, val[,<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># for k=2</span></span><br><span class="line">&gt; res2 &lt;- knn.reg(trg[, <span class="number">7</span>:<span class="number">12</span>], val[,<span class="number">7</span>:<span class="number">12</span>], trg[,<span class="number">6</span>], <span class="number">2</span>, algorithm=<span class="string">"brute"</span>)</span><br><span class="line">&gt; rmse2 = sqrt(mean((res2$pred-val[,<span class="number">6</span>])^<span class="number">2</span>))</span><br><span class="line">&gt; rmse2</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">38.09002</span></span><br><span class="line"></span><br><span class="line">&gt;<span class="comment"># for k=3</span></span><br><span class="line">&gt; res3 &lt;- knn.reg(trg[, <span class="number">7</span>:<span class="number">12</span>], val[,<span class="number">7</span>:<span class="number">12</span>], trg[,<span class="number">6</span>], <span class="number">3</span>, algorithm=<span class="string">"brute"</span>)</span><br><span class="line">&gt; rmse3 = sqrt(mean((res3$pred-val[,<span class="number">6</span>])^<span class="number">2</span>))</span><br><span class="line">&gt; rmse3</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">44.21224</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># for k=4</span></span><br><span class="line">&gt; res4 &lt;- knn.reg(trg[, <span class="number">7</span>:<span class="number">12</span>], val[,<span class="number">7</span>:<span class="number">12</span>], trg[,<span class="number">6</span>], <span class="number">4</span>, algorithm=<span class="string">"brute"</span>)</span><br><span class="line">&gt; rmse4 = sqrt(mean((res4$pred-val[,<span class="number">6</span>])^<span class="number">2</span>))</span><br><span class="line">&gt; rmse4</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">51.66557</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>We obtained the lowest RMS error for k=2. Evaluate the model on the test partition as follows:</p>
 <figure class="highlight plain"><figcaption><span>res.test <- knn.reg(trg[,="" 7:12],="" test[,7:12],="" trg[,6],="" 2,="" algorithm="brute" )<="" span=""></-></span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; rmse.test = sqrt(mean((res.test$pred-test[,6])^2))</span><br><span class="line">rmse.test</span><br><span class="line"></span><br><span class="line">[1] 35.05442</span><br></pre></td></tr></table></figure>
<p> We obtain a much lower RMS error on the test partition than on the validation partition. Of course, this cannot be trusted too much since our dataset was so small.</p>
</li>
</ol>
<h3 id="How-it-works…-35"><a href="#How-it-works…-35" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the required packages and step 2 reads the data.</p>
<p>Since KNN requires all the predictors to be numeric, step 3 uses the dummy function from the dummies package to generate dummies for the categorical variable region and then adds the resulting dummy variables to the educ data frame.</p>
<p>Step 4 scales the numeric predictor variables to the [0,1] range using the rescale function from the scales package. Standardizing the numerical predictors will be another option, but standardizing dummy variables will be tricky. Some analysts standardize numerical predictors and leave the dummy variables as they are. However, for consistency, we choose to have all of our predictors in the [0,1] range. Since the dummies are already in that range, we rescale only the other predictors.</p>
<p>Step 5 creates the three partitions that KNN requires. We set the random seed to enable you to match your results with those that we display. See recipe Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis for more details. Since we have only 50 cases in our dataset, we have chosen to partition it roughly into 60 %, 20 %, and 20 %. Instead of creating three partitions, we can manage with two and have the model building process use “leave one out” cross-validation. We discuss this under the There’s more… section.</p>
<p>Step 6 builds the models for k=1 through k=4. We use only three of the four dummy variables. It invokes the knn.reg function and passes the following as arguments:</p>
<ul>
<li>Training predictors.</li>
<li>Validation predictors.</li>
<li>Outcome variable in the training partition.</li>
<li>Value for k.</li>
<li>The algorithm to use for distance computations. We specified brute to use the brute-force method.</li>
</ul>
<p><strong>Tip</strong></p>
<p>If the dataset is large, one of the other options <code>kd_tree</code> or <code>cover_tree</code> may run faster.</p>
<p>Step 6 has highly repetitive code and we show a convenience function under the There’s more… section to get all the results using a single command.</p>
<p>The model resulting from the call has several components. To compute the RMS error, we have used the pred component, which contains the predicted values.</p>
<p>Step 7 repeats the process for the test partition.</p>
<h3 id="There’s-more…-27"><a href="#There’s-more…-27" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>Here we discuss some variations in running KNN.</p>
<h4 id="Running-KNN-with-cross-validation-in-place-of-validation-partition"><a href="#Running-KNN-with-cross-validation-in-place-of-validation-partition" class="headerlink" title="Running KNN with cross-validation in place of validation partition"></a>Running KNN with cross-validation in place of validation partition</h4><p>We used three partitions in the preceding code. A different approach will be to use two partitions. In this case, knn.reg will use “leave one out” cross-validation and predict for each case of the training partition itself. To use this mode, we pass only the training partition as argument and leave the other partition as NULL. After performing steps 1 through 4 from the main recipe, do the following:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; t.idx &lt;- createDataPartition(educ$expense, p = <span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; trg &lt;- educ[t.idx,]</span><br><span class="line">&gt; val &lt;- educ[-t.idx,]</span><br><span class="line">&gt; res1 &lt;- knn.reg(trg[,<span class="number">7</span>:<span class="number">12</span>], test = <span class="literal">NULL</span>, y = trg[,<span class="number">6</span>], k=<span class="number">2</span>, algorithm=<span class="string">"brute"</span>)</span><br><span class="line">&gt; <span class="comment"># When run in this mode, the result object contains</span></span><br><span class="line">&gt; <span class="comment"># the residuals which we can use to compute rmse</span></span><br><span class="line">&gt; rmse &lt;- sqrt(mean(res1$residuals^<span class="number">2</span>))</span><br><span class="line">&gt; <span class="comment"># and so on for other values of k</span></span><br></pre></td></tr></table></figure>
<h4 id="Using-a-convenience-function-to-run-KNN"><a href="#Using-a-convenience-function-to-run-KNN" class="headerlink" title="Using a convenience function to run KNN"></a>Using a convenience function to run KNN</h4><p>We would normally run knn and compute the RMS error. The following convenience function can help:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rdacb.knn.reg &lt;- <span class="keyword">function</span> (trg_predictors, val_predictors, trg_target, val_target, k) &#123;</span><br><span class="line">  <span class="keyword">library</span>(FNN)</span><br><span class="line">  res &lt;- knn.reg(trg_predictors, val_predictors, trg_target, k, algorithm = <span class="string">"brute"</span>)</span><br><span class="line">  errors &lt;- res$pred - val_target</span><br><span class="line">  rmse &lt;- sqrt(sum(errors * errors)/nrow(val_predictors))</span><br><span class="line">  cat(paste(<span class="string">"RMSE for k="</span>, toString(k), <span class="string">":"</span>, sep = <span class="string">""</span>), rmse, <span class="string">"\n"</span>)</span><br><span class="line">  rmse</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With the preceding function, we can execute the following after reading the data, creating dummies, rescaling the predictors and partitioning—that is, executing steps 1 through 4 of the main recipe:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(educ$expense, p = <span class="number">0.6</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; trg &lt;- educ[t.idx,]</span><br><span class="line">&gt; rest &lt;- educ[-t.idx,]</span><br><span class="line">&gt;set.seed(<span class="number">2000</span>)</span><br><span class="line">&gt; v.idx &lt;- createDataPartition(rest$expense, p=<span class="number">0.5</span>, list=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; val &lt;- rest[v.idx,]</span><br><span class="line">&gt; test &lt;- rest[-v.idx,]</span><br><span class="line">&gt; rdacb.knn.reg(trg[,<span class="number">7</span>:<span class="number">12</span>], val[,<span class="number">7</span>:<span class="number">12</span>], trg[,<span class="number">6</span>], val[,<span class="number">6</span>], <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">RMSE <span class="keyword">for</span> k=<span class="number">1</span>: <span class="number">59.66909</span></span><br><span class="line">[<span class="number">1</span>] <span class="number">59.66909</span></span><br><span class="line">&gt; rdacb.knn.reg(trg[,<span class="number">7</span>:<span class="number">12</span>], val[,<span class="number">7</span>:<span class="number">12</span>], trg[,<span class="number">6</span>], val[,<span class="number">6</span>], <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">RMSE <span class="keyword">for</span> k=<span class="number">2</span>: <span class="number">38.09002</span></span><br><span class="line">[<span class="number">1</span>] <span class="number">38.09002</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># and so on</span></span><br></pre></td></tr></table></figure>
<h4 id="Using-a-convenience-function-to-run-KNN-for-multiple-k-values"><a href="#Using-a-convenience-function-to-run-KNN-for-multiple-k-values" class="headerlink" title="Using a convenience function to run KNN for multiple k values"></a>Using a convenience function to run KNN for multiple k values</h4><p>Running knn for several values of k to choose the best one involves repetitively executing almost similar lines of code several times. We can automate the process with the following convenience function that runs knn for multiple values of k, reports the RMS error for each, and also produces a scree plot of the RMS errors:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rdacb.knn.reg.multi &lt;- <span class="keyword">function</span> (trg_predictors, val_predictors, trg_target, val_target, start_k, end_k)</span><br><span class="line">&#123;</span><br><span class="line">  rms_errors &lt;- vector()</span><br><span class="line">  <span class="keyword">for</span> (k <span class="keyword">in</span> start_k:end_k) &#123;</span><br><span class="line">    rms_error &lt;- rdacb.knn.reg(trg_predictors, val_predictors,</span><br><span class="line">                               trg_target, val_target, k)</span><br><span class="line">    rms_errors &lt;- c(rms_errors, rms_error)</span><br><span class="line">  &#125;</span><br><span class="line">  plot(rms_errors, type = <span class="string">"o"</span>, xlab = <span class="string">"k"</span>, ylab = <span class="string">"RMSE"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With the preceding function, we can execute the following after reading the data, creating dummies, rescaling the predictors and partitioning—that is, executing steps 1 through 4 of the main recipe. The code runs knn.reg for values of k from 1 to 5:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; rdacb.knn.reg.multi(trg[,<span class="number">7</span>:<span class="number">12</span>], val[,<span class="number">7</span>:<span class="number">12</span>], trg[,<span class="number">6</span>], val[,<span class="number">6</span>], <span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">RMSE <span class="keyword">for</span> k=<span class="number">1</span>: <span class="number">59.66909</span></span><br><span class="line">RMSE <span class="keyword">for</span> k=<span class="number">2</span>: <span class="number">38.09002</span></span><br><span class="line">RMSE <span class="keyword">for</span> k=<span class="number">3</span>: <span class="number">44.21224</span></span><br><span class="line">RMSE <span class="keyword">for</span> k=<span class="number">4</span>: <span class="number">51.66557</span></span><br><span class="line">RMSE <span class="keyword">for</span> k=<span class="number">5</span>: <span class="number">50.33476</span></span><br></pre></td></tr></table></figure>
<p>The preceding code also produces a plot of the RMS errors, as shown in the following:</p>
<p><img src="img/4_4_1.jpeg" alt=""></p>
<h3 id="See-also…-12"><a href="#See-also…-12" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
<li>Computing the root mean squared error in this chapter</li>
<li>Classifying using the KNN approach in Chapter 3, Where Does It Belong? – Classification</li>
</ul>
<h2 id="Performing-linear-regression"><a href="#Performing-linear-regression" class="headerlink" title="Performing linear regression"></a>Performing linear regression</h2><p>In this recipe, we discuss linear regression, arguably the most widely used technique. The stats package has the functionality for linear regression and R loads it automatically at startup.</p>
<h3 id="Getting-ready-37"><a href="#Getting-ready-37" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the data files for this chapter and ensure that the auto-mpg.csv file is in your R working directory. Install the caret package if you have not already done so. We want to predict mpg based on cylinders, displacement, horsepower, weight, and acceleration variables.</p>
<h3 id="How-to-do-it…-37"><a href="#How-to-do-it…-37" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To perform linear regression, follow these steps:</p>
<ol>
<li><p>Load the caret package:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the categorical variable cylinders into a factor with appropriate renaming of the levels:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto$cylinders &lt;- factor(auto$cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create partitions:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(auto$mpg, p = <span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>See the names of the variables in the data frame:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; names(auto)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"No"</span>           <span class="string">"mpg"</span></span><br><span class="line">[<span class="number">3</span>] <span class="string">"cylinders"</span>    <span class="string">"displacement"</span></span><br><span class="line">[<span class="number">5</span>] <span class="string">"horsepower"</span>   <span class="string">"weight"</span></span><br><span class="line">[<span class="number">7</span>] <span class="string">"acceleration"</span> <span class="string">"model_year"</span></span><br><span class="line">[<span class="number">9</span>] <span class="string">"car_name"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the linear regression model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- lm(mpg ~ ., data = auto[t.idx, -c(<span class="number">1</span>,<span class="number">8</span>,<span class="number">9</span>)])</span><br></pre></td></tr></table></figure>
</li>
<li><p>View the basic results (your results may differ because of random sampling differences in creating the partitions):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod</span><br><span class="line"></span><br><span class="line">Call:</span><br><span class="line">lm(formula = mpg ~ ., data = auto[t.idx, -c(<span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>)])</span><br><span class="line"></span><br><span class="line">Coefficients:</span><br><span class="line"></span><br><span class="line">  (Intercept)  cylinders4cyl  cylinders5cyl  cylinders6cyl</span><br><span class="line">    <span class="number">39.450422</span>       <span class="number">6.466511</span>       <span class="number">4.769794</span>       <span class="number">1.967411</span></span><br><span class="line">cylinders8cyl   displacement     horsepower         weight</span><br><span class="line">     <span class="number">6.291938</span>       <span class="number">0.004790</span>      -<span class="number">0.081642</span>      -<span class="number">0.004666</span></span><br><span class="line"> acceleration</span><br><span class="line">     <span class="number">0.003576</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>View more detailed results (your results may differ because of random sampling differences in creating the partitions):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    &gt; summary(mod)</span><br><span class="line"></span><br><span class="line">    Call:</span><br><span class="line">    lm(formula = mpg ~ ., data = auto[t.idx, -c(<span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>)])</span><br><span class="line"></span><br><span class="line">    Residuals:</span><br><span class="line">        Min      1Q  Median      3Q     Max</span><br><span class="line"><span class="number">9</span>--------------------------<span class="number">.8488</span> -<span class="number">2.4015</span> -<span class="number">0.5022</span>  <span class="number">1.8422</span> <span class="number">15.3597</span></span><br><span class="line"></span><br><span class="line">    Coefficients:</span><br><span class="line">                    Estimate Std. Error t value Pr(&gt;|t|)</span><br><span class="line">    (Intercept)   <span class="number">39.4504219</span>  <span class="number">3.3806186</span>  <span class="number">11.670</span>  &lt; <span class="number">2e-16</span> ***</span><br><span class="line">    cylinders4cyl  <span class="number">6.4665111</span>  <span class="number">2.1248876</span>   <span class="number">3.043</span>  <span class="number">0.00257</span> **</span><br><span class="line">    cylinders5cyl  <span class="number">4.7697941</span>  <span class="number">3.5603033</span>   <span class="number">1.340</span>  <span class="number">0.18146</span></span><br><span class="line">    cylinders6cyl  <span class="number">1.9674114</span>  <span class="number">2.4786061</span>   <span class="number">0.794</span>  <span class="number">0.42803</span></span><br><span class="line">    cylinders8cyl  <span class="number">6.2919383</span>  <span class="number">2.9612774</span>   <span class="number">2.125</span>  <span class="number">0.03451</span> *</span><br><span class="line">    displacement   <span class="number">0.0047899</span>  <span class="number">0.0109108</span>   <span class="number">0.439</span>  <span class="number">0.66100</span></span><br><span class="line">    horsepower    -<span class="number">0.0816418</span>  <span class="number">0.0200237</span>  -<span class="number">4.077</span> <span class="number">5.99e-05</span> ***</span><br><span class="line">    weight        -<span class="number">0.0046663</span>  <span class="number">0.0009857</span>  -<span class="number">4.734</span> <span class="number">3.55e-06</span> ***</span><br><span class="line">    acceleration   <span class="number">0.0035761</span>  <span class="number">0.1426022</span>   <span class="number">0.025</span>  <span class="number">0.98001</span></span><br><span class="line">---</span><br><span class="line">    Signif. codes:  <span class="number">0</span> <span class="string">'\*\*\*'</span> <span class="number">0.001</span> <span class="string">'\*\*'</span> <span class="number">0.01</span> <span class="string">'\*'</span> <span class="number">0.05</span> <span class="string">'.'</span> <span class="number">0.1</span> <span class="string">' '</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    Residual standard error: <span class="number">3.952</span> on <span class="number">271</span> degrees of freedom</span><br><span class="line">    Multiple R-squared:  <span class="number">0.756</span>, Adjusted R-squared:  <span class="number">0.7488</span></span><br><span class="line">    <span class="literal">F</span>-statistic:   <span class="number">105</span> on <span class="number">8</span> and <span class="number">271</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate predictions for the test data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pred &lt;- predict(mod, auto[-t.idx, -c(<span class="number">1</span>,<span class="number">8</span>,<span class="number">9</span>)])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Compute the RMS error on the test data (your results can differ):</p>
<figure class="highlight plain"><figcaption><span>sqrt(mean((pred - auto[-t.idx, 2])^2))</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1] 4.333631</span><br></pre></td></tr></table></figure>
</li>
<li><p>View diagnostic plots of the model:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">    &gt; par(mfrow = c(<span class="number">2</span>,<span class="number">2</span>))</span><br><span class="line">    &gt; plot(mod)</span><br><span class="line">    &gt; par(mfrow = c(<span class="number">1</span>,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    The following diagnostic plots are obtained as an output:</span><br><span class="line"></span><br><span class="line">    ![](img/4_5_<span class="number">1.</span>jpeg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### How it works...</span></span><br><span class="line"></span><br><span class="line">Step <span class="number">1</span> loads the caret package, step <span class="number">2</span> reads the data, and step <span class="number">3</span> converts the categorical variable cylinders (which has numeric values which R treats as a number by default) into a factor.</span><br><span class="line"></span><br><span class="line">Step <span class="number">4</span> creates the partitions—see recipe Creating random data partitions <span class="keyword">in</span> Chapter <span class="number">2</span>, What<span class="string">'s in There? – Exploratory Data Analysis for more details. We set the random seed to enable you to match your results with what we have displayed.</span><br><span class="line"></span><br><span class="line">Step 5 prints the variable names in the file so that we can use the appropriate variables in the linear regression model.</span><br><span class="line"></span><br><span class="line">Step 6 uses the lm function which builds the linear regression model. We specified data = auto[t.idx, -c(1,8,9)] because we want the model to use only the training data and because we do not want to use No, model_year, and car_name, which correspond to variables 1, 8, and 9, respectively. We could instead have included all variables, but that would have meant having to explicitly specify only the required predictors in the formula expression. We chose the shorter version.</span><br><span class="line"></span><br><span class="line">Although one of our predictors, cylinders, is a factor (categorical variable), we did not generate dummies for it because the lm function takes care of this automatically, and the regression coefficients in the output show this clearly.</span><br><span class="line"></span><br><span class="line">Step 7 shows how we can simply print the value of the model variable to get the values of the regression coefficients.</span><br><span class="line"></span><br><span class="line">Step 8 uses the summary function to get more information about the model:</span><br><span class="line"></span><br><span class="line">![](img/4_5_2.jpeg)</span><br><span class="line"></span><br><span class="line">In the detailed output, the Residuals section shows the distribution of the residuals on the training data through the quartiles. The Coefficients section gives details about the coefficients. The first column, Estimate, gives the estimates of the regression coefficients. The second column, Std. Error, gives the standard error of that estimate. The third column converts this standard error into a t value by dividing the coefficient by the standard error. The Pr (&gt; |t|) column converts the t value into a probability of the coefficient being 0. The annotation after the last column symbolically shows the level of significance of the coefficient estimate by a dot, blank, or a few stars. The legends below the table explain what the annotation means. It is customary to consider a coefficient to be significant at a 95 % level of significance (that is, probability being less than 0.05), which is represented by a "*".</span><br><span class="line"></span><br><span class="line">The next section gives information about how the regression performed as a whole. The Residual standard error is just the RMS adjusted for the degrees of freedom and is an excellent indicator of the average deviation of the predicted value from the actual value. The Adjusted R-squared value tells us what percentage of the variation in the outcome variable the regression model explains. The last line shows the F-statistic and the corresponding p-value for the whole regression.</span><br><span class="line"></span><br><span class="line">Step 9 generates the predictions on the test data using the predict function.</span><br><span class="line"></span><br><span class="line">Step 10 computes the RMS error.</span><br><span class="line"></span><br><span class="line">Step 11 generates the diagnostic plots. Since the standard plot function for lm produces four plots, we set up a matrix of four plots up front before calling the function and reset it after we finish plotting:</span><br><span class="line"></span><br><span class="line">- Residuals vs Fitted: As its name suggests, this plots the residuals against the values fitted by the model to enable us to examine if the residuals exhibit a trend. Ideally, we would like them to be trendless and almost a horizontal straight line at 0. In our example, we see a very slight trend.</span><br><span class="line">- Normal Q-Q: This plot helps us to check the extent to which the residuals are normally distributed by plotting the standardized residuals against the theoretical quartiles for the standard normal distribution. If the points all lie close to the 45 degree line, then we will know that the normality condition is met. In our example, we note that at the right extreme or at high values of the residuals, the standardized residuals are higher than expected and do not meet the normality requirement.</span><br><span class="line">- Scale Location: This plot is very similar to the first plot, except that the square root of the standardized residuals is plotted against the fitted values. Once again this is used to detect if the residuals exhibit any trend.</span><br><span class="line">- Residuals vs Leverage: You can use this plot to identify outlier cases that are exerting undue influence on the model. In our example, the labeled cases 150, 290, and 316 can be candidates for removal.</span><br><span class="line"></span><br><span class="line">### There'</span>s more...</span><br><span class="line"></span><br><span class="line">We discuss <span class="keyword">in</span> the following sections a few options <span class="keyword">for</span> using the lm function.</span><br><span class="line"></span><br><span class="line"><span class="comment">#### Forcing lm to use a specific factor level as the reference</span></span><br><span class="line"></span><br><span class="line">By default, lm uses the lowest factor as the reference level. To use a different one as reference, we can use the relevel function. Our original model uses 3cyl as the reference level. To force lm to instead use 4cyl as the reference:</span><br><span class="line"></span><br><span class="line">```R</span><br><span class="line">&gt; auto &lt;- within(auto, cylinders &lt;- relevel(cylinders, ref = "4cyl") )</span><br><span class="line">&gt; mod &lt;- lm(mpg ~., data = auto[t.idx, -c(1, 8, 9)])</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>The resulting model will not have a coefficient for 4cyl.</p>
<h4 id="Using-other-options-in-the-formula-expression-for-linear-models"><a href="#Using-other-options-in-the-formula-expression-for-linear-models" class="headerlink" title="Using other options in the formula expression for linear models"></a>Using other options in the formula expression for linear models</h4><p>Our example only showed the most common form of the formula for lm. The following table shows options to create models with interaction effects or to create models that apply arbitrary functions to predictor variables:</p>
<p><img src="img/4_5_3.jpeg" alt=""></p>
<h3 id="See-also…-13"><a href="#See-also…-13" class="headerlink" title="See also…"></a>See also…</h3><p>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis<br>Performing variable selection in linear regression in this chapter</p>
<h2 id="Performing-variable-selection-in-linear-regression"><a href="#Performing-variable-selection-in-linear-regression" class="headerlink" title="Performing variable selection in linear regression"></a>Performing variable selection in linear regression</h2><p>The MASS package has the functionality for variable selection and this recipe illustrates its use.</p>
<h3 id="Getting-ready-38"><a href="#Getting-ready-38" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the data files for this chapter and ensure that the auto-mpg.csv file is in your R working directory. We want to predict mpg based on cylinders, displacement, horsepower, weight, and acceleration.</p>
<h2 id="How-to-do-it…-38"><a href="#How-to-do-it…-38" class="headerlink" title="How to do it…"></a>How to do it…</h2><p>To perform variable selection in linear regression, follow the steps below:</p>
<ol>
<li><p>Load the caret and MASS packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br><span class="line">&gt; <span class="keyword">library</span>(MASS)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the categorical variable cylinders into a factor with appropriate renaming of the levels:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto$cylinders &lt;- factor(auto$cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create partitions:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(auto$mpg, p = <span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>See the names of the variables in the data frame:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; names(auto)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"No"</span>           <span class="string">"mpg"</span></span><br><span class="line">[<span class="number">3</span>] <span class="string">"cylinders"</span>    <span class="string">"displacement"</span></span><br><span class="line">[<span class="number">5</span>] <span class="string">"horsepower"</span>   <span class="string">"weight"</span></span><br><span class="line">[<span class="number">7</span>] <span class="string">"acceleration"</span> <span class="string">"model_year"</span></span><br><span class="line">[<span class="number">9</span>] <span class="string">"car_name"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the linear regression model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; fit &lt;- lm(mpg ~ ., data = auto[t.idx, -c(<span class="number">1</span>,<span class="number">8</span>,<span class="number">9</span>)])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the variable selection procedure. This will produce quite a lot of output, which we will display and discuss later. Because of random partitioning, your actual numbers will vary:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; step.model &lt;- stepAIC(fit, direction = <span class="string">"backward"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>See the final model (your results may differ because of variations in your training sample):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">    &gt; summary(step.model)</span><br><span class="line">    Call:</span><br><span class="line">    lm(formula = mpg ~ cylinders + horsepower + weight, data = auto[t.idx,</span><br><span class="line">        -c(<span class="number">1</span>, <span class="number">8</span>, <span class="number">9</span>)])</span><br><span class="line"></span><br><span class="line">    Residuals:</span><br><span class="line">        Min      1Q  Median      3Q     Max</span><br><span class="line">-<span class="number">9.7987</span> -<span class="number">2.3676</span> -<span class="number">0.6214</span>  <span class="number">1.8625</span> <span class="number">15.3231</span></span><br><span class="line"></span><br><span class="line">    Coefficients:</span><br><span class="line">                   Estimate Std. Error t value Pr(&gt;|t|)</span><br><span class="line">    (Intercept)   <span class="number">39.1290155</span>  <span class="number">2.5434458</span>  <span class="number">15.384</span>  &lt; <span class="number">2e-16</span> ***</span><br><span class="line">    cylinders4cyl  <span class="number">6.7241124</span>  <span class="number">2.0140804</span>   <span class="number">3.339</span> <span class="number">0.000959</span> ***</span><br><span class="line">    cylinders5cyl  <span class="number">5.0579997</span>  <span class="number">3.4762178</span>   <span class="number">1.455</span> <span class="number">0.146810</span></span><br><span class="line">    cylinders6cyl  <span class="number">2.5090718</span>  <span class="number">2.1315214</span>   <span class="number">1.177</span> <span class="number">0.240170</span></span><br><span class="line">    cylinders8cyl  <span class="number">7.0991790</span>  <span class="number">2.3133286</span>   <span class="number">3.069</span> <span class="number">0.002365</span> **</span><br><span class="line">    horsepower    -<span class="number">0.0792425</span>  <span class="number">0.0148396</span>  -<span class="number">5.340</span> <span class="number">1.96e-07</span> ***</span><br><span class="line">    weight        -<span class="number">0.0044670</span>  <span class="number">0.0007512</span>  -<span class="number">5.947</span> <span class="number">8.34e-09</span> ***</span><br><span class="line">---</span><br><span class="line">    Signif. codes:  <span class="number">0</span> <span class="string">'\*\*\*'</span> <span class="number">0.001</span> <span class="string">'\*\*'</span> <span class="number">0.01</span> <span class="string">'\*'</span> <span class="number">0.05</span> <span class="string">'.'</span> <span class="number">0.1</span> <span class="string">' '</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    Residual standard error: <span class="number">3.939</span> on <span class="number">273</span> degrees of freedom</span><br><span class="line">    Multiple R-squared:  <span class="number">0.7558</span>,    Adjusted R-squared:  <span class="number">0.7505</span></span><br><span class="line">    <span class="literal">F</span>-statistic: <span class="number">140.9</span> on <span class="number">6</span> and <span class="number">273</span> DF,  p-value: &lt; <span class="number">2.2e-16</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### How it works...</span></span><br><span class="line"></span><br><span class="line">For a description of steps <span class="number">1</span> through <span class="number">6</span>, refer to the How it works... section of the Performing linear regression recipe <span class="keyword">in</span> this chapter (the previous recipe).</span><br><span class="line"></span><br><span class="line">Step <span class="number">7</span> runs the variable selection procedure. We have chosen to illustrate backward elimination <span class="keyword">in</span> which the system first builds the model with all the predictors and eliminates predictors based on AIC scores. We show the sample output <span class="keyword">in</span> the following:</span><br><span class="line"></span><br><span class="line">```R</span><br><span class="line">Start:  AIC=778.38</span><br><span class="line">mpg ~ cylinders + displacement + horsepower + weight + acceleration</span><br><span class="line"></span><br><span class="line">               Df Sum of Sq    RSS    AIC</span><br><span class="line">- acceleration  1      0.01 4232.1 776.38</span><br><span class="line">- displacement  1      3.01 4235.1 776.58</span><br><span class="line">&lt;none&gt;                      4232.1 778.38</span><br><span class="line">- horsepower    1    259.61 4491.7 793.05</span><br><span class="line">- weight        1    349.99 4582.1 798.63</span><br><span class="line">- cylinders     4    859.84 5091.9 822.17</span><br><span class="line"></span><br><span class="line">Step:  AIC=776.38</span><br><span class="line">mpg ~ cylinders + displacement + horsepower + weight</span><br><span class="line"></span><br><span class="line">               Df Sum of Sq    RSS    AIC</span><br><span class="line">- displacement  1      3.02 4235.1 774.58</span><br><span class="line">&lt;none&gt;                      4232.1 776.38</span><br><span class="line">- horsepower    1    404.33 4636.4 799.93</span><br><span class="line">- weight        1    451.22 4683.3 802.75</span><br><span class="line">- cylinders     4    862.88 5094.9 820.34</span><br><span class="line"></span><br><span class="line">Step:  AIC=774.58</span><br><span class="line">mpg ~ cylinders + horsepower + weight</span><br><span class="line"></span><br><span class="line">             Df Sum of Sq    RSS    AIC</span><br><span class="line">&lt;none&gt;                    4235.1 774.58</span><br><span class="line">- horsepower  1    442.36 4677.4 800.40</span><br><span class="line">- weight      1    548.60 4783.7 806.69</span><br><span class="line">- cylinders   4    862.50 5097.6 818.49</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>From the preceding output, you can see that the system first built the complete model. In that model, acceleration had the lowest AIC score of 776.38 and was therefore not included in the next one. In this process, the system eliminated displacement as well.</p>
<p>The complete model had five predictors and the final one has three. In the process, the multiple R2 has remained almost unchanged, but we got a less complex model.</p>
<p><strong>Tip</strong></p>
<p>In the forward selection model, the system takes the reverse approach and adds predictors.</p>
<h3 id="See-also…-14"><a href="#See-also…-14" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
<li>Performing linear regression in this chapter</li>
</ul>
<h2 id="Building-regression-trees"><a href="#Building-regression-trees" class="headerlink" title="Building regression trees"></a>Building regression trees</h2><p>This recipe covers the use of tree models for regression. The rpart package provides the necessary functions to build regression trees.</p>
<h3 id="Getting-ready-39"><a href="#Getting-ready-39" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the rpart, caret, and rpart.plot packages if you do not already have them installed. If you have not already downloaded the data files for this chapter, do so now and ensure that the BostonHousing.csv and education.csv files are in the R working directory.</p>
<h3 id="How-to-do-it…-39"><a href="#How-to-do-it…-39" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To build regression trees, follow the steps below:</p>
<ol>
<li><p>Load the rpart, rpart.plot, and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(rpart)</span><br><span class="line">&gt; <span class="keyword">library</span>(rpart.plot)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(bh$MEDV, p=<span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build and view the regression tree model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; bfit &lt;- rpart(MEDV ~ ., data = bh[t.idx,])</span><br><span class="line">&gt; bfit</span><br><span class="line"> n= <span class="number">356</span></span><br><span class="line"></span><br><span class="line">node), split, n, deviance, yval</span><br><span class="line">      * denotes terminal node</span><br><span class="line"></span><br><span class="line"> <span class="number">1</span>) root <span class="number">356</span> <span class="number">32071.8400</span> <span class="number">22.61461</span></span><br><span class="line">   <span class="number">2</span>) LSTAT&gt;=<span class="number">7.865</span> <span class="number">242</span>  <span class="number">8547.6860</span> <span class="number">18.22603</span></span><br><span class="line">     <span class="number">4</span>) LSTAT&gt;=<span class="number">14.915</span> <span class="number">114</span>  <span class="number">2451.4590</span> <span class="number">14.50351</span></span><br><span class="line">       <span class="number">8</span>) CRIM&gt;=<span class="number">5.76921</span> <span class="number">56</span>   <span class="number">796.5136</span> <span class="number">11.63929</span> *</span><br><span class="line">      <span class="number">9</span>) CRIM&lt; <span class="number">5.76921</span> <span class="number">58</span>   <span class="number">751.9641</span> <span class="number">17.26897</span> *</span><br><span class="line">     <span class="number">5</span>) LSTAT&lt; <span class="number">14.915</span> <span class="number">128</span>  <span class="number">3109.5710</span> <span class="number">21.54141</span></span><br><span class="line">      <span class="number">10</span>) DIS&gt;=<span class="number">1.80105</span> <span class="number">121</span>  <span class="number">1419.7510</span> <span class="number">21.12562</span> *</span><br><span class="line">      <span class="number">11</span>) DIS&lt; <span class="number">1.80105</span> <span class="number">7</span>  <span class="number">1307.3140</span> <span class="number">28.72857</span> *</span><br><span class="line">   <span class="number">3</span>) LSTAT&lt; <span class="number">7.865</span> <span class="number">114</span>  <span class="number">8969.3230</span> <span class="number">31.93070</span></span><br><span class="line">     <span class="number">6</span>) RM&lt; <span class="number">7.4525</span> <span class="number">93</span>  <span class="number">3280.1050</span> <span class="number">28.70753</span></span><br><span class="line">      <span class="number">12</span>) RM&lt; <span class="number">6.659</span> <span class="number">46</span>  <span class="number">1022.5320</span> <span class="number">25.24130</span> *</span><br><span class="line">      <span class="number">13</span>) RM&gt;=<span class="number">6.659</span> <span class="number">47</span>  <span class="number">1163.9800</span> <span class="number">32.10000</span></span><br><span class="line">        <span class="number">26</span>) LSTAT&gt;=<span class="number">5.495</span> <span class="number">17</span>   <span class="number">329.2494</span> <span class="number">28.59412</span> *</span><br><span class="line">        <span class="number">27</span>) LSTAT&lt; <span class="number">5.495</span> <span class="number">30</span>   <span class="number">507.3747</span> <span class="number">34.08667</span> *</span><br><span class="line">     <span class="number">7</span>) RM&gt;=<span class="number">7.4525</span> <span class="number">21</span>   <span class="number">444.3295</span> <span class="number">46.20476</span> *</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the tree. Use the prp function from the rpart.plot package and select the options shown in the following to get a good-looking plot. For convenience, the plot rounds off the y values.</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; prp(bfit, type=<span class="number">2</span>, nn=<span class="literal">TRUE</span>, fallen.leaves=<span class="literal">TRUE</span>, faclen=<span class="number">4</span>, varlen=<span class="number">8</span>, shadow.col=<span class="string">"gray"</span>)</span><br></pre></td></tr></table></figure>
<p> The plot obtained appears as follows:</p>
<p> <img src="img/4_6_1.jpeg" alt=""></p>
</li>
<li><p>Look at the cptable. Your cptable may differ from that shown in the following output because of the random numbers used in the cross-validation process:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; bfit$cptable</span><br><span class="line"></span><br><span class="line">          CP nsplit rel error    xerror       xstd</span><br><span class="line"><span class="number">1</span> <span class="number">0.45381973</span>      <span class="number">0</span> <span class="number">1.0000000</span> <span class="number">1.0068493</span> <span class="number">0.09724445</span></span><br><span class="line"><span class="number">2</span> <span class="number">0.16353560</span>      <span class="number">1</span> <span class="number">0.5461803</span> <span class="number">0.6403963</span> <span class="number">0.06737452</span></span><br><span class="line"><span class="number">3</span> <span class="number">0.09312395</span>      <span class="number">2</span> <span class="number">0.3826447</span> <span class="number">0.4402408</span> <span class="number">0.05838413</span></span><br><span class="line"><span class="number">4</span> <span class="number">0.03409823</span>      <span class="number">3</span> <span class="number">0.2895207</span> <span class="number">0.3566122</span> <span class="number">0.04889254</span></span><br><span class="line"><span class="number">5</span> <span class="number">0.02815494</span>      <span class="number">4</span> <span class="number">0.2554225</span> <span class="number">0.3314437</span> <span class="number">0.04828523</span></span><br><span class="line"><span class="number">6</span> <span class="number">0.01192653</span>      <span class="number">5</span> <span class="number">0.2272675</span> <span class="number">0.2891804</span> <span class="number">0.04306039</span></span><br><span class="line"><span class="number">7</span> <span class="number">0.01020696</span>      <span class="number">6</span> <span class="number">0.2153410</span> <span class="number">0.2810795</span> <span class="number">0.04286100</span></span><br><span class="line"><span class="number">8</span> <span class="number">0.01000000</span>      <span class="number">7</span> <span class="number">0.2051341</span> <span class="number">0.2791785</span> <span class="number">0.04281285</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>You can either choose the tree with the lowest cross-validation error (xerror) or use the 1 SD rule and choose the tree that comes to within 1 SD (xstd) of the minimum xerror and has fewer nodes. The former approach will cause us to select the tree with seven splits (on the last row). That tree will have eight nodes. To apply the latter approach, min xerror + 1 SE = 0.2791785 + 0.04281285 = 0.3219914 and hence leads us to select the tree with five splits (on row 6).</p>
</li>
<li><p>You can simplify the process by just plotting cptree and using the resulting plot to select the cutoff value to use for pruning. The plot shows the size of the tree—which is one more than the number of splits. The table and the plot differ in another important way—the complexity or cp values in these differ. The table shows the minimum cp value for which corresponding split occurs. The plot shows the geometric means of the successive splits. As with the table, your plot may differ because of the random numbers used during cross-validation:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plotcp(bfit)</span><br></pre></td></tr></table></figure>
<p> To select the best cp value from the plot using the 1 SD rule, pick the leftmost cp value for which the cross-validation relative error (y axis) lies below the dashed line. Using this value, we will pick a cp value of 0.018:</p>
<p> <img src="img/4_6_2.jpeg" alt=""></p>
</li>
<li><p>Prune the tree with the chosen cp value and plot it as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># In the command below, replace the cp value</span></span><br><span class="line">&gt; <span class="comment"># based on your results</span></span><br><span class="line">&gt; bfitpruned &lt;- prune(bfit, cp= <span class="number">0.01192653</span>)</span><br><span class="line">&gt; prp(bfitpruned, type=<span class="number">2</span>, nn=<span class="literal">TRUE</span>, fallen.leaves=<span class="literal">TRUE</span>, faclen=<span class="number">4</span>, varlen=<span class="number">8</span>, shadow.col=<span class="string">"gray"</span>)</span><br></pre></td></tr></table></figure>
<p> The following output is obtained:</p>
<p> <img src="img/4_6_3.jpeg" alt=""></p>
</li>
<li><p>Use the chosen tree to compute the RMS error for the training partition:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; preds.t &lt;- predict(bfitpruned, bh[t.idx,])</span><br><span class="line">&gt; sqrt(mean((preds.t-bh[t.idx,<span class="string">"MEDV"</span>])^<span class="number">2</span>))</span><br><span class="line">[<span class="number">1</span>] <span class="number">4.524866</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate predictions and the RMS error for the validation partition:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">preds.v &lt;- predict(bfitpruned, bh[-t.idx,])</span><br><span class="line">&gt; sqrt(mean((preds.v - bh[-t.idx,<span class="string">"MEDV"</span>])^<span class="number">2</span>))</span><br><span class="line">[<span class="number">1</span>] <span class="number">4.535723</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-36"><a href="#How-it-works…-36" class="headerlink" title="How it works…"></a>How it works…</h3><p>Steps 1 and 2 load the required packages and read the data.</p>
<p>Step 3 partitions the data. See recipe Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis for more details. We set the random seed to enable you to match your results with those that we have displayed.</p>
<p>Step 4 uses the rpart function to build the tree model. It passes the formula as MEDV ~ . to indicate that MEDV is the outcome and that all the remaining variables will be predictors. It specifies data = bh[t.idx, ] to indicate that only the rows in the training partition should be used to build the model. It then prints the model details in textual form. The output shows information for the root node and subsequently for each split. Each row has the following information:</p>
<p>node), split, n, deviance, yval</p>
<ul>
<li>node number</li>
<li>splitting condition that generated the node (for the root it just says “root”)</li>
<li>number of cases at the node</li>
<li>sum of squared errors at the node based on average value of outcome variable of the cases at the node</li>
<li>average value of outcome variable of the cases at the node</li>
</ul>
<p>We have many options to control how the rpart function works. It uses the following important defaults among others:</p>
<ul>
<li>0.01 for the complexity factor, cp</li>
<li>Minimum node size of 20 to split a node, minsplit</li>
<li>The function does not split if a split will create a node with less than round(minsplit/3) cases, minbucket</li>
</ul>
<p>You can control these by passing an rpart.control object while invoking rpart. The following code shows an example. Here we use values of 0.001, 10, and 5 for cp, minsplit and minbucket, respectively:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; fit &lt;- rpart(MEDV ~ ., data = bh[t.idx,], control = rpart.control(minsplit = <span class="number">10</span>, cp = <span class="number">0.001</span>, minbucket = <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>Step 5 plots the tree model using the prp function from the rpart.print package. The function provides several parameters through which we can control the plot’s appearance. We describe a few options as follows; check the documentation for the other numerous options:</p>
<ul>
<li>Type: This refers to the amount of information and its placement</li>
<li>nn: This refers to whether to display node numbers or not</li>
<li>fallen.leaves: This refers to whether to display all the leaf nodes at the same level (bottom most)—this results in a plot with only horizontal and vertical lines and make it easier on the eye; otherwise, the plot has diagonal lines</li>
<li>faclen: This refers to the length of factor level names in the splits – abbreviates if needed</li>
<li>varlen: This refers to the length of variable names on the plot – truncates if needed</li>
<li>shadow.col: This refers to the color of the shadow that each node casts</li>
</ul>
<p>Step 6 prints the cptable, which is a component of the fitted tree model. The cptable shows comprehensive results of trees with differing number of nodes as well as the mean and standard deviation of the error on cross-validation for each tree size. This information helps us to select our optimal tree. We explain the columns of the table as follows:</p>
<ul>
<li>cp: This refers to the complexity factor.</li>
<li>nsplit: This refers to the number of splits in the best tree that the corresponding cp yields.</li>
<li>rel error: For the best tree with the specified number of splits, the overall squared classification error (on the data used to build the tree) as a proportion of the total squared error at the root node. The error at the root node is based on predicting every case as the average of the value of outcome variable across all cases.</li>
<li>xerror: This refers to mean cross-validation error using the best tree with the specified number of splits.</li>
<li>xstd: This refers to standard deviation of the cross-validation error using the best tree with the specified number of splits.</li>
</ul>
<p>Step 7 explains how we can use the information in cptable to prune the tree and prevent overfitting. We can choose either the tree with the lowest cross-validation error or the smallest one that comes within one SD of the cross-validation error. We can select the cp value corresponding to the selected tree and use that value to prune the tree.</p>
<p>Step 8 shows an easier way to select the best cp value by plotting the cptable with the plotcp function.</p>
<p>Step 9 prunes the tree with the chosen cp value.</p>
<p>Step 10 uses the predict function to generate predictions for the training partition and then computes the RMS error.</p>
<p>Step 11 does the same for the validation partition.</p>
<h3 id="There’s-more…-28"><a href="#There’s-more…-28" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>Regression trees can also be built for categorical predictors as explained in this section.</p>
<p>Generating regression trees for data with categorical predictors</p>
<p>The rpart function works even when a dataset has categorical predictor variables. You just have to ensure that the variable is tagged as a factor. See the following example:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; ed &lt;- read.csv(<span class="string">"education.csv"</span>)</span><br><span class="line">&gt; ed$region &lt;- factor(ed$region)</span><br><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(ed$expense, p = <span class="number">0.7</span>, list = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; fit &lt;- rpart(expense ~ region+urban+income+under18, data = ed[t.idx,])</span><br><span class="line">&gt; prp(fit, type=<span class="number">2</span>, nn=<span class="literal">TRUE</span>, fallen.leaves=<span class="literal">TRUE</span>, faclen=<span class="number">4</span>, varlen=<span class="number">8</span>, shadow.col=<span class="string">"gray"</span>)</span><br></pre></td></tr></table></figure>
<p>The following output is obtained:</p>
<p><img src="img/4_6_4.jpeg" alt=""></p>
<h3 id="See-also…-15"><a href="#See-also…-15" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
<li>Building, plotting, and evaluating classification trees in Chapter 3, Where Does It Belong? – Classification</li>
</ul>
<h2 id="Building-random-forest-models-for-regression"><a href="#Building-random-forest-models-for-regression" class="headerlink" title="Building random forest models for regression"></a>Building random forest models for regression</h2><p>This recipe looks at random forests—one of the most successful machine learning techniques.</p>
<h3 id="Getting-ready-40"><a href="#Getting-ready-40" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the randomForest and caret packages, install them now. Download the data files for this chapter from the book’s website and place the BostonHousing.csv file is in your R working directory. We will build a random forest model to predict MEDV based on the other variables.</p>
<h3 id="How-to-do-it…-40"><a href="#How-to-do-it…-40" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To build random forest models for regression, follow the steps below:</p>
<ol>
<li><p>Load the randomForest and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(randomForest)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bn &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(bh$MEDV, p=<span class="number">0.7</span>, list=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the random forest model. Since this command builds many regression trees, it can take significant processing time on even moderate datasets:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- randomForest(x = bh[t.idx,<span class="number">1</span>:<span class="number">13</span>], y=bh[t.idx,<span class="number">14</span>],ntree=<span class="number">1000</span>,  xtest = bh[-t.idx,<span class="number">1</span>:<span class="number">13</span>], ytest = bh[-t.idx,<span class="number">14</span>], importance=<span class="literal">TRUE</span>, keep.forest=<span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Examine the results (your results may differ slightly because of the random factor):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod</span><br><span class="line">Call:</span><br><span class="line"> randomForest(x = bh[t.idx, <span class="number">1</span>:<span class="number">13</span>], y = bh[t.idx, <span class="number">14</span>], xtest = bh[-t.idx,      <span class="number">1</span>:<span class="number">13</span>], ytest = bh[-t.idx, <span class="number">14</span>], ntree = <span class="number">1000</span>, importance = <span class="literal">TRUE</span>,      keep.forest = <span class="literal">TRUE</span>)</span><br><span class="line">               Type of random forest: regression</span><br><span class="line">                     Number of trees: <span class="number">1000</span></span><br><span class="line">No. of variables tried at each split: <span class="number">4</span></span><br><span class="line"></span><br><span class="line">          Mean of squared residuals: <span class="number">12.61296</span></span><br><span class="line">                    % Var explained: <span class="number">86</span></span><br><span class="line">                       Test set MSE: <span class="number">6.94</span></span><br><span class="line">                    % Var explained: <span class="number">90.25</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Examine variable importance:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod$importance</span><br><span class="line">           %IncMSE IncNodePurity</span><br><span class="line">CRIM     <span class="number">9.5803434</span>     <span class="number">2271.5448</span></span><br><span class="line">ZN       <span class="number">0.3410126</span>      <span class="number">142.1191</span></span><br><span class="line">INDUS    <span class="number">6.6838954</span>     <span class="number">1840.7041</span></span><br><span class="line">CHAS     <span class="number">0.6363144</span>      <span class="number">193.7132</span></span><br><span class="line">NOX      <span class="number">9.3106894</span>     <span class="number">1922.5483</span></span><br><span class="line">RM      <span class="number">36.2790912</span>     <span class="number">8540.4644</span></span><br><span class="line">AGE      <span class="number">3.7186444</span>      <span class="number">820.7750</span></span><br><span class="line">DIS      <span class="number">7.4519827</span>     <span class="number">2012.8193</span></span><br><span class="line">RAD      <span class="number">1.7799796</span>      <span class="number">287.6282</span></span><br><span class="line">TAX      <span class="number">4.5373887</span>     <span class="number">1049.3716</span></span><br><span class="line">PTRATIO  <span class="number">6.8372845</span>     <span class="number">2030.2044</span></span><br><span class="line">B        <span class="number">1.2240072</span>      <span class="number">530.1201</span></span><br><span class="line">LSTAT   <span class="number">67.0867117</span>     <span class="number">9532.3054</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Compare predicted and actual values for the training partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(bh[t.idx,<span class="number">14</span>], predict( mod, newdata=bh[t.idx,]), xlab = <span class="string">"Actual"</span>, ylab = <span class="string">"Predicted"</span>)</span><br></pre></td></tr></table></figure>
<p> The following output is obtained on executing the preceding command:</p>
<p> <img src="img/4_6_5.jpeg" alt=""></p>
</li>
<li><p>Compare the out of bag (OOB) predictions with actuals in the training partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; &gt; plot(bh[t.idx,<span class="number">14</span>], mod$predicted, xlab = <span class="string">"Actual"</span>, ylab = <span class="string">"Predicted"</span>)</span><br></pre></td></tr></table></figure>
<p> The preceding command produces the following output:</p>
<p> <img src="img/4_6_6.jpeg" alt=""></p>
</li>
<li><p>Compare predicted and actual values for the test partition:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(bh[-t.idx,<span class="number">14</span>], mod$test$predicted, xlab = <span class="string">"Actual"</span>, ylab = <span class="string">"Predicted"</span>)</span><br></pre></td></tr></table></figure>
<p> The following plot is obtained as a result of the preceding command:</p>
<p> <img src="img/4_6_7.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-37"><a href="#How-it-works…-37" class="headerlink" title="How it works…"></a>How it works…</h3><p>Steps 1 and 2 load the necessary packages and read the data.</p>
<p>Step 3 partitions the data. See recipe Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis for more details. We set the random seed to enable you to match your results with those that we have displayed. Technically speaking, we do not really need to partition the data for random forests because it builds many trees and uses only a subset of the data each time. Thus, each case is OOB for about a third of the trees built and can be used for validation. However, the method also provides for us to provide a validation dataset separately and we illustrate that process here.</p>
<p>Step 4 builds the random forest model. We show the command and describe the arguments as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mod &lt;- randomForest(x = bh[t.idx,<span class="number">1</span>:<span class="number">13</span>], y=bh[t.idx,<span class="number">14</span>],ntree=<span class="number">1000</span>,  xtest = bh[-t.idx,<span class="number">1</span>:<span class="number">13</span>], ytest = bh[-t.idx,<span class="number">14</span>], importance=<span class="literal">TRUE</span>, keep.forest=<span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>x: the predictors</li>
<li>y: This is the outcome variables</li>
<li>ntree: This is the number of trees to build</li>
<li>xtest: These are predictors in the validation partition</li>
<li>ytest: These are outcome variables in the validation partition</li>
<li>importance: This refers to whether or not to compute the importance scores of the predictor variables</li>
<li>keep.forest: This refers to whether or not to keep the trees built in the resulting model; only if we keep the trees can we generate predictions based on the model</li>
</ul>
<p>Step 5 prints the model. This shows the mean squared error on the training and the validation partitions, as well as the percentage of variability in the outcome variable that the model explains.</p>
<p>Step 6 uses the importance component of the model to print the computed importance level of each variable. For each tree generated, the method first generates the prediction. Then, for every variable (one at a time), it randomly permutes the values across the OOB cases and generates the predictions. The degradation in prediction with the variable permuted indicates how important the variable is. For each predictor variable, the importance table reports the average value of importance across all trees. Higher values indicate higher importance.</p>
<p>Step 7 plots the predictions for the training partition against the actual values.</p>
<p>Step 8 plots the OOB predictions against the actual values using the predicted component of the model—mod$predicted.</p>
<p>Step 9 uses mod$test$predicted to plot the performance of the model on the test cases against actuals.</p>
<h3 id="There’s-more…-29"><a href="#There’s-more…-29" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We discuss a few prominent options in this section.</p>
<h4 id="Controlling-forest-generation"><a href="#Controlling-forest-generation" class="headerlink" title="Controlling forest generation"></a>Controlling forest generation</h4><p>You can use the following additional options to control how the algorithm builds the forest:</p>
<ul>
<li>mtry: This is the number of predictors to randomly sample at each split; the default is m/3 where m is the number of predictors</li>
<li>nodesize: This is the minimum size of terminal nodes; the default is 5, setting it higher causes smaller trees</li>
<li>maxnodes: This is the maximum number of terminal nodes that a tree can have; if unspecified, the trees are grown to the maximum size possible, subject to nodesize</li>
</ul>
<h3 id="See-also…-16"><a href="#See-also…-16" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
<li>Using random forest models for classification in Chapter 3, Where Does It Belong? – Classification</li>
</ul>
<h2 id="Using-neural-networks-for-regression"><a href="#Using-neural-networks-for-regression" class="headerlink" title="Using neural networks for regression"></a>Using neural networks for regression</h2><p>The nnet package contains functionality to build neural network models for classification as well as prediction. In this recipe, we cover the steps to build a neural network regression model using nnet.</p>
<h3 id="Getting-ready-41"><a href="#Getting-ready-41" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you do not already have the nnet, caret, and devtools packages installed, install them now. If you have not already downloaded the data files for this chapter, download them now and ensure that the BostonHousing.csv file is in your R working directory. We will build a model to predict MEDV based on all of the remaining variables.</p>
<h3 id="How-to-do-it…-41"><a href="#How-to-do-it…-41" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To use neural networks for regression, follow these steps:</p>
<ol>
<li><p>Load the nnet and caret packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(nnet)</span><br><span class="line">&gt; <span class="keyword">library</span>(caret)</span><br><span class="line">&gt; <span class="keyword">library</span>(devtools)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Partition the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1000</span>)</span><br><span class="line">&gt; t.idx &lt;- createDataPartition(bh$MEDV, p=<span class="number">0.7</span>, list=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Find the range of the response variable to be able to scale it to [0,1]:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; summary(bh$MEDV)</span><br><span class="line">   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.</span><br><span class="line">   <span class="number">5.00</span>   <span class="number">17.02</span>   <span class="number">21.20</span>   <span class="number">22.53</span>   <span class="number">25.00</span>   <span class="number">50.00</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; fit &lt;- nnet(MEDV/<span class="number">50</span> ~ ., data=bh[t.idx,], size=<span class="number">6</span>, decay = <span class="number">0.1</span>, maxit = <span class="number">1000</span>, linout = <span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>In preparation for plotting the network, get the code for the plotting function plot.nnet from fawda123’s GitHub page. The following loads the function into R:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; source_url(<span class="string">'https://gist.githubusercontent.com/fawda123/7471137/raw/466c1474d0a505ff044412703516c34f1a4684a5/nnet_plot_update.r'</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the network:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(fit, max.sp = <span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
<p> The following plot is obtained as a result of the preceding commands:</p>
<p> <img src="img/4_6_8.jpeg" alt=""></p>
</li>
<li><p>Compute the RMS error on the training data (your results can differ):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; t.rmse = sqrt(mean((fit$fitted.values * <span class="number">50</span> - bh[t.idx, <span class="string">"MEDV"</span>])^<span class="number">2</span>))</span><br><span class="line">&gt; t.rmse</span><br><span class="line">[<span class="number">1</span>] <span class="number">2.797945</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate predictions on the validation partition and generate the RMS error (your results may differ):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; v.rmse &lt;- sqrt(mean((predict(fit,bh[-t.idx,]*<span class="number">50</span> - bh[-t.idx, <span class="string">"MEDV"</span>])^<span class="number">2</span>)))</span><br><span class="line">&gt; v.rmse</span><br><span class="line">[<span class="number">1</span>] <span class="number">0.42959</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-38"><a href="#How-it-works…-38" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the necessary packages—nnet for neural network modeling and caret for data partitioning. We also load devtools because we will be sourcing code using a web URL for printing the network.</p>
<p>Step 2 reads the file.</p>
<p>Step 3 partitions the data. See recipe Creating random data partitions from Chapter 2, for more details. We have set the random seed to enable you to match your results with those that we have displayed.</p>
<p>Step 4 builds the neural net model using the nnet function of the nnet package:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; fit &lt;- nnet(MEDV/<span class="number">50</span> ~ ., data=bh[t.idx,], size=<span class="number">6</span>, decay = <span class="number">0.1</span>, maxit = <span class="number">1000</span>, linout = <span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
<p>We divide our response variable by 50 to scale it to the range [0,1]. We pass the following arguments:</p>
<ul>
<li>size = 6: This indicates the number of nodes in the hidden layer.</li>
<li>decay = 0.1: This indicates the decay.</li>
<li>maxit = 1000: Stops if the process does not converge in the maxit iterations. The default value for maxit is 100. Provide a value based on trial and error.</li>
<li>linout = TRUE: This specifies that we want a linear output unit and not logistic.</li>
</ul>
<p>Step 6 loads code for the printing function from an eternal url using the source_url function of the devtools package.</p>
<p>Step 7 then plots the network. The thickness of the lines indicates the strength of the corresponding weights. We use max.sp = TRUE to cause the plot to have maximum possible spacing between the nodes.</p>
<p>Step 8 uses the fitted component of the model to compute the RMS error on the training partition.</p>
<p>Step 9 uses the predict function on the validation partition to generate predictions to compute the RMS error on the validation partition.</p>
<h3 id="See-also…-17"><a href="#See-also…-17" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Creating random data partitions in Chapter 2, What’s in There? – Exploratory Data Analysis</li>
<li>Using neural networks for classification in Chapter 3, Where Does It Belong? – Classification</li>
</ul>
<h2 id="Performing-k-fold-cross-validation"><a href="#Performing-k-fold-cross-validation" class="headerlink" title="Performing k-fold cross-validation"></a>Performing k-fold cross-validation</h2><p>The R implementation of some techniques, such as classification and regression trees, performs cross-validation out of the box to aid in model selection and to avoid overfitting. However, some others do not. When faced with several choices of machine learning methods for a particular problem, we can use the standard approach of partitioning the data into training and test sets and select based on the results. However, cross-validation gives a more thorough evaluation of a model’s performance on hold-out data. Comparing the performance of methods using cross-validation can paint a truer picture of their relative performance.</p>
<h3 id="Getting-ready-42"><a href="#Getting-ready-42" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>We illustrate the approach with the Boston Housing data, and thus you should download the code for this chapter and ensure that the BostonHousing.csv file is in your R working directory.</p>
<h3 id="How-to-do-it…-42"><a href="#How-to-do-it…-42" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>In this recipe, we show you basic code to perform k-fold cross-validation for linear regression. You can adapt the same code structure for all other regression methods. Although some packages like caret, DAAG and boot provide cross-validation functionality out of the box, they cover only a few machine-learning techniques. You might find a generic framework to be useful and be able to adapt it to whatever machine-learning technique you might want to apply it to. To do this, follow these steps:</p>
<ol>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create the two functions shown as follows; we show line numbers for discussion:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> rdacb.kfold.crossval.reg &lt;- <span class="keyword">function</span>(df, nfolds) &#123;</span><br><span class="line"><span class="number">2</span>   fold &lt;- sample(<span class="number">1</span>:nfolds, nrow(df), replace = <span class="literal">TRUE</span>)</span><br><span class="line"><span class="number">3</span>   mean.sqr.errs &lt;- sapply(<span class="number">1</span>:nfolds,</span><br><span class="line">         rdacb.kfold.cval.reg.iter,</span><br><span class="line">         df, fold)</span><br><span class="line"><span class="number">4</span>   list(<span class="string">"mean_sqr_errs"</span>= mean.sqr.errs,</span><br><span class="line">         <span class="string">"overall_mean_sqr_err"</span> = mean(mean.sqr.errs),</span><br><span class="line">         <span class="string">"std_dev_mean_sqr_err"</span> = sd(mean.sqr.errs))</span><br><span class="line"><span class="number">5</span> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="number">6</span> rdacb.kfold.cval.reg.iter &lt;- <span class="keyword">function</span>(k, df, fold) &#123;</span><br><span class="line"> <span class="number">7</span>   trg.idx &lt;- !fold %<span class="keyword">in</span>% c(k)</span><br><span class="line"> <span class="number">8</span>   test.idx &lt;-  fold %<span class="keyword">in</span>% c(k)</span><br><span class="line"> <span class="number">9</span>   mod &lt;- lm(MEDV ~ ., data = df[trg.idx, ] )</span><br><span class="line"><span class="number">10</span>   pred &lt;- predict(mod, df[test.idx,])</span><br><span class="line"><span class="number">11</span>   sqr.errs &lt;- (pred - df[test.idx, <span class="string">"MEDV"</span>])^<span class="number">2</span></span><br><span class="line"><span class="number">12</span>   mean(sqr.errs)</span><br><span class="line"><span class="number">13</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>With the preceding two functions in place, you can run k-fold cross-validation with k=5 as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; res &lt;- rdacb.kfold.crossval.reg(bh, <span class="number">5</span>)</span><br><span class="line">&gt; <span class="comment"># get the mean squared errors from each fold</span></span><br><span class="line">&gt; res$mean_sqr_errs</span><br><span class="line">&gt; <span class="comment"># get the overall mean squared errors</span></span><br><span class="line">&gt; res$overall_mean_sqr_err</span><br><span class="line">&gt; <span class="comment"># get the standard deviation of the mean squared errors</span></span><br><span class="line">&gt; res$std_dev_mean_sqr_err</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-39"><a href="#How-it-works…-39" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 reads the data file.</p>
<p>In step 2, we define two functions to perform k-fold cross-validation. Rows 1-5 define the first function and rows 6-13 define the second function.</p>
<p>The first function rdacb.kfold.crossval.reg sets up the k-folds and uses the second one to build the model and compute the errors for each fold.</p>
<p>Line 2 creates the folds by randomly sampling from 1 to k. Thus, if a data frame has 1000 elements, this line will generate 1000 random integers from 1 to k. The idea is that if the ith random number is, say, 3, then the ith case of the data frame belongs to the third fold.</p>
<p>Line 3 invokes the second function to compute the errors for each fold.</p>
<p>Line 4 creates a list with the raw values of the mean squared errors for each partition, the overall mean across all the folds, and the standard deviation of the mean squared errors.</p>
<p>The second function computes the error for a particular partition.</p>
<p>Lines 7 and 8 set up the training and test data. The fold number is passed in as the argument k and line 7 treats all data rows belonging to folds other than k as the training data. Line 8 sets up the data rows belonging to the kth fold as the test data.</p>
<p>Line 9 builds the linear regression model with the training data alone.</p>
<p>Line 10 generates the predictions on the test data.</p>
<p>Line 11 computes the squared errors.</p>
<p>Line 12 returns the mean of the squared errors.</p>
<h3 id="See-also…-18"><a href="#See-also…-18" class="headerlink" title="See also…"></a>See also…</h3><p>Performing leave-one-out-cross-validation to limit overfitting in this chapter.</p>
<h2 id="Performing-leave-one-out-cross-validation-to-limit-overfitting"><a href="#Performing-leave-one-out-cross-validation-to-limit-overfitting" class="headerlink" title="Performing leave-one-out-cross-validation to limit overfitting"></a>Performing leave-one-out-cross-validation to limit overfitting</h2><p>We provide the framework of the code to perform leave-one-out-cross-validation for linear regression. You should be able to easily adapt this code for any other regression technique. The rationale and explanation presented under the previous recipe Performing k-fold cross-validation apply to this one as well.</p>
<h3 id="How-to-do-it…-43"><a href="#How-to-do-it…-43" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To perform leave-one-out-cross-validation (LOOCV) to limit overfitting, follow the steps below:</p>
<ol>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create the two functions shown as follows; we show line numbers for discussion:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> rdacb.loocv.reg &lt;- <span class="keyword">function</span>(df) &#123;</span><br><span class="line"><span class="number">2</span>   mean.sqr.errs &lt;- sapply(<span class="number">1</span>:nrow(df),</span><br><span class="line">               rdacb.loocv.reg.iter, df)</span><br><span class="line"><span class="number">3</span>   list(<span class="string">"mean_sqr_errs"</span>= mean.sqr.errs,</span><br><span class="line">              <span class="string">"overall_mean_sqr_err"</span> = mean(mean.sqr.errs),</span><br><span class="line">              <span class="string">"std_dev_mean_sqr_err"</span> = sd(mean.sqr.errs))</span><br><span class="line"><span class="number">4</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> rdacb.loocv.reg.iter &lt;- <span class="keyword">function</span>(k, df) &#123;</span><br><span class="line"><span class="number">6</span>   mod &lt;- lm(MEDV ~ ., data = df[-k, ] )</span><br><span class="line"><span class="number">7</span>   pred &lt;- predict(mod, df[k,])</span><br><span class="line"><span class="number">8</span>   sqr.err &lt;- (pred - df[k, <span class="string">"MEDV"</span>])^<span class="number">2</span></span><br><span class="line"><span class="number">9</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>With the preceding two functions in place, you can run leave-one-out-cross-validation as follows (this runs 506 linear regression models and will take some time):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; res &lt;- rdacb.loocv.reg(bh)</span><br><span class="line">&gt; <span class="comment"># get the raw mean squared errors for each case</span></span><br><span class="line">&gt; res$mean_sqr_errs</span><br><span class="line">&gt; <span class="comment"># get the overall mean squared error</span></span><br><span class="line">&gt; res$overall_mean_sqr_err</span><br><span class="line">&gt; <span class="comment"># get the standard deviation of the mean squared errors</span></span><br><span class="line">&gt; res$std_dev_mean_sqr_err</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-40"><a href="#How-it-works…-40" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 reads the data.</p>
<p>Step 2 creates two functions for performing leave-one-out-cross-validation. Lines 1 to 4 define the first function rdacb.loocv.reg and lines 5 to 9 define the second one, rdacb.loocv.reg.iter:</p>
<ul>
<li>Line 2 of the first function rdacb.loocv.reg repeatedly calls the second function rdacb.loocv.reg.iter to build the regression model leaving one case out and compute the squared error</li>
<li>Line 3 creates a list with the output elements</li>
<li>Line 6 in the second function rdacb.loocv.reg.iter builds the regression model on the data frame leaving out one case</li>
<li>Line 7 generates the prediction for the case that was left out</li>
<li>Line 8 computes the squared error</li>
</ul>
<p>Step 3 uses the preceding functions to perform leave-one-out-cross-validation and displays the results.</p>
<h3 id="See-also…-19"><a href="#See-also…-19" class="headerlink" title="See also…"></a>See also…</h3><p>Performing k-fold cross-validation in this chapter.</p>
<hr>
<h1 id="Chapter-5-Can-You-Simplify-That-–-Data-Reduction-Techniques"><a href="#Chapter-5-Can-You-Simplify-That-–-Data-Reduction-Techniques" class="headerlink" title="Chapter 5. Can You Simplify That? – Data Reduction Techniques"></a>Chapter 5. Can You Simplify That? – Data Reduction Techniques</h1><p>In this chapter, we will cover:</p>
<ul>
<li>Performing cluster analysis using K-means clustering</li>
<li>Performing cluster analysis using hierarchical clustering</li>
<li>Reducing dimensionality with principal component analysis</li>
</ul>
<h2 id="Introduction-4"><a href="#Introduction-4" class="headerlink" title="Introduction"></a>Introduction</h2><p>When confronted with large datasets, either in terms of the number of cases or the number of variables, or both, analysts often seek to reduce the complexity. They can use cluster analysis to condense the number of cases to a manageable number of representative points, or they may use principal component analysis (PCA) to identify a smaller set of variables or dimensions that capture the information content of most of the larger set of original variables. This chapter will cover R recipes for cluster analysis and PCA.</p>
<h2 id="Performing-cluster-analysis-using-K-means-clustering"><a href="#Performing-cluster-analysis-using-K-means-clustering" class="headerlink" title="Performing cluster analysis using K-means clustering"></a>Performing cluster analysis using K-means clustering</h2><p>The standard R package stats provides the function for K-means clustering. We also use the cluster package to plot the results of our cluster analysis.</p>
<h3 id="Getting-ready-43"><a href="#Getting-ready-43" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and ensure that the auto-mpg.csv file is in your R working directory. Also, ensure that you have installed the cluster package.</p>
<h3 id="How-to-do-it…-44"><a href="#How-to-do-it…-44" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To perform cluster analysis using K-means clustering, follow theses steps:</p>
<ol>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Define a convenience function to standardize the relevant variables and append the resulting variables to the original data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rdacb.scale.many &lt;- <span class="keyword">function</span> (dat, column_nos) &#123;</span><br><span class="line">  nms &lt;- names(dat)</span><br><span class="line">  <span class="keyword">for</span> (col <span class="keyword">in</span> column_nos) &#123;</span><br><span class="line">    name &lt;- paste0(nms[col], <span class="string">"_z"</span>)</span><br><span class="line">    dat[name] &lt;- scale(dat[, col])</span><br><span class="line">  &#125;</span><br><span class="line">  cat(paste(<span class="string">"Scaled"</span>, length(column_nos), <span class="string">"variable(s)\n"</span>))</span><br><span class="line">  dat</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Use the preceding convenience function to standardize the variables of interest. We will ignore the variables No, <code>model_year</code>, and <code>car_name</code>:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; auto &lt;- rdacb.scale.many(auto, <span class="number">2</span>:<span class="number">7</span>)</span><br><span class="line">&gt; <span class="comment"># See the variables now in auto</span></span><br><span class="line">&gt; names(auto)</span><br><span class="line"> [<span class="number">1</span>] <span class="string">"No"</span>             <span class="string">"mpg"</span></span><br><span class="line"> [<span class="number">3</span>] <span class="string">"cylinders"</span>      <span class="string">"displacement"</span></span><br><span class="line"> [<span class="number">5</span>] <span class="string">"horsepower"</span>     <span class="string">"weight"</span></span><br><span class="line"> [<span class="number">7</span>] <span class="string">"acceleration"</span>   <span class="string">"model_year"</span></span><br><span class="line"> [<span class="number">9</span>] <span class="string">"car_name"</span>       <span class="string">"mpg_z"</span></span><br><span class="line">[<span class="number">11</span>] <span class="string">"cylinders_z"</span>    <span class="string">"displacement_z"</span></span><br><span class="line">[<span class="number">13</span>] <span class="string">"horsepower_z"</span>   <span class="string">"weight_z"</span></span><br><span class="line">[<span class="number">15</span>] <span class="string">"acceleration_z"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Perform K-means clustering for a given value of K. Let’s use K=5. We show how you can settle on a good value for K in the There’s more… section of this recipe. Due to the random choice of K starting points, your results may differ:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">1020</span>)</span><br><span class="line">&gt; fit &lt;- kmeans(auto[, <span class="number">10</span>:<span class="number">15</span>], <span class="number">5</span>)</span><br><span class="line">&gt; <span class="comment"># Examine the fit object – produces a lot of output</span></span><br><span class="line">&gt; <span class="comment"># Your results could differ slightly</span></span><br><span class="line">&gt; fit</span><br><span class="line">K-means clustering with <span class="number">5</span> clusters of sizes <span class="number">36</span>, <span class="number">96</span>, <span class="number">62</span>, <span class="number">117</span>, <span class="number">87</span></span><br><span class="line"></span><br><span class="line">Cluster means:</span><br><span class="line">       mpg_z cylinders_z displacement_z</span><br><span class="line"><span class="number">1</span> -<span class="number">0.4141251</span>   <span class="number">0.2388808</span>      <span class="number">0.2772370</span></span><br><span class="line"><span class="number">2</span> -<span class="number">1.1538840</span>   <span class="number">1.4963079</span>      <span class="number">1.4943315</span></span><br><span class="line"><span class="number">3</span> -<span class="number">0.4317115</span>   <span class="number">0.3679422</span>      <span class="number">0.1875709</span></span><br><span class="line"><span class="number">4</span>  <span class="number">0.3259756</span>  -<span class="number">0.8753429</span>     -<span class="number">0.7189046</span></span><br><span class="line"><span class="number">5</span>  <span class="number">1.3138889</span>  -<span class="number">0.8349721</span>     -<span class="number">0.9305048</span></span><br><span class="line"></span><br><span class="line">  horsepower_z   weight_z acceleration_z</span><br><span class="line"><span class="number">1</span>  -<span class="number">0.28320032</span>  <span class="number">0.5386915</span>     <span class="number">1.29988821</span></span><br><span class="line"><span class="number">2</span>   <span class="number">1.50450532</span>  <span class="number">1.3943873</span>    -<span class="number">1.06420891</span></span><br><span class="line"><span class="number">3</span>   <span class="number">0.03201748</span>  <span class="number">0.1614095</span>    -<span class="number">0.12178037</span></span><br><span class="line"><span class="number">4</span>  -<span class="number">0.43500729</span> -<span class="number">0.6304741</span>    -<span class="number">0.06498252</span></span><br><span class="line"><span class="number">5</span>  -<span class="number">0.98076471</span> -<span class="number">1.0286895</span>     <span class="number">0.81059100</span></span><br><span class="line"></span><br><span class="line">Clustering vector:</span><br><span class="line">  [<span class="number">1</span>] <span class="number">4</span> <span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">1</span> <span class="number">4</span></span><br><span class="line"> [<span class="number">23</span>] <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">5</span> <span class="number">2</span> <span class="number">3</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">5</span> <span class="number">4</span> <span class="number">5</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span></span><br><span class="line"> [<span class="number">45</span>] <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">5</span></span><br><span class="line"> [<span class="number">67</span>] <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">5</span> <span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">5</span> <span class="number">5</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">5</span> <span class="number">2</span></span><br><span class="line"> [<span class="number">89</span>] <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">5</span> <span class="number">5</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">5</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span> <span class="number">5</span> <span class="number">2</span> <span class="number">4</span> <span class="number">3</span></span><br><span class="line">[<span class="number">111</span>] <span class="number">5</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">3</span> <span class="number">5</span> <span class="number">3</span> <span class="number">5</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span></span><br><span class="line">[<span class="number">133</span>] <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">5</span> <span class="number">3</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">5</span> <span class="number">2</span> <span class="number">5</span> <span class="number">3</span> <span class="number">5</span> <span class="number">3</span> <span class="number">5</span> <span class="number">3</span> <span class="number">5</span> <span class="number">5</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span></span><br><span class="line">[<span class="number">155</span>] <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">3</span> <span class="number">5</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">5</span> <span class="number">2</span> <span class="number">5</span> <span class="number">3</span> <span class="number">2</span> <span class="number">5</span></span><br><span class="line">[<span class="number">177</span>] <span class="number">1</span> <span class="number">3</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span></span><br><span class="line">[<span class="number">199</span>] <span class="number">4</span> <span class="number">5</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">5</span> <span class="number">5</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">5</span> <span class="number">3</span> <span class="number">5</span> <span class="number">4</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">[<span class="number">221</span>] <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">5</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span></span><br><span class="line">[<span class="number">243</span>] <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">5</span> <span class="number">3</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">5</span> <span class="number">3</span> <span class="number">5</span> <span class="number">1</span> <span class="number">5</span> <span class="number">5</span> <span class="number">5</span> <span class="number">4</span></span><br><span class="line">[<span class="number">265</span>] <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">5</span> <span class="number">5</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span></span><br><span class="line">[<span class="number">287</span>] <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">5</span> <span class="number">4</span> <span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">5</span> <span class="number">4</span> <span class="number">5</span> <span class="number">3</span> <span class="number">2</span> <span class="number">4</span> <span class="number">3</span></span><br><span class="line">[<span class="number">309</span>] <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">5</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">5</span> <span class="number">5</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span></span><br><span class="line">[<span class="number">331</span>] <span class="number">5</span> <span class="number">5</span> <span class="number">3</span> <span class="number">1</span> <span class="number">5</span> <span class="number">3</span> <span class="number">3</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">5</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">5</span> <span class="number">1</span> <span class="number">2</span> <span class="number">5</span></span><br><span class="line">[<span class="number">353</span>] <span class="number">3</span> <span class="number">1</span> <span class="number">5</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">5</span> <span class="number">5</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">5</span> <span class="number">3</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span></span><br><span class="line">[<span class="number">375</span>] <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">5</span> <span class="number">4</span> <span class="number">1</span> <span class="number">5</span> <span class="number">2</span> <span class="number">5</span> <span class="number">2</span> <span class="number">2</span> <span class="number">5</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">5</span> <span class="number">5</span></span><br><span class="line">[<span class="number">397</span>] <span class="number">5</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">Within cluster sum of squares by cluster:</span><br><span class="line">[<span class="number">1</span>]  <span class="number">53.49325</span> <span class="number">134.03814</span>  <span class="number">51.86729</span>  <span class="number">96.53647</span></span><br><span class="line">[<span class="number">5</span>] <span class="number">115.59778</span></span><br><span class="line"> (between_SS / total_SS =  <span class="number">81.0</span> %)</span><br><span class="line"></span><br><span class="line">Available components:</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"cluster"</span>      <span class="string">"centers"</span>      <span class="string">"totss"</span></span><br><span class="line">[<span class="number">4</span>] <span class="string">"withinss"</span>     <span class="string">"tot.withinss"</span> <span class="string">"betweenss"</span></span><br><span class="line">[<span class="number">7</span>] <span class="string">"size"</span>         <span class="string">"iter"</span>         <span class="string">"ifault"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>We performed cluster analysis on six dimensions and thus cannot visualize the complete analysis. However, we can creatively use a pairwise plot to get an idea of the clustering and visualize the results:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pairs(auto[,<span class="number">2</span>:<span class="number">7</span>], col=c(<span class="number">1</span>:<span class="number">5</span>)[fit$cluster])</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_1.jpeg" alt=""></p>
</li>
<li><p>The clusplot function from the cluster package can help us visualize the clustering based on the first two principal components by generating a bivariate cluster plot using the following command:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(cluster)</span><br><span class="line">&gt; clusplot(auto[,<span class="number">10</span>:<span class="number">15</span>], fit$cluster, color = <span class="literal">TRUE</span>, shade = <span class="literal">TRUE</span>, labels=<span class="number">0</span>, lines=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_2.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-41"><a href="#How-it-works…-41" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the data is loaded.</p>
<p>In step 2 a convenience function is defined to standardize several variables at once. Although the scale function does this, the names it assigns to the standardized variables mimic the original ones and hence can cause confusion. This convenience function creates more meaningful names by appending _z to the original variable names.</p>
<p>In step 3 the convenience function is used to scale only the variables of interest—we leave out No, model_year, and car_name.</p>
<p>In step 4 the K-means clustering algorithm is run by invoking the kmeans function and then printing the resulting object. We used K=5 as an illustration. The next section, There’s more…, shows how we can settle on a suitable value for K. While invoking the kmeans function, we have the option of selecting the specific K-means clustering algorithm by passing a value for the algorithm argument. If left out, the function uses the Hartigan Wong algorithm by default. Other options are Lloyd, Forgy, and MacQueen.</p>
<p>From the output, we can see that the resulting model contains information about the centers of the clusters, information about which cluster each case of the data falls under, the sum of squares within each cluster, and finally, the proportion of total variability that the K clusters retain. We see that the 5-cluster solution retains 81 percent of the variability.</p>
<p>The output also shows the components of the fitted model, from which we can extract relevant information. The following table summarizes the information:</p>
<p>|Command|Function|<br>|:=—–|——–|<br>|fit$cluster|The clustering vector, specifying the cluster to which each case belongs.|<br>|fit$centers|The center of each cluster.|<br>|fit$totss|Total sum of squares of the variables used. We used standardized values and hence this number represents the total sum of squares of these standardized values.|<br>|fit$withinss|Within sum of squares for each cluster.|<br>|fit$tot.withinss|Total of the withinss values.|<br>|fit$betweenss|Total sum of squares if we represent each case by just the center of its cluster.|<br>|fit$size|Number of cases in each cluster.|<br>|fit$iter|Number of iterations used.|<br>|fit$ifault|An indicator of a possible algorithm problem—for experts.|</p>
<p>In step 5 a scatterplot matrix is generated and the points are colored based on the clustering vector from the results of K-means clustering.</p>
<p>In step 6 use the clusplot function from the cluster package to generate a bivariate plot of the first two principal components (see Reducing dimensionality with principal components analysis in this chapter). From the bottom of the plot, we see that the first two principal components explain nearly 92 percent of the overall variability and hence the plot can be treated as a good representation of the overall clustering along the six original dimensions.</p>
<h3 id="There’s-more…-30"><a href="#There’s-more…-30" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>Once the value of K is known, K-means clustering can be performed. We now provide you with a recipe to ease the process of choosing a suitable value for K.</p>
<h3 id="Use-a-convenience-function-to-choose-a-value-for-K"><a href="#Use-a-convenience-function-to-choose-a-value-for-K" class="headerlink" title="Use a convenience function to choose a value for K"></a>Use a convenience function to choose a value for K</h3><p>Using what we covered, you can try out various values of K and choose a suitable one. To avoid the repetitive tasks involved in doing this, we suggest the following convenience function:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rdacb.kmeans.plot &lt;- <span class="keyword">function</span> (data, num_clust = <span class="number">15</span>, seed = <span class="number">9876</span>) &#123;</span><br><span class="line">  set.seed(seed)</span><br><span class="line">  ss &lt;- numeric(num_clust)</span><br><span class="line">  ss[<span class="number">1</span>] &lt;- (nrow(data) - <span class="number">1</span>) * sum(apply(data, <span class="number">2</span>, var))</span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">2</span>:num_clust) &#123;</span><br><span class="line">    ss[i] &lt;- sum(kmeans(data, centers = i)$withinss)</span><br><span class="line">  &#125;</span><br><span class="line">  plot(<span class="number">1</span>:num_clust, ss, type = <span class="string">"b"</span>, pch = <span class="number">18</span>, xlab = <span class="string">"# Clusters"</span>, ylab = <span class="string">"Total within_ss across clusters"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Since the method generates a plot and helps you identify the place where the gain in performance tapers off—the elbow in the graph—it is sometimes referred to as the “elbow” technique.</p>
<p>The preceding function generates and plots the total withinss across all clusters for values of K between 1 and 15. We can also supply an upper limit for K through the num_clust argument. Armed with the function, we can standardize the variables of interest as in the main recipe and then run:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; rdacb.kmeans.plot(auto[,<span class="number">10</span>:<span class="number">15</span>])</span><br></pre></td></tr></table></figure>
<p><img src="img/5_2_3.jpeg" alt=""></p>
<p>From the resulting plot, we can identify the value of K where the drop in the total withinss tapers off—the elbow in the graph. We may choose K=4 or K=5 in this situation. If we really wanted very few clusters, K=3 may also be a good choice. We can always get a very low value for withinss by increasing the number of clusters. However, we want to strike a balance between the value of withinss and the number of clusters.</p>
<h3 id="See-also…-20"><a href="#See-also…-20" class="headerlink" title="See also…"></a>See also…</h3><p>Performing cluster analysis using hierarchical clustering in this chapter</p>
<h2 id="Performing-cluster-analysis-using-hierarchical-clustering"><a href="#Performing-cluster-analysis-using-hierarchical-clustering" class="headerlink" title="Performing cluster analysis using hierarchical clustering"></a>Performing cluster analysis using hierarchical clustering</h2><p>The hclust function in the package stats helps us perform hierarchical clustering.</p>
<h3 id="Getting-ready-44"><a href="#Getting-ready-44" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the data files for this chapter, do it now and ensure that the auto-mpg.csv file is in R’s working directory.</p>
<p>We will hierarchically cluster the data based on the variables mpg, cylinders, displacement, horsepower, weight, and acceleration.</p>
<h3 id="How-to-do-it…-45"><a href="#How-to-do-it…-45" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To perform cluster analysis using hierarchical clustering, follow these steps:</p>
<ol>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Define a convenience function to standardize the relevant variables and append the resulting variables to the original data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rdacb.scale.many &lt;- <span class="keyword">function</span> (dat, column_nos) &#123;</span><br><span class="line">  nms &lt;- names(dat)</span><br><span class="line">  <span class="keyword">for</span> (col <span class="keyword">in</span> column_nos) &#123;</span><br><span class="line">    name &lt;- paste0(nms[col], <span class="string">"_z"</span>)</span><br><span class="line">    dat[name] &lt;- scale(dat[, col])</span><br><span class="line">  &#125;</span><br><span class="line">  cat(paste(<span class="string">"Scaled"</span>, length(column_nos), <span class="string">"variable(s)\n"</span>))</span><br><span class="line"> dat</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Use the preceding convenience function to standardize the variables of interest. We will ignore the variables No, <code>model_year</code>, and <code>car_name</code>:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- rdacb.scale.many(auto, <span class="number">2</span>:<span class="number">7</span>)</span><br><span class="line">&gt; <span class="comment"># See the variables now in auto</span></span><br><span class="line">&gt; names(auto)</span><br><span class="line"> [<span class="number">1</span>] <span class="string">"No"</span>             <span class="string">"mpg"</span></span><br><span class="line"> [<span class="number">3</span>] <span class="string">"cylinders"</span>      <span class="string">"displacement"</span></span><br><span class="line"> [<span class="number">5</span>] <span class="string">"horsepower"</span>     <span class="string">"weight"</span></span><br><span class="line"> [<span class="number">7</span>] <span class="string">"acceleration"</span>   <span class="string">"model_year"</span></span><br><span class="line"> [<span class="number">9</span>] <span class="string">"car_name"</span>       <span class="string">"mpg_z"</span></span><br><span class="line">[<span class="number">11</span>] <span class="string">"cylinders_z"</span>    <span class="string">"displacement_z"</span></span><br><span class="line">[<span class="number">13</span>] <span class="string">"horsepower_z"</span>   <span class="string">"weight_z"</span></span><br><span class="line">[<span class="number">15</span>] <span class="string">"acceleration_z"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Compute the distance matrix to provide as input to the hclust function in the next step. We use Euclidean distances here:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dis &lt;- dist(auto[,<span class="number">10</span>:<span class="number">15</span>], method = <span class="string">"euclidean"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Use the hclust function to perform hierarchical clustering:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; fit &lt;- hclust(dis, method = <span class="string">"ward"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the dendrogram representing the result of clustering. The result looks very crowded at the bottom because the function plots every single case in the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(fit, labels = <span class="literal">FALSE</span>, hang = <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_4.jpeg" alt=""></p>
</li>
<li><p>Select a value for K and place a rectangle around each of the K clusters. We use k=4 in the following code:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; rect.hclust(fit, k=<span class="number">4</span>, border=<span class="string">"blue"</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_5.jpeg" alt=""></p>
</li>
<li><p>Get the cluster to which each case belongs:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; cluster &lt;- cutree(fit, k=<span class="number">4</span>)</span><br><span class="line">&gt; cluster</span><br><span class="line">  [<span class="number">1</span>] <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"> [<span class="number">26</span>] <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span></span><br><span class="line"> [<span class="number">51</span>] <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span></span><br><span class="line"> [<span class="number">76</span>] <span class="number">4</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">1</span> <span class="number">4</span></span><br><span class="line">[<span class="number">101</span>] <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">[<span class="number">126</span>] <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span></span><br><span class="line">[<span class="number">151</span>] <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line">[<span class="number">176</span>] <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span></span><br><span class="line">[<span class="number">201</span>] <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">4</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span></span><br><span class="line">[<span class="number">226</span>] <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">4</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">[<span class="number">251</span>] <span class="number">1</span> <span class="number">4</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span></span><br><span class="line">[<span class="number">276</span>] <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line">[<span class="number">301</span>] <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">4</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span></span><br><span class="line">[<span class="number">326</span>] <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span></span><br><span class="line">[<span class="number">351</span>] <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">4</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span></span><br><span class="line">[<span class="number">376</span>] <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">3</span> <span class="number">2</span> <span class="number">4</span> <span class="number">2</span> <span class="number">4</span> <span class="number">4</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-42"><a href="#How-it-works…-42" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the data is read and in step 2 we define the convenience function for scaling a set of variables in a data frame.</p>
<p>In step 3 the convenience function is used to scale only the variables of interest. We leave out the No, <code>model_year</code>, and <code>car_name</code> variables.</p>
<p>In step 4 the distance matrix is created based on the standardized values of the relevant variables. We have computed Euclidean distances; other possibilities are: maximum, manhattan, canberra, binary, and minkowski.</p>
<p>In step 5 the distance matrix is passed to the hclust function to create the clustering model. We specified method = “ward” to use Ward’s method, which tries to get compact spherical clusters. The hclust function also supports single, complete, average, mcquitty, median, and centroid.</p>
<p>In step 6 the resulting dendrogram is plotted. We specified labels=FALSE because we have too many cases and printing them will only add clutter. With a smaller dataset, using labels = TRUE will make sense. The hang argument controls the distance from the bottom of the dendrogram to the labels. Since we are not using labels, we specified hang = 0 to prevent numerous vertical lines below the dendrogram.</p>
<p>The dendrogram shows all the cases at the bottom (too numerous to distinguish in our plot) and shows the step-by-step agglomeration of the clusters. The dendrogram is organized in such a way that we can obtain a desired set of clusters, say K, by drawing a horizontal line in such a way that it cuts across exactly K vertical lines on the dendrogram.</p>
<p>Step 7 show how to use the rect.hclust function to demarcate the cases comprising the various clusters for a selected value of k.</p>
<p>Step 8 shows how we can use the cutree function to identify, for a specific K, which cluster each case of our data belongs to.</p>
<h3 id="See-also…-21"><a href="#See-also…-21" class="headerlink" title="See also…"></a>See also…</h3><p>Performing cluster analysis using K-means clustering in this chapter</p>
<h2 id="Reducing-dimensionality-with-principal-component-analysis"><a href="#Reducing-dimensionality-with-principal-component-analysis" class="headerlink" title="Reducing dimensionality with principal component analysis"></a>Reducing dimensionality with principal component analysis</h2><p>The stats package offers the prcomp function to perform PCA. This recipe shows you how to perform PCA using these capabilities.</p>
<h3 id="Getting-ready-45"><a href="#Getting-ready-45" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the data files for this chapter and ensure that the BostonHousing.csv file is in your R working directory. We want to predict MEDV based on the remaining 13 predictor variables. We will use PCA to reduce the dimensionality.</p>
<h3 id="How-to-do-it…-46"><a href="#How-to-do-it…-46" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To reduce dimensionality with PCA, follow the steps:</p>
<ol>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh &lt;- read.csv(<span class="string">"BostonHousing.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>View the correlation matrix to check whether some variables are highly correlated and whether PCA has the potential to yield some dimensionality reduction. Since we are interested in reducing the dimensionality of the predictor variables, we leave out the outcome variable MEDV:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt; round(cor(bh[,-<span class="number">14</span>]),<span class="number">2</span>)</span><br><span class="line">         CRIM    ZN INDUS  CHAS   NOX    RM   AGE</span><br><span class="line">CRIM     <span class="number">1.00</span> -<span class="number">0.20</span>  <span class="number">0.41</span> -<span class="number">0.06</span>  <span class="number">0.42</span> -<span class="number">0.22</span>  <span class="number">0.35</span></span><br><span class="line">ZN      -<span class="number">0.20</span>  <span class="number">1.00</span> -<span class="number">0.53</span> -<span class="number">0.04</span> -<span class="number">0.52</span>  <span class="number">0.31</span> -<span class="number">0.57</span></span><br><span class="line">INDUS    <span class="number">0.41</span> -<span class="number">0.53</span>  <span class="number">1.00</span>  <span class="number">0.06</span>  <span class="number">0.76</span> -<span class="number">0.39</span>  <span class="number">0.64</span></span><br><span class="line">CHAS    -<span class="number">0.06</span> -<span class="number">0.04</span>  <span class="number">0.06</span>  <span class="number">1.00</span>  <span class="number">0.09</span>  <span class="number">0.09</span>  <span class="number">0.09</span></span><br><span class="line">NOX      <span class="number">0.42</span> -<span class="number">0.52</span>  <span class="number">0.76</span>  <span class="number">0.09</span>  <span class="number">1.00</span> -<span class="number">0.30</span>  <span class="number">0.73</span></span><br><span class="line">RM      -<span class="number">0.22</span>  <span class="number">0.31</span> -<span class="number">0.39</span>  <span class="number">0.09</span> -<span class="number">0.30</span>  <span class="number">1.00</span> -<span class="number">0.24</span></span><br><span class="line">AGE      <span class="number">0.35</span> -<span class="number">0.57</span>  <span class="number">0.64</span>  <span class="number">0.09</span>  <span class="number">0.73</span> -<span class="number">0.24</span>  <span class="number">1.00</span></span><br><span class="line">DIS     -<span class="number">0.38</span>  <span class="number">0.66</span> -<span class="number">0.71</span> -<span class="number">0.10</span> -<span class="number">0.77</span>  <span class="number">0.21</span> -<span class="number">0.75</span></span><br><span class="line">RAD      <span class="number">0.63</span> -<span class="number">0.31</span>  <span class="number">0.60</span> -<span class="number">0.01</span>  <span class="number">0.61</span> -<span class="number">0.21</span>  <span class="number">0.46</span></span><br><span class="line">TAX      <span class="number">0.58</span> -<span class="number">0.31</span>  <span class="number">0.72</span> -<span class="number">0.04</span>  <span class="number">0.67</span> -<span class="number">0.29</span>  <span class="number">0.51</span></span><br><span class="line">PTRATIO  <span class="number">0.29</span> -<span class="number">0.39</span>  <span class="number">0.38</span> -<span class="number">0.12</span>  <span class="number">0.19</span> -<span class="number">0.36</span>  <span class="number">0.26</span></span><br><span class="line">B       -<span class="number">0.39</span>  <span class="number">0.18</span> -<span class="number">0.36</span>  <span class="number">0.05</span> -<span class="number">0.38</span>  <span class="number">0.13</span> -<span class="number">0.27</span></span><br><span class="line">LSTAT    <span class="number">0.46</span> -<span class="number">0.41</span>  <span class="number">0.60</span> -<span class="number">0.05</span>  <span class="number">0.59</span> -<span class="number">0.61</span>  <span class="number">0.60</span></span><br><span class="line">          DIS   RAD   TAX PTRATIO     B LSTAT</span><br><span class="line">CRIM    -<span class="number">0.38</span>  <span class="number">0.63</span>  <span class="number">0.58</span>    <span class="number">0.29</span> -<span class="number">0.39</span>  <span class="number">0.46</span></span><br><span class="line">ZN       <span class="number">0.66</span> -<span class="number">0.31</span> -<span class="number">0.31</span>   -<span class="number">0.39</span>  <span class="number">0.18</span> -<span class="number">0.41</span></span><br><span class="line">INDUS   -<span class="number">0.71</span>  <span class="number">0.60</span>  <span class="number">0.72</span>    <span class="number">0.38</span> -<span class="number">0.36</span>  <span class="number">0.60</span></span><br><span class="line">CHAS    -<span class="number">0.10</span> -<span class="number">0.01</span> -<span class="number">0.04</span>   -<span class="number">0.12</span>  <span class="number">0.05</span> -<span class="number">0.05</span></span><br><span class="line">NOX     -<span class="number">0.77</span>  <span class="number">0.61</span>  <span class="number">0.67</span>    <span class="number">0.19</span> -<span class="number">0.38</span>  <span class="number">0.59</span></span><br><span class="line">RM       <span class="number">0.21</span> -<span class="number">0.21</span> -<span class="number">0.29</span>   -<span class="number">0.36</span>  <span class="number">0.13</span> -<span class="number">0.61</span></span><br><span class="line">AGE     -<span class="number">0.75</span>  <span class="number">0.46</span>  <span class="number">0.51</span>    <span class="number">0.26</span> -<span class="number">0.27</span>  <span class="number">0.60</span></span><br><span class="line">DIS      <span class="number">1.00</span> -<span class="number">0.49</span> -<span class="number">0.53</span>   -<span class="number">0.23</span>  <span class="number">0.29</span> -<span class="number">0.50</span></span><br><span class="line">RAD     -<span class="number">0.49</span>  <span class="number">1.00</span>  <span class="number">0.91</span>    <span class="number">0.46</span> -<span class="number">0.44</span>  <span class="number">0.49</span></span><br><span class="line">TAX     -<span class="number">0.53</span>  <span class="number">0.91</span>  <span class="number">1.00</span>    <span class="number">0.46</span> -<span class="number">0.44</span>  <span class="number">0.54</span></span><br><span class="line">PTRATIO -<span class="number">0.23</span>  <span class="number">0.46</span>  <span class="number">0.46</span>    <span class="number">1.00</span> -<span class="number">0.18</span>  <span class="number">0.37</span></span><br><span class="line">B        <span class="number">0.29</span> -<span class="number">0.44</span> -<span class="number">0.44</span>   -<span class="number">0.18</span>  <span class="number">1.00</span> -<span class="number">0.37</span></span><br><span class="line">LSTAT   -<span class="number">0.50</span>  <span class="number">0.49</span>  <span class="number">0.54</span>    <span class="number">0.37</span> -<span class="number">0.37</span>  <span class="number">1.00</span></span><br></pre></td></tr></table></figure>
<p> Ignoring the main diagonal, we see several correlations above 0.5, and a PCA can help to reduce the dimensionality.</p>
</li>
<li><p>We can perform the preceding step visually as well by plotting the scatterplot matrix:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(bh[,-<span class="number">14</span>])</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_6.jpeg" alt=""></p>
</li>
<li><p>Build the PCA model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh.pca &lt;- prcomp(bh[,-<span class="number">14</span>], scale = <span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Examine the rotations for the principal components generated:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&gt; print(bh.pca)</span><br><span class="line"></span><br><span class="line">Standard deviations:</span><br><span class="line"> [<span class="number">1</span>] <span class="number">2.4752472</span> <span class="number">1.1971947</span> <span class="number">1.1147272</span> <span class="number">0.9260535</span> <span class="number">0.9136826</span></span><br><span class="line"> [<span class="number">6</span>] <span class="number">0.8108065</span> <span class="number">0.7316803</span> <span class="number">0.6293626</span> <span class="number">0.5262541</span> <span class="number">0.4692950</span></span><br><span class="line">[<span class="number">11</span>] <span class="number">0.4312938</span> <span class="number">0.4114644</span> <span class="number">0.2520104</span></span><br><span class="line"></span><br><span class="line">Rotation:</span><br><span class="line">                 PC1         PC2         PC3         PC4</span><br><span class="line">CRIM     <span class="number">0.250951397</span> -<span class="number">0.31525237</span>  <span class="number">0.24656649</span> -<span class="number">0.06177071</span></span><br><span class="line">ZN      -<span class="number">0.256314541</span> -<span class="number">0.32331290</span>  <span class="number">0.29585782</span> -<span class="number">0.12871159</span></span><br><span class="line">INDUS    <span class="number">0.346672065</span>  <span class="number">0.11249291</span> -<span class="number">0.01594592</span> -<span class="number">0.01714571</span></span><br><span class="line">CHAS     <span class="number">0.005042434</span>  <span class="number">0.45482914</span>  <span class="number">0.28978082</span> -<span class="number">0.81594136</span></span><br><span class="line">NOX      <span class="number">0.342852313</span>  <span class="number">0.21911553</span>  <span class="number">0.12096411</span>  <span class="number">0.12822614</span></span><br><span class="line">RM      -<span class="number">0.189242570</span>  <span class="number">0.14933154</span>  <span class="number">0.59396117</span>  <span class="number">0.28059184</span></span><br><span class="line">AGE      <span class="number">0.313670596</span>  <span class="number">0.31197778</span> -<span class="number">0.01767481</span>  <span class="number">0.17520603</span></span><br><span class="line">DIS     -<span class="number">0.321543866</span> -<span class="number">0.34907000</span> -<span class="number">0.04973627</span> -<span class="number">0.21543585</span></span><br><span class="line">RAD      <span class="number">0.319792768</span> -<span class="number">0.27152094</span>  <span class="number">0.28725483</span> -<span class="number">0.13234996</span></span><br><span class="line">TAX      <span class="number">0.338469147</span> -<span class="number">0.23945365</span>  <span class="number">0.22074447</span> -<span class="number">0.10333509</span></span><br><span class="line">PTRATIO  <span class="number">0.204942258</span> -<span class="number">0.30589695</span> -<span class="number">0.32344627</span> -<span class="number">0.28262198</span></span><br><span class="line">B       -<span class="number">0.202972612</span>  <span class="number">0.23855944</span> -<span class="number">0.30014590</span> -<span class="number">0.16849850</span></span><br><span class="line">LSTAT    <span class="number">0.309759840</span> -<span class="number">0.07432203</span> -<span class="number">0.26700025</span> -<span class="number">0.06941441</span></span><br><span class="line">                 PC5         PC6          PC7          PC8</span><br><span class="line">CRIM     <span class="number">0.082156919</span> -<span class="number">0.21965961</span>  <span class="number">0.777607207</span> -<span class="number">0.153350477</span></span><br><span class="line">ZN       <span class="number">0.320616987</span> -<span class="number">0.32338810</span> -<span class="number">0.274996280</span>  <span class="number">0.402680309</span></span><br><span class="line">INDUS   -<span class="number">0.007811194</span> -<span class="number">0.07613790</span> -<span class="number">0.339576454</span> -<span class="number">0.173931716</span></span><br><span class="line">CHAS     <span class="number">0.086530945</span>  <span class="number">0.16749014</span>  <span class="number">0.074136208</span>  <span class="number">0.024662148</span></span><br><span class="line">NOX      <span class="number">0.136853557</span> -<span class="number">0.15298267</span> -<span class="number">0.199634840</span> -<span class="number">0.080120560</span></span><br><span class="line">RM      -<span class="number">0.423447195</span>  <span class="number">0.05926707</span>  <span class="number">0.063939924</span>  <span class="number">0.326752259</span></span><br><span class="line">AGE      <span class="number">0.016690847</span> -<span class="number">0.07170914</span>  <span class="number">0.116010713</span>  <span class="number">0.600822917</span></span><br><span class="line">DIS      <span class="number">0.098592247</span>  <span class="number">0.02343872</span> -<span class="number">0.103900440</span>  <span class="number">0.121811982</span></span><br><span class="line">RAD     -<span class="number">0.204131621</span> -<span class="number">0.14319401</span> -<span class="number">0.137942546</span> -<span class="number">0.080358311</span></span><br><span class="line">TAX     -<span class="number">0.130460565</span> -<span class="number">0.19293428</span> -<span class="number">0.314886835</span> -<span class="number">0.082774347</span></span><br><span class="line">PTRATIO -<span class="number">0.584002232</span>  <span class="number">0.27315330</span>  <span class="number">0.002323869</span>  <span class="number">0.317884202</span></span><br><span class="line">B       -<span class="number">0.345606947</span> -<span class="number">0.80345454</span>  <span class="number">0.070294759</span>  <span class="number">0.004922915</span></span><br><span class="line">LSTAT    <span class="number">0.394561129</span> -<span class="number">0.05321583</span>  <span class="number">0.087011169</span>  <span class="number">0.424352926</span></span><br><span class="line">               PC9         PC10        PC11         PC12</span><br><span class="line">CRIM     <span class="number">0.26039028</span> -<span class="number">0.019369130</span> -<span class="number">0.10964435</span> -<span class="number">0.086761070</span></span><br><span class="line">ZN       <span class="number">0.35813749</span> -<span class="number">0.267527234</span>  <span class="number">0.26275629</span>  <span class="number">0.071425278</span></span><br><span class="line">INDUS    <span class="number">0.64441615</span>  <span class="number">0.363532262</span> -<span class="number">0.30316943</span>  <span class="number">0.113199629</span></span><br><span class="line">CHAS    -<span class="number">0.01372777</span>  <span class="number">0.006181836</span>  <span class="number">0.01392667</span>  <span class="number">0.003982683</span></span><br><span class="line">NOX     -<span class="number">0.01852201</span> -<span class="number">0.231056455</span>  <span class="number">0.11131888</span> -<span class="number">0.804322567</span></span><br><span class="line">RM       <span class="number">0.04789804</span>  <span class="number">0.431420193</span>  <span class="number">0.05316154</span> -<span class="number">0.152872864</span></span><br><span class="line">AGE     -<span class="number">0.06756218</span> -<span class="number">0.362778957</span> -<span class="number">0.45915939</span>  <span class="number">0.211936074</span></span><br><span class="line">DIS     -<span class="number">0.15329124</span>  <span class="number">0.171213138</span> -<span class="number">0.69569257</span> -<span class="number">0.390941129</span></span><br><span class="line">RAD     -<span class="number">0.47089067</span> -<span class="number">0.021909452</span>  <span class="number">0.03654388</span>  <span class="number">0.107025890</span></span><br><span class="line">TAX     -<span class="number">0.17656339</span>  <span class="number">0.035168348</span> -<span class="number">0.10483575</span>  <span class="number">0.215191126</span></span><br><span class="line">PTRATIO  <span class="number">0.25442836</span> -<span class="number">0.153430488</span>  <span class="number">0.17450534</span> -<span class="number">0.209598826</span></span><br><span class="line">B       -<span class="number">0.04489802</span>  <span class="number">0.096515117</span>  <span class="number">0.01927490</span> -<span class="number">0.041723158</span></span><br><span class="line">LSTAT   -<span class="number">0.19522139</span>  <span class="number">0.600711409</span>  <span class="number">0.27138243</span> -<span class="number">0.055225960</span></span><br><span class="line">               PC13</span><br><span class="line">CRIM     <span class="number">0.045952304</span></span><br><span class="line">ZN      -<span class="number">0.080918973</span></span><br><span class="line">INDUS   -<span class="number">0.251076540</span></span><br><span class="line">CHAS     <span class="number">0.035921715</span></span><br><span class="line">NOX      <span class="number">0.043630446</span></span><br><span class="line">RM       <span class="number">0.045567096</span></span><br><span class="line">AGE     -<span class="number">0.038550683</span></span><br><span class="line">DIS     -<span class="number">0.018298538</span></span><br><span class="line">RAD     -<span class="number">0.633489720</span></span><br><span class="line">TAX      <span class="number">0.720233448</span></span><br><span class="line">PTRATIO  <span class="number">0.023398052</span></span><br><span class="line">B       -<span class="number">0.004463073</span></span><br><span class="line">LSTAT    <span class="number">0.024431677</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Examine the importance of the principal components:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; summary(bh.pca)</span><br><span class="line"></span><br><span class="line">Importance of components:</span><br><span class="line">                         PC1    PC2     PC3     PC4</span><br><span class="line">Standard deviation     <span class="number">2.4752</span> <span class="number">1.1972</span> <span class="number">1.11473</span> <span class="number">0.92605</span></span><br><span class="line">Proportion of Variance <span class="number">0.4713</span> <span class="number">0.1103</span> <span class="number">0.09559</span> <span class="number">0.06597</span></span><br><span class="line">Cumulative Proportion  <span class="number">0.4713</span> <span class="number">0.5816</span> <span class="number">0.67713</span> <span class="number">0.74310</span></span><br><span class="line">                           PC5     PC6     PC7     PC8</span><br><span class="line">Standard deviation     <span class="number">0.91368</span> <span class="number">0.81081</span> <span class="number">0.73168</span> <span class="number">0.62936</span></span><br><span class="line">Proportion of Variance <span class="number">0.06422</span> <span class="number">0.05057</span> <span class="number">0.04118</span> <span class="number">0.03047</span></span><br><span class="line">Cumulative Proportion  <span class="number">0.80732</span> <span class="number">0.85789</span> <span class="number">0.89907</span> <span class="number">0.92954</span></span><br><span class="line">                          PC9    PC10    PC11    PC12</span><br><span class="line">Standard deviation     <span class="number">0.5263</span> <span class="number">0.46930</span> <span class="number">0.43129</span> <span class="number">0.41146</span></span><br><span class="line">Proportion of Variance <span class="number">0.0213</span> <span class="number">0.01694</span> <span class="number">0.01431</span> <span class="number">0.01302</span></span><br><span class="line">Cumulative Proportion  <span class="number">0.9508</span> <span class="number">0.96778</span> <span class="number">0.98209</span> <span class="number">0.99511</span></span><br><span class="line">                        PC13</span><br><span class="line">Standard deviation     <span class="number">0.25201</span></span><br><span class="line">Proportion of Variance <span class="number">0.00489</span></span><br><span class="line">Cumulative Proportion  <span class="number">1.00000</span></span><br></pre></td></tr></table></figure>
<p> Note that from the reported cumulative proportions, the first seven principal components account for almost 90% of the variance.</p>
</li>
<li><p>Visualize the importance of the components through a scree plot or a barplot:<br> For a barplot use the following command:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># barplot</span></span><br><span class="line">&gt; plot(bh.pca)</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_7.jpeg" alt=""></p>
<p> For a scree plot the following command can be used:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># scree plot</span></span><br><span class="line">&gt; plot(bh.pca, type = <span class="string">"lines"</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_8.jpeg" alt=""></p>
</li>
<li><p>Create a biplot of the PCA results:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; biplot(bh.pca, col = c(<span class="string">"gray"</span>, <span class="string">"black"</span>))</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_9.jpeg" alt=""></p>
</li>
<li><p>Use the x component of bh.pca to see the computed principal component values for each of these cases:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; head(bh.pca$x, <span class="number">3</span>)</span><br><span class="line">           PC1       PC2        PC3       PC4</span><br><span class="line">[<span class="number">1</span>,] -<span class="number">2.096223</span> <span class="number">0.7723484</span>  <span class="number">0.3426037</span> <span class="number">0.8908924</span></span><br><span class="line">[<span class="number">2</span>,] -<span class="number">1.455811</span> <span class="number">0.5914000</span> -<span class="number">0.6945120</span> <span class="number">0.4869766</span></span><br><span class="line">[<span class="number">3</span>,] -<span class="number">2.072547</span> <span class="number">0.5990466</span>  <span class="number">0.1669564</span> <span class="number">0.7384734</span></span><br><span class="line">           PC5        PC6       PC7        PC8</span><br><span class="line">[<span class="number">1</span>,]  <span class="number">0.4226521</span> -<span class="number">0.3150264</span> <span class="number">0.3183257</span> -<span class="number">0.2955393</span></span><br><span class="line">[<span class="number">2</span>,] -<span class="number">0.1956820</span>  <span class="number">0.2639620</span> <span class="number">0.5533137</span>  <span class="number">0.2234488</span></span><br><span class="line">[<span class="number">3</span>,] -<span class="number">0.9336102</span>  <span class="number">0.4476516</span> <span class="number">0.4840809</span> -<span class="number">0.1050622</span></span><br><span class="line">             PC9        PC10        PC11</span><br><span class="line">[<span class="number">1</span>,] -<span class="number">0.42451671</span> -<span class="number">0.63957348</span> -<span class="number">0.03296774</span></span><br><span class="line">[<span class="number">2</span>,] -<span class="number">0.16679701</span> -<span class="number">0.08415319</span> -<span class="number">0.64017631</span></span><br><span class="line">[<span class="number">3</span>,]  <span class="number">0.06970615</span>  <span class="number">0.18020170</span> -<span class="number">0.48707471</span></span><br><span class="line">          PC12        PC13</span><br><span class="line">[<span class="number">1</span>,] -<span class="number">0.01942101</span>  <span class="number">0.36561351</span></span><br><span class="line">[<span class="number">2</span>,]  <span class="number">0.12567304</span> -<span class="number">0.07064958</span></span><br><span class="line">[<span class="number">3</span>,] -<span class="number">0.13319472</span> -<span class="number">0.01400794</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>See the rotations and standard deviations using the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; bh.pca$rotation</span><br><span class="line">&gt; bh.pca$sdev</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-43"><a href="#How-it-works…-43" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the data is read.</p>
<p>In step 2 the correlation matrix of the relevant dimensions is generated to examine if there is scope for PCA to yield some dimensionality reduction. If most of the correlations are low, then PCA might not yield any reductions.</p>
<p>In step 3 the same is done graphically by showing a scatterplot matrix of the relevant variables.</p>
<p>In step 4 the PCA model is generated using the prcomp function. We used scale=TRUE to generate the model based on the correlation matrix and not the covariance matrix.</p>
<p>In step 5 the resulting model is printed. It shows the standard deviations of the variables used and the rotations for all the principal components in decreasing order of importance.</p>
<p>In step 6 the summary function is used to get different information on the model. This display is also ordered in decreasing order of importance of the components. For each principal component, this shows its standard deviation, proportion of variance, and the cumulative proportion of variance. We can use this to identify the components that capture most of the variability in the dataset. For example, the output tells us that the top 7 of the 13 principal components account for almost 90 percent of the variance.</p>
<p>In step 7 a barplot as well as a scree plot of the variances by PCA is generated using the plot function.</p>
<p>Step 8 shows how to generate the biplot. It uses the first two principal components as the main axes and shows how each variable loads on these two components. The top and right axes correspond to the scores of the data points on the two principal components.</p>
<p>In step 9 the predict function is used to view the principal component scores for each of our data points. You can also use this function to compute the principal component scores for new data:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; predict(bh.pca, newdata = …)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Chapter-6-Lessons-from-History-–-Time-Series-Analysis"><a href="#Chapter-6-Lessons-from-History-–-Time-Series-Analysis" class="headerlink" title="Chapter 6. Lessons from History – Time Series Analysis"></a>Chapter 6. Lessons from History – Time Series Analysis</h1><p>In this chapter, we will cover:</p>
<ul>
<li>Creating and examining date objects</li>
<li>Operating on date objects</li>
<li>Performing preliminary analyses on time series data</li>
<li>Using time series objects</li>
<li>Decomposing time series</li>
<li>Filtering time series data</li>
<li>Smoothing and forecasting using the Holt-Winters method</li>
<li>Building an automated ARIMA Model</li>
</ul>
<h2 id="Introduction-5"><a href="#Introduction-5" class="headerlink" title="Introduction"></a>Introduction</h2><p>R has exceptional features for time series analysis and this chapter covers the topic through a chosen set of recipes. The stats package provides a basic set of features and several other packages go beyond.</p>
<h2 id="Creating-and-examining-date-objects"><a href="#Creating-and-examining-date-objects" class="headerlink" title="Creating and examining date objects"></a>Creating and examining date objects</h2><p>The base R package provides date functionality. This grab-bag recipe shows you several date-related operations in R. R internally represents dates as the number of days from 1 January, 1970.</p>
<h3 id="Getting-ready-46"><a href="#Getting-ready-46" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>In this recipe, we will only be using features from the base package and not from any external data. Therefore, you do not need to perform any preparatory steps.</p>
<h3 id="How-to-do-it…-47"><a href="#How-to-do-it…-47" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Internally, R represents dates as the number of days from 1 January, 1970:</p>
<ol>
<li><p>Get today’s date:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; Sys.Date()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a date object from a string:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Supply year as two digits</span></span><br><span class="line">&gt; <span class="comment"># Note correspondence between separators in the date string and the format string</span></span><br><span class="line">&gt; as.Date(<span class="string">"1/1/80"</span>, format = <span class="string">"%m/%d/%y"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1980-01-01"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Supply year as 4 digits</span></span><br><span class="line">&gt; <span class="comment"># Note uppercase Y below instead of lowercase y as above</span></span><br><span class="line">&gt; as.Date(<span class="string">"1/1/1980"</span>, format = <span class="string">"%m/%d/%Y"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1980-01-01"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># If you omit format string, you must give date as "yyyy/mm/dd" or as "yyyy-mm-dd"</span></span><br><span class="line">&gt; as.Date(<span class="string">"1970/1/1"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1970-01-01"</span></span><br><span class="line"></span><br><span class="line">&gt; as.Date(<span class="string">"70/1/1"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"0070-01-01"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Use other options for separators (this example uses hyphens) in the format string, and also see the underlying numeric value:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; dt &lt;- as.Date(<span class="string">"1-1-70"</span>, format = <span class="string">"%m-%d-%y"</span>)</span><br><span class="line">&gt; as.numeric(dt)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Explore other format string options:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; as.Date(<span class="string">"Jan 15, 2015"</span>, format = <span class="string">"%b %d, %Y"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"2015-01-15"</span></span><br><span class="line"></span><br><span class="line">&gt; as.Date(<span class="string">"January 15, 15"</span>, format = <span class="string">"%B %d, %y"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"2015-01-15"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create dates from numbers by typecasting:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; dt &lt;- <span class="number">1000</span></span><br><span class="line">&gt; class(dt) &lt;- <span class="string">"Date"</span></span><br><span class="line">&gt; dt                 <span class="comment"># 1000 days from 1/1/70</span></span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1972-09-27"</span></span><br><span class="line"></span><br><span class="line">&gt; dt &lt;- -<span class="number">1000</span></span><br><span class="line">&gt; class(dt) &lt;- <span class="string">"Date"</span></span><br><span class="line">&gt; dt                 <span class="comment"># 1000 days before 1/1/70</span></span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1967-04-07"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create dates directly from numbers by setting the origin date:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; as.Date(<span class="number">1000</span>, origin = as.Date(<span class="string">"1980-03-31"</span>))</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1982-12-26"</span></span><br><span class="line"></span><br><span class="line">&gt; as.Date(-<span class="number">1000</span>, origin = as.Date(<span class="string">"1980-03-31"</span>))</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1977-07-05"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Examine date components:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&gt; dt &lt;- as.Date(<span class="number">1000</span>, origin = as.Date(<span class="string">"1980-03-31"</span>))</span><br><span class="line">&gt; dt</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1982-12-26"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Get year as four digits</span></span><br><span class="line">&gt; format(dt, <span class="string">"%Y"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1982"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Get the year as a number rather than as character string</span></span><br><span class="line">&gt; as.numeric(format(dt, <span class="string">"%Y"</span>))</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">1982</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Get year as two digits</span></span><br><span class="line">&gt; format(dt, <span class="string">"%y"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"82"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Get month</span></span><br><span class="line">&gt; format(dt, <span class="string">"%m"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"12"</span></span><br><span class="line"></span><br><span class="line">&gt; as.numeric(format(dt, <span class="string">"%m"</span>))</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">12</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Get month as string</span></span><br><span class="line">&gt; format(dt, <span class="string">"%b"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"Dec"</span></span><br><span class="line"></span><br><span class="line">&gt; format(dt, <span class="string">"%B"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"December"</span></span><br><span class="line"></span><br><span class="line">&gt; months(dt)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"December"</span></span><br><span class="line"></span><br><span class="line">&gt; weekdays(dt)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"Sunday"</span></span><br><span class="line"></span><br><span class="line">&gt; quarters(dt)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Q4"</span></span><br><span class="line"></span><br><span class="line">&gt; julian(dt)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">4742</span></span><br><span class="line">attr(,<span class="string">"origin"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"1970-01-01"</span></span><br><span class="line"></span><br><span class="line">&gt; julian(dt, origin = as.Date(<span class="string">"1980-03-31"</span>))</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">1000</span></span><br><span class="line">attr(,<span class="string">"origin"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"1980-03-31"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-44"><a href="#How-it-works…-44" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 shows how to get the system date.</p>
<p>Steps 2 through 4 show how to create dates from strings. You can see that, by specifying the format string appropriately, we can read dates from almost any string representation. We can use any separators, as long as we mimic them in the format string. The following table summarizes the formatting options for the components of the date:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Format specifier</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">%d</td>
<td>Day of month as a number—for example, 15</td>
</tr>
<tr>
<td style="text-align:left">%m</td>
<td>Month as a number—for example, 10</td>
</tr>
<tr>
<td style="text-align:left">%b</td>
<td>Abbreviated string representation of month—for example, “Jan”</td>
</tr>
<tr>
<td style="text-align:left">%B</td>
<td>Complete string representation of month—for example, “January”</td>
</tr>
<tr>
<td style="text-align:left">%y</td>
<td>Year as two digits—for example, 87</td>
</tr>
<tr>
<td style="text-align:left">%Y</td>
<td>Year as four digits—for example, 2001</td>
</tr>
</tbody>
</table>
<p>Step 5 shows how an integer can be typecast as a date. Internally, R represents dates as the number of days from 1 January, 1970 and hence zero corresponds to 1 January, 1970. We can convert positive and negative numbers to dates. Negative numbers give dates before 1/1/1970.</p>
<p>Step 6 shows how to find the date with a specific offset from a given date (origin).</p>
<p>Step 7 shows how to examine the individual components of a date object using the format function along with the appropriate format specification (see the preceding table) for the desired component. Step 7 also shows the use of the months, weekdays, and julian functions for getting the month, day of the week, and the Julian date corresponding to a date. If we omit the origin in the julian function, R assumes 1/1/1970 as the origin.</p>
<h3 id="See-also…-22"><a href="#See-also…-22" class="headerlink" title="See also…"></a>See also…</h3><p>The Operating on date objects recipe in this chapter</p>
<h2 id="Operating-on-date-objects"><a href="#Operating-on-date-objects" class="headerlink" title="Operating on date objects"></a>Operating on date objects</h2><p>R supports many useful manipulations with date objects such as date addition and subtraction, and the creation of date sequences. This recipe shows many of these operations in action. For details on creating and examining date objects, see the previous recipe Creating and examining date objects, in this chapter.</p>
<h3 id="Getting-ready-47"><a href="#Getting-ready-47" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>The base R package provides date functionality, and you do not need any preparatory steps.</p>
<h3 id="How-to-do-it…-48"><a href="#How-to-do-it…-48" class="headerlink" title="How to do it…"></a>How to do it…</h3><ol>
<li><p>Perform the addition and subtraction of days from date objects:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; dt &lt;- as.Date(<span class="string">"1/1/2001"</span>, format = <span class="string">"%m/%d/%Y"</span>)</span><br><span class="line">&gt; dt</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"2001-01-01"</span></span><br><span class="line"></span><br><span class="line">&gt; dt + <span class="number">100</span>                 <span class="comment"># Date 100 days from dt</span></span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"2001-04-11"</span></span><br><span class="line"></span><br><span class="line">&gt; dt + <span class="number">31</span></span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"2001-02-01"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Subtract date objects to find the number of days between two dates:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; dt1 &lt;- as.Date(<span class="string">"1/1/2001"</span>, format = <span class="string">"%m/%d/%Y"</span>)</span><br><span class="line">&gt; dt2 &lt;- as.Date(<span class="string">"2/1/2001"</span>, format = <span class="string">"%m/%d/%Y"</span>)</span><br><span class="line">&gt; dt1-dt1</span><br><span class="line"></span><br><span class="line">Time difference of <span class="number">0</span> days</span><br><span class="line"></span><br><span class="line">&gt; dt2-dt1</span><br><span class="line"></span><br><span class="line">Time difference of <span class="number">31</span> days</span><br><span class="line"></span><br><span class="line">&gt; dt1-dt2</span><br><span class="line"></span><br><span class="line">Time difference of -<span class="number">31</span> days</span><br><span class="line"></span><br><span class="line">&gt; as.numeric(dt2-dt1)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">31</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Compare date objects:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; dt2 &gt; dt1</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">&gt; dt2 == dt1</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="literal">FALSE</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create date sequences:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&gt; d1 &lt;- as.Date(<span class="string">"1980/1/1"</span>)</span><br><span class="line">&gt; d2 &lt;- as.Date(<span class="string">"1982/1/1"</span>)</span><br><span class="line">&gt; <span class="comment"># Specify start date, end date and interval</span></span><br><span class="line">&gt; seq(d1, d2, <span class="string">"month"</span>)</span><br><span class="line"></span><br><span class="line"> [<span class="number">1</span>] <span class="string">"1980-01-01"</span> <span class="string">"1980-02-01"</span> <span class="string">"1980-03-01"</span> <span class="string">"1980-04-01"</span></span><br><span class="line"> [<span class="number">5</span>] <span class="string">"1980-05-01"</span> <span class="string">"1980-06-01"</span> <span class="string">"1980-07-01"</span> <span class="string">"1980-08-01"</span></span><br><span class="line"> [<span class="number">9</span>] <span class="string">"1980-09-01"</span> <span class="string">"1980-10-01"</span> <span class="string">"1980-11-01"</span> <span class="string">"1980-12-01"</span></span><br><span class="line">[<span class="number">13</span>] <span class="string">"1981-01-01"</span> <span class="string">"1981-02-01"</span> <span class="string">"1981-03-01"</span> <span class="string">"1981-04-01"</span></span><br><span class="line">[<span class="number">17</span>] <span class="string">"1981-05-01"</span> <span class="string">"1981-06-01"</span> <span class="string">"1981-07-01"</span> <span class="string">"1981-08-01"</span></span><br><span class="line">[<span class="number">21</span>] <span class="string">"1981-09-01"</span> <span class="string">"1981-10-01"</span> <span class="string">"1981-11-01"</span> <span class="string">"1981-12-01"</span></span><br><span class="line">[<span class="number">25</span>] <span class="string">"1982-01-01"</span></span><br><span class="line"></span><br><span class="line">&gt; d3 &lt;- as.Date(<span class="string">"1980/1/5"</span>)</span><br><span class="line">&gt; seq(d1, d3, <span class="string">"day"</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1980-01-01"</span> <span class="string">"1980-01-02"</span> <span class="string">"1980-01-03"</span> <span class="string">"1980-01-04"</span></span><br><span class="line">[<span class="number">5</span>] <span class="string">"1980-01-05"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># more interval options</span></span><br><span class="line">&gt; seq(d1, d2, <span class="string">"2 months"</span>)</span><br><span class="line"></span><br><span class="line"> [<span class="number">1</span>] <span class="string">"1980-01-01"</span> <span class="string">"1980-03-01"</span> <span class="string">"1980-05-01"</span> <span class="string">"1980-07-01"</span></span><br><span class="line"> [<span class="number">5</span>] <span class="string">"1980-09-01"</span> <span class="string">"1980-11-01"</span> <span class="string">"1981-01-01"</span> <span class="string">"1981-03-01"</span></span><br><span class="line"> [<span class="number">9</span>] <span class="string">"1981-05-01"</span> <span class="string">"1981-07-01"</span> <span class="string">"1981-09-01"</span> <span class="string">"1981-11-01"</span></span><br><span class="line">[<span class="number">13</span>] <span class="string">"1982-01-01"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Specify start date, interval and sequence length</span></span><br><span class="line">&gt; seq(from = d1, by = <span class="string">"4 months"</span>, length.out = <span class="number">4</span> )</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1980-01-01"</span> <span class="string">"1980-05-01"</span> <span class="string">"1980-09-01"</span> <span class="string">"1981-01-01"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Find a future or past date from a given date, based on an interval:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; seq(from = d1, by = <span class="string">"3 weeks"</span>, length.out = <span class="number">2</span>)[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"1980-01-22"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-45"><a href="#How-it-works…-45" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 shows how you can add and subtract days from a date to get the resulting date.</p>
<p>Step 2 shows how you can find the number of days between two dates through subtraction. The result is a difftime object that you can convert into a number if needed.</p>
<p>Step 3 shows the logical comparison of dates.</p>
<p>Step 4 shows two different ways to create sequences of dates. In one, you specify the from date, the to date, and the fixed interval by between the sequence elements as a string. In the other, you specify the from date, the interval, and the number of sequence elements you want. If using the latter approach, you have to name the arguments.</p>
<p>Step 5 shows how you can create sequences by specifying the intervals more flexibly.</p>
<h3 id="See-also…-23"><a href="#See-also…-23" class="headerlink" title="See also…"></a>See also…</h3><p>The Creating and examining date objects recipe in this chapter</p>
<h2 id="Performing-preliminary-analyses-on-time-series-data"><a href="#Performing-preliminary-analyses-on-time-series-data" class="headerlink" title="Performing preliminary analyses on time series data"></a>Performing preliminary analyses on time series data</h2><p>Before creating proper time series objects, we may want to do some preliminary analyses. This recipe shows you how.</p>
<h3 id="Getting-ready-48"><a href="#Getting-ready-48" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>The base R package provides all the necessary functionality. If you have not already downloaded the data files for this chapter, please do it now and ensure that they are located in your R working directory.</p>
<h3 id="How-to-do-it…-49"><a href="#How-to-do-it…-49" class="headerlink" title="How to do it…"></a>How to do it…</h3><ol>
<li><p>Read the file. We will use a data file that has the share prices of Walmart (downloaded from Yahoo Finance) between March 11, 1999 and January 15, 2015:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; wm &lt;- read.csv(<span class="string">"walmart.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>View the data as a line chart:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(wm$Adj.Close, type = <span class="string">"l"</span>)</span><br></pre></td></tr></table></figure>
<p> The data can be viewed as a line chart as follows:</p>
<p> <img src="img/5_2_10.jepg" alt=""></p>
</li>
<li><p>Compute and plot daily price movements:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; d &lt;- diff(wm$Adj.Close)</span><br><span class="line">&gt; plot(d, type = <span class="string">"l"</span>)</span><br></pre></td></tr></table></figure>
<p> The plotted daily price movements appear as follows:</p>
<p> <img src="img/5_2_11.jpeg" alt=""></p>
</li>
<li><p>Generate a histogram of the daily price changes, along with a density plot:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; hist(d, prob = <span class="literal">TRUE</span>, ylim = c(<span class="number">0</span>,<span class="number">0.8</span>), main = <span class="string">"Walmart stock"</span>, col = <span class="string">"blue"</span>)</span><br><span class="line">&gt; lines(density(d), lwd = <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p> The following histogram shows daily price change:</p>
<p> <img src="img/5_2_12.jpeg" alt=""></p>
</li>
<li><p>Compute one-period returns:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; wmm &lt;- read.csv(<span class="string">"walmart-monthly.csv"</span>)</span><br><span class="line">&gt; wmm.ts &lt;- ts(wmm$Adj.Close)</span><br><span class="line">&gt; d &lt;- diff(wmm.ts)</span><br><span class="line">&gt; wmm.return &lt;- d/lag(wmm.ts, k=-<span class="number">1</span>)</span><br><span class="line">&gt; hist(wmm.return, prob = <span class="literal">TRUE</span>, col = <span class="string">"blue"</span>)</span><br></pre></td></tr></table></figure>
<p> The following histogram shows the output of the preceding command:</p>
<p> <img src="img/5_2_13.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-46"><a href="#How-it-works…-46" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 reads the data and step 2 plots it as a line chart.</p>
<p>Step 3 uses the diff function to generate single-period differences. It then uses the plot function to plot the differences. By default, the diff function computes single-period differences. You can use the lag argument to compute differences for greater lags. For example, the following calculates two-period lagged differences:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; diff(wmm$Adj.Close, lag = <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>Step 4 generates a histogram of one-period price changes. It uses prob=TRUE to generate a histogram based on proportions, and then adds on a density plot as well to give a higher-granularity view of the shape of the distribution.</p>
<p>Step 5 computes one-period returns for the stock. It does this by dividing the one-period differences by the stock value at the first of the two periods that the difference is based on. It then generates a histogram of the returns.</p>
<h3 id="See-also…-24"><a href="#See-also…-24" class="headerlink" title="See also…"></a>See also…</h3><p>The Using time series objects recipe in this chapter</p>
<h2 id="Using-time-series-objects"><a href="#Using-time-series-objects" class="headerlink" title="Using time series objects"></a>Using time series objects</h2><p>In this recipe, we look at various features to create and plot time-series objects. We will consider data with single and multiple time series.</p>
<h3 id="Getting-ready-49"><a href="#Getting-ready-49" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the data files for this chapter, do it now and ensure that the files are in your R working directory.</p>
<h3 id="How-to-do-it…-50"><a href="#How-to-do-it…-50" class="headerlink" title="How to do it…"></a>How to do it…</h3><ol>
<li><p>Read the data. The file has 100 rows and a single column named sales:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; s &lt;- read.csv(<span class="string">"ts-example.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the data to a simplistic time series object without any explicit notion of time:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; s.ts &lt;- ts(s)</span><br><span class="line">&gt; class(s.ts)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"ts"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the time series:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(s.ts)</span><br></pre></td></tr></table></figure>
<p> <img src="img/5_2_14.jpeg" alt=""></p>
</li>
<li><p>Create a proper time series object with time points:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; s.ts.a &lt;- ts(s, start = <span class="number">2002</span>)</span><br><span class="line">&gt; s.ts.a</span><br><span class="line">Time Series:</span><br><span class="line">Start = <span class="number">2002</span></span><br><span class="line">End = <span class="number">2101</span></span><br><span class="line">Frequency = <span class="number">1</span></span><br><span class="line">       sales</span><br><span class="line">  [<span class="number">1</span>,]    <span class="number">51</span></span><br><span class="line">  [<span class="number">2</span>,]    <span class="number">56</span></span><br><span class="line">  [<span class="number">3</span>,]    <span class="number">37</span></span><br><span class="line">  [<span class="number">4</span>,]   <span class="number">101</span></span><br><span class="line">  [<span class="number">5</span>,]    <span class="number">66</span></span><br><span class="line">  (output truncated)</span><br><span class="line">&gt; plot(s.ts.a)</span><br><span class="line">&gt; <span class="comment"># results show that R treated this as an annual</span></span><br><span class="line">&gt; <span class="comment"># time series with 2002 as the starting year</span></span><br></pre></td></tr></table></figure>
<p> The result of the preceding commands is seen in the following graph:</p>
<p> <img src="img/5_2_15.jpeg" alt=""></p>
<p> To create a monthly time series run the following command:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Create a monthly time series</span></span><br><span class="line">&gt; s.ts.m &lt;- ts(s, start = c(<span class="number">2002</span>,<span class="number">1</span>), frequency = <span class="number">12</span>)</span><br><span class="line">&gt; s.ts.m</span><br><span class="line"></span><br><span class="line">     Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec</span><br><span class="line"><span class="number">2002</span>  <span class="number">51</span>  <span class="number">56</span>  <span class="number">37</span> <span class="number">101</span>  <span class="number">66</span>  <span class="number">63</span>  <span class="number">45</span>  <span class="number">68</span>  <span class="number">70</span> <span class="number">107</span>  <span class="number">86</span> <span class="number">102</span></span><br><span class="line"><span class="number">2003</span>  <span class="number">90</span> <span class="number">102</span>  <span class="number">79</span>  <span class="number">95</span>  <span class="number">95</span> <span class="number">101</span> <span class="number">128</span> <span class="number">109</span> <span class="number">139</span> <span class="number">119</span> <span class="number">124</span> <span class="number">116</span></span><br><span class="line"><span class="number">2004</span> <span class="number">106</span> <span class="number">100</span> <span class="number">114</span> <span class="number">133</span> <span class="number">119</span> <span class="number">114</span> <span class="number">125</span> <span class="number">167</span> <span class="number">149</span> <span class="number">165</span> <span class="number">135</span> <span class="number">152</span></span><br><span class="line"><span class="number">2005</span> <span class="number">155</span> <span class="number">167</span> <span class="number">169</span> <span class="number">192</span> <span class="number">170</span> <span class="number">180</span> <span class="number">175</span> <span class="number">207</span> <span class="number">164</span> <span class="number">204</span> <span class="number">180</span> <span class="number">203</span></span><br><span class="line"><span class="number">2006</span> <span class="number">215</span> <span class="number">222</span> <span class="number">205</span> <span class="number">202</span> <span class="number">203</span> <span class="number">209</span> <span class="number">200</span> <span class="number">199</span> <span class="number">218</span> <span class="number">221</span> <span class="number">225</span> <span class="number">212</span></span><br><span class="line"><span class="number">2007</span> <span class="number">250</span> <span class="number">219</span> <span class="number">242</span> <span class="number">241</span> <span class="number">267</span> <span class="number">249</span> <span class="number">253</span> <span class="number">242</span> <span class="number">251</span> <span class="number">279</span> <span class="number">298</span> <span class="number">260</span></span><br><span class="line"><span class="number">2008</span> <span class="number">269</span> <span class="number">257</span> <span class="number">279</span> <span class="number">273</span> <span class="number">275</span> <span class="number">314</span> <span class="number">288</span> <span class="number">286</span> <span class="number">290</span> <span class="number">288</span> <span class="number">304</span> <span class="number">291</span></span><br><span class="line"><span class="number">2009</span> <span class="number">314</span> <span class="number">290</span> <span class="number">312</span> <span class="number">319</span> <span class="number">334</span> <span class="number">307</span> <span class="number">315</span> <span class="number">321</span> <span class="number">339</span> <span class="number">348</span> <span class="number">323</span> <span class="number">342</span></span><br><span class="line"><span class="number">2010</span> <span class="number">340</span> <span class="number">348</span> <span class="number">354</span> <span class="number">291</span></span><br><span class="line">&gt; plot(s.ts.m)  <span class="comment"># note x axis on plot</span></span><br></pre></td></tr></table></figure>
<p> The following plot can be seen as a result of the preceding commands:</p>
<p> <img src="img/5_2_16.jpeg" alt=""></p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Specify frequency = 4 for quarterly data</span></span><br><span class="line">&gt; s.ts.q &lt;- ts(s, start = <span class="number">2002</span>, frequency = <span class="number">4</span>)</span><br><span class="line">&gt; s.ts.q</span><br><span class="line"></span><br><span class="line">     Qtr1 Qtr2 Qtr3 Qtr4</span><br><span class="line"><span class="number">2002</span>   <span class="number">51</span>   <span class="number">56</span>   <span class="number">37</span>  <span class="number">101</span></span><br><span class="line"><span class="number">2003</span>   <span class="number">66</span>   <span class="number">63</span>   <span class="number">45</span>   <span class="number">68</span></span><br><span class="line"><span class="number">2004</span>   <span class="number">70</span>  <span class="number">107</span>   <span class="number">86</span>  <span class="number">102</span></span><br><span class="line"><span class="number">2005</span>   <span class="number">90</span>  <span class="number">102</span>   <span class="number">79</span>   <span class="number">95</span></span><br><span class="line"><span class="number">2006</span>   <span class="number">95</span>  <span class="number">101</span>  <span class="number">128</span>  <span class="number">109</span></span><br><span class="line">(output truncated)</span><br><span class="line">&gt; plot(s.ts.q)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Query time series objects (we use the s.ts.m object we created in the previous step):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># When does the series start?</span></span><br><span class="line">&gt; start(s.ts.m)</span><br><span class="line">[<span class="number">1</span>] <span class="number">2002</span>    <span class="number">1</span></span><br><span class="line">&gt; <span class="comment"># When does it end?</span></span><br><span class="line">&gt; end(s.ts.m)</span><br><span class="line">[<span class="number">1</span>] <span class="number">2010</span>    <span class="number">4</span></span><br><span class="line">&gt; <span class="comment"># What is the frequency?</span></span><br><span class="line">&gt; frequency(s.ts.m)</span><br><span class="line">[<span class="number">1</span>] <span class="number">12</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a time series object with multiple time series. This data file contains US monthly consumer prices for white flour and unleaded gas for the years 1980 through 2014 (downloaded from the website of the US Bureau of Labor Statistics):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; prices &lt;- read.csv(<span class="string">"prices.csv"</span>)</span><br><span class="line">&gt; prices.ts &lt;- ts(prices, start=c(<span class="number">1980</span>,<span class="number">1</span>), frequency = <span class="number">12</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot a time series object with multiple time series:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(prices.ts)</span><br></pre></td></tr></table></figure>
<p> The plot in two separate panels appears as follows:</p>
<p> <img src="img/5_2_17.jpeg" alt=""></p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Plot both series in one panel with suitable legend</span></span><br><span class="line">&gt; plot(prices.ts, plot.type = <span class="string">"single"</span>, col = <span class="number">1</span>:<span class="number">2</span>)</span><br><span class="line">&gt; legend(<span class="string">"topleft"</span>, colnames(prices.ts), col = <span class="number">1</span>:<span class="number">2</span>, lty = <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p> Two series plotted in one panel appear as shown here:</p>
<p> <img src="img/5_2_18.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-47"><a href="#How-it-works…-47" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 reads the data.</p>
<p>Step 2 uses the ts function to generate a time series object based on the raw data.</p>
<p>Step 3 uses the plot function to generate a line plot of the time series. We see that the time axis does not provide much information. Time series objects can represent time in more friendly terms.</p>
<p>Step 4 shows how to create time series objects with a better notion of time. It shows how we can treat a data series as an annual, monthly, or quarterly time series. The start and frequency parameters help us to control these data series.</p>
<p>Although the time series we provide is just a list of sequential values, in reality our data can have an implicit notion of time attached to it. For example, the data can be annual numbers, monthly numbers, or quarterly ones (or something else, such as 10-second observations of something). Given just the raw numbers (as in our data file, ts-example.csv), the ts function cannot figure out the time aspect and by default assumes no secondary time interval at all.</p>
<p>We can use the frequency parameter to tell ts how to interpret the time aspect of the data. The frequency parameter controls how many secondary time intervals there are in one major time interval. If we do not explicitly specify it, by default frequency takes on a value of 1. Thus, the following code treats the data as an annual sequence, starting in 2002:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; s.ts.a &lt;- ts(s, start = <span class="number">2002</span>)</span><br></pre></td></tr></table></figure>
<p>The following code, on the other hand, treats the data as a monthly time series, starting in January 2002. If we specify the start parameter as a number, then R treats it as starting at the first subperiod, if any, of the specified start period. When we specify frequency as different from 1, then the start parameter can be a vector such as c(2002,1) to specify the series, the major period, and the subperiod where the series starts. c(2002,1) represents January 2002:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; s.ts.m &lt;- ts(s, start = c(<span class="number">2002</span>,<span class="number">1</span>), frequency = <span class="number">12</span>)</span><br></pre></td></tr></table></figure>
<p>Similarly, the following code treats the data as a quarterly sequence, starting in the first quarter of 2002:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; s.ts.q &lt;- ts(s, start = <span class="number">2002</span>, frequency = <span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<p>The frequency values of 12 and 4 have a special meaning—they represent monthly and quarterly time sequences.</p>
<p>We can supply start and end, just one of them, or none. If we do not specify either, then R treats the start as 1 and figures out end based on the number of data points. If we supply one, then R figures out the other based on the number of data points.</p>
<p>While start and end do not play a role in computations, frequency plays a big role in determining seasonality, which captures periodic fluctuations.</p>
<p>If we have some other specialized time series, we can specify the frequency parameter appropriately. Here are two examples:</p>
<ul>
<li>With measurements taken every 10 minutes and seasonality pegged to the hour, we should specify frequency as 6</li>
<li>With measurements taken every 10 minutes and seasonality pegged to the day, use frequency = 24*6 (6 measurements per hour times 24 hours per day)</li>
</ul>
<p>Step 5 shows the use of the functions start, end, and frequency to query time series objects.</p>
<p>Steps 6 and 7 show that R can handle data files that contain multiple time series.</p>
<h3 id="See-also…-25"><a href="#See-also…-25" class="headerlink" title="See also…"></a>See also…</h3><p>The Performing preliminary analyses on time series objects recipe in this chapter</p>
<h2 id="Decomposing-time-series"><a href="#Decomposing-time-series" class="headerlink" title="Decomposing time series"></a>Decomposing time series</h2><p>The stats package provides many functions to process time series. This recipe covers the use of the decompose and stl functions to extract the seasonal, trend, and random components of time series.</p>
<h3 id="Getting-ready-50"><a href="#Getting-ready-50" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the data files for this chapter, do it now and ensure that the files are in your R working directory.</p>
<h3 id="How-to-do-it…-51"><a href="#How-to-do-it…-51" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>The following steps decompose time series:</p>
<ol>
<li><p>Read the data. The file has the Bureau of Labor Statistics monthly price data for unleaded gas and white flour for 1980 through 2014:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; prices &lt;- read.csv(<span class="string">"prices.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create and plot the time series of gas prices:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; prices.ts = ts(prices, start = c(<span class="number">1980</span>,<span class="number">1</span>), frequency = <span class="number">12</span>)</span><br><span class="line">&gt; plot(prices.ts[,<span class="number">2</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>The plot shows seasonality in gas prices. The amplitude of fluctuations seems to increase with time and hence this looks like a multiplicative time series. Thus, we will use the log of the prices to make it additive. Use the stl function to perform a Loess decomposition of the gas prices:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; prices.stl &lt;- stl(log(prices.ts[,<span class="number">1</span>]), s.window = <span class="string">"period"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the results of stl:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(prices.stl)</span><br></pre></td></tr></table></figure>
<p> The following plot is the result of the preceding command:</p>
<p> <img src="img/5_3_1.jpeg" alt=""></p>
</li>
</ol>
<ol>
<li><p>Alternately, you can use the decompose function to perform a decomposition by moving averages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; prices.dec &lt;- decompose(log(prices.ts[,<span class="number">2</span>]))</span><br><span class="line">&gt; plot(prices.dec)</span><br></pre></td></tr></table></figure>
<p> The following graph shows the output of the preceding command:</p>
<p> <img src="img/5_3_2.jpeg" alt=""></p>
</li>
<li><p>Adjust the gas prices for seasonality and plot it:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; gas.seasonally.adjusted &lt;- prices.ts[,<span class="number">2</span>] - prices.dec$seasonal</span><br><span class="line">&gt; plot(gas.seasonally.adjusted)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-48"><a href="#How-it-works…-48" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 reads the data and Step 2 creates and plots the time series. For more details, see the recipe, Using time series objects, earlier in this chapter.</p>
<p>Step 3 shows the use of the stl function to decompose an additive time series. Since our earlier plot indicated that the amplitude of the fluctuations increased with time, thereby suggesting a multiplicative time series, we applied the log function to convert it into an additive time series and then decomposed it.</p>
<p>Step 4 uses the plot function to plot the results.</p>
<p>Step 5 uses the decompose function to perform a decomposition through moving averages and then plots it.</p>
<p>Step 6 adjusts gas prices for seasonality by subtracting the seasonal component from the original time series of the gas prices, and then plots the resulting time series.</p>
<h3 id="See-also…-26"><a href="#See-also…-26" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>The Using time series objects recipe in this chapter</li>
<li>The Filtering time series data recipe in this chapter</li>
<li>The Smoothing and forecasting using the Holt-Winters method recipe in this chapter</li>
</ul>
<h2 id="Filtering-time-series-data"><a href="#Filtering-time-series-data" class="headerlink" title="Filtering time series data"></a>Filtering time series data</h2><p>This recipe shows how we can use the filter function from the stats package to compute moving averages.</p>
<h3 id="Getting-ready-51"><a href="#Getting-ready-51" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already done so, download the data files for this chapter and ensure that they are available in your R working directory.</p>
<h3 id="How-to-do-it…-52"><a href="#How-to-do-it…-52" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To filter time series data, follow these steps:</p>
<ol>
<li><p>Read the data. The file has fictitious weekly sales data for some product:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; s &lt;- read.csv(<span class="string">"ts-example.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create the filtering vector. We assume a seven-period filter:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; n &lt;- <span class="number">7</span></span><br><span class="line">&gt; wts &lt;- rep(<span class="number">1</span>/n, n)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Compute the symmetrically filtered values (three past values, one current value, and three future values) and one-sided values (one current and six past values:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; s.filter1 &lt;- filter(s$sales, filter = wts, sides = <span class="number">2</span>)</span><br><span class="line">&gt; s.filter2 &lt;- filter(s$sales, filter = wts, sides = <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the filtered values:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(s$sales, type = <span class="string">"l"</span>)</span><br><span class="line">&gt; lines(s.filter1, col = <span class="string">"blue"</span>, lwd = <span class="number">3</span>)</span><br><span class="line">&gt; lines(s.filter2, col = <span class="string">"red"</span>, lwd = <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p> The plotted filtered values appear as follows:</p>
<p> <img src="img/5_4_1.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-49"><a href="#How-it-works…-49" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 reads the data.</p>
<p>Step 2 creates the filtering weights. We used a window of seven periods. This means that the weighted average of the current value and six others will comprise the filtered value at the current position.</p>
<p>Step 3 computes the two-sided filter (the weighted average of the current value and three prior and three succeeding values) and a one-sided filter based on the current value and six prior ones.</p>
<p>Step 4 plots the original data and the symmetric and one-sided filters. We can see that the two-sided filter tracks the changes earlier.</p>
<h3 id="See-also…-27"><a href="#See-also…-27" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>The Using time series objects recipe in this chapter</li>
<li>The Decomposing time series recipe in this chapter</li>
<li>The Smoothing and forecasting using the Holt-Winters method recipe in this chapter</li>
</ul>
<h2 id="Smoothing-and-forecasting-using-the-Holt-Winters-method"><a href="#Smoothing-and-forecasting-using-the-Holt-Winters-method" class="headerlink" title="Smoothing and forecasting using the Holt-Winters method"></a>Smoothing and forecasting using the Holt-Winters method</h2><p>The stats package contains functionality for applying the HoltWinters method for exponential smoothing in the presence of trends and seasonality, and the forecast package extends this to forecasting. This recipe addresses these topics.</p>
<h3 id="Getting-ready-52"><a href="#Getting-ready-52" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and place them in your R working directory. Install and load the forecast package.</p>
<h3 id="How-to-do-it…-53"><a href="#How-to-do-it…-53" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To apply the HoltWinters method for exponential smoothing and forecasting, follow these steps:</p>
<ol>
<li><p>Read the data. The file has monthly stock prices from Yahoo! Finance for Infosys between March 1999 and January 2015:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; infy &lt;- read.csv(<span class="string">"infy-monthly.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create the time series object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; infy.ts &lt;- ts(infy$Adj.Close, start = c(<span class="number">1999</span>,<span class="number">3</span>),    frequency = <span class="number">12</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Perform Holt-Winters exponential smoothing:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; infy.hw &lt;- HoltWinters(infy.ts)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the results:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(infy.hw, col = <span class="string">"blue"</span>, col.predicted = <span class="string">"red"</span>)</span><br></pre></td></tr></table></figure>
<p> The plotted result can be seen as follows:</p>
<p> <img src="img.5_4_2.jpeg" alt=""></p>
</li>
</ol>
<p>Examine the results:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># See the squared errors</span></span><br><span class="line">&gt; infy.hw$SSE</span><br><span class="line">[<span class="number">1</span>] <span class="number">1446.232</span></span><br><span class="line">&gt; <span class="comment"># The alpha beta and gamma used for filtering</span></span><br><span class="line">&gt; infy.hw$alpha</span><br><span class="line">    alpha</span><br><span class="line"><span class="number">0.5658932</span></span><br><span class="line">&gt; infy.hw$beta</span><br><span class="line">       beta</span><br><span class="line"><span class="number">0.009999868</span></span><br><span class="line">&gt; infy.hw$gamma</span><br><span class="line">gamma</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">&gt; <span class="comment"># the fitted values</span></span><br><span class="line">&gt; head(infy.hw$fitted)</span><br><span class="line">         xhat    level     trend      season</span><br><span class="line">[<span class="number">1</span>,] <span class="number">13.91267</span> <span class="number">11.00710</span> <span class="number">0.5904618</span>  <span class="number">2.31510417</span></span><br><span class="line">[<span class="number">2</span>,] <span class="number">18.56803</span> <span class="number">15.11025</span> <span class="number">0.6255882</span>  <span class="number">2.83218750</span></span><br><span class="line">[<span class="number">3</span>,] <span class="number">15.17744</span> <span class="number">17.20828</span> <span class="number">0.6403124</span> -<span class="number">2.67114583</span></span><br><span class="line">[<span class="number">4</span>,] <span class="number">19.01611</span> <span class="number">18.31973</span> <span class="number">0.6450237</span>  <span class="number">0.05135417</span></span><br><span class="line">[<span class="number">5</span>,] <span class="number">15.23710</span> <span class="number">18.66703</span> <span class="number">0.6420466</span> -<span class="number">4.07197917</span></span><br><span class="line">[<span class="number">6</span>,] <span class="number">18.45236</span> <span class="number">18.53545</span> <span class="number">0.6343104</span> -<span class="number">0.71739583</span></span><br></pre></td></tr></table></figure>
<p>Generate and plot forecasts with the Holt-Winters model:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(forecast)</span><br><span class="line">&gt; infy.forecast &lt;- forecast(infy.hw, h=<span class="number">20</span>)</span><br><span class="line">&gt; plot(infy.forecast)</span><br></pre></td></tr></table></figure>
<p>The following is the resulting plot:</p>
<p><img src="img/5_4_3.jpeg" alt=""></p>
<h3 id="How-it-works…-50"><a href="#How-it-works…-50" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 reads the data and in step 2 the time series object, ts, is created. For more details, see the recipe, Using time series objects, earlier in this chapter.</p>
<p>In step 3 the HoltWinters function is used to smooth the data.</p>
<p>In step 4 the resulting HoltWinters object is plotted. It shows the original time series as well as the smoothed values.</p>
<p>Step 5 shows the functions available to extract information from the Holt-Winters model object.</p>
<p>In step 6 the predict.HoltWinters function is used to predict future values. The colored bands show the 85 % and 95 % confidence intervals.</p>
<h3 id="See-also…-28"><a href="#See-also…-28" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>The Using time series objects recipe in this chapter</li>
<li>The Decomposing time series recipe in this chapter</li>
<li>The Filtering time series data recipe in this chapter</li>
</ul>
<h2 id="Building-an-automated-ARIMA-model"><a href="#Building-an-automated-ARIMA-model" class="headerlink" title="Building an automated ARIMA model"></a>Building an automated ARIMA model</h2><p>The forecast package provides the auto.arima function to fit the best ARIMA models for a univariate time series.</p>
<h3 id="Getting-ready-53"><a href="#Getting-ready-53" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and place them in your R working directory. Install and load the forecast package.</p>
<h3 id="How-to-do-it…-54"><a href="#How-to-do-it…-54" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To build an automated ARIMA model, follow these steps:</p>
<ol>
<li><p>Read the data. The file has monthly stock prices from Yahoo! Finance for Infosys between March 1999 and January 2015:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; infy &lt;- read.csv(<span class="string">"infy-monthly.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create the time series object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; infy.ts &lt;- ts(infy$Adj.Close, start = c(<span class="number">1999</span>,<span class="number">3</span>), frequency = <span class="number">12</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Run the ARIMA model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; infy.arima &lt;- auto.arima(infy.ts)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Generate the forecast using the ARIMA model:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; infy.forecast &lt;- forecast(infy.arima, h=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the results:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(infy.forecast)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>The plotted result can be seen as follows:</p>
<p><img src="img/5_4_4.jpeg" alt=""></p>
<h3 id="How-it-works…-51"><a href="#How-it-works…-51" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 reads the data.</p>
<p>In step 2, the time series object, ts, is created. For more details, see the recipe Using time series objects, earlier in this chapter.</p>
<p>In step 3, the auto.arima function in the forecast package is used to generate the ARIMA model. This function conducts an orderly search to generate the best ARIMA model according to the AIC, AICc, or the BIC value. We control the criterion used through the ic parameter (for example, ic = “aicc”). If we provide no value, the function uses AICc.</p>
<p>In step 4, the forecast for the specified time horizon (the h parameter) is generated.</p>
<p>Step 5 plots the results. The two bands show the 85 percent and the 95 percent confidence intervals. You can control the color of the data line through the col parameter and the color of the forecast line through fcol.</p>
<h3 id="See-also…-29"><a href="#See-also…-29" class="headerlink" title="See also…"></a>See also…</h3><p>The Using time series objects recipe in this chapter</p>
<hr>
<h1 id="Chapter-7-It’s-All-About-Your-Connections-–-Social-Network-Analysis"><a href="#Chapter-7-It’s-All-About-Your-Connections-–-Social-Network-Analysis" class="headerlink" title="Chapter 7. It’s All About Your Connections – Social Network Analysis"></a>Chapter 7. It’s All About Your Connections – Social Network Analysis</h1><p>In this chapter, you will cover:</p>
<ul>
<li>Downloading social network data using public APIs</li>
<li>Creating adjacency matrices and edge lists</li>
<li>Plotting social network data</li>
<li>Computing important network metrics</li>
</ul>
<h2 id="Introduction-6"><a href="#Introduction-6" class="headerlink" title="Introduction"></a>Introduction</h2><p>When we think of the term “social network,” sites such as Twitter, Facebook, Google+, LinkedIn, and Meetup immediately come to mind. However, data analysts have applied the concepts of social network analysis in domains as varied as co-authorship networks, human networks, the spread of disease, migratory birds, and interlocking corporate board memberships, just to name a few. In this chapter, we will cover recipes to make sense of social network data. R provides multiple packages to manipulate social network data; we address the most prominent of these, igraph.</p>
<h2 id="Downloading-social-network-data-using-public-APIs"><a href="#Downloading-social-network-data-using-public-APIs" class="headerlink" title="Downloading social network data using public APIs"></a>Downloading social network data using public APIs</h2><p>Social networking websites provide public APIs to enable us to download their data. In this recipe, we cover the process of downloading data from Meetup.com using their public API. You can adapt this basic approach to download data from other websites. In this recipe, we get the data in JSON format and then import it into an R data frame.</p>
<h3 id="Getting-ready-54"><a href="#Getting-ready-54" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>In this recipe, you will download data from Meetup.com. To gain access to the data, you need to be a member:</p>
<ul>
<li>If you do not have an account in <a href="http://www.meetup.com" target="_blank" rel="external">http://www.meetup.com</a>, sign up and become a member of a couple of groups.</li>
<li>You need your own API key to download data through scripts. Get your own by clicking on the API Key link on <a href="http://www.meetup.com/meetup_api/" target="_blank" rel="external">http://www.meetup.com/meetup_api/</a>. Save the key.</li>
</ul>
<p>You can replicate the steps in this recipe without additional information. However, if you would like more details, you can read about the API at <a href="http://www.meetup.com/meetup_api/" target="_blank" rel="external">http://www.meetup.com/meetup_api/</a>.</p>
<p>Download the groups.json file and place it in your R working directory.</p>
<h3 id="How-to-do-it…-55"><a href="#How-to-do-it…-55" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>In this recipe, we see how to get data from the console and how R scripts are used:</p>
<ol>
<li>Download information about Meetup groups that satisfy certain criteria. <a href="http://www.meetup.com" target="_blank" rel="external">http://www.meetup.com</a> allows you to download data from their Console by filling up fields to define your criteria. Alternately, you can also construct a suitable URL to directly get the data. The former approach has some limitations when downloading large volumes of data.</li>
<li>In this recipe, we first show you how to get data from the console. We then show you how to use R scripts that use URLs for larger data volumes. We will first get a list of groups. Use your browser to visit <code>http://www.meetup.com/meetup_api/</code>. Click on Console and then click on the first link under Groups on the right (GET /2/groups). Enter the topic you are interested in and enter your two character ISO country code (see <code>http://en.wikipedia.org/wiki/ISO_3166-1</code> for country codes) and city or zip code. You can specify “radius” to restrict the number of groups returned. We used hiking for topic, US for country, 08816 for zip code, and 25 for radius. Click on Show Response to see the results. If you get an error, try with different values. If you used different selection criteria, you may see many groups. From the earlier results, you will notice information on many attributes for each group. You can use the “only” field to get some of these attributes, for example, to get only the group ID, name, and number of members, enter id, name, members in the “only” textbox (note that there is no space after the commas).</li>
<li>You can also get information using a URL directly, but you will need to use your API key for this. For example, the following URL gets the ID, name, and number of members for all hiking-related groups in Amsterdam, NL (replace &lt;<your api="" key="">&gt; with the API key you downloaded earlier in the Getting started part of this recipe; no angle braces needed):<br><code>http://api.meetup.com/2/groups?topic=hiking&amp;country=NL&amp;city=Amsterdam&amp;only=id,name,members&amp;key=&lt;&lt;your api key&gt;&gt;</code></your></li>
</ol>
<p>You will note that the results look different in the console when using the URL directly, but this is just a formatting issue. The console pretty prints the JSON, whereas we see unformatted JSON when we use a URL.</p>
<ol>
<li>We will now save the downloaded data; the process depends on whether you used the console approach in step 2 or the URL approach in step 3. If you used the console approach, you should select the block of text starting with the { before results and ending with the very last }. Paste the copied text into a text editor and save the file as groups.json. On the other hand, if you used the URL approach of step 3, right-click and select “Save As” to save the displayed results as a file named groups.json in your R working directory. You can also use the groups.json file that you downloaded earlier.</li>
<li><p>We will now load the data from the saved JSON file into an R data frame. For details, refer to the recipe Reading JSON data in Chapter 1, Acquire and Prepare the Ingredients – Your Data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(jsonlite)</span><br><span class="line">&gt; g &lt;- fromJSON(<span class="string">"groups.json"</span>)</span><br><span class="line">&gt; groups &lt;- g$results</span><br><span class="line">&gt; head(groups)</span><br></pre></td></tr></table></figure>
</li>
<li><p>For each group, we will now use the Meetup.com API to download member information into a data frame called users. Among the code files that you downloaded for this chapter is a file called rdacb.getusers.R. Source this file into your R environment now and run the following code. For each group from our list of groups, this code uses the Meetup.com API to get the group’s members. It generates a data frame with a set of <code>group_id</code>, <code>user_id</code> pairs. In the following command, replace &lt;<apikey>&gt; with your actual API key from the Getting ready section. Be sure to enclose the key in double quotes and also be sure that you do not have any angle brackets in the command. This command can take a while to execute because of the sheer number of web requests and the volume of data involved. If you get an error message, see the How it works… section for this recipe:</apikey></p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">source</span>(<span class="string">"rdacb.getusers.R"</span>)</span><br><span class="line">&gt; <span class="comment"># in command below, substitute your api key for</span></span><br><span class="line">&gt; <span class="comment"># &lt;&lt;apikey&gt;&gt; and enclose it in double-quotes</span></span><br><span class="line">&gt; members &lt;- rdacb.getusers(groups, &lt;&lt;apikey&gt;&gt;)</span><br><span class="line">This creates a data frame with the variables (`group_id`, `user_id`).</span><br></pre></td></tr></table></figure>
</li>
<li><p>The members data frame now has information about the social network, and normally we will use it for all further processing. However, since it is very large, many of the steps in subsequent recipes will take a lot of processing time. For convenience, we reduce the size of the social network by retaining only members who belong to more than 16 groups. This step uses data tables; see Chapter 9, Work Smarter, Not harder – Efficient and Elegant R code for more details. If you would like to work with the complete network, execute the users &lt;- members command and skip to step 8 without executing these two code lines:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(data.table)</span><br><span class="line">&gt; users &lt;- setDT(members)[,.SD[.N &gt; <span class="number">16</span>], by = user_id]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Save the members data before further processing:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; save(users,file=<span class="string">"meetup_users.Rdata"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-52"><a href="#How-it-works…-52" class="headerlink" title="How it works…"></a>How it works…</h3><p>Steps 2 and 3 get data from Meetup.com using their console.</p>
<p>By default, Meetup APIs return 20 results (JSON documents) for each call. However, by adding page=n in the console or in the URL (where n is a number), we can get more documents (up to a maximum of 200). The API response contains metadata information including the number of documents returned (in the count element), the total documents available (the total_count element), the URL used to get the response, and the URL to get the next set of results (the next element).</p>
<p>Step 4 saves the results displayed in the browser as groups.json in your R working directory.</p>
<p>Step 5 loads the JSON data file into an R data frame using the fromJSON function in the jsonlite package. For more details on this, refer to the recipe Reading JSON data in Chapter 1, Acquire and Prepare the Ingredients – Your Data.</p>
<p>The returned object g contains the results in the results element, and we assign g$results (a data frame) to the variable groups.</p>
<p>Step 6 uses the rdacb.getusers convenience function to iterate through each group and get its members. The function constructs the appropriate API URL using group id. Since each call returns only a fixed number of users, the while loop of the function iterates till it gets all the users. The next element of the result returned tells us if the group has more members.</p>
<p>There can be groups with no members and hence we check if temp$results returns a data frame. The API returns group and user IDs as they are in Meetup.com.</p>
<p>If the Meetup.com site is overloaded with several API requests during the time of your invocation, you may get an error message “Error in function (type, msg, asError = TRUE) : Empty reply from server”. Retry the same step again. Depending on the number of groups and the number of members in each group, this step can take a long time.</p>
<p>At this point, we have the data for a very large social network. Subsequent recipes in this chapter use the social network that we create in this recipe. Some of the steps in subsequent recipes can take a lot of processing time if run on the complete network. Using a smaller network will suffice for illustration. Therefore, step 7 uses data.table to retain only members who belong to more than 16 groups.</p>
<p>Step 8 saves the member data in a file for possible future use. We now have a two-mode network, where the first mode is a set of groups and the second mode is the list of members. From this, we can either create a network of users based on common group memberships or a network of groups based on common members. In the rest of this chapter, we do the former.</p>
<p>We created a data frame in which each row represents a membership of an individual user in a group. From this information, we can create representations of social networks.</p>
<h3 id="See-also…-30"><a href="#See-also…-30" class="headerlink" title="See also…"></a>See also…</h3><ul>
<li>Reading JSON data in Chapter 1, Acquire and Prepare the Ingredients – Your Data</li>
<li>Slicing, dicing, and combining data with data tables in Chapter 9, Work Smarter, Not Harder – Efficient and Elegant R Code</li>
</ul>
<h2 id="Creating-adjacency-matrices-and-edge-lists"><a href="#Creating-adjacency-matrices-and-edge-lists" class="headerlink" title="Creating adjacency matrices and edge lists"></a>Creating adjacency matrices and edge lists</h2><p>We can represent social network data in different formats. We cover two common representations: sparse adjacency matrices and edge lists.</p>
<p>Taking data from the Meetup.com social networking site (from the previous recipe in this chapter—Downloading social network data using public APIs), this recipe shows how you can convert a data frame with membership information into a sparse adjacency matrix and then to an edge list.</p>
<p>In this application, nodes represent users of Meetup.com and an edge connects two nodes if they are members of at least one common group. The number of common groups for a pair of people will represent the weight of the connection.</p>
<h3 id="Getting-ready-55"><a href="#Getting-ready-55" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not yet installed the Matrix package, you should do so now using the following code:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"Matrix"</span>)</span><br></pre></td></tr></table></figure>
<p>If you completed the prior recipe Downloading social network data using public APIs and have the meetup_users.Rdata file, you can use it. Otherwise, you can download that data file from the book’s website and place it in your R working directory.</p>
<h3 id="How-to-do-it…-56"><a href="#How-to-do-it…-56" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To create adjacency matrices and edge lists, follow these steps:</p>
<ol>
<li><p>Load Meetup.com user information from the <code>meetup_users.Rdata file</code>. This creates a data frame called users which has the variables (<code>user_id</code>, <code>group_id</code>):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; load(<span class="string">"meetup_users.Rdata"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a sparse matrix with groups on the rows and users on the columns with TRUE on each (<code>group_id</code>, <code>user_id</code>) position, where the group has the user as a member. If you have a large number of users, this step will take a long time. It also needs a lot of memory to create a sparse matrix. If your R session freezes, you will have to either find a computer with more RAM or reduce the number of users and try again:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(Matrix)</span><br><span class="line">&gt; grp.membership = sparseMatrix(`users$group_id`, `users$user_id`, x = <span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Use the sparse matrix to create an adjacency matrix with users on both rows and columns with the number of common groups between a pair of users as the matrix element:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; adjacency = t(grp.membership) %*% grp.membership</span><br></pre></td></tr></table></figure>
</li>
<li><p>We can use the group membership matrix to create a network of groups instead of users with groups as the nodes and edges representing common memberships across groups. In this example, we will consider only a network of users.</p>
</li>
<li><p>Use the adjacency matrix to create an edge list:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; users.edgelist &lt;- as.data.frame(summary(adjacency))</span><br><span class="line">&gt; names(users.edgelist)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"i"</span> <span class="string">"j"</span> <span class="string">"x"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>The relationship between any two users is reciprocal. That is, if users 25 and 326 have 32 groups in common, then the edge list currently duplicates that information as (25, 362, 32) and (362, 25, 32). We need to keep only one of these. Also, our adjacency matrix has non-zero diagonal elements and the edge list has edges corresponding to those. We can eliminate these by keeping only the edges corresponding to the upper or lower triangle of the adjacency matrix:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Extract upper triangle of the edgelist</span></span><br><span class="line">&gt; users.edgelist.upper &lt;- users.edgelist[users.edgelist$i &lt; users.edgelist$j,]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Save the data, just in case:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; save(users.edgelist.upper, file = <span class="string">"users_edgelist_upper.Rdata"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-53"><a href="#How-it-works…-53" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the users’ group membership data from the <code>meetup_users</code>.Rdata saved file. This creates a users data frame with the (<code>user_id</code>, <code>group_id</code>) structure. From this, we want to create a network in which the nodes are users and a pair of users has an edge if they are members of at least one common group. We want to have the number of common group memberships as the weight of an edge.</p>
<p>Step 2 converts the information in the group membership data frame to a sparse matrix with groups on the rows and users on the columns. To clarify, the following table shows a sample matrix with four groups and nine users. The first group has users 1, 4, and 7 as members, while the second has users 1, 3, 4, and 6 as members, and so on. We have shown the complete matrix here, but step 2 creates a much more space efficient sparse representation of this information:</p>
<p><img src="img/7_1_1.jpeg" alt=""></p>
<p>While the sparse matrix has all the network information, several social network analysis functions work with the data represented as an “adjacency matrix” or as an “edge list.” We want to create a social network of Meetup.com users. The adjacency matrix will have the shape of a square matrix with users on both rows and columns, and the number of shared groups as the matrix element. For the sample data in the preceding figure, the adjacency matrix will look like this:</p>
<p><img src="img/7_1_2.jpeg" alt=""></p>
<p>Step 3 creates a sparse adjacency matrix from the earlier sparse group membership matrix. From the earlier figure, we see that users 1 and 4 have three groups in common (groups 1, 2, and 3) and thus the elements (1, 4) and (4, 1) of the matrix have a 3 in them. The diagonal elements simply indicate the number of groups to which the corresponding users belong. User 1 belongs to three groups and hence (1, 1) has a 3. We only need the upper or lower triangle of the matrix, and we take care of that in a later step.</p>
<p>Step 4 creates an edge list from the sparse adjacency matrix. An edge list will have the following structure: (<code>user_id1</code>, <code>users_id2</code>, number of common groups). For the sample data in the preceding figure, the edge list will look like this (only 10 of the 47 edges are shown in the following figure). Once again, we need only the upper or lower triangle of this, and we take care of that in a later step:</p>
<p><img src="img/7_1_3.jpeg" alt=""></p>
<p>We have a symmetric network. Saying that users A and B have n groups in common is the same thing as saying that users B and A have n groups in common. Thus, we do not need to represent both of these in the adjacency matrix or in the edge list. We also do not need any edges connecting users to themselves and thus do not need the diagonal elements in the sparse matrix or elements with the same value for i and j in the edge list.</p>
<p>Step 6 eliminates the redundant edges and the edges that connect a user to themselves.</p>
<p>Step 7 saves the sparse network for possible future use.</p>
<p>We have created both a sparse adjacency matrix and an edge list representation of the social network of users in our chosen Meetup groups. We can use these representations for social network analyses.</p>
<h3 id="See-also…-31"><a href="#See-also…-31" class="headerlink" title="See also…"></a>See also…</h3><p>Downloading social network data using public APIs, from this chapter</p>
<h2 id="Plotting-social-network-data"><a href="#Plotting-social-network-data" class="headerlink" title="Plotting social network data"></a>Plotting social network data</h2><p>This recipe covers the features in the igraph package to create graph objects, plot them, and extract network information from graph objects.</p>
<h3 id="Getting-ready-56"><a href="#Getting-ready-56" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already installed the igraph package, do it now using the following code:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"igraph"</span>)</span><br></pre></td></tr></table></figure>
<p>Also, download the <code>users_edgelist_upper.Rdata</code> file from the book’s data files to your R working directory. Alternately, if you worked through the previous recipe Creating adjacency matrices and edge lists from this chapter, you will have created the file and ensured that it is in your R working directory.</p>
<h3 id="How-to-do-it…-57"><a href="#How-to-do-it…-57" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To plot social network data using igraph, follow these steps:</p>
<ol>
<li><p>Load the data. The following code will restore, from the saved file, a data frame called users.edgelist.upper:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; load(<span class="string">"users_edgelist_upper.Rdata"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>The data file that we have provided users.edgelist.upper should now have 1953 rows of data. Plotting such a network will take too much time—even worse, we will get too dense a plot to get any meaningful information. Just for convenience, we will create a much smaller network by filtering our edge list. We will consider as connected only users who have more than 16 common group memberships and create a far smaller network for illustration only:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt;  edgelist.filtered &lt;-</span><br><span class="line">        users.edgelist.upper[users.edgelist.upper$x &gt; <span class="number">16</span>, ]</span><br><span class="line"></span><br><span class="line">&gt; edgelist.filtered  <span class="comment"># Your results could differ</span></span><br><span class="line"></span><br><span class="line">                 i         j  x</span><br><span class="line"><span class="number">34364988</span>   <span class="number">2073657</span>   <span class="number">3823125</span> <span class="number">17</span></span><br><span class="line"><span class="number">41804209</span>   <span class="number">2073657</span>   <span class="number">4379102</span> <span class="number">18</span></span><br><span class="line"><span class="number">53937250</span>   <span class="number">2073657</span>   <span class="number">5590181</span> <span class="number">17</span></span><br><span class="line"><span class="number">62598651</span>   <span class="number">3823125</span>   <span class="number">6629901</span> <span class="number">18</span></span><br><span class="line"><span class="number">190318039</span>  <span class="number">5286367</span>  <span class="number">13657677</span> <span class="number">17</span></span><br><span class="line"><span class="number">190321739</span>  <span class="number">8417076</span>  <span class="number">13657677</span> <span class="number">17</span></span><br><span class="line"><span class="number">205800861</span>  <span class="number">5054895</span>  <span class="number">14423171</span> <span class="number">18</span></span><br><span class="line"><span class="number">252063744</span>  <span class="number">5054895</span>  <span class="number">33434002</span> <span class="number">18</span></span><br><span class="line"><span class="number">252064197</span>  <span class="number">5590181</span>  <span class="number">33434002</span> <span class="number">17</span></span><br><span class="line"><span class="number">252064967</span>  <span class="number">6629901</span>  <span class="number">33434002</span> <span class="number">18</span></span><br><span class="line"><span class="number">252071701</span> <span class="number">10973799</span>  <span class="number">33434002</span> <span class="number">17</span></span><br><span class="line"><span class="number">252076384</span> <span class="number">13657677</span>  <span class="number">33434002</span> <span class="number">17</span></span><br><span class="line"><span class="number">254937514</span>  <span class="number">5227777</span>  <span class="number">34617262</span> <span class="number">17</span></span><br><span class="line"><span class="number">282621070</span>  <span class="number">5590181</span>  <span class="number">46801552</span> <span class="number">19</span></span><br><span class="line"><span class="number">282621870</span>  <span class="number">6629901</span>  <span class="number">46801552</span> <span class="number">18</span></span><br><span class="line"><span class="number">282639752</span> <span class="number">33434002</span>  <span class="number">46801552</span> <span class="number">20</span></span><br><span class="line"><span class="number">307874358</span> <span class="number">33434002</span>  <span class="number">56882992</span> <span class="number">17</span></span><br><span class="line"><span class="number">335204492</span> <span class="number">33434002</span>  <span class="number">69087262</span> <span class="number">17</span></span><br><span class="line"><span class="number">486425803</span> <span class="number">33434002</span> <span class="number">147010712</span> <span class="number">17</span></span><br><span class="line"></span><br><span class="line">&gt; nrow(edgelist.filtered)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">19</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Renumber the users. Since we filtered the graph significantly, we have only 18 unique users left, but they retain their original user IDs. We will find it convenient to sequence them with unique numbers from 1 through 18. This step is not strictly needed, but will make the social network graph look cleaner:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; uids &lt;- unique(c(edgelist.filtered$i, edgelist.filtered$j))</span><br><span class="line">&gt; i &lt;- match(edgelist.filtered$i, uids)</span><br><span class="line">&gt; j &lt;- match(edgelist.filtered$j, uids)</span><br><span class="line">&gt; nw.new &lt;- data.frame(i, j, x = edgelist.filtered$x)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create the graph object and plot the network:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(igraph)</span><br><span class="line">&gt; g &lt;- graph.data.frame(nw.new, directed=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; g</span><br><span class="line">IGRAPH UN-- <span class="number">18</span> <span class="number">19</span> --</span><br><span class="line">+ attr: name (v/c), x (e/n)</span><br><span class="line">&gt; <span class="comment"># Save the graph for use in later recipes:</span></span><br><span class="line">&gt; save(g, file = <span class="string">"undirected-graph.Rdata"</span>)</span><br><span class="line">&gt; plot.igraph(g, vertex.size = <span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<p> Your plot may look different in terms of layout, but if you look carefully, you will see that the nodes and edges are identical:</p>
<p> <img src="img/7_1_4.jpeg" alt=""></p>
</li>
<li><p>Plot the graph object with a different layout:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot.igraph(g,layout=layout.circle, vertex.size = <span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<p> The following graph is the output of the preceding command:</p>
<p> <img src="img/7_1_5.jpeg" alt=""></p>
</li>
<li><p>Plot the graph object using colors for the vertices and edges:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot.igraph(g,edge.curved=<span class="literal">TRUE</span>,vertex.color=<span class="string">"pink"</span>, edge.color=<span class="string">"black"</span>)</span><br></pre></td></tr></table></figure>
<p> Again, your plot may be laid out differently, but should be functionally identical to the following plot:</p>
<p> <img src="img/7_1_6.jpeg" alt=""></p>
</li>
<li><p>Plot the graph with node size proportional to node degree:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; V(g)$size=degree(g) * <span class="number">4</span></span><br><span class="line">&gt; plot.igraph(g,edge.curved=<span class="literal">TRUE</span>,vertex.color=<span class="string">"pink"</span>, edge.color=<span class="string">"black"</span>)</span><br></pre></td></tr></table></figure>
<p> The output is similar to the following plot:</p>
<p> <img src="img/7_1_7.jpeg" alt=""></p>
</li>
<li><p>Plot the graph with the node size and color based on degree:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; color &lt;- ifelse(degree(g) &gt; <span class="number">5</span>,<span class="string">"red"</span>,<span class="string">"blue"</span>)</span><br><span class="line">&gt; size &lt;- degree(g)*<span class="number">4</span></span><br><span class="line">&gt; plot.igraph(g,vertex.label=<span class="literal">NA</span>,layout= layout.fruchterman.reingold,vertex.color=color,vertex.size=size)</span><br></pre></td></tr></table></figure>
<p> A plot identical to the following will be obtained:</p>
<p> <img src="img/7_1_8.jpeg" alt=""></p>
</li>
<li><p>Plot the graph with the edge thickness proportional to edge weights:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; E(g)$x</span><br><span class="line"></span><br><span class="line"> [<span class="number">1</span>] <span class="number">17</span> <span class="number">18</span> <span class="number">17</span> <span class="number">18</span> <span class="number">17</span> <span class="number">17</span> <span class="number">18</span> <span class="number">18</span> <span class="number">17</span> <span class="number">18</span> <span class="number">17</span> <span class="number">17</span> <span class="number">17</span> <span class="number">19</span> <span class="number">18</span> <span class="number">20</span> <span class="number">17</span> <span class="number">17</span> <span class="number">17</span></span><br><span class="line"></span><br><span class="line">&gt; plot.igraph(g,edge.curved=<span class="literal">TRUE</span>,edge.color=<span class="string">"black"</span>, edge.width=E(g)$x/<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p> The output is similar to the following plot:</p>
<p> <img src="img/7_1_9.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-54"><a href="#How-it-works…-54" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 loads the saved network data in the form of an edge list.</p>
<p>With so much data, we will not find a plot to be a useful visual aid because it will be too crowded. Thus, for illustration, we redefine two users (nodes) to be related (connected in the social network) only if they have more than 16 group memberships in common.</p>
<p>Step 2 filters the edge list and retains only edges that meet the preceding criterion.</p>
<p>Although we have filtered the data, users still retain their original IDs, which are big numbers. Having user numbers in sequence starting with 1 might be nice.</p>
<p>Step 3 does this conversion.</p>
<p>Step 4 uses the graph.data.frame function from the igraph package to create a graph object. The function treats the first two columns of the nw.new data frame argument as the edge list, and treats the rest of the columns as edge attributes.</p>
<p>We created an undirected graph by specifying directed = FALSE. Specifying directed = TRUE (or omitting this argument altogether, since TRUE is the default) will create a directed graph.</p>
<p>Here g is an Undirected Named graph represented by UN. A graph is treated as named, if the vertex has a name attribute. The third letter indicates if the graph is weighted (W), and the fourth letter indicates if it is a bipartite (B) graph. The two numbers indicate the number of vertices and the number of edges. The second line + attr: name (v/c), x (e/n) gives details about the attributes. The name attribute represents the vertex, and the attribute x represents the edge.</p>
<p>The step then uses the plot.igraph function from the igraph package to plot it.</p>
<p>We specified the vertex.size argument to ensure that the node circles were large enough to fit the node numbers.</p>
<p>Step 5 plots the very same graph but with the nodes laid out on the circumference of a circle.</p>
<p>Step 6 shows other options which should be self-explanatory.</p>
<p>In step 7, we set the node (or vertex) size. We use V(g) to access each vertex in the graph object and use the $ operator to extract attributes, for example, V(g)$size. Similarly, we can use E(g) to access the edges.</p>
<p>Step 8 goes further by assigning node color and size based on a node’s degree. It also shows the use of the layout option.</p>
<h3 id="There’s-more…-31"><a href="#There’s-more…-31" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We can do much more with the graph object that the graph.data.frame function of the igraph package creates.</p>
<h4 id="Specifying-plotting-preferences"><a href="#Specifying-plotting-preferences" class="headerlink" title="Specifying plotting preferences"></a>Specifying plotting preferences</h4><p>We showed only a few options to control the look of the plot. You have many more options for controlling the look of the edges, nodes, and other aspects. The documentation of plot.igraph mentions these options. When using them, remember to prefix the node options with (vertex.) and edge options with (edge.).</p>
<h4 id="Plotting-directed-graphs"><a href="#Plotting-directed-graphs" class="headerlink" title="Plotting directed graphs"></a>Plotting directed graphs</h4><p>In step 4 of the main recipe, we created an undirected graph. Here, we create a directed graph object dg:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; dg &lt;- graph.data.frame(nw.new)</span><br><span class="line">&gt; <span class="comment"># save for later use</span></span><br><span class="line">&gt; save(dg, file = <span class="string">"directed-graph.Rdata"</span>)</span><br><span class="line">&gt; plot.igraph(dg,edge.curved=<span class="literal">TRUE</span>,edge.color=<span class="string">"black"</span>, edge.width=E(dg)$x/<span class="number">10</span>,vertex.label.cex=<span class="number">.6</span>)</span><br></pre></td></tr></table></figure>
<p>On plotting the preceding graph, we get the following output:</p>
<p><img src="img/7_1_10.jpeg" alt=""></p>
<h4 id="Creating-a-graph-object-with-weights"><a href="#Creating-a-graph-object-with-weights" class="headerlink" title="Creating a graph object with weights"></a>Creating a graph object with weights</h4><p>If the name of the third column in the edge list passed to graph.data.frame is called weight, it creates a weighted graph. Hence, we can rename the third column from x to weight and redraw the graph:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; nw.weights &lt;- nw.new</span><br><span class="line">&gt; names(nw.weights) &lt;- c(<span class="string">"i"</span>,<span class="string">"j"</span>,<span class="string">"weight"</span>)</span><br><span class="line">&gt; g.weights &lt;- graph.data.frame(nw.weights, directed=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; g.weights</span><br><span class="line">IGRAPH UNW- <span class="number">18</span> <span class="number">19</span> --</span><br><span class="line">+ attr: name (v/c), weight (e/n)</span><br></pre></td></tr></table></figure>
<p>When we check the graph properties, we see W in the third position of UNW-.</p>
<h4 id="Extracting-the-network-as-an-adjacency-matrix-from-the-graph-object"><a href="#Extracting-the-network-as-an-adjacency-matrix-from-the-graph-object" class="headerlink" title="Extracting the network as an adjacency matrix from the graph object"></a>Extracting the network as an adjacency matrix from the graph object</h4><p>Earlier, we created an edge list from a sparse adjacency matrix. Here, we show how to get the sparse adjacency matrix from the graph object that we created in step 4 of the main recipe. In the following, we used type=”upper” to get the upper triangular matrix. Other options are lower and both.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; get.adjacency(g,type=<span class="string">"upper"</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">18</span> x <span class="number">18</span> sparse Matrix of class <span class="string">"dgCMatrix"</span></span><br><span class="line">   [[ suppressing <span class="number">18</span> column names <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span> <span class="keyword">...</span> ]]</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>  . <span class="number">1</span> . . . <span class="number">1</span> . . . . . <span class="number">1</span> . . . . . .</span><br><span class="line"><span class="number">2</span>  . . . . . . <span class="number">1</span> . . . . . . . . . . .</span><br><span class="line"><span class="number">3</span>  . . . . . . . . <span class="number">1</span> . . . . . . . . .</span><br><span class="line"><span class="number">4</span>  . . . . . . . . <span class="number">1</span> . . . . . . . . .</span><br><span class="line"><span class="number">5</span>  . . . . . . . . . . <span class="number">1</span> . <span class="number">1</span> . . . . .</span><br><span class="line"><span class="number">6</span>  . . . . . . . . . . <span class="number">1</span> . . . <span class="number">1</span> . . .</span><br><span class="line"><span class="number">7</span>  . . . . . . . . . . <span class="number">1</span> . . . <span class="number">1</span> . . .</span><br><span class="line"><span class="number">8</span>  . . . . . . . . . . <span class="number">1</span> . . . . . . .</span><br><span class="line"><span class="number">9</span>  . . . . . . . . . . <span class="number">1</span> . . . . . . .</span><br><span class="line"><span class="number">10</span> . . . . . . . . . . . . . <span class="number">1</span> . . . .</span><br><span class="line"><span class="number">11</span> . . . . . . . . . . . . . . <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">12</span> . . . . . . . . . . . . . . . . . .</span><br><span class="line"><span class="number">13</span> . . . . . . . . . . . . . . . . . .</span><br><span class="line"><span class="number">14</span> . . . . . . . . . . . . . . . . . .</span><br><span class="line"><span class="number">15</span> . . . . . . . . . . . . . . . . . .</span><br><span class="line"><span class="number">16</span> . . . . . . . . . . . . . . . . . .</span><br><span class="line"><span class="number">17</span> . . . . . . . . . . . . . . . . . .</span><br><span class="line"><span class="number">18</span> . . . . . . . . . . . . . . . . . .</span><br></pre></td></tr></table></figure>
<p>In the preceding code, we did not get back the weights and got back a 0-1 sparse matrix instead.</p>
<p>If we want the weights, we can implement the following techniques.</p>
<h4 id="Extracting-an-adjacency-matrix-with-weights"><a href="#Extracting-an-adjacency-matrix-with-weights" class="headerlink" title="Extracting an adjacency matrix with weights"></a>Extracting an adjacency matrix with weights</h4><p>The graph.data.frame function from the igraph package treats the first two columns of the data frame supplied as making up the edge list and the rest of the columns as edge attributes. By default, the get.adjacency function does not return any edge attributes and instead returns a simple 0-1 sparse matrix of connections.</p>
<p>However, you can pass the attr argument to tell the function which of the remaining attributes you want as the elements of the sparse matrix (and hence the edge weight). In our situation, this attribute will be x, representing the number of common group memberships between two users. In the following, we have specified type = “lower” to get the lower triangular matrix. Other options are upper and both.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; get.adjacency(g, type = <span class="string">"lower"</span>, attr = <span class="string">"x"</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">18</span> x <span class="number">18</span> sparse Matrix of class <span class="string">"dgCMatrix"</span></span><br><span class="line">   [[ suppressing <span class="number">18</span> column names <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span> <span class="keyword">...</span> ]]</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>   .  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">2</span>  <span class="number">17</span>  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">3</span>   .  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">4</span>   .  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">5</span>   .  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">6</span>  <span class="number">17</span>  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">7</span>   . <span class="number">18</span>  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">8</span>   .  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">9</span>   .  . <span class="number">17</span> <span class="number">17</span>  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">10</span>  .  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">11</span>  .  .  .  . <span class="number">18</span> <span class="number">17</span> <span class="number">18</span> <span class="number">17</span> <span class="number">17</span>  .  . . . . . . . .</span><br><span class="line"><span class="number">12</span> <span class="number">18</span>  .  .  .  .  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">13</span>  .  .  .  . <span class="number">18</span>  .  .  .  .  .  . . . . . . . .</span><br><span class="line"><span class="number">14</span>  .  .  .  .  .  .  .  .  . <span class="number">17</span>  . . . . . . . .</span><br><span class="line"><span class="number">15</span>  .  .  .  .  . <span class="number">19</span> <span class="number">18</span>  .  .  . <span class="number">20</span> . . . . . . .</span><br><span class="line"><span class="number">16</span>  .  .  .  .  .  .  .  .  .  . <span class="number">17</span> . . . . . . .</span><br><span class="line"><span class="number">17</span>  .  .  .  .  .  .  .  .  .  . <span class="number">17</span> . . . . . . .</span><br><span class="line"><span class="number">18</span>  .  .  .  .  .  .  .  .  .  . <span class="number">17</span> . . . . . . .</span><br></pre></td></tr></table></figure>
<h4 id="Extracting-edge-list-from-graph-object"><a href="#Extracting-edge-list-from-graph-object" class="headerlink" title="Extracting edge list from graph object"></a>Extracting edge list from graph object</h4><p>You can use the get.data.frame on an igraph object, to get the edge list:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; y &lt;- get.data.frame(g)</span><br></pre></td></tr></table></figure>
<p>Use this to get only the vertices:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; y &lt;- get.data.frame(g,<span class="string">"vertices"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Creating-bipartite-network-graph"><a href="#Creating-bipartite-network-graph" class="headerlink" title="Creating bipartite network graph"></a>Creating bipartite network graph</h4><p>Say we have a set of groups and a set of users with each user belonging to several groups and each group potentially has several members.</p>
<p>We can represent this information as a bipartite graph with the groups forming one set, the users forming the other, and edges linking members of one set to the other. You can use the graph.incidence function from the igraph package to create and visualize this network:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&gt; set.seed(<span class="number">2015</span>)</span><br><span class="line">&gt; g1 &lt;- rbinom(<span class="number">10</span>,<span class="number">1</span>,<span class="number">.5</span>)</span><br><span class="line">&gt; g2 &lt;- rbinom(<span class="number">10</span>,<span class="number">1</span>,<span class="number">.5</span>)</span><br><span class="line">&gt; g3 &lt;- rbinom(<span class="number">10</span>,<span class="number">1</span>,<span class="number">.5</span>)</span><br><span class="line">&gt; g4 &lt;- rbinom(<span class="number">10</span>,<span class="number">1</span>,<span class="number">.5</span>)</span><br><span class="line">&gt; membership &lt;- data.frame(g1, g2, g3, g4)</span><br><span class="line">&gt; names(membership)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"g1"</span> <span class="string">"g2"</span> <span class="string">"g3"</span> <span class="string">"g4"</span></span><br><span class="line"></span><br><span class="line">&gt; rownames(membership) = c(<span class="string">"u1"</span>, <span class="string">"u2"</span>, <span class="string">"u3"</span>, <span class="string">"u4"</span>, <span class="string">"u5"</span>, <span class="string">"u6"</span>, <span class="string">"u7"</span>, <span class="string">"u8"</span>, <span class="string">"u9"</span>, <span class="string">"u10"</span>)</span><br><span class="line"></span><br><span class="line">&gt; rownames(membership)</span><br><span class="line"></span><br><span class="line"> [<span class="number">1</span>] <span class="string">"u1"</span>  <span class="string">"u2"</span>  <span class="string">"u3"</span>  <span class="string">"u4"</span>  <span class="string">"u5"</span>  <span class="string">"u6"</span>  <span class="string">"u7"</span>  <span class="string">"u8"</span></span><br><span class="line"> [<span class="number">9</span>] <span class="string">"u9"</span>  <span class="string">"u10"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Create the bipartite graph through the</span></span><br><span class="line">&gt; <span class="comment"># graph.incidence function</span></span><br><span class="line">&gt; bg &lt;- graph.incidence(membership)</span><br><span class="line">&gt; bg</span><br><span class="line"></span><br><span class="line">IGRAPH UN-B <span class="number">14</span> <span class="number">17</span> --</span><br><span class="line">+ attr: type (v/l), name (v/c)</span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># The B above tells us that this is a bipartite graph</span></span><br><span class="line">&gt; <span class="comment"># Explore bg</span></span><br><span class="line">&gt; V(bg)$type</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span> <span class="literal">FALSE</span></span><br><span class="line"> [<span class="number">9</span>] <span class="literal">FALSE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># FALSE represents the users and TRUE represents the groups</span></span><br><span class="line">&gt; <span class="comment"># See node names</span></span><br><span class="line">&gt; V(bg)$name</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"u1"</span>  <span class="string">"u2"</span>  <span class="string">"u3"</span>  <span class="string">"u4"</span>  <span class="string">"u5"</span>  <span class="string">"u6"</span>  <span class="string">"u7"</span>  <span class="string">"u8"</span></span><br><span class="line">[<span class="number">9</span>] <span class="string">"u9"</span>  <span class="string">"u10"</span> <span class="string">"g1"</span>  <span class="string">"g2"</span>  <span class="string">"g3"</span>  <span class="string">"g4"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># create a layout</span></span><br><span class="line">&gt; lay &lt;- layout.bipartite(bg)</span><br><span class="line">&gt; <span class="comment"># plot it</span></span><br><span class="line">&gt; plot(bg, layout=lay, vertex.size = <span class="number">20</span>)</span><br><span class="line">&gt; <span class="comment"># save for later use</span></span><br><span class="line">&gt; save(bg, file = <span class="string">"bipartite-graph.Rdata"</span>)</span><br></pre></td></tr></table></figure>
<p>We created a random network of four groups and ten users which when plotted appears as follows:</p>
<p><img src="img/7_1_11.jpeg" alt=""></p>
<h4 id="Generating-projections-of-a-bipartite-network"><a href="#Generating-projections-of-a-bipartite-network" class="headerlink" title="Generating projections of a bipartite network"></a>Generating projections of a bipartite network</h4><p>Very often, we need to extract adjacency information about one or both types of nodes in a bipartite network. In the preceding example with users and groups, we may want to consider two users as related or connected if they have a common group membership and create a graph only of the users. Analogously, we may consider two groups as connected if they have at least one user in common. Use the bipartite.projection function to achieve this:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Generate the two projections</span></span><br><span class="line">&gt; p &lt;- bipartite.projection(bg)</span><br><span class="line">&gt; p</span><br><span class="line"></span><br><span class="line">$proj1</span><br><span class="line">IGRAPH UNW- <span class="number">10</span> <span class="number">24</span> --</span><br><span class="line">+ attr: name (v/c), weight (e/n)</span><br><span class="line"></span><br><span class="line">$proj2</span><br><span class="line">IGRAPH UNW- <span class="number">4</span> <span class="number">5</span> --</span><br><span class="line">+ attr: name (v/c), weight (e/n)</span><br><span class="line"></span><br><span class="line">&gt; plot(p$proj1, vertex.size = <span class="number">20</span>)</span><br><span class="line">&gt; plot(p$proj2, vertex.size = <span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<p>The first projection is plotted as follows:</p>
<p><img src="img/7_1_12.jpeg" alt=""></p>
<p>The next projection is generated as follows:</p>
<p><img src="img/7_1_13.jpeg" alt=""></p>
<h3 id="See-also…-32"><a href="#See-also…-32" class="headerlink" title="See also…"></a>See also…</h3><p>Creating adjacency matrices and edge lists from this chapter</p>
<h2 id="Computing-important-network-metrics"><a href="#Computing-important-network-metrics" class="headerlink" title="Computing important network metrics"></a>Computing important network metrics</h2><p>This recipe covers the methods used to compute some of the common metrics used on social networks.</p>
<h3 id="Getting-ready-57"><a href="#Getting-ready-57" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not yet installed the igraph package, do it now. If you worked through the earlier recipes in this chapter, you should have the data files directed-graph.Rdata, undirected-graph.Rdata, and bipartite-graph.Rdata and should ensure that they are in your R working directory. If not, you should download these data files and place them in your R working directory.</p>
<h3 id="How-to-do-it…-58"><a href="#How-to-do-it…-58" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To compute important network metrics, follow these steps:</p>
<ol>
<li><p>Load the data files:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; load(<span class="string">"undirected-graph.Rdata"</span>)</span><br><span class="line">&gt; load(<span class="string">"directed-graph.Rdata"</span>)</span><br><span class="line">&gt; load(<span class="string">"bipartite-graph.Rdata"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>The degree centrality can be measured as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&gt; degree(dg)</span><br><span class="line"></span><br><span class="line"> <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">16</span> <span class="number">17</span> <span class="number">18</span></span><br><span class="line"> <span class="number">3</span>  <span class="number">2</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">3</span>  <span class="number">1</span>  <span class="number">3</span>  <span class="number">1</span>  <span class="number">9</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">3</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&gt; degree(g)</span><br><span class="line"></span><br><span class="line"> <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">16</span> <span class="number">17</span> <span class="number">18</span></span><br><span class="line"> <span class="number">3</span>  <span class="number">2</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">3</span>  <span class="number">1</span>  <span class="number">3</span>  <span class="number">1</span>  <span class="number">9</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">3</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&gt; degree(dg, <span class="string">"7"</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"></span><br><span class="line">&gt; degree(dg, <span class="number">9</span>, mode = <span class="string">"in"</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"></span><br><span class="line">&gt; degree(dg, <span class="number">9</span>, mode = <span class="string">"out"</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># Proportion of vertices with degree 0, 1, 2, etc.</span></span><br><span class="line">&gt; options(digits=<span class="number">3</span>)</span><br><span class="line">&gt; degree.distribution(bg)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">0.0714</span> <span class="number">0.2857</span> <span class="number">0.1429</span> <span class="number">0.3571</span></span><br><span class="line">[<span class="number">5</span>] <span class="number">0.0714</span> <span class="number">0.0000</span> <span class="number">0.0000</span> <span class="number">0.0714</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>The betweenness centrality can be measured as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; betweenness(dg)</span><br><span class="line"></span><br><span class="line"> <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">16</span> <span class="number">17</span> <span class="number">18</span></span><br><span class="line"> <span class="number">0</span>  <span class="number">1</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">5</span>  <span class="number">5</span>  <span class="number">0</span> <span class="number">10</span>  <span class="number">0</span> <span class="number">32</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; betweenness(g)</span><br><span class="line"></span><br><span class="line">   <span class="number">1</span>    <span class="number">2</span>    <span class="number">3</span>    <span class="number">4</span>    <span class="number">5</span>    <span class="number">6</span>    <span class="number">7</span>    <span class="number">8</span>    <span class="number">9</span>   <span class="number">10</span>   <span class="number">11</span>   <span class="number">12</span></span><br><span class="line"><span class="number">15.0</span>  <span class="number">2.0</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">14.0</span> <span class="number">22.0</span> <span class="number">11.0</span>  <span class="number">0.0</span> <span class="number">27.0</span>  <span class="number">0.0</span> <span class="number">86.5</span>  <span class="number">0.0</span></span><br><span class="line">  <span class="number">13</span>   <span class="number">14</span>   <span class="number">15</span>   <span class="number">16</span>   <span class="number">17</span>   <span class="number">18</span></span><br><span class="line"> <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">0.5</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">&gt; betweenness(dg, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; edge.betweenness(dg)</span><br><span class="line"></span><br><span class="line"> [<span class="number">1</span>]  <span class="number">2</span>  <span class="number">1</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">6</span>  <span class="number">6</span>  <span class="number">1</span>  <span class="number">5</span>  <span class="number">8</span>  <span class="number">8</span>  <span class="number">5</span> <span class="number">15</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">2</span>  <span class="number">6</span> <span class="number">10</span> <span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"></span><br><span class="line">&gt; edge.betweenness(dg,<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">8</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>The closeness centrality can be measured as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&gt; options(digits=<span class="number">3</span>)</span><br><span class="line">&gt; closeness(dg,mode=<span class="string">"in"</span>)</span><br><span class="line"></span><br><span class="line">      <span class="number">1</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">4</span>       <span class="number">5</span>       <span class="number">6</span></span><br><span class="line"><span class="number">0.00327</span> <span class="number">0.00346</span> <span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00346</span></span><br><span class="line">      <span class="number">7</span>       <span class="number">8</span>       <span class="number">9</span>      <span class="number">10</span>      <span class="number">11</span>      <span class="number">12</span></span><br><span class="line"><span class="number">0.00366</span> <span class="number">0.00327</span> <span class="number">0.00368</span> <span class="number">0.00327</span> <span class="number">0.00637</span> <span class="number">0.00346</span></span><br><span class="line">     <span class="number">13</span>      <span class="number">14</span>      <span class="number">15</span>      <span class="number">16</span>      <span class="number">17</span>      <span class="number">18</span></span><br><span class="line"><span class="number">0.00346</span> <span class="number">0.00346</span> <span class="number">0.00690</span> <span class="number">0.00671</span> <span class="number">0.00671</span> <span class="number">0.00671</span></span><br><span class="line"></span><br><span class="line">&gt; closeness(dg,mode=<span class="string">"out"</span>)</span><br><span class="line"></span><br><span class="line">      <span class="number">1</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">4</span>       <span class="number">5</span>       <span class="number">6</span></span><br><span class="line"><span class="number">0.00617</span> <span class="number">0.00472</span> <span class="number">0.00469</span> <span class="number">0.00469</span> <span class="number">0.00481</span> <span class="number">0.00446</span></span><br><span class="line">      <span class="number">7</span>       <span class="number">8</span>       <span class="number">9</span>      <span class="number">10</span>      <span class="number">11</span>      <span class="number">12</span></span><br><span class="line"><span class="number">0.00446</span> <span class="number">0.00444</span> <span class="number">0.00444</span> <span class="number">0.00346</span> <span class="number">0.00420</span> <span class="number">0.00327</span></span><br><span class="line">     <span class="number">13</span>      <span class="number">14</span>      <span class="number">15</span>      <span class="number">16</span>      <span class="number">17</span>      <span class="number">18</span></span><br><span class="line"><span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span></span><br><span class="line"></span><br><span class="line">&gt; closeness(dg,mode=<span class="string">"all"</span>)</span><br><span class="line"></span><br><span class="line">      <span class="number">1</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">4</span>       <span class="number">5</span>       <span class="number">6</span></span><br><span class="line"><span class="number">0.01333</span> <span class="number">0.01316</span> <span class="number">0.01220</span> <span class="number">0.01220</span> <span class="number">0.01429</span> <span class="number">0.01515</span></span><br><span class="line">      <span class="number">7</span>       <span class="number">8</span>       <span class="number">9</span>      <span class="number">10</span>      <span class="number">11</span>      <span class="number">12</span></span><br><span class="line"><span class="number">0.01493</span> <span class="number">0.01389</span> <span class="number">0.01471</span> <span class="number">0.00346</span> <span class="number">0.01724</span> <span class="number">0.01124</span></span><br><span class="line">     <span class="number">13</span>      <span class="number">14</span>      <span class="number">15</span>      <span class="number">16</span>      <span class="number">17</span>      <span class="number">18</span></span><br><span class="line"><span class="number">0.01190</span> <span class="number">0.00346</span> <span class="number">0.01493</span> <span class="number">0.01389</span> <span class="number">0.01389</span> <span class="number">0.01389</span></span><br><span class="line"></span><br><span class="line">&gt; closeness(dg)</span><br><span class="line"></span><br><span class="line">      <span class="number">1</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">4</span>       <span class="number">5</span>       <span class="number">6</span></span><br><span class="line"><span class="number">0.00617</span> <span class="number">0.00472</span> <span class="number">0.00469</span> <span class="number">0.00469</span> <span class="number">0.00481</span> <span class="number">0.00446</span></span><br><span class="line">      <span class="number">7</span>       <span class="number">8</span>       <span class="number">9</span>      <span class="number">10</span>      <span class="number">11</span>      <span class="number">12</span></span><br><span class="line"><span class="number">0.00446</span> <span class="number">0.00444</span> <span class="number">0.00444</span> <span class="number">0.00346</span> <span class="number">0.00420</span> <span class="number">0.00327</span></span><br><span class="line">     <span class="number">13</span>      <span class="number">14</span>      <span class="number">15</span>      <span class="number">16</span>      <span class="number">17</span>      <span class="number">18</span></span><br><span class="line"><span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span> <span class="number">0.00327</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-55"><a href="#How-it-works…-55" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 computes various metrics dealing with the degree of the vertices in a graph. Degree measures the number of edges connected to a vertex or node. Degree distribution provides the frequency of all degree measures up to the maximum degree. For an undirected graph, the degree is always the total adjacent edges. However, for a directed graph, the degree depends on the mode argument passed. Mode can be out, in, all, or total. Both all and total return the total degree of that node or vertex. You should be able to verify some of the numbers from the plots provided earlier.</p>
<p>Centrality determines how individual nodes fit within a network. High centrality nodes are influencers: positive and negative. There are different types of centrality, and we discuss a few important ones here.</p>
<p>Step 2, computes betweenness, which quantifies the number of times a node falls in the shortest path between two other nodes. Nodes with high betweenness sit between two different clusters. To travel from any node in one cluster to any other node in the second cluster, one will likely need to travel through this particular node.</p>
<p>Edge betweenness computes the number of shortest paths through a particular edge. If a graph includes the weight attribute, then it is used by default. In our example, we have an attribute x. You will get different results if you rename the column to weight.</p>
<p>Step 3 computes closeness, which quantifies the extent to which a node is close to other nodes. It is a measure of the total distance from a node to all others. A node with high closeness has easy access to many other nodes. In a directed graph, if mode is not specified, then out is the default. In an undirected graph, mode does not play any role and is ignored.</p>
<p><strong>Tip</strong></p>
<p>Closeness measures the extent of access a node has to others, and betweenness measures the extent to which a node acts as an intermediary.</p>
<h3 id="There’s-more…-32"><a href="#There’s-more…-32" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We show a few additional options to work on the graph objects.</p>
<h4 id="Getting-edge-sequences"><a href="#Getting-edge-sequences" class="headerlink" title="Getting edge sequences"></a>Getting edge sequences</h4><p>You can look at the edges—the connections—in the figure showing the directed graph in Plotting directed graphs. You can identify edges as E(1) … E(19):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; E(dg)</span><br><span class="line">Edge sequence:</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>]  <span class="number">1</span>  -&gt; <span class="number">2</span></span><br><span class="line">[<span class="number">2</span>]  <span class="number">1</span>  -&gt; <span class="number">12</span></span><br><span class="line">[<span class="number">3</span>]  <span class="number">1</span>  -&gt; <span class="number">6</span></span><br><span class="line">[<span class="number">4</span>]  <span class="number">2</span>  -&gt; <span class="number">7</span></span><br><span class="line">[<span class="number">5</span>]  <span class="number">3</span>  -&gt; <span class="number">9</span></span><br><span class="line">[<span class="number">6</span>]  <span class="number">4</span>  -&gt; <span class="number">9</span></span><br><span class="line">[<span class="number">7</span>]  <span class="number">5</span>  -&gt; <span class="number">13</span></span><br><span class="line">[<span class="number">8</span>]  <span class="number">5</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">9</span>]  <span class="number">6</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">10</span>] <span class="number">7</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">11</span>] <span class="number">8</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">12</span>] <span class="number">9</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">13</span>] <span class="number">10</span> -&gt; <span class="number">14</span></span><br><span class="line">[<span class="number">14</span>] <span class="number">6</span>  -&gt; <span class="number">15</span></span><br><span class="line">[<span class="number">15</span>] <span class="number">7</span>  -&gt; <span class="number">15</span></span><br><span class="line">[<span class="number">16</span>] <span class="number">11</span> -&gt; <span class="number">15</span></span><br><span class="line">[<span class="number">17</span>] <span class="number">11</span> -&gt; <span class="number">16</span></span><br><span class="line">[<span class="number">18</span>] <span class="number">11</span> -&gt; <span class="number">17</span></span><br><span class="line">[<span class="number">19</span>] <span class="number">11</span> -&gt; <span class="number">18</span></span><br></pre></td></tr></table></figure>
<h4 id="Getting-immediate-and-distant-neighbors"><a href="#Getting-immediate-and-distant-neighbors" class="headerlink" title="Getting immediate and distant neighbors"></a>Getting immediate and distant neighbors</h4><p>The neighbors function lists the neighbors of a given node (excluding itself):</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; neighbors(g, <span class="number">1</span>)</span><br><span class="line">[<span class="number">1</span>]  <span class="number">2</span>  <span class="number">6</span> <span class="number">12</span></span><br><span class="line">&gt; neighbors(bg, <span class="string">"u1"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="number">12</span> <span class="number">13</span> <span class="number">14</span></span><br><span class="line">&gt; <span class="comment"># for a bipartite graph, refer to nodes by node name and</span></span><br><span class="line">&gt; <span class="comment"># get results also as node names</span></span><br><span class="line">&gt; V(bg)$name[neighbors(bg,<span class="string">"g1"</span>)]</span><br><span class="line">[<span class="number">1</span>] <span class="string">"u2"</span>  <span class="string">"u9"</span>  <span class="string">"u10"</span></span><br></pre></td></tr></table></figure>
<p>The neighborhood function gets the list of neighbors lying at most a specified distance from a given node or a set of nodes. The node in question is always included in the list since it is of distance 0 from itself:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment">#immediate neighbors of node 1</span></span><br><span class="line">&gt; neighborhood(dg, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">[[<span class="number">1</span>]]</span><br><span class="line">[<span class="number">1</span>]  <span class="number">1</span>  <span class="number">2</span>  <span class="number">6</span> <span class="number">12</span></span><br><span class="line"></span><br><span class="line">&gt; neighborhood(dg, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">[[<span class="number">1</span>]]</span><br><span class="line"> [<span class="number">1</span>]  <span class="number">1</span>  <span class="number">2</span>  <span class="number">6</span> <span class="number">12</span>  <span class="number">7</span> <span class="number">11</span> <span class="number">15</span></span><br></pre></td></tr></table></figure>
<h4 id="Adding-vertices-or-nodes"><a href="#Adding-vertices-or-nodes" class="headerlink" title="Adding vertices or nodes"></a>Adding vertices or nodes</h4><p>We can add nodes to an existing graph object:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment">#Add a new vertex</span></span><br><span class="line">&gt; g.new &lt;- g + vertex(<span class="number">19</span>)</span><br><span class="line">&gt; <span class="comment"># Add 2 new vertices</span></span><br><span class="line">&gt; g.new &lt;- g + vertices(<span class="number">19</span>, <span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Adding-edges"><a href="#Adding-edges" class="headerlink" title="Adding edges"></a>Adding edges</h4><p>If we need to add a new relationship between nodes 15 and 20, we can do the following:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; g.new &lt;- g.new + edge(<span class="number">15</span>, <span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Deleting-isolates-from-a-graph"><a href="#Deleting-isolates-from-a-graph" class="headerlink" title="Deleting isolates from a graph"></a>Deleting isolates from a graph</h4><p>Isolated nodes have no connections or edges and therefore have degree 0. We can use this to select vertices that have 0 degree and delete them using delete.vertices as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; g.new &lt;- delete.vertices(g.new, V(g.new)[ degree(g.new)==<span class="number">0</span> ])</span><br></pre></td></tr></table></figure>
<p>We can also use delete.vertices to delete a specific vertex. This function creates a new graph. If the vertex does not exist in the graph, you will see an error message Invalid vertex names. Plot the new graph to check if the isolated vertex has been removed:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; g.new &lt;- delete.vertices(g.new,<span class="number">12</span>)</span><br></pre></td></tr></table></figure>
<p>Deletion reassigns the vertex IDs even in some cases when edges are deleted. Hence, if you are using IDs instead of vertex names, exercise caution as the IDs may change.</p>
<h4 id="Creating-subgraphs"><a href="#Creating-subgraphs" class="headerlink" title="Creating subgraphs"></a>Creating subgraphs</h4><p>You can create new graphs by selecting the vertices you are interested in using the following code:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; g.sub &lt;- induced.subgraph(g, c(<span class="number">5</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">7</span>))</span><br></pre></td></tr></table></figure>
<p>You can also create new graphs by selecting the edges you are interested in using the following code:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; E(dg)</span><br><span class="line"></span><br><span class="line">Edge sequence:</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>]  <span class="number">1</span>  -&gt; <span class="number">2</span></span><br><span class="line">[<span class="number">2</span>]  <span class="number">1</span>  -&gt; <span class="number">12</span></span><br><span class="line">[<span class="number">3</span>]  <span class="number">1</span>  -&gt; <span class="number">6</span></span><br><span class="line">[<span class="number">4</span>]  <span class="number">2</span>  -&gt; <span class="number">7</span></span><br><span class="line">[<span class="number">5</span>]  <span class="number">3</span>  -&gt; <span class="number">9</span></span><br><span class="line">[<span class="number">6</span>]  <span class="number">4</span>  -&gt; <span class="number">9</span></span><br><span class="line">[<span class="number">7</span>]  <span class="number">5</span>  -&gt; <span class="number">13</span></span><br><span class="line">[<span class="number">8</span>]  <span class="number">5</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">9</span>]  <span class="number">6</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">10</span>] <span class="number">7</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">11</span>] <span class="number">8</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">12</span>] <span class="number">9</span>  -&gt; <span class="number">11</span></span><br><span class="line">[<span class="number">13</span>] <span class="number">10</span> -&gt; <span class="number">14</span></span><br><span class="line">[<span class="number">14</span>] <span class="number">6</span>  -&gt; <span class="number">15</span></span><br><span class="line">[<span class="number">15</span>] <span class="number">7</span>  -&gt; <span class="number">15</span></span><br><span class="line">[<span class="number">16</span>] <span class="number">11</span> -&gt; <span class="number">15</span></span><br><span class="line">[<span class="number">17</span>] <span class="number">11</span> -&gt; <span class="number">16</span></span><br><span class="line">[<span class="number">18</span>] <span class="number">11</span> -&gt; <span class="number">17</span></span><br><span class="line">[<span class="number">19</span>] <span class="number">11</span> -&gt; <span class="number">18</span></span><br><span class="line"></span><br><span class="line">&gt; eids &lt;- c(<span class="number">1</span>:<span class="number">2</span>, <span class="number">9</span>:<span class="number">15</span>)</span><br><span class="line">&gt; dg.sub &lt;- subgraph.edges(dg, eids)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Chapter-8-Put-Your-Best-Foot-Forward-–-Document-and-Present-Your-Analysis"><a href="#Chapter-8-Put-Your-Best-Foot-Forward-–-Document-and-Present-Your-Analysis" class="headerlink" title="Chapter 8. Put Your Best Foot Forward – Document and Present Your Analysis"></a>Chapter 8. Put Your Best Foot Forward – Document and Present Your Analysis</h1><p>In this chapter, you will cover:</p>
<ul>
<li>Generating reports of your data analysis with R Markdown and knitR</li>
<li>Creating interactive web applications with shiny</li>
<li>Creating PDF presentations of your analysis with R Presentation</li>
</ul>
<h2 id="Introduction-7"><a href="#Introduction-7" class="headerlink" title="Introduction"></a>Introduction</h2><p>Other than helping us analyze data, R has libraries that help you with professional presentations as well. You can perform the following tasks:</p>
<p>Create professional web pages that showcase your analysis and allow others to actively experiment with the underlying data<br>Generate PDF reports of your analysis; your report can include embedded R commands for the system to execute and fill live data and charts so that, when the data changes, you can regenerate the report with a single button click<br>Generate PDF presentations of your analysis<br>This chapter provides recipes for you to exploit all of these capabilities.</p>
<h2 id="Generating-reports-of-your-data-analysis-with-R-Markdown-and-knitr"><a href="#Generating-reports-of-your-data-analysis-with-R-Markdown-and-knitr" class="headerlink" title="Generating reports of your data analysis with R Markdown and knitr"></a>Generating reports of your data analysis with R Markdown and knitr</h2><p>R Markdown provides a simple syntax to define analysis reports. Based on such a report definition, knitr can generate reports in HTML, PDF, Microsoft Word format, and several presentation formats. R Markdown documents contain regular text, embedded R code chunks, and inline R code. knitr parses the markdown document and inserts the results of executing the R code at specified locations within regular text to produce a well-formatted report.</p>
<p>R Markdown extends the regular markdown format to enable us to embed R code.</p>
<p>We can create R Markdown documents either in RStudio or directly in R using the markdown package. In this recipe, we describe the RStudio approach.</p>
<h3 id="Getting-ready-58"><a href="#Getting-ready-58" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and place the auto-mpg.csv and knitr.Rmd files in a known location (this need not necessarily be the working directory of your R installation).</p>
<p>Install the latest version of the knitr and rmarkdown packages:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"knitr"</span>)</span><br><span class="line">&gt; install.packages(<span class="string">"rmarkdown"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-59"><a href="#How-to-do-it…-59" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To generate reports using rmarkdown and knitr, follow these steps:</p>
<ol>
<li>Open RStudio.</li>
<li>Create a new R Markdown document as follows:</li>
<li>Select the menu option by navigating to File | New File | R Markdown.</li>
<li><p>Enter the title as “Introduction”, leave the other defaults as is, and click on OK.</p>
<p> This generates a sample R Markdown document that we can edit to suit our needs. The sample document resembles the following screenshot:</p>
<p> <img src="img/8_1_1.jpeg" alt=""></p>
</li>
<li><p>Take a quick look at the document. You do not need to understand everything in it. In this step, we are just trying to get an overview.</p>
</li>
<li>Generate an HTML document based on the markdown file. Depending on the width of your editing pane, you may either see just the knitr icon (a blue bale of wool and a knitting needle) with a downward-facing arrow or the icon and the text Knit HTML beside it. If you only see the icon, click on the downward arrow beside the icon and select Knit HTML. If you see the text in addition to the icon, just click on Knit HTML to generate the HTML document. RStudio may render the report in a separate window or in the top pane on the right side. The menu that you used to generate HTML has options to control where RStudio will render the report—choose either View in pane or View in window.</li>
<li>With the same file, you can generate a PDF or Word document by invoking the appropriate menu option. To generate a Word document, you need to have Microsoft Word installed on your system and, to generate a PDF, you need to have the Latex PDF generator pdflatex installed. Note that the output item in the metadata changes according to the output format you choose from the menu.</li>
<li>Now that you have an idea of the process, use the menu option by navigating to File | Open file to open the knitr.Rmd file. Before proceeding further, edit line 40 of the file and change the root.dir location to wherever you downloaded the files for this chapter. For ease of discussion, we show the output incrementally.</li>
<li><p>The metadata section is between two lines, each with just three hyphens, shown as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: <span class="string">"Markdown Document"</span></span><br><span class="line">author: <span class="string">"Shanthi Viswanathan"</span></span><br><span class="line">date: <span class="string">"December 8, 2014"</span></span><br><span class="line">output:</span><br><span class="line">  html_document:</span><br><span class="line">    theme: cosmo</span><br><span class="line">    toc: yes</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p> <img src="img/8_1_2.jpeg" alt=""></p>
</li>
<li><p>The Introduction section of the R Markdown document appears as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* * *</span><br><span class="line"><span class="comment"># Introduction</span></span><br><span class="line">This is an *R Markdown document*. Markdown is a simple formatting syntax <span class="keyword">for</span> authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see &lt;http://rmarkdown.rstudio.com&gt;.</span><br></pre></td></tr></table></figure>
<p>When you click the <strong>Knit</strong> button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.</p>
<p>This is also seen in the following screenshot:</p>
<p><img src="img/8_1_3.jpeg" alt=""></p>
</li>
<li><p>The HTML content of the document is as follows:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#HTML Content</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span> This is a new paragraph written with the HTML tag</span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">th</span>&gt;</span> Pros <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">th</span>&gt;</span> Cons <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span>Easy to use<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span>Need to Plan ahead <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>In the document it appears as follows:</p>
<p><img src="img/8_1_4.jpeg" alt=""></p>
</li>
<li><p>Embed the R Code. Change the following root.dir path to the folder where you stored the auto-mpg.csv and knitr.Rmd files:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Embed Code</span></span><br><span class="line"><span class="comment">## Set Directory</span></span><br><span class="line">You can embed any R code chunk within <span class="number">3</span> ticks. If you add echo=<span class="literal">FALSE</span> the code chunk is not displayed <span class="keyword">in</span> the document. We can set knitr options either globally or within a code segment. The options set globally are used throughout the document.</span><br><span class="line"></span><br><span class="line">We set the root.dir before loading any files. By enabling cache=<span class="literal">TRUE</span>, a code chunk is executed only when there is a change from the prior execution. This enhances knitr performance.</span><br><span class="line"></span><br><span class="line">```&#123;r setup, echo=FALSE, message=FALSE, warning=FALSE&#125;</span><br><span class="line">knitr::opts_chunk$set(cache=TRUE)</span><br><span class="line">knitr::opts_knit$set(root.dir = "/Users/shanthiviswanathan/projects/RCookbook/chapter8/")</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    This can be seen in the following screenshot:</span><br><span class="line"></span><br><span class="line">    ![](img/8_1_5.jpeg)</span><br><span class="line"></span><br><span class="line">13. Load the data:</span><br><span class="line"></span><br><span class="line">    ```R</span><br><span class="line">    ##Load Data</span><br><span class="line">    ```&#123;r loadData, echo=FALSE&#125;</span><br><span class="line">    auto &lt;- read.csv(&quot;auto-mpg.csv&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">14. Plot the data:</span><br><span class="line"></span><br><span class="line">    ```R</span><br><span class="line">    ```&#123;r plotData &#125;</span><br><span class="line">    plot(auto$mpg~auto$weight)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    The output of the preceding command can be seen here:</span><br><span class="line"></span><br><span class="line">    ![](img/8_1_6.jpeg)</span><br><span class="line"></span><br><span class="line">15. Plot with the format options:</span><br><span class="line"></span><br><span class="line">    ```R</span><br><span class="line">    ```&#123;r plotFormatData, echo=FALSE, fig.height=4, fig.width=8&#125;</span><br><span class="line">    plot(auto$mpg~auto$weight)</span><br><span class="line">    str(auto)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    The following screenshot shows the plotted output:</span><br><span class="line"></span><br><span class="line">    ![](img/8_1_7.jpeg)</span><br><span class="line"></span><br><span class="line">16. Embed the code within a sentence:</span><br><span class="line"></span><br><span class="line">    There are `r nrow(auto)` cars in the auto data set.</span><br><span class="line">    Here&apos;s the output of the preceding command:</span><br><span class="line"></span><br><span class="line">    ![](img/8_1_8.jpeg)</span><br><span class="line"></span><br><span class="line">### How it works...</span><br><span class="line"></span><br><span class="line">Step 1 opens RStudio.</span><br><span class="line"></span><br><span class="line">Step 2 creates a new R Markdown document. A new document includes a default metadata section between lines containing three dashes. This metadata section includes the title and output sections and can optionally also specify the author and date.</span><br><span class="line"></span><br><span class="line">Step 4 shows you how to generate the HTML document. If running in RStudio, you can indicate the desired output format by selecting the appropriate menu option. However, it is possible to run knitr within a standard R environment; in this case, the output specified in the markdown document determines the format of the output document.</span><br><span class="line"></span><br><span class="line">Step 5 shows you how to generate a PDF or Word document based on the markdown document.</span><br><span class="line"></span><br><span class="line">Step 6 opens a precreated document that illustrates many of the important features of knitr. We explain the code in parts here.</span><br><span class="line"></span><br><span class="line">Step 7 contains the metadata of the document:</span><br><span class="line"></span><br><span class="line">- There are three output types: Word, PDF, and HTML.</span><br><span class="line">- The initial three hyphens indicate the start of the metadata section.</span><br><span class="line">- toc:TRUE causes the table of contents to be generated based on the headings in the document. This is explained in in the next section.</span><br><span class="line">- The final three hyphens end the metadata section.</span><br><span class="line"></span><br><span class="line">Step 8 contains the Introduction section of our sample document:</span><br><span class="line"></span><br><span class="line">- The three asterisks on a line by itself cause a horizontal line to be output.</span><br><span class="line">- Lines starting with a single # signify a first-level heading and, if toc:TRUE is set in the metadata, it is added in the table of contents. Lines starting with ## signify second-level headings.</span><br><span class="line">- Text surrounded by a single asterisk displays as italic, and text surrounded by double asterisks displays as bold.</span><br><span class="line">- Text starting with &lt;http and ending with &gt; is displayed as a URL.</span><br><span class="line">- Checkout *There&apos;s more...* for the most commonly used syntax.</span><br><span class="line"></span><br><span class="line">Step 9 includes the HTML content of our sample document:</span><br><span class="line"></span><br><span class="line">- Regular HTML coding can be embedded in a R Markdown document. knitr will only properly display the HTML if the output format is set in HTML; you must leave an empty line before starting the HTML code.</span><br><span class="line">- In this segment, we used the HTML table syntax to produce a table.</span><br><span class="line"></span><br><span class="line">Step 10 shows how to embed R code in a markdown document:</span><br><span class="line"></span><br><span class="line">- R code fragments or chunks begin on new lines with three back quotes (```) at the start. These chunks end with a line containing just three back quotes. The text of the R code segment starts with r, followed by an optional name for the chunk (we can choose any unique name).</span><br><span class="line">- We recommend that you do not mix the code for knitr settings with regular R code in a single chunk. Keep them in separate chunks. In this step, we set cache=TRUE and also set the home directory for knitr. The knitr options set here apply to the whole document. Thus, cache is enabled for each R code chunk that follows this setting.</span><br><span class="line">- We set up display options for the current code chunk. If echo=FALSE, then the code chunk is not displayed in the document. Similarly, message=FALSE and warning=FALSE suppress any R messages and warnings in the document.</span><br><span class="line"></span><br><span class="line">Step 11 loads data from a file:</span><br><span class="line"></span><br><span class="line">- We show a code chunk named loadData to read a .csv file into a variable. This code chunk does not appear in the report because we have chosen echo=FALSE.</span><br><span class="line">- The location of the file is taken from the directory that we set in the earlier step. Also, since we have enabled cache, the file is not read each time the document is generated.</span><br><span class="line"></span><br><span class="line">Steps 12 and 13 plot data:</span><br><span class="line"></span><br><span class="line">- We create a code chunk called plotData. The R code appears in the report because the default value for echo is TRUE. If an R code chunk produces any output, knitr automatically includes that output in the generated report.</span><br><span class="line"></span><br><span class="line">Step 14 illustrates how to embed R code in-line:</span><br><span class="line"></span><br><span class="line">- We enclose the R code between a set of single back quotes. knitr substitutes the output of the R command in place of the in line R code.</span><br><span class="line">- Thus, nrow(auto) returns the number of autos and is included in the generated document.</span><br><span class="line"></span><br><span class="line">### There&apos;s more...</span><br><span class="line"></span><br><span class="line">The following is a list of the most commonly used markdown syntax elements. See http://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf for a complete list of markdown syntax elements:</span><br><span class="line"></span><br><span class="line">|Option|Syntax|Remarks|</span><br><span class="line">|:-----|------|-------|</span><br><span class="line">|Italics|\*text\*||</span><br><span class="line">|Bold|\*\*text\*\*||</span><br><span class="line">|New Paragraph|Leave 2 spaces after the end of the line||</span><br><span class="line">|Header1–6|# text, ## text, ### text, and so on|Headers display the word in an appropriate font|</span><br><span class="line">|Horizontal Rule `&lt;hr&gt;`|\*\*\*|Draws a horizontal line|</span><br><span class="line">|Unordered List (*, +, -)|\* List Item 1|Note that the space between * and the list item + and – can also be used|</span><br><span class="line">|Unordered SubItem|+ sub item 1|Use an indented + to create a sublist or an indented – or an indented * to create sublists|</span><br><span class="line">|Ordered list|1. List item; 1. Another List item|Even for the ordered list, the indented + is used to create subitems|</span><br><span class="line"></span><br><span class="line">The following table shows the various display options in a code chunk:</span><br><span class="line"></span><br><span class="line">|Option|Description|Possible Values|</span><br><span class="line">|-----|-----------|----------------|</span><br><span class="line">|eval|Evaluate the code in the code chunk|TRUE, FALSE; default: TRUE|</span><br><span class="line">|echo|Display code along with the output|TRUE, FALSE;default: TRUE|</span><br><span class="line">|warning|Display warning messages|TRUE, FALSE; default: TRUE|</span><br><span class="line">|error|Display errors|TRUE, FALSE; default: FALSE|</span><br><span class="line">|message|Display R messages|TRUE, FALSE; default: TRUE|</span><br><span class="line">|results|Display results|markup, asis, hold, hide; default: markup|</span><br><span class="line">|cache|Cache the results|TRUE, FALSE; default: FALSE|</span><br><span class="line"></span><br><span class="line">#### Using the render function</span><br><span class="line"></span><br><span class="line">In RStudio, document output can be generated using knitr by clicking on the knit button. You can also directly enter a command in the R command line. If you leave out the second argument, then the output specification in the markdown document determines the output format:</span><br><span class="line"></span><br><span class="line">```R</span><br><span class="line">rmarkdown::render(&quot;introduction.Rmd&quot;,&quot;pdf_document&quot;).</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>To create the output in all formats mentioned in the markdown document, use the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rmarkdown::render(<span class="string">"introduction.Rmd"</span>,<span class="string">"all"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Adding-output-options"><a href="#Adding-output-options" class="headerlink" title="Adding output options"></a>Adding output options</h4><p>The following output options can be added:</p>
<ul>
<li>Type of output document to build:<br>output:<code>html_document</code>, output:<code>pdf_document</code>, output:<code>beamer_presentation</code>, output:<code>ioslides_presentation</code>, output:<code>word_document</code></li>
<li>Number the section headings. If the sections are not named, then they are incrementally numbered: <code>number_sections</code> = <code>TRUE</code></li>
<li>The <code>fig_width</code>, <code>fig_height</code> options are the default width and height in inches. figures:<code>fig_width=7</code>, <code>fig_height=5</code></li>
<li>Theme: Visual theme; pass null to use custom CSS</li>
<li>CSS: Include filename</li>
</ul>
<h2 id="Creating-interactive-web-applications-with-shiny"><a href="#Creating-interactive-web-applications-with-shiny" class="headerlink" title="Creating interactive web applications with shiny"></a>Creating interactive web applications with shiny</h2><p>The shiny package helps in building interactive web applications using R. This recipe illustrates the main components of a shiny application through examples.</p>
<h3 id="Getting-ready-59"><a href="#Getting-ready-59" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store them in your R working directory. The code for this chapter contains files in various subfolders (named DummyApp, SimpleApp, TabApp, ConditionalApp, and SingleFileApp). Copy these folders into your R working directory.</p>
<p>Install and load the shiny package as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"shiny"</span>)</span><br></pre></td></tr></table></figure>
<p>Restart RStudio after installing shiny.</p>
<h3 id="How-to-do-it…-60"><a href="#How-to-do-it…-60" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To create interactive web applications with shiny, follow the steps below:</p>
<ol>
<li><p>Get a feel for shiny by examining a dummy application with no functionality. The folder called DummyApp in your R working directory contains the ui.R and server.R files with the following code:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ui.R</span></span><br><span class="line"><span class="keyword">library</span>(shiny)</span><br><span class="line">shinyUI(pageWithSidebar(</span><br><span class="line">   headerPanel(<span class="string">"Dummy Application"</span>),</span><br><span class="line">   sidebarPanel(     h3(<span class="string">'Sidebar text'</span>)   ),</span><br><span class="line">   mainPanel(       h3(<span class="string">'Main Panel text'</span>)   ) ))</span><br><span class="line"></span><br><span class="line"><span class="comment">#server.R</span></span><br><span class="line"><span class="keyword">library</span>(shiny)</span><br><span class="line">shinyServer(<span class="keyword">function</span>(input,output) &#123; &#125; )</span><br></pre></td></tr></table></figure>
<p> Run the application using runApp(“DummyApp”). If you have the files loaded in the code pane in RStudio, click on Run App.</p>
</li>
<li><p>The SimpleApp directory in your R working directory contains the files ui.R and server.R with the following code:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ui.R</span></span><br><span class="line"><span class="keyword">library</span>(shiny)</span><br><span class="line">shinyUI(fluidPage(</span><br><span class="line">  titlePanel(<span class="string">"Simple Shiny Application"</span>),</span><br><span class="line">  sidebarLayout(</span><br><span class="line">    sidebarPanel(</span><br><span class="line">      p(<span class="string">"Create plots using the auto data"</span>),</span><br><span class="line">      selectInput(<span class="string">"x"</span>, <span class="string">"Select X axis"</span>,</span><br><span class="line">      choices = c(<span class="string">"weight"</span>,<span class="string">"cylinders"</span>,<span class="string">"acceleration"</span>))</span><br><span class="line">    ),</span><br><span class="line">    mainPanel(</span><br><span class="line">          h4(textOutput(<span class="string">"outputString"</span>)),</span><br><span class="line">         plotOutput(<span class="string">"autoplot"</span>))   )</span><br><span class="line">  ))</span><br><span class="line">))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># server.R</span></span><br><span class="line">auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br><span class="line">shinyServer(<span class="keyword">function</span>(input, output) &#123;</span><br><span class="line">     output$outputString &lt;- renderText(paste(<span class="string">"mpg ~"</span>,</span><br><span class="line">        input$x))</span><br><span class="line">    output$autoplot &lt;- renderPlot(</span><br><span class="line">        plot(as.formula(paste(<span class="string">"mpg ~"</span>,input$x)),data=auto))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Enter the runApp(“SimpleApp”) command or, if the preceding files are loaded in the code pane, click on Run App to run the shiny application in the RStudio environment. The application opens in a separate window. When the application is running, RStudio cannot execute any command. Either close the application window, or press the Esc key in RStudio to exit the application.</p>
</li>
</ol>
<h3 id="How-it-works…-56"><a href="#How-it-works…-56" class="headerlink" title="How it works…"></a>How it works…</h3><p>A shiny application typically includes a folder with the ui.R and server.R files. The code in ui.R controls the user interface, and server.R controls the data that the application renders on the user interface as well as how the application responds to user actions on the interface.</p>
<p>In step 1, the dummy application presents a simple static user interface with no scope for user interaction.</p>
<p>The shinyUI function of ui.R constructs the user interface. In DummyApp, the function constructs the user interface with three static elements. It uses the pageWithSidebar function to create a page with static text in headerPanel, sidebarPanel, and mainPanel.</p>
<p>The shinyServer function in the server.R file controls how the application responds to user actions. This function represents the listeners on the server side. For every user action, the shinyServer function gets the relevant values from the user interface. The relevant parts of the server’s listener get executed and send the output back to the user interface, which then updates the screen with the new values. The reactivity of the shiny package is explained as follows. Since DummyApp has no elements with which a user can actually interact and also has an empty shinyServer function, it cannot respond to user actions.</p>
<p>Step 2 builds a simple application in the SimpleApp folder. This application showcases the elements of a reactive application—one where the application truly reacts to user actions on the user interface. shiny has functions to generate static html as well as html code for user interface widgets, such as buttons, checkboxes, and drop-down lists, among others. The ui.R file in SimpleApp shows the use of the p function to add an HTML paragraph, the selectInput function to create a drop-down listbox, the textOutput and h4 function to create a level 4 heading text, and the plotOutput function to plot the output image from the server.</p>
<p>shiny has several layout options to customize the look and feel of the user interface. In this recipe, we used fluidPage with three panels: titlePanel, sidebarPanel, and mainPanel.</p>
<p>shiny uses reactive-programming. A user input—such as the user entering text, selecting an item from a list, or clicking on a button—is a reactive source. A server output, such as a plot or data table, is a reactive endpoint that appears on the user’s browser window. Whenever a reactive source changes, the reactive end point that uses the source is notified to re-execute. In this recipe, both renderText and renderPlot are reactive. renderText depends on input x, which means that renderText() is executed each time the user selects a different x. renderPlot depends on both x and the color and hence any change to either of these two input values causes renderPlot to be invoked.</p>
<p>When you run the application, the preceding statements shinyServer(function(input, output) in server.R are executed just once during the first application load. After this, only the relevant portions of the listener function execute for each change in the user interface.</p>
<p>We loaded the auto-mpg.csv data file here once for the application. We typically load packages, data, and dependent R source files once during the initial load of the application.</p>
<h3 id="There’s-more…-33"><a href="#There’s-more…-33" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>For a complete tutorial on shiny, refer to <a href="http://shiny.rstudio.com/tutorial" target="_blank" rel="external">http://shiny.rstudio.com/tutorial</a>. We provide a few key additions relating to building shiny web applications here.</p>
<h4 id="Adding-images"><a href="#Adding-images" class="headerlink" title="Adding images"></a>Adding images</h4><p>To add images in the user interface, save the image file in the www directory under the application folder. Include the saved image file in ui.R with height and width in pixels as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img(src = <span class="string">"myappimage.png"</span>, height = <span class="number">72</span>, width = <span class="number">72</span>)</span><br></pre></td></tr></table></figure>
<p>The css, javascript, and jquery files are all stored in the www folder.</p>
<h4 id="Adding-HTML"><a href="#Adding-HTML" class="headerlink" title="Adding HTML"></a>Adding HTML</h4><p>shiny provides R functions for several HTML markup tags. We have seen a sample of the R function h3(“text here”) in our first dummy application. Similarly, there are R functions such as p(), h1() to include paragraph, header 1, and so on, in a shiny application.</p>
<h4 id="Adding-tab-sets"><a href="#Adding-tab-sets" class="headerlink" title="Adding tab sets"></a>Adding tab sets</h4><p>Tabs are created by the tabPanel() function and each tab can hold its own output UI components. The TabApp folder has the ui.R and server.R files for a tabbed user interface. We give the main excerpts from each in the following code:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Excerpt from ui.R</span></span><br><span class="line">mainPanel(</span><br><span class="line">      tabsetPanel(</span><br><span class="line">        tabPanel(<span class="string">"Plot"</span>, textOutput(<span class="string">"outputString"</span>),</span><br><span class="line">                 plotOutput(<span class="string">"plot"</span>)),</span><br><span class="line">        tabPanel(<span class="string">"Summary"</span>, verbatimTextOutput(<span class="string">"summary"</span>)),</span><br><span class="line">        tabPanel(<span class="string">"Table"</span>, tableOutput(<span class="string">"table"</span>)),</span><br><span class="line">        tabPanel(<span class="string">"DataTable"</span>, dataTableOutput(<span class="string">"datatable"</span>))</span><br><span class="line">      )</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>Add functionality in server.R to get the summary, table, and the data.table output:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># Excerpt from server.R to generate a summary of the data</span></span><br><span class="line">  output$summary &lt;- renderPrint(&#123;</span><br><span class="line">    summary(auto)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Generate an HTML table view of the data</span></span><br><span class="line">  output$table &lt;- renderTable(&#123;</span><br><span class="line">    data.frame(x=auto)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Generate an HTML table view of the data</span></span><br><span class="line">  output$datatable &lt;- renderDataTable(&#123;</span><br><span class="line">    auto</span><br><span class="line">  &#125;, options = list(aLengthMenu = c(<span class="number">5</span>, <span class="number">25</span>, <span class="number">50</span>), iDisplayLength = <span class="number">5</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>The options argument in renderDataTable expects a list. The preceding code specifies the items in the list and the number of items to display in the drop-down box.</p>
<p>Run the application with runApp(“TabApp”) to see the tabs and tab contents. If not all items are visible in the “table” tab, increase the size of the browser window.</p>
<h4 id="Adding-a-dynamic-UI"><a href="#Adding-a-dynamic-UI" class="headerlink" title="Adding a dynamic UI"></a>Adding a dynamic UI</h4><p>You can create dynamic user interfaces in two different ways: using conditionalPanel or renderUI. We show an example of each in this section.</p>
<p>We use conditionalPanel to show or hide a UI component based on a condition. In this sample, we draw a histogram or scatterplot of mpg based on user selection. For the scatterplot, we fix mpg on the y axis and allow the user to pick a variable for the x axis. Hence, we need to show the list of possible variables for the x axis only when the user chooses the scatterplot option. In ui.R, we check for the condition with input.plotType != ‘hist’ and then display the list of choices to the user:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sidebarPanel(</span><br><span class="line">  selectInput(<span class="string">"plotType"</span>, <span class="string">"Plot Type"</span>,</span><br><span class="line">    c(<span class="string">"Scatter plot"</span> = <span class="string">"scatter"</span>, Histogram = <span class="string">"hist"</span>)),</span><br><span class="line">conditionalPanel(condition=<span class="string">"input.plotType != 'hist'"</span>,</span><br><span class="line">  selectInput(<span class="string">"xaxis"</span>,<span class="string">"X Axis Variable"</span>,</span><br><span class="line">     choices = c(Weight=<span class="string">"wt"</span>, Cylinders=<span class="string">"cyl"</span>, <span class="string">"Horse Power"</span>=<span class="string">"hp"</span>))</span><br><span class="line"> )),</span><br><span class="line">mainPanel( plotOutput(<span class="string">"plot"</span>))</span><br></pre></td></tr></table></figure>
<p>To check how conditionalPanel works, execute runApp(“conditionalApp”) in your R environment and select the plot type. You will see “X Axis Variable” only when you choose scatter plot. In the case of conditionalPanel, the entire work is done in ui.R and is executed by the client.</p>
<p>In the preceding example, we had a fixed set of choices for the variables and hence we could build selectInput with these choices. What if this list is not known and is dependent on the user’s selection of a dataset? The application in the renderUIApp folder illustrates this. In this application, the server builds the list of variable names dynamically based on the dataset chosen.</p>
<p>In the UI component, we need a placeholder, uiOutput(“var”), to display the list that will be populated by the server every time a different dataset is chosen in the user interface.</p>
<p>In the server component, we use the renderUI function call to populate output$var using the variable names of the chosen dataset. In this sample, we also use a reactive expression as given here:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">datasetInput &lt;- reactive(&#123;</span><br><span class="line">  <span class="keyword">switch</span>(input$dataset,</span><br><span class="line">    <span class="string">"rock"</span> = rock,</span><br><span class="line">    <span class="string">"mtcars"</span> = mtcars)</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>
<p>A reactive expression reads input and returns an output. It regenerates the output only when the input it depends on changes. Every time it generates the output, it caches the output and uses it until the input changes. The reactive expression can be called from another reactive expression or from a <code>render*</code> function.</p>
<h4 id="Creating-single-file-web-application"><a href="#Creating-single-file-web-application" class="headerlink" title="Creating single file web application"></a>Creating single file web application</h4><p>In R 3.0.0 Version, a shiny application can include just a single app.R file in a separate folder along with any needed data files and dependent R source code files. Create a new SingleFileApp folder and save the downloaded app.R here. Take a look at the downloaded app.R file and start the application by entering the runApp(“SingleFileApp”) command.</p>
<p>In app.R, the shinyApp(ui = ui, server = server) line is executed first by R. This shinyApp function returns an object of class shiny.appobj to the console. When this object is printed, the shiny app is launched in a separate window.</p>
<p>It is possible to create a single-file shiny application without a specific application directory and with a filename other than app.R. There should be a call to the shinyApp function, which is what tells R that it is a shiny application. We can then run print(source(“appfilename”)) to launch the application. The caveat if you run with a different name is that, when you modify the file, the application is not automatically relaunched.</p>
<h2 id="Creating-PDF-presentations-of-your-analysis-with-R-Presentation"><a href="#Creating-PDF-presentations-of-your-analysis-with-R-Presentation" class="headerlink" title="Creating PDF presentations of your analysis with R Presentation"></a>Creating PDF presentations of your analysis with R Presentation</h2><p>Rpres, built into RStudio, enables you to create PDF slide presentations of your data analysis. In this recipe, we develop a small application that showcases the important Rpres features.</p>
<h3 id="Getting-ready-60"><a href="#Getting-ready-60" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the sample-image.png and Introduction.Rpres files in your R working directory.</p>
<h3 id="How-to-do-it…-61"><a href="#How-to-do-it…-61" class="headerlink" title="How to do it…"></a>How to do it…</h3><ol>
<li>Open RStudio.</li>
<li>Create a new R Presentation document using the following steps:</li>
</ol>
<ul>
<li>Navigate to File | New File and click on R Presentation.</li>
<li>Enter the filename as RPresentation and save it in your R working directory.</li>
<li>RStudio creates a file with the extension Rpres. This file includes a default title slide (the very first slide) and a few other sample slides. Creating this file also results in a preview being displayed in the upper right of the RStudio environment.</li>
<li>Fill in author and date and click on Preview.</li>
<li>By default, the preview appears in RStudio itself. However, to see all features properly, drop down the menu on the top right of the tab where the presentation appears and select View in browser.</li>
<li>Click on the arrow button at the bottom right to navigate through the slides.</li>
</ul>
<ol>
<li>Open the R Presentation document that you downloaded earlier:</li>
</ol>
<ul>
<li>Navigate to File | Open File.</li>
<li>Open the Introduction.Rpres file.</li>
</ul>
<ol>
<li><p>To embed an image use the following code:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Slide with image</span><br><span class="line">===============</span><br><span class="line">![Sample Image](sample-image.png)</span><br></pre></td></tr></table></figure>
</li>
<li><p>To create a two-column layout perform the following steps:</p>
</li>
</ol>
<ul>
<li>The two columns are separated by <em>*</em> on a separate line.</li>
<li><p>Add the following slide:</p>
  <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Two Columns</span><br><span class="line">===============</span><br><span class="line">left:<span class="number">40</span>%</span><br><span class="line"></span><br><span class="line">**ColumnOne**</span><br><span class="line">-  this slide has two columns</span><br><span class="line">-   the first column has text</span><br><span class="line">-   the second column has an image</span><br><span class="line"></span><br><span class="line">***</span><br><span class="line">**ColumnTwo**</span><br><span class="line"></span><br><span class="line">![Sample Image](sample-image.png)Two Columns</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li><p>To add a transition to the slides:</p>
<p> Global transition setting:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Introduction</span><br><span class="line">========================================================</span><br><span class="line">author: Shanthi Viswanathan</span><br><span class="line">date: <span class="number">16</span> Dec <span class="number">2014</span></span><br><span class="line">transition:rotate</span><br><span class="line">transition-speed:slow</span><br></pre></td></tr></table></figure>
</li>
<li><p>To add incremental displays:</p>
<p> Add the following in the first slide:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Incremental Display</span><br><span class="line">========================================================</span><br><span class="line">transition: concave</span><br><span class="line">incremental: true</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-57"><a href="#How-it-works…-57" class="headerlink" title="How it works…"></a>How it works…</h3><p>In steps 1 and 2, a simple presentation is created.</p>
<p>In step 3, an R presentation file is opened. When a text is followed by a set of = characters (at least 3 on a line by itself) it is taken as the slide title.</p>
<p>In step 4, an image is added with the standard markdown syntax of the exclamation mark followed in square brackets by the alt text, followed by the image file’s name in parentheses. The image occupies the entire slide if it is the only content on that slide.</p>
<p>In step 5, a two-column slide is created. The two columns are separated by three * characters. This time, the image occupies the entire column into which it is added.</p>
<p>The double asterisks signify a column. By default, the two columns occupy 50% of the slide width. In a two-column layout, each column by default occupies 50% of the slide width. Use left or right to change this. We used left: 40%.</p>
<p>A transition effect can be applied to all slides within a presentation or specifically for each slide. The default transition is linear. To apply to all slides, add it to the title slide as in step 6.</p>
<p>By default, all elements on the slide appear when RPres shows the slide. We can change this by setting incremental = TRUE. With this setting, list items, code blocks, and paragraphs are displayed incrementally with a mouse-click. The first paragraph in a slide is immediately displayed and the increment rule is applied to the subsequent content. In step 7, we see this behavior in the display of bullet points.</p>
<h3 id="There’s-more…-34"><a href="#There’s-more…-34" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We now describe additional options to control the display.</p>
<h4 id="Using-hyperlinks"><a href="#Using-hyperlinks" class="headerlink" title="Using hyperlinks"></a>Using hyperlinks</h4><p>External or internal links can be added to an R presentation. External links use the same R Markdown syntax. For internal links, we first need to add an id to a slide and then create a link using it, as the following code shows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Two Columns</span><br><span class="line">========</span><br><span class="line">id: twocols</span><br><span class="line"></span><br><span class="line">First Slide</span><br><span class="line">========</span><br><span class="line">[Go to Slide](<span class="comment">#/twocols)e</span></span><br></pre></td></tr></table></figure>
<h4 id="Controlling-the-display"><a href="#Controlling-the-display" class="headerlink" title="Controlling the display"></a>Controlling the display</h4><p>The default size of an R presentation is 960 x 700 pixels. However, adding a specific width or height to a slide can change its default size:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Slide with plot</span><br><span class="line">========================================================</span><br><span class="line">title: false</span><br><span class="line">```&#123;r renderplot,echo=FALSE,out.width="1920px"&#125;</span><br><span class="line">plot(cars)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">If the entire plot is not displayed in the slide when viewed in a browser, you can include fig.width and fig.height as follows:</span><br><span class="line"></span><br><span class="line">```R</span><br><span class="line">Slide with plot</span><br><span class="line">========================================================</span><br><span class="line">title: false</span><br><span class="line">```&#123;r renderplot,echo=FALSE, fig.width=8,fig.height=4,</span><br><span class="line">out.width=&quot;1920px&quot;&#125;</span><br><span class="line">plot(cars)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### Enhancing the look of the presentation</span><br><span class="line"></span><br><span class="line">You can set the font in the title slide, after which the font is applied to all the slides. This global font can also be overridden in specific slides:</span><br><span class="line"></span><br><span class="line">```R</span><br><span class="line">Introduction</span><br><span class="line">========================================================</span><br><span class="line">author: Shanthi Viswanathan</span><br><span class="line">date: 16 Dec 2014</span><br><span class="line">font-family: Arial</span><br></pre></td></tr></table></figure>
<p>You can include a .css file in the title slide and use the styles defined in the .css file in the slides as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Introduction</span><br><span class="line">========================================================</span><br><span class="line">author: Shanthi Viswanathan</span><br><span class="line">date: <span class="number">16</span> Dec <span class="number">2014</span></span><br><span class="line">css: custom.css</span><br><span class="line"></span><br><span class="line">Two Columns</span><br><span class="line">===============</span><br><span class="line">class: highlight</span><br><span class="line">left:<span class="number">70</span>%</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Chapter-9-Work-Smarter-Not-Harder-–-Efficient-and-Elegant-R-Code"><a href="#Chapter-9-Work-Smarter-Not-Harder-–-Efficient-and-Elegant-R-Code" class="headerlink" title="Chapter 9. Work Smarter, Not Harder – Efficient and Elegant R Code"></a>Chapter 9. Work Smarter, Not Harder – Efficient and Elegant R Code</h1><p>In this chapter, we will cover recipes for doing the following without explicit iteration:</p>
<ul>
<li>Exploiting vectorized operations</li>
<li>Processing entire rows or columns using the apply function</li>
<li>Applying a function to all elements of a collection with lapply and sapply</li>
<li>Applying functions to subsets of a vector</li>
<li>Using the split-apply-combine strategy with plyr</li>
<li>Slicing, dicing, and combining data with data tables</li>
</ul>
<h2 id="Introduction-8"><a href="#Introduction-8" class="headerlink" title="Introduction"></a>Introduction</h2><p>The R programming language, being procedural, provides looping control structures. Most people will therefore tend to automatically use these control structures in their own code and end up with performance issues because R handles loops very inefficiently. Serious number crunching and handling large datasets in R require us to exploit powerful, alternative ways to write succinct, elegant, and efficient code as follows:</p>
<ul>
<li>Vectorized operations process collections as a whole instead of operating element by element</li>
<li>The apply family of functions processes rows, columns, or lists as a whole without the need for explicit iteration</li>
<li>The plyr package provides a wide range of **ply functions with additional functionality, including parallel processing</li>
<li>The data.table package provides helpful functions to manipulate data easily and efficiently</li>
</ul>
<p>This chapter provides recipes using all of these features.</p>
<h2 id="Exploiting-vectorized-operations"><a href="#Exploiting-vectorized-operations" class="headerlink" title="Exploiting vectorized operations"></a>Exploiting vectorized operations</h2><p>Some R functions can operate on vectors as a whole. The function can either be a built-in R function or a custom function. In your own code, before you resort to a loop to process all elements of a vector, see whether you can exploit an existing vectorized function.</p>
<h3 id="Getting-ready-61"><a href="#Getting-ready-61" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and ensure that the auto-mpg.csv file is in your R working directory.</p>
<h3 id="How-to-do-it…-62"><a href="#How-to-do-it…-62" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To exploit vectorized operations follow these steps:</p>
<ol>
<li><p>Operate on all elements of vector(s) without explicit iteration (vectorized operations):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; first.name &lt;- c(<span class="string">"John"</span>, <span class="string">"Jane"</span>, <span class="string">"Tom"</span>, <span class="string">"Zach"</span>)</span><br><span class="line">&gt; last.name &lt;- c(<span class="string">"Doe"</span>, <span class="string">"Smith"</span>, <span class="string">"Glock"</span>, <span class="string">"Green"</span>)</span><br><span class="line">&gt; <span class="comment"># The paste function below operates on vectors</span></span><br><span class="line">&gt; paste(first.name,last.name)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"John Doe"</span>   <span class="string">"Jane Smith"</span> <span class="string">"Tom Glock"</span>  <span class="string">"Zach Green"</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># This works even with different sized vectors</span></span><br><span class="line">&gt; new.last.name &lt;- c(<span class="string">"Dalton"</span>)</span><br><span class="line">&gt; paste(first.name,new.last.name)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"John Dalton"</span>   <span class="string">"Jane Dalton"</span>  <span class="string">"Tom Dalton"</span>  <span class="string">"Zach Dalton"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Use vectorized operations within your own functions:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; username &lt;- <span class="keyword">function</span>(first, last) &#123;</span><br><span class="line">   tolower(paste0(last, substr(first,<span class="number">1</span>,<span class="number">1</span>)))</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&gt; username(first.name,last.name)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"doej"</span>   <span class="string">"smithj"</span>  <span class="string">"glockt"</span> <span class="string">"greenz"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Apply an arithmetic operation implicitly on all elements of a vector:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>)</span><br><span class="line">&gt; auto$kmpg &lt;- auto$mpg*<span class="number">1.6</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-58"><a href="#How-it-works…-58" class="headerlink" title="How it works…"></a>How it works…</h3><p>By operating on entire vectors at a time, vectorized operations eliminate the need for explicit loops. R processes loops inefficiently because it interprets the statements in a loop over and over again. Thus, loops with much iteration tend to perform poorly. Vectorized operations help us to get around this bottleneck, while at the same time making our code compact and more elegant.</p>
<p>Several built-in functions are vectorized and step 1 illustrates this with the paste function that concatenates strings.</p>
<p>The later part of step 1 shows that, if the vectors have unequal length, then the shorter vector recycles the list of vectors as needed. The new.last.name vector of size 1 repeats itself to match the size of the first.name vector. Hence, the last name Dalton is pasted to each element of first.name.</p>
<p>Vector operations work for built-in functions, custom functions, and arithmetic operations. A custom function to generate usernames using the two vectors first.name and last.name is seen in step 3.</p>
<p>Vector operations work even when we combine vectors and scalars in arithmetic operations. A new variable is created in step 4 in the auto data frame to represent fuel efficiency in kilometers per gallon (kmpg) using a simple formula combining a vector and a scalar.</p>
<h3 id="There’s-more…-35"><a href="#There’s-more…-35" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>R functions such as sum, min, max, range, and prod combine their arguments into vectors:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; sum(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">15</span></span><br></pre></td></tr></table></figure>
<p>On the contrary, beware of functions such as mean and median that do not combine arguments into vectors and yield misleading results:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; mean(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">1</span></span><br><span class="line">&gt; mean(c(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h2 id="Processing-entire-rows-or-columns-using-the-apply-function"><a href="#Processing-entire-rows-or-columns-using-the-apply-function" class="headerlink" title="Processing entire rows or columns using the apply function"></a>Processing entire rows or columns using the apply function</h2><p>The apply function can apply a user-specified function to all rows or columns of a matrix and return an appropriate collection with the results.</p>
<h3 id="Getting-ready-62"><a href="#Getting-ready-62" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>This recipe uses no external objects or resources.</p>
<h3 id="How-to-do-it…-63"><a href="#How-to-do-it…-63" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To process entire rows or columns using the apply function, follow these steps:</p>
<ol>
<li><p>Calculate row minimums for a matrix:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; m &lt;- matrix(seq(<span class="number">1</span>,<span class="number">16</span>), <span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line">&gt; m</span><br><span class="line"></span><br><span class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,]    <span class="number">1</span>    <span class="number">5</span>    <span class="number">9</span>   <span class="number">13</span></span><br><span class="line">[<span class="number">2</span>,]    <span class="number">2</span>    <span class="number">6</span>   <span class="number">10</span>   <span class="number">14</span></span><br><span class="line">[<span class="number">3</span>,]    <span class="number">3</span>    <span class="number">7</span>   <span class="number">11</span>   <span class="number">15</span></span><br><span class="line">[<span class="number">4</span>,]    <span class="number">4</span>    <span class="number">8</span>   <span class="number">12</span>   <span class="number">16</span></span><br><span class="line"></span><br><span class="line">&gt; apply(m, <span class="number">1</span>, min)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Calculate column maximums for a matrix:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; apply(m, <span class="number">2</span>, max)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>]  <span class="number">4</span>  <span class="number">8</span> <span class="number">12</span> <span class="number">16</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a new matrix by squaring every element of a given matrix:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; apply(m,c(<span class="number">1</span>,<span class="number">2</span>),<span class="keyword">function</span>(x) x^<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,]    <span class="number">1</span>   <span class="number">25</span>   <span class="number">81</span>  <span class="number">169</span></span><br><span class="line">[<span class="number">2</span>,]    <span class="number">4</span>   <span class="number">36</span>  <span class="number">100</span>  <span class="number">196</span></span><br><span class="line">[<span class="number">3</span>,]    <span class="number">9</span>   <span class="number">49</span>  <span class="number">121</span>  <span class="number">225</span></span><br><span class="line">[<span class="number">4</span>,]   <span class="number">16</span>   <span class="number">64</span>  <span class="number">144</span>  <span class="number">256</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Apply a function to every row and pass an argument to the function:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; apply(m, <span class="number">1</span>, quantile, probs=c(<span class="number">.4</span>,<span class="number">.8</span>))</span><br><span class="line">    [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line"><span class="number">40</span>%  <span class="number">5.8</span>  <span class="number">6.8</span>  <span class="number">7.8</span>  <span class="number">8.8</span></span><br><span class="line"><span class="number">80</span>% <span class="number">10.6</span> <span class="number">11.6</span> <span class="number">12.6</span> <span class="number">13.6</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-59"><a href="#How-it-works…-59" class="headerlink" title="How it works…"></a>How it works…</h3><p>Step 1 creates a matrix and generates the row minimums for it.</p>
<ul>
<li>The first argument for apply is a matrix or array.</li>
<li>The second argument (called the margin) specifies how we want to split the matrix or array into pieces. For a two-dimensional structure, we can operate on rows as 1, columns as 2, or elements as c(1,2). For matrices of more than two dimensions, margin can be more than two and specifies the dimension(s) of interest (see the There’s more… section).</li>
<li>The third argument is a function—built-in or custom. In fact, we can even specify an unnamed function in-line as step 3 shows.</li>
</ul>
<p>The apply function invokes the specified function with each row, column, or element of the matrix depending on the second argument.</p>
<p>The return value from apply depends on margin and the type of return value from the user-specified function.</p>
<p>If we supply more than three arguments to apply, it passes these along to the specified function. The probs argument in step 4 serves as an example. In step 4, apply passes along the probs vector to the quantile function.</p>
<p><strong>Tip</strong></p>
<p>To calculate row/column means or sums for a matrix, use the highly optimized colMeans, rowMeans, colSums, and rowSums functions instead of apply.</p>
<h3 id="There’s-more…-36"><a href="#There’s-more…-36" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The apply function can use an array of any dimension as input. Also, you can use apply on a data frame after converting it into a matrix using as.matrix.</p>
<h4 id="Using-apply-on-a-three-dimensional-array"><a href="#Using-apply-on-a-three-dimensional-array" class="headerlink" title="Using apply on a three-dimensional array"></a>Using apply on a three-dimensional array</h4><ol>
<li><p>Create a three-dimensional array:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; array.3d &lt;- array( seq(<span class="number">100</span>,<span class="number">69</span>), dim = c(<span class="number">4</span>,<span class="number">4</span>,<span class="number">2</span>))</span><br><span class="line">&gt; array.3d</span><br><span class="line"></span><br><span class="line">, , <span class="number">1</span></span><br><span class="line"></span><br><span class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,]  <span class="number">100</span>   <span class="number">96</span>   <span class="number">92</span>   <span class="number">88</span></span><br><span class="line">[<span class="number">2</span>,]   <span class="number">99</span>   <span class="number">95</span>   <span class="number">91</span>   <span class="number">87</span></span><br><span class="line">[<span class="number">3</span>,]   <span class="number">98</span>   <span class="number">94</span>   <span class="number">90</span>   <span class="number">86</span></span><br><span class="line">[<span class="number">4</span>,]   <span class="number">97</span>   <span class="number">93</span>   <span class="number">89</span>   <span class="number">85</span></span><br><span class="line"></span><br><span class="line">, , <span class="number">2</span></span><br><span class="line"></span><br><span class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,]   <span class="number">84</span>   <span class="number">80</span>   <span class="number">76</span>   <span class="number">72</span></span><br><span class="line">[<span class="number">2</span>,]   <span class="number">83</span>   <span class="number">79</span>   <span class="number">75</span>   <span class="number">71</span></span><br><span class="line">[<span class="number">3</span>,]   <span class="number">82</span>   <span class="number">78</span>   <span class="number">74</span>   <span class="number">70</span></span><br><span class="line">[<span class="number">4</span>,]   <span class="number">81</span>   <span class="number">77</span>   <span class="number">73</span>   <span class="number">69</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Calculate the sum across the first and second dimensions. We get a one-dimensional array with two elements:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; apply(array.3d, <span class="number">3</span>, sum)</span><br><span class="line">[<span class="number">1</span>] <span class="number">1480</span> <span class="number">1224</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="comment"># verify</span></span><br><span class="line">&gt; sum(<span class="number">85</span>:<span class="number">100</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="number">1480</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Calculate the sum across the third dimension. We get a two-dimensional array:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; apply(array.3d,c(<span class="number">1</span>,<span class="number">2</span>),sum)</span><br><span class="line">     [,<span class="number">1</span>] [,<span class="number">2</span>] [,<span class="number">3</span>] [,<span class="number">4</span>]</span><br><span class="line">[<span class="number">1</span>,]  <span class="number">184</span>  <span class="number">176</span>  <span class="number">168</span>  <span class="number">160</span></span><br><span class="line">[<span class="number">2</span>,]  <span class="number">182</span>  <span class="number">174</span>  <span class="number">166</span>  <span class="number">158</span></span><br><span class="line">[<span class="number">3</span>,]  <span class="number">180</span>  <span class="number">172</span>  <span class="number">164</span>  <span class="number">156</span></span><br><span class="line">[<span class="number">4</span>,]  <span class="number">178</span>  <span class="number">170</span>  <span class="number">162</span>  <span class="number">154</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Applying-a-function-to-all-elements-of-a-collection-with-lapply-and-sapply"><a href="#Applying-a-function-to-all-elements-of-a-collection-with-lapply-and-sapply" class="headerlink" title="Applying a function to all elements of a collection with lapply and sapply"></a>Applying a function to all elements of a collection with lapply and sapply</h2><p>The lapply function works on objects of type vector, list, or data frame. It applies a user-specified function to each element of the passed-in object and returns a list of the results.</p>
<h3 id="Getting-ready-63"><a href="#Getting-ready-63" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the auto-mpg.csv file in your R working directory. Read the data:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(&quot;auto-mpg.csv&quot;, stringsAsFactors=FALSE)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-64"><a href="#How-to-do-it…-64" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To apply a function to all elements of a collection with lapply and sapply, follow these instructions:</p>
<ol>
<li><p>Operate on a simple vector:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; lapply(c(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>), sqrt)</span><br><span class="line"></span><br><span class="line">[[<span class="number">1</span>]]</span><br><span class="line">[<span class="number">1</span>] <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[[<span class="number">2</span>]]</span><br><span class="line">[<span class="number">1</span>] <span class="number">1.414214</span></span><br><span class="line"></span><br><span class="line">[[<span class="number">3</span>]]</span><br><span class="line">[<span class="number">1</span>] <span class="number">1.732051</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Use lapply and sapply to calculate the means of a list of collections:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; x &lt;- list(a = <span class="number">1</span>:<span class="number">10</span>, b = c(<span class="number">1</span>,<span class="number">10</span>,<span class="number">100</span>,<span class="number">1000</span>), c=seq(<span class="number">5</span>,<span class="number">50</span>,by=<span class="number">5</span>))</span><br><span class="line">&gt; lapply(x, mean)</span><br><span class="line"></span><br><span class="line">$a</span><br><span class="line">[<span class="number">1</span>] <span class="number">5.5</span></span><br><span class="line">$b</span><br><span class="line">[<span class="number">1</span>] <span class="number">277.75</span></span><br><span class="line">$c</span><br><span class="line">[<span class="number">1</span>] <span class="number">27.5</span></span><br><span class="line"></span><br><span class="line">&gt; class(lapply(x,mean))</span><br><span class="line">[<span class="number">1</span>] <span class="string">"list"</span></span><br><span class="line"></span><br><span class="line">&gt; sapply(x, mean)</span><br><span class="line"></span><br><span class="line">     a      b      c</span><br><span class="line">  <span class="number">5.50</span> <span class="number">277.75</span>  <span class="number">27.50</span></span><br><span class="line"></span><br><span class="line">&gt; class(sapply(x,mean))</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"numeric"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Calculate the minimum value for each variable in the auto data frame:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; sapply(auto[,<span class="number">2</span>:<span class="number">8</span>], min)</span><br><span class="line">         mpg    cylinders displacement   horsepower</span><br><span class="line">           <span class="number">9</span>            <span class="number">3</span>           <span class="number">68</span>           <span class="number">46</span></span><br><span class="line">      weight acceleration   model_year</span><br><span class="line">        <span class="number">1613</span>            <span class="number">8</span>           <span class="number">70</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-60"><a href="#How-it-works…-60" class="headerlink" title="How it works…"></a>How it works…</h3><p>The lapply function accepts three arguments—the first argument is the object, the second is the user-specified function, and the optional third argument specifies the additional arguments to the user-specified function. The lapply function always returns a list irrespective of the type of the first argument.</p>
<p>In step 1, the lapply function is used to apply sqrt to each element of a vector. The lapply function always returns a list.</p>
<p>In step 2, a list with three elements is involved, each of which is a vector. It calculates the mean of these vectors. The lapply function returns a list, whereas sapply returns a vector in this case.</p>
<p>In step 3, sapply is used to apply a function to columns of a data frame. For obvious reasons, we pass only the numeric columns.</p>
<h3 id="There’s-more…-37"><a href="#There’s-more…-37" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The sapply function returns a vector if every element of the result is of length 1. If every element of the result list is a vector of the same length, then sapply returns a matrix. However, if we specify simplify=F, then sapply always returns a list. The default is simplify=T. See the following:</p>
<h4 id="Dynamic-output"><a href="#Dynamic-output" class="headerlink" title="Dynamic output"></a>Dynamic output</h4><p>In the next two examples, sapply returns a matrix. If the function that it executes has row and column names defined, then sapply uses these for the matrix:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; sapply(auto[,<span class="number">2</span>:<span class="number">6</span>], summary)</span><br><span class="line"></span><br><span class="line">              mpg cylinders displacement horsepower weight</span><br><span class="line">    Min.     <span class="number">9.00</span>     <span class="number">3.000</span>         <span class="number">68.0</span>       <span class="number">46.0</span>   <span class="number">1613</span></span><br><span class="line">    1st Qu. <span class="number">17.50</span>     <span class="number">4.000</span>        <span class="number">104.2</span>       <span class="number">76.0</span>   <span class="number">2224</span></span><br><span class="line">    Median  <span class="number">23.00</span>     <span class="number">4.000</span>        <span class="number">148.5</span>       <span class="number">92.0</span>   <span class="number">2804</span></span><br><span class="line">    Mean    <span class="number">23.51</span>     <span class="number">5.455</span>        <span class="number">193.4</span>      <span class="number">104.1</span>   <span class="number">2970</span></span><br><span class="line">    3rd Qu. <span class="number">29.00</span>     <span class="number">8.000</span>        <span class="number">262.0</span>      <span class="number">125.0</span>   <span class="number">3608</span></span><br><span class="line">    Max.    <span class="number">46.60</span>     <span class="number">8.000</span>        <span class="number">455.0</span>      <span class="number">230.0</span>   <span class="number">5140</span></span><br><span class="line"></span><br><span class="line">    &gt; sapply(auto[,<span class="number">2</span>:<span class="number">6</span>], range)</span><br><span class="line"></span><br><span class="line">          mpg cylinders displacement horsepower weight</span><br><span class="line">    [<span class="number">1</span>,]  <span class="number">9.0</span>         <span class="number">3</span>           <span class="number">68</span>         <span class="number">46</span>   <span class="number">1613</span></span><br><span class="line">    [<span class="number">2</span>,] <span class="number">46.6</span>         <span class="number">8</span>          <span class="number">455</span>        <span class="number">230</span>   <span class="number">5140</span></span><br></pre></td></tr></table></figure>
<h4 id="One-caution"><a href="#One-caution" class="headerlink" title="One caution"></a>One caution</h4><p>As we mentioned earlier, the output type of sapply depends on the input object. However, because of how R operates with data frames, it is possible to get an “unexpected” output:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; sapply(auto[,<span class="number">2</span>:<span class="number">6</span>], min)</span><br><span class="line"></span><br><span class="line">         mpg    cylinders displacement   horsepower       weight</span><br><span class="line">           <span class="number">9</span>            <span class="number">3</span>           <span class="number">68</span>           <span class="number">46</span>         <span class="number">1613</span></span><br></pre></td></tr></table></figure>
<p>In the preceding example, auto[,2:6] returns a data frame and hence the input to sapply is a data frame object. Each variable (or column) of the data frame is passed as an input to the min function, and we get the output as a vector with column names taken from the input object. Try this:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; sapply(auto[,<span class="number">2</span>], min)</span><br><span class="line"></span><br><span class="line">  [<span class="number">1</span>] <span class="number">28.0</span> <span class="number">19.0</span> <span class="number">36.0</span> <span class="number">28.0</span> <span class="number">21.0</span> <span class="number">23.0</span> <span class="number">15.5</span> <span class="number">32.9</span> <span class="number">16.0</span> <span class="number">13.0</span> <span class="number">12.0</span> <span class="number">30.7</span></span><br><span class="line"> [<span class="number">13</span>] <span class="number">13.0</span> <span class="number">27.9</span> <span class="number">13.0</span> <span class="number">23.8</span> <span class="number">29.0</span> <span class="number">14.0</span> <span class="number">14.0</span> <span class="number">29.0</span> <span class="number">20.5</span> <span class="number">26.6</span> <span class="number">20.0</span> <span class="number">20.0</span></span><br><span class="line"> [<span class="number">25</span>] <span class="number">26.4</span> <span class="number">16.0</span> <span class="number">40.8</span> <span class="number">15.0</span> <span class="number">18.0</span> <span class="number">35.0</span> <span class="number">26.5</span> <span class="number">13.0</span> <span class="number">25.8</span> <span class="number">39.1</span> <span class="number">25.0</span> <span class="number">14.0</span></span><br><span class="line"> [<span class="number">37</span>] <span class="number">19.4</span> <span class="number">30.0</span> <span class="number">32.0</span> <span class="number">26.0</span> <span class="number">20.6</span> <span class="number">17.5</span> <span class="number">18.0</span> <span class="number">14.0</span> <span class="number">27.0</span> <span class="number">25.1</span> <span class="number">14.0</span> <span class="number">19.1</span></span><br><span class="line"> [<span class="number">49</span>] <span class="number">17.0</span> <span class="number">23.5</span> <span class="number">21.5</span> <span class="number">19.0</span> <span class="number">22.0</span> <span class="number">19.4</span> <span class="number">20.0</span> <span class="number">32.0</span> <span class="number">30.9</span> <span class="number">29.0</span> <span class="number">14.0</span> <span class="number">14.0</span></span><br><span class="line"> [<span class="number">61</span>] ……..</span><br></pre></td></tr></table></figure>
<p>This happened because R treats auto[,2:6] as a data frame, but auto[,2] as just a vector. Hence, in the former case sapply operated on each column separately and in the latter case it operated on each element of a vector.</p>
<p>We can fix the preceding code by coercing the auto[,2] vector to a data frame and then pass this data frame object as an input to the min function:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; sapply(as.data.frame(auto[,<span class="number">2</span>]), min)</span><br><span class="line">auto[, <span class="number">2</span>]</span><br><span class="line">        <span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>In the following example, we add simplify=F to force the return value to a list:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; sapply(as.data.frame(auto[,<span class="number">2</span>]), min, simplify=<span class="literal">F</span>)</span><br><span class="line">$`auto[, 2]`</span><br><span class="line">[<span class="number">1</span>] <span class="number">9</span></span><br></pre></td></tr></table></figure>
<h2 id="Applying-functions-to-subsets-of-a-vector"><a href="#Applying-functions-to-subsets-of-a-vector" class="headerlink" title="Applying functions to subsets of a vector"></a>Applying functions to subsets of a vector</h2><p>The tapply function applies a function to each partition of the dataset. Hence, when we need to evaluate a function over subsets of a vector defined by a factor, tapply comes in handy.</p>
<h3 id="Getting-ready-64"><a href="#Getting-ready-64" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the auto-mpg.csv file in your R working directory. Read the data and create factors for the cylinders variable:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; auto$cylinders &lt;- factor(auto$cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-65"><a href="#How-to-do-it…-65" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To apply functions to subsets of a vector, follow these steps:</p>
<ol>
<li><p>Calculate mean mpg for each cylinder type:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; tapply(auto$mpg,auto$cylinders,mean)</span><br><span class="line"></span><br><span class="line">    3cyl     4cyl     5cyl     6cyl     8cyl</span><br><span class="line"><span class="number">20.55000</span> <span class="number">29.28676</span> <span class="number">27.36667</span> <span class="number">19.98571</span> <span class="number">14.96311</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>We can even specify multiple factors as a list. The following example shows only one factor since the out file has only one, but it serves as a template that you can adapt:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; tapply(auto$mpg,list(cyl=auto$cylinders),mean)</span><br><span class="line"></span><br><span class="line">cyl</span><br><span class="line">    3cyl     4cyl     5cyl     6cyl     8cyl</span><br><span class="line"><span class="number">20.55000</span> <span class="number">29.28676</span> <span class="number">27.36667</span> <span class="number">19.98571</span> <span class="number">14.96311</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-61"><a href="#How-it-works…-61" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the mean function is applied to the auto$mpg vector grouped according to the auto$cylinders vector. The grouping factor should be of the same length as the input vector so that each element of the first vector can be associated with a group.</p>
<p>The tapply function creates groups of the first argument based on each element’s group affiliation as defined by the second argument and passes each group to the user-specified function.</p>
<p>Step 2 shows that we can actually group by several factors specified as a list. In this case, tapply applies the function to each unique combination of the specified factors.</p>
<h3 id="There’s-more…-38"><a href="#There’s-more…-38" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The by function is similar to tapply and applies the function to a group of rows in a dataset, but by passing in the entire data frame. The following examples clarify this.</p>
<h4 id="Applying-a-function-on-groups-from-a-data-frame"><a href="#Applying-a-function-on-groups-from-a-data-frame" class="headerlink" title="Applying a function on groups from a data frame"></a>Applying a function on groups from a data frame</h4><p>In the following example, we find the correlation between mpg and weight for each cylinder type:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; by(auto, auto$cylinders, <span class="keyword">function</span>(x) cor(x$mpg, x$weight))</span><br><span class="line">auto$cylinders: 3cyl</span><br><span class="line">[<span class="number">1</span>] <span class="number">0.6191685</span></span><br><span class="line">---------------------------------------------------</span><br><span class="line">auto$cylinders: 4cyl</span><br><span class="line">[<span class="number">1</span>] -<span class="number">0.5430774</span></span><br><span class="line">---------------------------------------------------</span><br><span class="line">auto$cylinders: 5cyl</span><br><span class="line">[<span class="number">1</span>] -<span class="number">0.04750808</span></span><br><span class="line">---------------------------------------------------</span><br><span class="line">auto$cylinders: 6cyl</span><br><span class="line">[<span class="number">1</span>] -<span class="number">0.4634435</span></span><br><span class="line">---------------------------------------------------</span><br><span class="line">auto$cylinders: 8cyl</span><br><span class="line">[<span class="number">1</span>] -<span class="number">0.5569099</span></span><br></pre></td></tr></table></figure>
<h2 id="Using-the-split-apply-combine-strategy-with-plyr"><a href="#Using-the-split-apply-combine-strategy-with-plyr" class="headerlink" title="Using the split-apply-combine strategy with plyr"></a>Using the split-apply-combine strategy with plyr</h2><p>Many data analysis tasks involve first splitting the data into subsets, applying some operation on each subset, and then combining the results suitably. A common wrinkle in applying this happens to be the numerous possible combinations of input and output object types. The plyr package provides simple functions to apply this pattern while simplifying the specification of the object types through systematic naming of the functions.</p>
<p>A plyr function name has three parts:</p>
<ul>
<li>The first letter represents the input object type</li>
<li>The second letter represents the output object type</li>
<li>The third to fifth letters are always ply</li>
</ul>
<p>In the plyr function names, d represents a data frame, l represents a list, and a represents an array. For example, ddply has its input and output as data frames, and ldply takes a list input and produces a data frame as output. Sometimes, we apply functions only for their side effects (such as plots) and do not want the output objects at all. In such cases, we can use _ for the second part. Therefore, d_ply()takes a data frame as input and produces no output—only the side effects of the function application occur.</p>
<h3 id="Getting-ready-65"><a href="#Getting-ready-65" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the auto-mpg.csv file in your R working directory. Read the data and create factors for auto$cylinders:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; auto$cylinders &lt;- factor(auto$cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br></pre></td></tr></table></figure>
<p>Install the plyr package in your R environment if you do not have it already. This can be done using the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"plyr"</span>)</span><br><span class="line">&gt; <span class="keyword">library</span>(plyr)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-66"><a href="#How-to-do-it…-66" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To use the split-apply-combine strategy for data analysis with plyr follow these steps:</p>
<ol>
<li><p>Calculate mean mpg for each cylinder type (two versions):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; ddply(auto, <span class="string">"cylinders"</span>, <span class="keyword">function</span>(df) mean(df$mpg))</span><br><span class="line">&gt; ddply(auto, ~ cylinders, <span class="keyword">function</span>(df) mean(df$mpg))</span><br><span class="line">cylinders       V1</span><br><span class="line"><span class="number">1</span>      3cyl <span class="number">20.55000</span></span><br><span class="line"><span class="number">2</span>      4cyl <span class="number">29.28676</span></span><br><span class="line"><span class="number">3</span>      5cyl <span class="number">27.36667</span></span><br><span class="line"><span class="number">4</span>      6cyl <span class="number">19.98571</span></span><br><span class="line"><span class="number">5</span>      8cyl <span class="number">14.96311</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Calculate the mean, minimum, and maximum mpg for each cylinder type and model year:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&gt; ddply(auto, c(<span class="string">"cylinders"</span>,<span class="string">"model_year"</span>), <span class="keyword">function</span>(df) c(mean=mean(df$mpg), min=min(df$mpg), max=max(df$mpg)))</span><br><span class="line">&gt; ddply(auto, ~ cylinders + model_year, <span class="keyword">function</span>(df) c(mean=mean(df$mpg), min=min(df$mpg), max=max(df$mpg)))</span><br><span class="line"></span><br><span class="line">   cylinders model_year     mean  min  max</span><br><span class="line"><span class="number">1</span>       3cyl         <span class="number">72</span> <span class="number">19.00000</span> <span class="number">19.0</span> <span class="number">19.0</span></span><br><span class="line"><span class="number">2</span>       3cyl         <span class="number">73</span> <span class="number">18.00000</span> <span class="number">18.0</span> <span class="number">18.0</span></span><br><span class="line"><span class="number">3</span>       3cyl         <span class="number">77</span> <span class="number">21.50000</span> <span class="number">21.5</span> <span class="number">21.5</span></span><br><span class="line"><span class="number">4</span>       3cyl         <span class="number">80</span> <span class="number">23.70000</span> <span class="number">23.7</span> <span class="number">23.7</span></span><br><span class="line"><span class="number">5</span>       4cyl         <span class="number">70</span> <span class="number">25.28571</span> <span class="number">24.0</span> <span class="number">27.0</span></span><br><span class="line"><span class="number">6</span>       4cyl         <span class="number">71</span> <span class="number">27.46154</span> <span class="number">22.0</span> <span class="number">35.0</span></span><br><span class="line"><span class="number">7</span>       4cyl         <span class="number">72</span> <span class="number">23.42857</span> <span class="number">18.0</span> <span class="number">28.0</span></span><br><span class="line"><span class="number">8</span>       4cyl         <span class="number">73</span> <span class="number">22.72727</span> <span class="number">19.0</span> <span class="number">29.0</span></span><br><span class="line"><span class="number">9</span>       4cyl         <span class="number">74</span> <span class="number">27.80000</span> <span class="number">24.0</span> <span class="number">32.0</span></span><br><span class="line"><span class="number">10</span>      4cyl         <span class="number">75</span> <span class="number">25.25000</span> <span class="number">22.0</span> <span class="number">33.0</span></span><br><span class="line"><span class="number">11</span>      4cyl         <span class="number">76</span> <span class="number">26.76667</span> <span class="number">19.0</span> <span class="number">33.0</span></span><br><span class="line"><span class="number">12</span>      4cyl         <span class="number">77</span> <span class="number">29.10714</span> <span class="number">21.5</span> <span class="number">36.0</span></span><br><span class="line"><span class="number">13</span>      4cyl         <span class="number">78</span> <span class="number">29.57647</span> <span class="number">21.1</span> <span class="number">43.1</span></span><br><span class="line"><span class="number">14</span>      4cyl         <span class="number">79</span> <span class="number">31.52500</span> <span class="number">22.3</span> <span class="number">37.3</span></span><br><span class="line"><span class="number">15</span>      4cyl         <span class="number">80</span> <span class="number">34.61200</span> <span class="number">23.6</span> <span class="number">46.6</span></span><br><span class="line"><span class="number">16</span>      4cyl         <span class="number">81</span> <span class="number">32.81429</span> <span class="number">25.8</span> <span class="number">39.1</span></span><br><span class="line"><span class="number">17</span>      4cyl         <span class="number">82</span> <span class="number">32.07143</span> <span class="number">23.0</span> <span class="number">44.0</span></span><br><span class="line"><span class="number">18</span>      5cyl         <span class="number">78</span> <span class="number">20.30000</span> <span class="number">20.3</span> <span class="number">20.3</span></span><br><span class="line"><span class="number">19</span>      5cyl         <span class="number">79</span> <span class="number">25.40000</span> <span class="number">25.4</span> <span class="number">25.4</span></span><br><span class="line"><span class="number">20</span>      5cyl         <span class="number">80</span> <span class="number">36.40000</span> <span class="number">36.4</span> <span class="number">36.4</span></span><br><span class="line"><span class="number">21</span>      6cyl         <span class="number">70</span> <span class="number">20.50000</span> <span class="number">18.0</span> <span class="number">22.0</span></span><br><span class="line"><span class="number">22</span>      6cyl         <span class="number">71</span> <span class="number">18.00000</span> <span class="number">16.0</span> <span class="number">19.0</span></span><br><span class="line"><span class="number">23</span>      6cyl         <span class="number">73</span> <span class="number">19.00000</span> <span class="number">16.0</span> <span class="number">23.0</span></span><br><span class="line"><span class="number">24</span>      6cyl         <span class="number">74</span> <span class="number">17.85714</span> <span class="number">15.0</span> <span class="number">21.0</span></span><br><span class="line"><span class="number">25</span>      6cyl         <span class="number">75</span> <span class="number">17.58333</span> <span class="number">15.0</span> <span class="number">21.0</span></span><br><span class="line"><span class="number">26</span>      6cyl         <span class="number">76</span> <span class="number">20.00000</span> <span class="number">16.5</span> <span class="number">24.0</span></span><br><span class="line"><span class="number">27</span>      6cyl         <span class="number">77</span> <span class="number">19.50000</span> <span class="number">17.5</span> <span class="number">22.0</span></span><br><span class="line"><span class="number">28</span>      6cyl         <span class="number">78</span> <span class="number">19.06667</span> <span class="number">16.2</span> <span class="number">20.8</span></span><br><span class="line"><span class="number">29</span>      6cyl         <span class="number">79</span> <span class="number">22.95000</span> <span class="number">19.8</span> <span class="number">28.8</span></span><br><span class="line"><span class="number">30</span>      6cyl         <span class="number">80</span> <span class="number">25.90000</span> <span class="number">19.1</span> <span class="number">32.7</span></span><br><span class="line"><span class="number">31</span>      6cyl         <span class="number">81</span> <span class="number">23.42857</span> <span class="number">17.6</span> <span class="number">30.7</span></span><br><span class="line"><span class="number">32</span>      6cyl         <span class="number">82</span> <span class="number">28.33333</span> <span class="number">22.0</span> <span class="number">38.0</span></span><br><span class="line"><span class="number">33</span>      8cyl         <span class="number">70</span> <span class="number">14.11111</span>  <span class="number">9.0</span> <span class="number">18.0</span></span><br><span class="line"><span class="number">34</span>      8cyl         <span class="number">71</span> <span class="number">13.42857</span> <span class="number">12.0</span> <span class="number">14.0</span></span><br><span class="line"><span class="number">35</span>      8cyl         <span class="number">72</span> <span class="number">13.61538</span> <span class="number">11.0</span> <span class="number">17.0</span></span><br><span class="line"><span class="number">36</span>      8cyl         <span class="number">73</span> <span class="number">13.20000</span> <span class="number">11.0</span> <span class="number">16.0</span></span><br><span class="line"><span class="number">37</span>      8cyl         <span class="number">74</span> <span class="number">14.20000</span> <span class="number">13.0</span> <span class="number">16.0</span></span><br><span class="line"><span class="number">38</span>      8cyl         <span class="number">75</span> <span class="number">15.66667</span> <span class="number">13.0</span> <span class="number">20.0</span></span><br><span class="line"><span class="number">39</span>      8cyl         <span class="number">76</span> <span class="number">14.66667</span> <span class="number">13.0</span> <span class="number">17.5</span></span><br><span class="line"><span class="number">40</span>      8cyl         <span class="number">77</span> <span class="number">16.00000</span> <span class="number">15.0</span> <span class="number">17.5</span></span><br><span class="line"><span class="number">41</span>      8cyl         <span class="number">78</span> <span class="number">19.05000</span> <span class="number">17.5</span> <span class="number">20.2</span></span><br><span class="line"><span class="number">42</span>      8cyl         <span class="number">79</span> <span class="number">18.63000</span> <span class="number">15.5</span> <span class="number">23.9</span></span><br><span class="line"><span class="number">43</span>      8cyl         <span class="number">81</span> <span class="number">26.60000</span> <span class="number">26.6</span> <span class="number">26.6</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-62"><a href="#How-it-works…-62" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 ddply is used. This function takes a data frame as input and produces a data frame as output. The first argument is the auto data frame. The second argument cylinders describes the way to split the data. The third argument is the function to perform on the resulting components. We can add additional arguments if the function needs arguments. We can specify the splitting factor using the formula interface, ~ cylinders, as the second option of step 1 shows.</p>
<p>Step 2 shows how data splitting can occur across multiple variables as well. We use the c(“cylinders”,”model_year”) vector format to split the data using two variables. We also named the variables as mean, min, and max instead of the default V1, V2, and so on. The second option here also shows the use of the formula interface.</p>
<h3 id="There’s-more…-39"><a href="#There’s-more…-39" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>In this section, we discuss the transform and summarize functions as well as the identity function I.</p>
<h4 id="Adding-a-new-column-using-transform"><a href="#Adding-a-new-column-using-transform" class="headerlink" title="Adding a new column using transform"></a>Adding a new column using transform</h4><p>Suppose you want to add a new column to reflect each auto’s deviation from the mean mpg of the cylinder group to which it belongs:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- ddply(auto, .(cylinders), transform, mpg.deviation = round(mpg - mean(mpg),<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
<h4 id="Using-summarize-along-with-the-plyr-function"><a href="#Using-summarize-along-with-the-plyr-function" class="headerlink" title="Using summarize along with the plyr function"></a>Using summarize along with the plyr function</h4><p>The following command shows the output when summarize is used:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; ddply(auto, .(cylinders), summarize, freq=length(cylinders), meanmpg=mean(mpg))</span><br><span class="line">cylinders freq  meanmpg</span><br><span class="line"><span class="number">1</span>      3cyl    <span class="number">4</span> <span class="number">20.55000</span></span><br><span class="line"><span class="number">2</span>      4cyl  <span class="number">204</span> <span class="number">29.28676</span></span><br><span class="line"><span class="number">3</span>      5cyl    <span class="number">3</span> <span class="number">27.36667</span></span><br><span class="line"><span class="number">4</span>      6cyl   <span class="number">84</span> <span class="number">19.98571</span></span><br><span class="line"><span class="number">5</span>      8cyl  <span class="number">103</span> <span class="number">14.96311</span></span><br></pre></td></tr></table></figure>
<p>We calculate the number of rows and the mean mpg of the data frame grouped by cylinders.</p>
<h4 id="Concatenating-the-list-of-data-frames-into-a-big-data-frame"><a href="#Concatenating-the-list-of-data-frames-into-a-big-data-frame" class="headerlink" title="Concatenating the list of data frames into a big data frame"></a>Concatenating the list of data frames into a big data frame</h4><p>Run the following commands:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; autos &lt;- list(auto, auto)</span><br><span class="line">&gt; big.df &lt;- ldply(autos, I)</span><br></pre></td></tr></table></figure>
<p>The ldply function takes a list input and spits out a data frame output. The identity function I returns the input as is. If the input is a list then there is no split by argument; each list element is passed as an argument to the function.</p>
<h2 id="Slicing-dicing-and-combining-data-with-data-tables"><a href="#Slicing-dicing-and-combining-data-with-data-tables" class="headerlink" title="Slicing, dicing, and combining data with data tables"></a>Slicing, dicing, and combining data with data tables</h2><p>R provides several packages to do data analysis and data manipulation. Over and above the apply family of functions, the most commonly used packages are plyr, reshape, dplyr, and data.table. In this recipe, we will cover data.table, which processes large amounts of data very efficiently without our having to write detailed procedural code.</p>
<h3 id="Getting-ready-66"><a href="#Getting-ready-66" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Download the files for this chapter and store the auto-mpg.csv, employees.csv, and departments.csv files in your R working directory. Read the data and create factors for cylinders in auto-mpg.csv:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; auto$cylinders &lt;- factor(auto$cylinders, levels = c(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>), labels = c(<span class="string">"3cyl"</span>, <span class="string">"4cyl"</span>, <span class="string">"5cyl"</span>, <span class="string">"6cyl"</span>, <span class="string">"8cyl"</span>))</span><br></pre></td></tr></table></figure>
<p>Install the data.table package in your R environment as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"data.table"</span>)</span><br><span class="line">&gt; <span class="keyword">library</span>(data.table)</span><br><span class="line">&gt; autoDT &lt;- data.table(auto)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-67"><a href="#How-to-do-it…-67" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>In this recipe, we cover data.table which processes large amounts of data very efficiently without our having to write detailed procedural code. To do this follow these steps:</p>
<ol>
<li><p>Calculate the mean mpg for each cylinder type:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; autoDT[, mean(mpg), by=cylinders]</span><br><span class="line"></span><br><span class="line">   cylinders       V1</span><br><span class="line"><span class="number">1</span>:      4cyl <span class="number">29.28676</span></span><br><span class="line"><span class="number">2</span>:      3cyl <span class="number">20.55000</span></span><br><span class="line"><span class="number">3</span>:      6cyl <span class="number">19.98571</span></span><br><span class="line"><span class="number">4</span>:      8cyl <span class="number">14.96311</span></span><br><span class="line"><span class="number">5</span>:      5cyl <span class="number">27.36667</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Add a column for the mean mpg for each cylinder type:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; autoDT[, meanmpg := mean(mpg), by=cylinders]</span><br><span class="line"></span><br><span class="line">&gt; autoDT[<span class="number">1</span>:<span class="number">5</span>,c(<span class="number">1</span>:<span class="number">3</span>,<span class="number">9</span>:<span class="number">10</span>), with=<span class="literal">FALSE</span>]</span><br><span class="line"></span><br><span class="line">   No mpg cylinders            car_name  meanmpg</span><br><span class="line"><span class="number">1</span>:  <span class="number">1</span>  <span class="number">28</span>      4cyl chevrolet vega <span class="number">2300</span> <span class="number">29.28676</span></span><br><span class="line"><span class="number">2</span>:  <span class="number">2</span>  <span class="number">19</span>      3cyl     mazda rx2 coupe <span class="number">20.55000</span></span><br><span class="line"><span class="number">3</span>:  <span class="number">3</span>  <span class="number">36</span>      4cyl        honda accord <span class="number">29.28676</span></span><br><span class="line"><span class="number">4</span>:  <span class="number">4</span>  <span class="number">28</span>      4cyl     datsun <span class="number">510</span> (sw) <span class="number">29.28676</span></span><br><span class="line"><span class="number">5</span>:  <span class="number">5</span>  <span class="number">21</span>      6cyl         amc gremlin <span class="number">19.98571</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create an index on cylinders by defining a key:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; setkey(autoDT,cylinders)</span><br><span class="line"></span><br><span class="line">&gt; tables()</span><br><span class="line"></span><br><span class="line">     NAME   NROW NCOL MB</span><br><span class="line">[<span class="number">1</span>,] autoDT  <span class="number">398</span>   <span class="number">10</span>  <span class="number">1</span></span><br><span class="line">     COLS</span><br><span class="line">[<span class="number">1</span>,] No,mpg,cylinders,displacement,horsepower,weight,acceleration,model_year,car_name</span><br><span class="line">     KEY</span><br><span class="line">[<span class="number">1</span>,] cylinders</span><br><span class="line">Total: 1MB</span><br><span class="line"></span><br><span class="line">&gt; autoDT[<span class="string">"4cyl"</span>,c(<span class="number">1</span>:<span class="number">3</span>,<span class="number">9</span>:<span class="number">10</span>),with=<span class="literal">FALSE</span>]</span><br><span class="line"></span><br><span class="line">No  mpg cylinders              car_name  meanmpg</span><br><span class="line">  <span class="number">1</span>:   <span class="number">1</span> <span class="number">28.0</span>      4cyl   chevrolet vega <span class="number">2300</span> <span class="number">29.28676</span></span><br><span class="line">  <span class="number">2</span>:   <span class="number">3</span> <span class="number">36.0</span>      4cyl          honda accord <span class="number">29.28676</span></span><br><span class="line">  <span class="number">3</span>:   <span class="number">4</span> <span class="number">28.0</span>      4cyl       datsun <span class="number">510</span> (sw) <span class="number">29.28676</span></span><br><span class="line">  <span class="number">4</span>:   <span class="number">6</span> <span class="number">23.0</span>      4cyl            audi 100ls <span class="number">29.28676</span></span><br><span class="line">  <span class="number">5</span>:   <span class="number">8</span> <span class="number">32.9</span>      4cyl          datsun 200sx <span class="number">29.28676</span></span><br><span class="line"> ---</span><br><span class="line"><span class="number">200</span>: <span class="number">391</span> <span class="number">32.1</span>      4cyl    chevrolet chevette <span class="number">29.28676</span></span><br><span class="line"><span class="number">201</span>: <span class="number">392</span> <span class="number">23.9</span>      4cyl         datsun <span class="number">200</span>-sx <span class="number">29.28676</span></span><br><span class="line"><span class="number">202</span>: <span class="number">395</span> <span class="number">34.5</span>      4cyl  plymouth horizon tc3 <span class="number">29.28676</span></span><br><span class="line"><span class="number">203</span>: <span class="number">396</span> <span class="number">38.1</span>      4cyl toyota corolla tercel <span class="number">29.28676</span></span><br><span class="line"><span class="number">204</span>: <span class="number">397</span> <span class="number">30.5</span>      4cyl    chevrolet chevette <span class="number">29.28676</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Calculate mean, min and max mpg grouped by cylinder type:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; autoDT[, list(meanmpg=mean(mpg), minmpg=min(mpg), maxmpg=max(mpg)), by=cylinders]</span><br><span class="line"></span><br><span class="line">   cylinders  meanmpg minmpg maxmpg</span><br><span class="line"><span class="number">1</span>:      3cyl <span class="number">20.55000</span>   <span class="number">18.0</span>   <span class="number">23.7</span></span><br><span class="line"><span class="number">2</span>:      4cyl <span class="number">29.28676</span>   <span class="number">18.0</span>   <span class="number">46.6</span></span><br><span class="line"><span class="number">3</span>:      5cyl <span class="number">27.36667</span>   <span class="number">20.3</span>   <span class="number">36.4</span></span><br><span class="line"><span class="number">4</span>:      6cyl <span class="number">19.98571</span>   <span class="number">15.0</span>   <span class="number">38.0</span></span><br><span class="line"><span class="number">5</span>:      8cyl <span class="number">14.96311</span>    <span class="number">9.0</span>   <span class="number">26.6</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-63"><a href="#How-it-works…-63" class="headerlink" title="How it works…"></a>How it works…</h3><p>Data tables in the data.table package outperform the <em>apply family of functions and the *</em>ply functions. The simple data.table syntax is DT[i,j,by], where the data table DT is subset using rows in i to calculate j grouped by by.</p>
<p>In step 1 mean(mpg) is calculated, grouped by cylinders for all rows of the data table; omitting i causes all rows of the data table to be included.</p>
<p>To create a new column for the calculated j, just add := as in step 2. Here, we added a new column meanmpg to the data table to store mean(mpg) for each cylinder type.</p>
<p>By default, with is set to TRUE and j is evaluated for subsets of the data frame. However, if we do not need any computation and just want to retrieve data, then we can specify with=FALSE. In this case, data tables behave just like data frames.</p>
<p>Unlike data frames, data tables do not have row names. Instead, we can define keys and use these keys for row indexing. Step 3 defines cylinders as the key, and then uses autoDT[“4cyl”,c(1:3,9:10),with=FALSE] to extract data for the key-column value 4cyl.</p>
<p>We can define multiple keys using setkeyv(DT, c(“col1”, “col2”)), where DT is the data table and col1 and col2 are the two columns in the data table. In step 3, if multiple keys are defined, then the syntax to extract the data is autoDT[.(“4cyl”),c(1:3,9:10),with=FALSE].</p>
<p>If, in DT[i, j, by], i is itself a data.table, then R joins the two data tables on keys. If keys are not defined, then an error is displayed. However, for by, keys are not required.</p>
<h3 id="There’s-more…-40"><a href="#There’s-more…-40" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>We see some advanced techniques using data.table.</p>
<h4 id="Adding-multiple-aggregated-columns"><a href="#Adding-multiple-aggregated-columns" class="headerlink" title="Adding multiple aggregated columns"></a>Adding multiple aggregated columns</h4><p>In step 2, we added one calculated column meanmpg. The := syntax computes the variable and merges it into the original data:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># calculate median and sd of mpg grouped by cylinders</span></span><br><span class="line">&gt; autoDT[,c(<span class="string">"medianmpg"</span>,<span class="string">"sdmpg"</span>) := list(median(mpg),sd(mpg)), by=cylinders]</span><br><span class="line">&gt; <span class="comment"># Display selected columns of autoDT table for the first 5 rows</span></span><br><span class="line">&gt; autoDT[<span class="number">1</span>:<span class="number">5</span>,c(<span class="number">3</span>,<span class="number">9</span>:<span class="number">12</span>), with=<span class="literal">FALSE</span>]</span><br><span class="line">   cylinders            car_name  meanmpg medianmpg    sdmpg</span><br><span class="line"><span class="number">1</span>:      3cyl     mazda rx2 coupe <span class="number">20.55000</span>     <span class="number">20.25</span> <span class="number">2.564501</span></span><br><span class="line"><span class="number">2</span>:      3cyl           maxda rx3 <span class="number">20.55000</span>     <span class="number">20.25</span> <span class="number">2.564501</span></span><br><span class="line"><span class="number">3</span>:      3cyl       mazda rx-<span class="number">7</span> gs <span class="number">20.55000</span>     <span class="number">20.25</span> <span class="number">2.564501</span></span><br><span class="line"><span class="number">4</span>:      3cyl          mazda rx-<span class="number">4</span> <span class="number">20.55000</span>     <span class="number">20.25</span> <span class="number">2.564501</span></span><br><span class="line"><span class="number">5</span>:      4cyl chevrolet vega <span class="number">2300</span> <span class="number">29.28676</span>     <span class="number">28.25</span> <span class="number">5.710156</span></span><br></pre></td></tr></table></figure>
<h4 id="Counting-groups"><a href="#Counting-groups" class="headerlink" title="Counting groups"></a>Counting groups</h4><p>We can easily count the number of rows in each group as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; autoDT[,.N ,by=cylinders]</span><br><span class="line">   cylinders   N</span><br><span class="line"><span class="number">1</span>:      3cyl   <span class="number">4</span></span><br><span class="line"><span class="number">2</span>:      4cyl <span class="number">204</span></span><br><span class="line"><span class="number">3</span>:      5cyl   <span class="number">3</span></span><br><span class="line"><span class="number">4</span>:      6cyl  <span class="number">84</span></span><br><span class="line"><span class="number">5</span>:      8cyl <span class="number">103</span></span><br></pre></td></tr></table></figure>
<p>We can also count after subsetting as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; autoDT[<span class="string">"4cyl"</span>,.N]</span><br><span class="line">[<span class="number">1</span>] <span class="number">204</span></span><br></pre></td></tr></table></figure>
<h4 id="Deleting-a-column"><a href="#Deleting-a-column" class="headerlink" title="Deleting a column"></a>Deleting a column</h4><p>We can easily delete a column by setting it to NULL as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; autoDT[,medianmpg:=<span class="literal">NULL</span>]</span><br></pre></td></tr></table></figure>
<h4 id="Joining-data-tables"><a href="#Joining-data-tables" class="headerlink" title="Joining data tables"></a>Joining data tables</h4><p>We can define one or more keys on data tables and use them for joins. Suppose that a data table DT has a key defined. Then if, in DT[i, j, by], i is also a data table, R outer joins the two data tables on the key of DT. It joins the first key field of DT with the first column of i, the second key field of DT with the second column of i, and so on. If no keys are defined in DT, then R returns an error:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; emp &lt;- read.csv(<span class="string">"employees.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; dept &lt;- read.csv(<span class="string">"departments-1.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; empDT &lt;- data.table(emp)</span><br><span class="line">&gt; deptDT &lt;- data.table(dept)</span><br><span class="line">&gt; setkey(empDT,<span class="string">"DeptId"</span>)</span><br></pre></td></tr></table></figure>
<p>At this point, we have two data tables empDT and deptDT and a key field in empDT. The department ID in deptDT also happens to be the first column. We can now join the two tables on department ID by the following code. Note that the column name in deptDT does not have to match the name of the key field in empDT—only the column position matters:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; combine &lt;- empDT[deptDT]</span><br><span class="line">&gt; combine[,.N]</span><br><span class="line">[<span class="number">1</span>] <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>To prevent creating large result sets inadvertently, the data table’s join operation checks to see if the result set has become larger than the size of either table and stops with an error immediately. Unfortunately, this check results in an error in some perfectly valid situations.</p>
<p>For example, if there were two departments in the deptDT table that did not appear in the empDT table, then the outer join operation will yield 102 rows and not 100. Since the number of resultant rows is larger than the larger of the two tables, the preceding check results in an error message. The following code illustrates this:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; dept &lt;- read.csv(<span class="string">"departments-2.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; deptDT &lt;- data.table(dept)</span><br><span class="line">&gt; <span class="comment"># The following line gives an error</span></span><br><span class="line">&gt; combine &lt;- empDT[deptDT]</span><br><span class="line">Error <span class="keyword">in</span> vecseq(f__, len__, <span class="keyword">if</span> (allow.cartesian) <span class="literal">NULL</span> <span class="keyword">else</span> as.integer(max(nrow(x),  : Join results <span class="keyword">in</span> <span class="number">102</span> rows; more than <span class="number">100</span> = max(nrow(x),nrow(i)) … (error message truncated)</span><br></pre></td></tr></table></figure>
<p>If we know for sure that what we are doing is correct, we can force R to perform the join by using <code>allow.cartesian=TRUE</code>:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">combine &lt;- empDT[deptDT, allow.cartesian=<span class="literal">TRUE</span>]</span><br><span class="line">combine[,.N]</span><br><span class="line"><span class="number">102</span></span><br></pre></td></tr></table></figure>
<p>We get 102 rows because of the two departments that had no employees and the default outer join added two extra rows for these two departments. We can force an inner join by passing, nomatch=0 as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; mash &lt;- empDT[deptDT, nomatch=<span class="number">0</span>]</span><br><span class="line">&gt; mash[,.N]</span><br><span class="line">[<span class="number">1</span>] <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### Using symbols</span></span><br><span class="line"></span><br><span class="line">We can use special symbols such as .SD, .EACHI, .N, .I, and .BY <span class="keyword">in</span> data.table to enhance the functionality. We already saw some examples on .N, which represents the number of rows or the last row.</span><br><span class="line"></span><br><span class="line">The .SD symbol holds all columns except the columns <span class="keyword">in</span> by and can be used only <span class="keyword">in</span> the j evaluation part of data.table. The .SDcols symbol is used along with .SD and has columns to be included or excluded <span class="keyword">in</span> the j part of data.table.</span><br><span class="line"></span><br><span class="line">The .EACHI symbol is used <span class="keyword">in</span> the by grouping to group each subset of the groups <span class="keyword">in</span> i. This needs a key to be defined. If there is no key, R throws an error.</span><br><span class="line"></span><br><span class="line">In the following example, we calculate the maximum salary <span class="keyword">in</span> each department. If we omit .SDcols=<span class="string">"Salary"</span> then R will <span class="keyword">try</span> to find the max <span class="keyword">for</span> all columns since, by default, .SD includes all columns. In this case, R will throw an error since there are columns with textual values <span class="keyword">in</span> the empDT data table:</span><br><span class="line"></span><br><span class="line">```R</span><br><span class="line">&gt; empDT[deptDT, max(.SD), by=.EACHI, .SDcols="Salary"]</span><br><span class="line"></span><br><span class="line">   DeptId    V1</span><br><span class="line">1:      1 99211</span><br><span class="line">2:      2 98291</span><br><span class="line">3:      3 70655</span><br><span class="line">4:      4    NA</span><br><span class="line">5:      5 99397</span><br><span class="line">6:      6 92429</span><br><span class="line">7:      7    NA</span><br></pre></td></tr></table></figure>
<p>In the following example, we calculate the average salary in each department. We give the name AvgSalary to this calculated column. We can either use list or .() notation in the j evaluation part:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; empDT[,.(AvgSalary = lapply(.SD, mean)), by=<span class="string">"DeptId"</span>,.SDcols=<span class="string">"Salary"</span>]</span><br><span class="line"></span><br><span class="line">   DeptId AvgSalary</span><br><span class="line"><span class="number">1</span>:      <span class="number">1</span>  <span class="number">63208.02</span></span><br><span class="line"><span class="number">2</span>:      <span class="number">2</span>  <span class="number">59668.06</span></span><br><span class="line"><span class="number">3</span>:      <span class="number">3</span>  <span class="number">47603.64</span></span><br><span class="line"><span class="number">4</span>:      <span class="number">5</span>  <span class="number">59448.24</span></span><br><span class="line"><span class="number">5</span>:      <span class="number">6</span>  <span class="number">51957.44</span></span><br></pre></td></tr></table></figure>
<p>In the following example, we calculate the average salary in each department. We also include the department name DeptName by joining empDT with deptDT:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; empDT[deptDT,list(DeptName, AvgSalary = lapply(.SD, mean)), by=.EACHI,.SDcols=<span class="string">"Salary"</span>]</span><br><span class="line">   DeptId   DeptName AvgSalary</span><br><span class="line"><span class="number">1</span>:      <span class="number">1</span>    Finance  <span class="number">63208.02</span></span><br><span class="line"><span class="number">2</span>:      <span class="number">2</span>         HR  <span class="number">59668.06</span></span><br><span class="line"><span class="number">3</span>:      <span class="number">3</span>  Marketing  <span class="number">47603.64</span></span><br><span class="line"><span class="number">4</span>:      <span class="number">4</span>      Sales        <span class="literal">NA</span></span><br><span class="line"><span class="number">5</span>:      <span class="number">5</span>         IT  <span class="number">59448.24</span></span><br><span class="line"><span class="number">6</span>:      <span class="number">6</span>    Service  <span class="number">51957.44</span></span><br><span class="line"><span class="number">7</span>:      <span class="number">7</span> Facilities        <span class="literal">NA</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Chapter-10-Where-in-the-World-–-Geospatial-Analysis"><a href="#Chapter-10-Where-in-the-World-–-Geospatial-Analysis" class="headerlink" title="Chapter 10. Where in the World? – Geospatial Analysis"></a>Chapter 10. Where in the World? – Geospatial Analysis</h1><p>In this chapter, we will cover:</p>
<ul>
<li>Downloading and plotting a Google map of an area</li>
<li>Overlaying data on the downloaded Google map</li>
<li>Importing ESRI shape files into R</li>
<li>Using the sp package to plot geographic data</li>
<li>Getting maps from the maps package</li>
<li>Creating spatial data frames from regular data frames containing spatial and other data</li>
<li>Creating spatial data frames by combining regular data frames with spatial objects</li>
<li>Adding variables to an existing spatial data frame</li>
</ul>
<h2 id="Introduction-9"><a href="#Introduction-9" class="headerlink" title="Introduction"></a>Introduction</h2><p>Maps and other forms of geographical displays surround us. With the proliferation of location-aware mobile devices, people are also finding it increasingly easy to add spatial information to other data. We can also easily add a geographic dimension to other data based on the address and related information. As expected, R has packages to process and visualize geospatial data and therefore processing geospatial data has come within easy reach of most people. The sp, maptools, maps, rgdal, and RgoogleMaps packages have the necessary features. In this chapter, we cover recipes to perform the most common operations that most people will need: getting geospatial data into R and visualizing such data. People who need to perform more advanced operations should consult books dedicated to the topic.</p>
<h2 id="Downloading-and-plotting-a-Google-map-of-an-area"><a href="#Downloading-and-plotting-a-Google-map-of-an-area" class="headerlink" title="Downloading and plotting a Google map of an area"></a>Downloading and plotting a Google map of an area</h2><p>You can use the RgoogleMaps package to get and plot Google maps of specific areas based on latitude and longitude. This approach offers tremendous ease of use. However, we do not gain much control over the map elements and how we plot the maps. For fine control, you can use some of the later recipes in this chapter.</p>
<h3 id="Getting-ready-67"><a href="#Getting-ready-67" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the RgoogleMaps package using the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install.packages(<span class="string">"RgoogleMaps"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="How-to-do-it…-68"><a href="#How-to-do-it…-68" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To download and use Google maps of an area, follow these steps:</p>
<ol>
<li><p>Load the RgoogleMaps package:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(RgoogleMaps)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Determine the latitude and longitude of the location for which you need a map. In this recipe, you will get the map for the neighborhood of Seton Hall University in New Jersey, USA. The location is: (lat, long) = (40.742634, -74.246215).</p>
</li>
<li><p>Get the static map from Google Maps and then plot it as follows:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; shu.map &lt;- GetMap(center = c(<span class="number">40.742634</span>, -<span class="number">74.246215</span>), zoom=<span class="number">17</span>)</span><br><span class="line">&gt; PlotOnStaticMap(shu.map)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_1_1.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-64"><a href="#How-it-works…-64" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 we load the RgoogleMaps package.</p>
<p>In step 2 the latitude and longitude of the location for which we want a map are determined.</p>
<p>Having determined the latitude and longitude of the location, step 3 uses the GetMap function to acquire and store the map in an R variable called shu.map. The zoom option controls the zoom level of the returned map. The zoom=1 option gives the whole world, and zoom=17 covers a square area approximately a quarter of a mile on each side.</p>
<p>In step 3 the PlotOnStaticMap function is used to plot the map.</p>
<h3 id="There’s-more…-41"><a href="#There’s-more…-41" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>In the main recipe, we acquired and stored the map in an R variable. However, we can store it as an image file as well. We also have several options for the kind of map we can download.</p>
<h4 id="Saving-the-downloaded-map-as-an-image-file"><a href="#Saving-the-downloaded-map-as-an-image-file" class="headerlink" title="Saving the downloaded map as an image file"></a>Saving the downloaded map as an image file</h4><p>Use the destfile option to save the downloaded map as an image file:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; shu.map = GetMap(center = c(<span class="number">40.742634</span>, -<span class="number">74.246215</span>), zoom=<span class="number">16</span>, destfile = <span class="string">"shu.jpeg"</span>, format = <span class="string">"jpeg"</span>)</span><br></pre></td></tr></table></figure>
<p>GetMap also supports other formats such as png and gif. See the help file for more details.</p>
<h4 id="Getting-a-satellite-image"><a href="#Getting-a-satellite-image" class="headerlink" title="Getting a satellite image"></a>Getting a satellite image</h4><p>By default, GetMap returns a road map. You can use the maptype argument to control what is returned as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; shu.map = GetMap(center = c(<span class="number">40.742634</span>, -<span class="number">74.246215</span>), zoom=<span class="number">16</span>, destfile = <span class="string">"shu.jpeg"</span>, format = <span class="string">"jpeg"</span>, maptype = <span class="string">"satellite"</span>)</span><br><span class="line">&gt; PlotOnStaticMap(shu.map)</span><br></pre></td></tr></table></figure>
<p><img src="img/10_1_2.jpeg" alt=""></p>
<p>GetMap supports other map types such as roadmap and terrain. See the help file for details.</p>
<h2 id="Overlaying-data-on-the-downloaded-Google-map"><a href="#Overlaying-data-on-the-downloaded-Google-map" class="headerlink" title="Overlaying data on the downloaded Google map"></a>Overlaying data on the downloaded Google map</h2><p>In addition to plotting static Google maps, RgoogleMaps also allows you to overlay your own data points on static maps. In this recipe, we will use a data file with wage and geospatial information to plot a Google map of the general area covered by the data points; we will then overlay the wage information. The RgoogleMaps package offers tremendous ease of use but does not allow you control over the map elements and how you plot the maps. For fine control, you can use some of the later recipes in this chapter.</p>
<h3 id="Getting-ready-68"><a href="#Getting-ready-68" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the RgoogleMaps package. If you have not already downloaded the nj-wages.csv file, do it now and ensure that it is in your R working directory. The file contains information downloaded from the New Jersey Department of Education mashed up with latitude and longitude information downloaded from <a href="http://federalgovernmentzipcodes.us" target="_blank" rel="external">http://federalgovernmentzipcodes.us</a>.</p>
<h3 id="How-to-do-it…-69"><a href="#How-to-do-it…-69" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To overlay data on the downloaded Google map, follow these steps:</p>
<ol>
<li><p>Load RgoogleMaps and read the data file:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(RgoogleMaps)</span><br><span class="line">&gt; wages &lt;- read.csv(<span class="string">"nj-wages.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the wages into quantiles for ease of plotting:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; wages$wgclass &lt;- cut(wages$Avgwg, quantile(wages$Avgwg, probs=seq(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0.2</span>)), labels=<span class="literal">FALSE</span>, include.lowest=<span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a color palette:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pal &lt;- palette(rainbow(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Attach the data frame:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">attach</span>(wages)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get the Google map for the area covered by the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; MyMap &lt;- MapBackground(lat=Lat, lon=Long)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"http://maps.google.com/maps/api/staticmap?center=40.115,-74.715&amp;zoom=8&amp;size=640x640&amp;maptype=mobile&amp;format=png32&amp;sensor=true"</span></span><br><span class="line">center, zoom:  <span class="number">40.115</span> -<span class="number">74.715</span> <span class="number">8</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the map with the average wages overlaid with color and size proportional to the quintile:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; PlotOnStaticMap(MyMap, Lat, Long, pch=<span class="number">21</span>, cex = sqrt(wgclass),bg=pal[wgclass])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add a legend:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; legend(<span class="string">"bottomright"</span>, legend=paste(<span class="string">"&lt;="</span>, round(tapply(Avgwg, wgclass, max))), pch=<span class="number">21</span>, pt.bg=pal, pt.cex=<span class="number">1.0</span>, bg=<span class="string">"gray"</span>, title=<span class="string">"Avg wgs"</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_2_1.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-65"><a href="#How-it-works…-65" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the RgoogleMaps package is loaded and the data file is read. The file has geographic and other data for several school districts in New Jersey. We aim to show a Google map of the general area and to overlay the average wages for each school district on the map.</p>
<p>In step 2 the cut function is used on the Avgwg column to create a new column called wgclass. This column represents the quantile to which a school district belongs.</p>
<p>In step 3 a color palette is created with five colors—one for each quantile.</p>
<p>In step 4 the wages data frame is attached to ease variable references.</p>
<p>In step 5 the MapBackground function is used to get the static Google map for the general area. We pass all the latitudes and longitudes, and the MapBackground function uses these to determine the overall extent of the map.</p>
<p>In step 6 the PlotOnStaticMap function is used to plot the map from step 5. Apart from plotting the static map from step 5, this step also plots the individual points because the call passes the latitudes and longitudes as the second and third arguments to the call. The other arguments play the following roles:</p>
<ul>
<li>pch determines the character used to plot each point</li>
<li>cex determines the size of each point based on its quantile</li>
<li>bg determines the background color of each point based on its quantile</li>
</ul>
<p>In step 7 we add a legend by calling the legend function. The arguments work as follows:</p>
<ul>
<li>The first argument determines the position of the legend.</li>
<li>The legend function provides the vector of text for the legend. It creates the vector by finding the maximum Avgwg value for each wage class.</li>
<li>As before, pch determines the character used to plot each point.</li>
<li>The pt.bg argument determines the palette applied to the background color for the legend points.</li>
<li>The pt.cex argument determines the size of the legend points.</li>
<li>The bg argument determines the background color for the legend as a whole.</li>
<li>The title argument specifies the title for the legend.</li>
</ul>
<h2 id="Importing-ESRI-shape-files-into-R"><a href="#Importing-ESRI-shape-files-into-R" class="headerlink" title="Importing ESRI shape files into R"></a>Importing ESRI shape files into R</h2><p>Several organizations make ESRI shape files freely available, and you can adapt them for your purposes. Using RgoogleMaps is easy, and we have seen that it offers very little control over map elements and plotting. Importing shape files, on the other hand, gives us total control. We should prefer this approach when we need fine control over the rendering of individual elements rather than just plotting a map image as a whole. The rgdal package offers the functionality to download shape files into R in a format that the sp package can handle.</p>
<h3 id="Getting-ready-69"><a href="#Getting-ready-69" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the rgdal and sp packages. At the time of writing, installing rgdal on Mac OS X is tricky. Binary packages are unavailable and different versions of the OS require us to do different things. You will need to research this on the web and get it installed.</p>
<p>Copy the following files to your R working directory:</p>
<ul>
<li><code>ne_50m_admin_0_countries.shp</code></li>
<li><code>ne_50m_admin_0_countries.prj</code></li>
<li><code>ne_50m_admin_0_countries.shx</code></li>
<li><code>ne_50m_admin_0_countries.VERSION.txt</code></li>
<li><code>ne_50m_airports.shp</code></li>
<li><code>ne_50m_airports.prj</code></li>
<li><code>ne_50m_airports.shx</code>,</li>
<li><code>ne_50m_airports.VERSION.txt</code></li>
</ul>
<p>We obtained these files from <a href="http://www.naturalearthdata.com/" target="_blank" rel="external">http://www.naturalearthdata.com/</a>.</p>
<h3 id="How-to-do-it…-70"><a href="#How-to-do-it…-70" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To import ESRI shape files into R, follow these steps:</p>
<ol>
<li><p>Load the sp and rgdal packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(sp)</span><br><span class="line">&gt; <span class="keyword">library</span>(rgdal)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the ESRI file of countries:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; countries_sp &lt;- readOGR(<span class="string">"."</span>, <span class="string">"ne_50m_admin_0_countries"</span>)</span><br><span class="line"></span><br><span class="line">OGR data <span class="keyword">source</span> with driver: ESRI Shapefile</span><br><span class="line">Source: <span class="string">"."</span>, layer: <span class="string">"ne_50m_admin_0_countries"</span></span><br><span class="line">with <span class="number">241</span> features and <span class="number">63</span> fields</span><br><span class="line">Feature type: wkbPolygon with <span class="number">2</span> dimensions</span><br><span class="line"></span><br><span class="line">&gt; class(countries_sp)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"SpatialPolygonsDataFrame"</span></span><br><span class="line">attr(,<span class="string">"package"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"sp"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the ESRI file of airports:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; airports_sp &lt;- readOGR(<span class="string">"."</span>, <span class="string">"ne_50m_airports"</span>)</span><br><span class="line"></span><br><span class="line">OGR data <span class="keyword">source</span> with driver: ESRI Shapefile</span><br><span class="line">Source: <span class="string">"."</span>, layer: <span class="string">"ne_50m_airports"</span></span><br><span class="line">with <span class="number">281</span> features and <span class="number">10</span> fields</span><br><span class="line">Feature type: wkbPoint with <span class="number">2</span> dimensions</span><br><span class="line"></span><br><span class="line">&gt; class(airports_sp)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"SpatialPointsDataFrame"</span></span><br><span class="line">attr(,<span class="string">"package"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"sp"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-66"><a href="#How-it-works…-66" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the sp and rgdal packages are loaded.</p>
<p>In step 2 the readOGR function from the rgdal package is used to read the ne_50m_admin_0_countries.shp shape file layer. An ESRI shape file comes in layers with all files in a layer having the same filename and different filename extensions. Each file contains some information about the map in a layer. The first argument to the readOGR function specifies the dsn (data source name), or a directory containing the layer, and the second argument specifies the layer to be read.</p>
<p>The result of step 2 shows that readOGR returns an object of the SpatialPolygonsDataFrame class. The sp package defines several spatial classes including SpatialPolygonsDataFrame. This class stores spatial information for each country as a polygon, and additionally has nonspatial attributes for each country stored in a slot called data. Effectively, a SpatialPolygonsDataFrame object is a spatial object (a collection of polygons) embellished with nonspatial attributes.</p>
<p>Step 3 uses the readOGR function to read another layer called ne_50m_airports. Examining the class of this object reveals it to be a SpatialPointsDataFrame object. Like SpatialPolygonsDataFrame, a SpatialPointsDataFrame object is also a spatial object (a collection of points) embellished with nonspatial attributes.</p>
<h2 id="Using-the-sp-package-to-plot-geographic-data"><a href="#Using-the-sp-package-to-plot-geographic-data" class="headerlink" title="Using the sp package to plot geographic data"></a>Using the sp package to plot geographic data</h2><p>The sp package has the necessary features to store and plot geographic data. In this recipe, we will use the sp package to plot imported shape files.</p>
<h3 id="Getting-ready-70"><a href="#Getting-ready-70" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the packages rgdal and sp. If you have issues installing the rgdal package on Mac or Linux, refer to the earlier recipe for details.</p>
<p>Copy the following files to your R working directory:</p>
<ul>
<li><code>ne_50m_admin_0_countries.shp</code></li>
<li><code>ne_50m_admin_0_countries.prj</code></li>
<li><code>ne_50m_admin_0_countries.shx</code></li>
<li><code>ne_50m_admin_0_countries.VERSION.txt</code></li>
<li><code>ne_50m_airports.shp</code></li>
<li><code>ne_50m_airports.prj</code></li>
<li><code>ne_50m_airports.shx</code></li>
<li><code>ne_50m_airports.VERSION.txt</code></li>
</ul>
<p>We obtained these files from <a href="http://www.naturalearthdata.com/" target="_blank" rel="external">http://www.naturalearthdata.com/</a>.</p>
<h3 id="How-to-do-it…-71"><a href="#How-to-do-it…-71" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To plot geographic data using the sp package, follow these steps:</p>
<ol>
<li><p>Load the sp and rgdal packages:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(sp)</span><br><span class="line">&gt; <span class="keyword">library</span>(rgdal)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; countries_sp &lt;- readOGR(<span class="string">"."</span>, <span class="string">"ne_50m_admin_0_countries"</span>)</span><br><span class="line">&gt; airports_sp &lt;- readOGR(<span class="string">"."</span>, <span class="string">"ne_50m_airports"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the countries without color:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># without color</span></span><br><span class="line">&gt; plot(countries_sp)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_3_1.jpeg" alt=""></p>
</li>
</ol>
<ol>
<li><p>Plot the countries with color:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># with color</span></span><br><span class="line">&gt; plot(countries_sp, col = countries_sp@data$admin)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_3_2.jpeg" alt=""></p>
</li>
<li><p>Add the airports. Do not close the previous plot:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(airports_sp, add=<span class="literal">TRUE</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_3_3.jpeg" alt=""></p>
</li>
<li><p>Plot the economic level (factor):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; spplot(countries_sp, c(<span class="string">"economy"</span>))</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_3_4.jpeg" alt=""></p>
</li>
<li><p>Plot the population (numeric):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; spplot(countries_sp, c(<span class="string">"pop_est"</span>))</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_3_5.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-67"><a href="#How-it-works…-67" class="headerlink" title="How it works…"></a>How it works…</h3><p>If you have not already done so, you should read the recipe Importing ESRI shape files into R from this chapter.</p>
<p>In step 1 the sp and rgdal packages are loaded.</p>
<p>In step 2 readOGR is used to read the ESRI shape files of countries and airports.</p>
<p>Step 3 shows how to plot the countries without color using the plot function. The plot function plots several polygon objects in countries_sp.</p>
<p>Step 4, similar to step 3, plots countries but adds color to them.</p>
<p>Step 5 adds the airport information using the plot function, with the add=TRUE option. The airports_sp object contains several points, and the plot function plots each point with specified properties such as plot character and size.</p>
<p>In steps 6 and 7 the use of the spplot function is demonstrated, which exploits the lattice plotting features. These steps show that spplot can handle both factors and numeric values.</p>
<h2 id="Getting-maps-from-the-maps-package"><a href="#Getting-maps-from-the-maps-package" class="headerlink" title="Getting maps from the maps package"></a>Getting maps from the maps package</h2><p>The maps package has several pre-built maps that we can download and adapt. This recipe demonstrates the capabilities of these maps.</p>
<h3 id="Getting-ready-71"><a href="#Getting-ready-71" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the maps package.</p>
<h3 id="How-to-do-it…-72"><a href="#How-to-do-it…-72" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To get maps from the maps package, follow these steps:</p>
<ol>
<li><p>Load the maps package:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(maps)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the world map:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># with country boundaries</span></span><br><span class="line">&gt; map(<span class="string">"world"</span>)</span><br><span class="line">&gt; <span class="comment"># without country boundaries</span></span><br><span class="line">&gt; map(<span class="string">"world"</span>, interior=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the world map with colors:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; map(<span class="string">"world"</span>, fill=<span class="literal">TRUE</span>, col=palette(rainbow(<span class="number">7</span>)))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the map of a country:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># for most countries, we access the map as a region on the world map</span></span><br><span class="line">&gt; map(<span class="string">"world"</span>, <span class="string">"tanzania"</span>)</span><br><span class="line">&gt; <span class="comment"># some countries (Italy, France, USA) have dedicated maps that we can directly access by name</span></span><br><span class="line">&gt; map(<span class="string">"france"</span>)</span><br><span class="line">&gt; map(<span class="string">"italy"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot a map of the USA:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># with state boundaries</span></span><br><span class="line">&gt; map(<span class="string">"state"</span>)</span><br><span class="line">&gt; <span class="comment"># without state boundaries</span></span><br><span class="line">&gt; map(<span class="string">"state"</span>, interior = <span class="literal">FALSE</span>)</span><br><span class="line">&gt; <span class="comment"># with county boundaries</span></span><br><span class="line">&gt; map(<span class="string">"county"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot a map of a state in the USA:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># only state boundary</span></span><br><span class="line">&gt; map(<span class="string">"state"</span>, <span class="string">"new jersey"</span>)</span><br><span class="line">&gt; <span class="comment"># state with county boundaries</span></span><br><span class="line">&gt; map(<span class="string">"county"</span>, <span class="string">"new jersey"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-68"><a href="#How-it-works…-68" class="headerlink" title="How it works…"></a>How it works…</h3><p>The fact that the maps package has several databases has enabled us to access several capabilities of the maps.</p>
<h2 id="Creating-spatial-data-frames-from-regular-data-frames-containing-spatial-and-other-data"><a href="#Creating-spatial-data-frames-from-regular-data-frames-containing-spatial-and-other-data" class="headerlink" title="Creating spatial data frames from regular data frames containing spatial and other data"></a>Creating spatial data frames from regular data frames containing spatial and other data</h2><p>When you have a regular data frame that has spatial attributes in addition to other attributes, processing them becomes easier if you convert them to full-fledged spatial objects. This recipe shows how to accomplish this.</p>
<h3 id="Getting-ready-72"><a href="#Getting-ready-72" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the sp package. Download the nj-wages.csv file and ensure that it is in your R working directory.</p>
<h3 id="How-to-do-it…-73"><a href="#How-to-do-it…-73" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To process a a regular data frame with spatial attributes, follow these steps:</p>
<ol>
<li><p>Load the sp package:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(sp)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; nj &lt;- read.csv(<span class="string">"nj-wages.csv"</span>)</span><br><span class="line">&gt; class(nj)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"data.frame"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert nj into a spatial object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; coordinates(nj) &lt;- c(<span class="string">"Long"</span>, <span class="string">"Lat"</span>)</span><br><span class="line">&gt; class(nj)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"SpatialPointsDataFrame"</span></span><br><span class="line">attr(,<span class="string">"package"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"sp"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the points:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; plot(nj)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_6_1.jpeg" alt=""></p>
</li>
<li><p>Convert the points to lines and plot them:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; nj.lines &lt;- SpatialLines(list(Lines(list(Line(coordinates(nj))), <span class="string">"linenj"</span>)))</span><br><span class="line">&gt; plot(nj.lines)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_6_2.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-69"><a href="#How-it-works…-69" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the sp package is loaded.</p>
<p>In step 2 the data file is read, showing that nj is now a regular data frame object.</p>
<p>In step 3 the Lat and Long variables are identified from the nj data frame as spatial coordinates through the coordinates function. We see that nj has now been transformed into a SpatialPointsDataFrame object—a full-fledged spatial object.</p>
<h2 id="Creating-spatial-data-frames-by-combining-regular-data-frames-with-spatial-objects"><a href="#Creating-spatial-data-frames-by-combining-regular-data-frames-with-spatial-objects" class="headerlink" title="Creating spatial data frames by combining regular data frames with spatial objects"></a>Creating spatial data frames by combining regular data frames with spatial objects</h2><p>Often we have data that has some geographical aspect to it (such as postal codes) but does not have sufficient geographic coordinate information for plotting. In order to display such information on a map representation, we will need to embellish the basic data with enough geographic coordinate information for plotting. The sp package has several SpatialXXXDataFrame classes to represent geographic information along with additional descriptive data. This recipe shows how we can create and plot such objects. In this recipe, we demonstrate how to get a map from the maps package and convert it into a SpatialPolygons object. We then add data from a normal data frame to create a SpatialPolygonsDataFrame object, which we then plot.</p>
<h3 id="Getting-ready-73"><a href="#Getting-ready-73" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the sp, maps, and maptools packages. Download the nj-county-data.csv file into your R working directory.</p>
<h3 id="How-to-do-it…-74"><a href="#How-to-do-it…-74" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>In this recipe we demonstrate how to get a map from the maps package, convert it into a SpatialPolygons object, and then add on data from a normal data frame to create a SpatialPolygonsDataFrame object, which we then plot. To do this, follow these steps:</p>
<ol>
<li><p>Load the packages needed:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(maps)</span><br><span class="line">&gt; <span class="keyword">library</span>(maptools) <span class="comment"># this also loads the sp package</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Get the county map of New Jersey:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; nj.map &lt;- map(<span class="string">"county"</span>, <span class="string">"new jersey"</span>, fill=<span class="literal">TRUE</span>, plot=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; str(nj.map)</span><br><span class="line"></span><br><span class="line">List of <span class="number">4</span></span><br><span class="line"> $ x    : num [<span class="number">1</span>:<span class="number">774</span>] -<span class="number">75</span> -<span class="number">74.9</span> -<span class="number">74.9</span> -<span class="number">74.7</span> -<span class="number">74.7</span> <span class="keyword">...</span></span><br><span class="line"> $ y    : num [<span class="number">1</span>:<span class="number">774</span>] <span class="number">39.5</span> <span class="number">39.6</span> <span class="number">39.6</span> <span class="number">39.7</span> <span class="number">39.7</span> <span class="keyword">...</span></span><br><span class="line"> $ range: num [<span class="number">1</span>:<span class="number">4</span>] -<span class="number">75.6</span> -<span class="number">73.9</span> <span class="number">38.9</span> <span class="number">41.4</span></span><br><span class="line"> $ names: chr [<span class="number">1</span>:<span class="number">21</span>] <span class="string">"new jersey,atlantic"</span> <span class="string">"new jersey,bergen"</span> <span class="string">"new jersey,burlington"</span> <span class="string">"new jersey,camden"</span> <span class="keyword">...</span></span><br><span class="line"> - attr(*, <span class="string">"class"</span>)= chr <span class="string">"map"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Extract the county names:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; county_names &lt;- sapply(strsplit(nj.map$names, <span class="string">","</span>), <span class="keyword">function</span>(x) x[<span class="number">2</span>])</span><br></pre></td></tr></table></figure>
</li>
<li><p>Convert the map to SpatialPolygon:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; nj.sp &lt;- map2SpatialPolygons(nj.map, IDs = county_names, proj4string = CRS(<span class="string">"+proj=longlat +ellps=WGS84"</span>))</span><br><span class="line">&gt; class(nj.sp)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"SpatialPolygons"</span></span><br><span class="line">attr(,<span class="string">"package"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"sp"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a regular data frame from the file:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; nj.dat &lt;- read.csv(<span class="string">"nj-county-data.csv"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create row names to match those in the map:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; rownames(nj.dat) &lt;- nj.dat$name</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create SpatialPolygonsDataFrame:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; nj.spdf &lt;- SpatialPolygonsDataFrame(nj.sp, nj.dat)</span><br><span class="line">&gt; class(nj.spdf)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"SpatialPolygonsDataFrame"</span></span><br><span class="line">attr(,<span class="string">"package"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"sp"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the map:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># plain plot of the object</span></span><br><span class="line">&gt; plot(nj.spdf)</span><br><span class="line">&gt; <span class="comment"># Plot of population:</span></span><br><span class="line">&gt; spplot(nj.spdf, <span class="string">"population"</span>, main = <span class="string">"Population"</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_7_1.jpeg" alt=""></p>
</li>
<li><p>Based on incomes, a comparison can be obtained between per capita income and median family income:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; spplot(nj.spdf, c(<span class="string">"per_capita_income"</span>,<span class="string">"median_family_income"</span>), main = <span class="string">"Incomes"</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_7_2.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-70"><a href="#How-it-works…-70" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the maps, maptools, and sp packages are loaded.</p>
<p>In step 2 the Map function in the maps package is used to get the county map of New Jersey.</p>
<p>From the maps package, we can get maps as lines or as polygons. To color regions (such as countries on a world map or states or counties on country maps) based on their data values, we need to have the regions represented as polygons. The fill parameter controls whether or not we get a map as lines or as polygons. We used the fill = TRUE option to get the map as polygons.</p>
<p>We will first convert the map into a SpatialPolygons object and then add on nonspatial attribute values to make it a SpatialPolygonsDataFrame object.</p>
<p>Every polygon in a SpatialPolygons object must have a unique ID. From the output generated by step 2, we see that the individual regions (polygons, corresponding to the counties) in the map have names like new jersey,atlantic.</p>
<p>In step 3 just the county names from the region names in the map are extracted by applying the strsplit function to each of the region names. We use the extracted county names as identifiers for the polygons. To combine spatial data with normal data frames, identifiers of polygons are matched with the row names of regular data frames. This is why we need to assign identifiers for the polygons.</p>
<p>In step 4 the map2SpatialPolygons function from the maptools package is used to generate a SpatialPolygons object nj.sp from the map nj.map. This function uses the IDs argument supplied to name the polygons in the resultant SpatialPolygons object. If the length of the IDs argument does not match the number of polygons, then the function generates an error. At this point, we have a spatial object without any nonspatial attributes. Map files have geographic coordinate information in many different formats. The proj4string argument indicates the kind of coordinate information by creating a Coordinate Reference System (CRS) object. In the current example, we indicate that the coordinates are represented as longitudes and latitudes, and that the World Geodetic System 1984 (WGS84) standard is used. Depending on the coordinates in the map, other CRS objects may need to be created.</p>
<p>In step 5, data on the counties in New Jersey is read from a file and a normal data frame nj.dat is created. This data frame has no spatial attributes. We want to add the attributes from this data frame to the SpatialPolygons nj.sp to create a SpatialPolygonsDataFrame object.</p>
<p>In step 6 the county names are assigned as the row names for the data frame. We will shortly see why.</p>
<p>In step 7 the SpatialPolygonsDataFrame function is used to combine spatial and nonspatial information into a single SpatialPolygonsDataFrame object. The function uses the SpatialPolygons object nj.sp as well as the nj.dat data frame. It matches both objects by matching the row names in the data frame with the polygon IDs in the SpatialPolygon objects. This is why we assigned the county names as the row names in step 6 and also generated the county names in step 3. At this point, we have a SpatialPointsDataFrame object nj.spdf that contains both spatial and nonspatial information.</p>
<p>Step 8 shows that a regular plot of the SpatialPointsDataFrame object with the plot function displays only spatial information.</p>
<p>In step 9 the spplot function is used to plot the data and color each county based on its population. The last plot from step 9 clearly shows that spplot is based on the lattice package.</p>
<h2 id="Adding-variables-to-an-existing-spatial-data-frame"><a href="#Adding-variables-to-an-existing-spatial-data-frame" class="headerlink" title="Adding variables to an existing spatial data frame"></a>Adding variables to an existing spatial data frame</h2><p>This recipe shows how you can add variables to spatial data frame objects. One approach (see the recipe Creating spatial data frames by combining regular data frames with spatial objects, earlier in this chapter) will be to create all the necessary variables before creating the spatial data frame object. However, this might not always be feasible. This recipe shows how you can add nonspatial variables to an existing spatial data frame object.</p>
<h3 id="Getting-ready-74"><a href="#Getting-ready-74" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Install the sp, maps, and maptools packages. Download and place the nj-county-data.csv file in your R working directory.</p>
<h3 id="How-to-do-it…-75"><a href="#How-to-do-it…-75" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To add variables to an existing spatial data frame, follow these steps:</p>
<ol>
<li><p>Follow the following steps shown (from the recipe Creating spatial data frames by combining regular data frames with spatial objects, earlier in this chapter):</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(maps)</span><br><span class="line">&gt; <span class="keyword">library</span>(maptools)</span><br><span class="line">&gt; nj.map &lt;- map(<span class="string">"county"</span>, <span class="string">"new jersey"</span>, fill=<span class="literal">T</span>, plot=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; county_names &lt;- sapply(strsplit(nj.map$names, <span class="string">","</span>), <span class="keyword">function</span>(x) x[<span class="number">2</span>])</span><br><span class="line">&gt; nj.sp &lt;- map2SpatialPolygons(nj.map, IDs = county_names, proj4string = CRS(<span class="string">"+proj=longlat +ellps=WGS84"</span>))</span><br><span class="line">&gt; nj.dat &lt;- read.csv(<span class="string">"nj-county-data.csv"</span>)</span><br><span class="line">&gt; rownames(nj.dat) &lt;- nj.dat$name</span><br><span class="line">&gt; nj.spdf &lt;- SpatialPolygonsDataFrame(nj.sp, nj.dat)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Compute the population density for each county:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pop_density &lt;- nj.spdf@data$population/nj.spdf@data$area_sq_mi</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add a new variable to nj.spdf:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; nj.spdf &lt;- spCbind(nj.spdf, pop_density)</span><br><span class="line">&gt; names(nj.spdf@data)</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>] <span class="string">"name"</span>                    <span class="string">"per_capita_income"</span></span><br><span class="line">[<span class="number">3</span>] <span class="string">"median_household_income"</span> <span class="string">"median_family_income"</span></span><br><span class="line">[<span class="number">5</span>] <span class="string">"population"</span>              <span class="string">"no_households"</span></span><br><span class="line">[<span class="number">7</span>] <span class="string">"area_sq_mi"</span>              <span class="string">"pop_density"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Plot the data:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; spplot(nj.spdf, <span class="string">"pop_density"</span>)</span><br></pre></td></tr></table></figure>
<p> <img src="img/10_8_1.jpeg" alt=""></p>
</li>
</ol>
<h3 id="How-it-works…-71"><a href="#How-it-works…-71" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1 the code from the recipe Creating spatial data frames by combining regular data frames with spatial objects is repeated to create the SpatialPointsDataFrame object of New Jersey with county level data.</p>
<p>In step 2 the underlying data frame is accessed through the nj.spdf@data variable and computes the population density based on the population and area_sq_mi variables.</p>
<p>In step 3 the maptools package method, spCbind, is used to add the new variable to the underlying data frame in the SpatialpointsDataFrame object nj.spdf.</p>
<p>In step 4 the new variable is then plotted.</p>
<hr>
<h1 id="Chapter-11-Playing-Nice-–-Connecting-to-Other-Systems"><a href="#Chapter-11-Playing-Nice-–-Connecting-to-Other-Systems" class="headerlink" title="Chapter 11. Playing Nice – Connecting to Other Systems"></a>Chapter 11. Playing Nice – Connecting to Other Systems</h1><p>In this chapter, we will cover the following recipes to connect to other systems:</p>
<ul>
<li>Using Java objects in R</li>
<li>Using JRI to call R functions from Java</li>
<li>Using Rserve to call R functions from Java</li>
<li>Executing R scripts from Java</li>
<li>Using the xlsx package to connect to Excel</li>
<li>Reading data from relational databases – MySQL</li>
<li>Reading data from NoSQL databases – MongoDB</li>
</ul>
<p>Introduction</p>
<p>R is an open source product and hence its capabilities are constantly expanding. R is specifically useful for its numerous statistical packages and powerful visualization. When applications written in other environments (such as Java, C++, Python, and Excel) need to exploit R’s special capabilities, we need to smoothly integrate these environments with R. In this chapter, we will discuss working with R from Java and Excel and reading data from databases.</p>
<p>The rJava package allows us to create and access Java objects using Java Native Interface (JNI) from within R. The Java-R Interface (JRI) and Rserve packages allow us to do the reverse by invoking R from within Java programs. We also discuss various ways to work on Excel files directly from R.</p>
<h2 id="Using-Java-objects-in-R"><a href="#Using-Java-objects-in-R" class="headerlink" title="Using Java objects in R"></a>Using Java objects in R</h2><p>Sometimes, we develop parts of an application in Java and need to access them from R. The rJava package allows us to access Java objects directly from within R.</p>
<h3 id="Getting-ready-75"><a href="#Getting-ready-75" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and ensure that these files are in your R working directory:</p>
<ol>
<li>Create a folder called javasamples and move all the files with extension .java or .class into this folder under your working directory.</li>
<li>Install rJava using the install.packages(“rJava”) command.</li>
<li>Load the package using the library(rJava) command.</li>
<li>For rJava to work in your environment, the JDK version should be identical for the following, and we explain how to get them in sync for Mac OS X:</li>
</ol>
<ul>
<li>The environment JDK version: Execute java –version in your command line to get the installed version of Java. You will be using this version to create .jar files or to compile Java programs.</li>
<li>The JDK version in R: After you install and load the rJava package, check the JVM version in the R environment. We execute the commands to check this in the previous step. This should match with the response you get in the java –version command.</li>
</ul>
<ol>
<li>If there is a mismatch in the versions and you are using Mac OS X, do the following to install the latest version of rJava from source:</li>
</ol>
<ul>
<li><p>Download the latest rJava source rJava_0.9-7.tar.gz from <a href="http://www.rforge.net/rJava/files/" target="_blank" rel="external">http://www.rforge.net/rJava/files/</a>. The filename can be different with each new version of rJava:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo R CMD javareconf</span><br></pre></td></tr></table></figure>
</li>
<li><p>Include the following lines in your shell profile file (.bash_profile in bash, .profile in csh, and so forth); make sure to change the following folders as per your environment:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/</span><br><span class="line">export LD_LIBRARY_PATH=$JAVA_HOME/jre/lib/server</span><br><span class="line">export MAKEFLAGS=&quot;LDFLAGS=-Wl,-rpath $JAVA_HOME/lib/server&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Close your terminal window and reopen it so that the profile settings take effect.</p>
</li>
<li><p>Install the downloaded rJava package and make sure to change the filename:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo R CMD INSTALL rJava_0.9-7.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>Close R or RStudio session, whichever you are using, and reopen it from the same terminal window by executing open -a R or open -a RStudio.</p>
</li>
<li>Load the library again using library(rJava).</li>
<li>Check the JVM version using step 1.</li>
</ul>
<ol>
<li>Download the three JAR files JRI.jar, REngine.jar, and JRIEngine.jar from <a href="http://www.rforge.net/JRI/files/" target="_blank" rel="external">http://www.rforge.net/JRI/files/</a>; the RserveEngine.jar from <a href="http://www.rforge.net/Rserve/files/" target="_blank" rel="external">http://www.rforge.net/Rserve/files/</a>. Copy the four downloaded JAR files to the lib folder under your R working directory.</li>
<li>You can either use the class files provided or compile the Java code. These class files are created with JDK 1.8.0_25, and if your JDK version is different, follow the next step to compile all the Java programs.</li>
<li>To compile the downloaded Java programs, go to the javasamples folder and execute the javac -cp .:../lib/<em> </em>java command. You should see files with the class extensions for each of the downloaded Java programs.</li>
</ol>
<h3 id="How-to-do-it…-76"><a href="#How-to-do-it…-76" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To use Java objects in R, follow these steps:</p>
<ol>
<li><p>From within R, start the JVM, check the Java version, and set classpath:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; .jinit()</span><br><span class="line"></span><br><span class="line">&gt; .jcall(<span class="string">"java/lang/System"</span>, <span class="string">"S"</span>, <span class="string">"getProperty"</span>, <span class="string">"java.runtime.version"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"1.8.0_25-b17"</span></span><br><span class="line"></span><br><span class="line">&gt; .jaddClassPath(getwd())</span><br><span class="line"></span><br><span class="line">&gt; .jclassPath()</span><br><span class="line">[<span class="number">1</span>] <span class="string">"/Library/Frameworks/R.framework/Versions/3.1/Resources/library/rJava/java"</span></span><br><span class="line">[<span class="number">2</span>] <span class="string">"/Users/sv/book/Chapter11"</span>  =&gt; my working directory</span><br></pre></td></tr></table></figure>
</li>
<li><p>Perform these Java string operations in R:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; s &lt;- .jnew(<span class="string">"java/lang/String"</span>, <span class="string">"Hello World!"</span>)</span><br><span class="line">&gt; print(s)</span><br><span class="line"> [<span class="number">1</span>] <span class="string">"Java-Object&#123;Hello World!&#125;"</span></span><br><span class="line"></span><br><span class="line">&gt; .jstrVal(s)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Hello World!"</span></span><br><span class="line"></span><br><span class="line">&gt; .jcall(s,<span class="string">"S"</span>,<span class="string">"toLowerCase"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"hello world!"</span></span><br><span class="line"></span><br><span class="line">&gt; .jcall(s,<span class="string">"S"</span>,<span class="string">"replaceAll"</span>,<span class="string">"World"</span>,<span class="string">"SV"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Hello SV!"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Perform these Java vector operations:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; javaVector &lt;- .jnew(<span class="string">"java/util/Vector"</span>)</span><br><span class="line">&gt; months &lt;- month.abb</span><br><span class="line"></span><br><span class="line">&gt; sapply(months, javaVector$add)</span><br><span class="line"> Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec</span><br><span class="line"><span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span> <span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">&gt; javaVector$size()</span><br><span class="line">[<span class="number">1</span>] <span class="number">12</span></span><br><span class="line"></span><br><span class="line">&gt; javaVector$toString()</span><br><span class="line">[<span class="number">1</span>] <span class="string">"[Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec]"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Perform these Java array operations:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; monthsArray &lt;- .jarray(month.abb)</span><br><span class="line">&gt; yearsArray &lt;- .jarray(as.numeric(<span class="number">2010</span>:<span class="number">2015</span>))</span><br><span class="line">&gt; calArray &lt;- .jarray(list(monthsArray,yearsArray))</span><br><span class="line"></span><br><span class="line">&gt; print(monthsArray)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Java-Array-Object[Ljava/lang/String;:[Ljava.lang.String;@1ff4689e"</span></span><br><span class="line"></span><br><span class="line">&gt; .jevalArray(monthsArray)</span><br><span class="line"> [<span class="number">1</span>] <span class="string">"Jan"</span> <span class="string">"Feb"</span> <span class="string">"Mar"</span> <span class="string">"Apr"</span> <span class="string">"May"</span> <span class="string">"Jun"</span> <span class="string">"Jul"</span> <span class="string">"Aug"</span> <span class="string">"Sep"</span> <span class="string">"Oct"</span> <span class="string">"Nov"</span> <span class="string">"Dec"</span></span><br><span class="line"></span><br><span class="line">&gt; print(l &lt;- .jevalArray(calArray))</span><br><span class="line">[[<span class="number">1</span>]]</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Java-Object&#123;[Ljava.lang.String;@30f7f540&#125;"</span></span><br><span class="line"></span><br><span class="line">[[<span class="number">2</span>]]</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Java-Object&#123;[D@670655dd&#125;"</span></span><br><span class="line"></span><br><span class="line">&gt; lapply(l, .jevalArray)</span><br><span class="line">[[<span class="number">1</span>]]</span><br><span class="line"> [<span class="number">1</span>] <span class="string">"Jan"</span> <span class="string">"Feb"</span> <span class="string">"Mar"</span> <span class="string">"Apr"</span> <span class="string">"May"</span> <span class="string">"Jun"</span> <span class="string">"Jul"</span> <span class="string">"Aug"</span> <span class="string">"Sep"</span> <span class="string">"Oct"</span> <span class="string">"Nov"</span> <span class="string">"Dec"</span></span><br><span class="line"></span><br><span class="line">[[<span class="number">2</span>]]</span><br><span class="line">[<span class="number">1</span>] <span class="number">2010</span> <span class="number">2011</span> <span class="number">2012</span> <span class="number">2013</span> <span class="number">2014</span> <span class="number">2015</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Insert this simple Java class HelloWorld:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; hw &lt;- .jnew(<span class="string">"javasamples.HelloWorld"</span>)</span><br><span class="line">&gt; hello &lt;- .jcall(hw,<span class="string">"S"</span>, <span class="string">"getString"</span>)</span><br><span class="line">&gt; hello</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Hello World"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Insert this simple Java class Greeting with a method that accepts an argument:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; greet &lt;- .jnew(<span class="string">"javasamples.Greeting"</span>)</span><br><span class="line">&gt; print(greet)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Java-Object&#123;Hi World!&#125;"</span></span><br><span class="line"></span><br><span class="line">&gt; g &lt;- .jcall(greet, <span class="string">"S"</span>, <span class="string">"getString"</span>, <span class="string">"Shanthi"</span>)</span><br><span class="line">&gt; print(g)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Hello Shanthi"</span></span><br><span class="line"></span><br><span class="line">&gt; .jstrVal(g)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"Hello Shanthi"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-72"><a href="#How-it-works…-72" class="headerlink" title="How it works…"></a>How it works…</h3><p>The .jinit() initializes the Java Virtual Machine (JVM) and needs to be executed before invoking any of the rJava functions. If you encounter errors at this point, the issue is usually a lack of sufficient memory. Close unwanted processes or programs, including R, and retry.</p>
<p>For rJava to work, we need to sync up the Java version in the system environment with the rJava version. We used the .jcall(“java/lang/System”, “S”, “getProperty”, “java.runtime.version”) command to get the Java version within the R environment.</p>
<p>After making sure that the Java versions are identical, the first thing we need to do to access any Java object is to set up classpath. We do this using .jaddClassPath. We pass the R working directory, since our Java classes reside here. However, if you have the Java class files in a different location or if you created a .jar file, include that location instead. Once the classpath is set using .jaddClassPath, you can verify it by executing .jclassPath().</p>
<p>Step 2 illustrates string operations. We use .jnew to instantiate any Java object. The classname is the full classname separated by “/“. Hence, we refer to the string class as java/lang/String instead of java.lang.string.</p>
<p>The jstrVal function emits the equivalent of toString() for any Java object. In our example, we get the content of string s.</p>
<p>We use .jcall to execute any method on a Java object. In jcall(s,”S”,”toLowerCase”), we are invoking the toLowerCase method on the string object s. The “S” in the call specifies the return type of the method invocation. In .jcall(s,”S”,”replaceAll”,”World”,”SV”), we invoke the replaceAll method and get a new replaced string back.</p>
<p>We list the possible return types in the following table:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Return Type</th>
<th>Java Type</th>
<th>Remarks</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">I</td>
<td>int</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">D</td>
<td>double</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">J</td>
<td>long</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">F</td>
<td>float</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">V</td>
<td>void</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">Z</td>
<td>boolean</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">C</td>
<td>char</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">B</td>
<td>byte (raw)</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"><code>L&lt;class&gt;</code></td>
<td>Java object of class <code>&lt;class&gt;</code></td>
<td>Eg: Ljava/awt/Component</td>
</tr>
<tr>
<td style="text-align:left">S</td>
<td>java.lang.String</td>
<td>S is special for Ljava/long/object</td>
</tr>
<tr>
<td style="text-align:left"><code>[&lt;type&gt;</code></td>
<td>array of objects of <code>&lt;type&gt;</code></td>
<td><code>[D</code> for array of doubles</td>
</tr>
</tbody>
</table>
<p>Step 3 illustrates vector operations in Java from R. We first create a Java vector object using javaVector &lt;- .jnew(“java/util/Vector”). We then use the add method to add elements to this vector. Earlier in step 2, we used the .jcall function to invoke a method on an object, but now we use a shortcut that closely resembles what we typically do in Java. In Java, to call a method, we use the “.” operator and in R we use the $ operator. Thus, we use javaVector$add to invoke the add method on the javaVector object.</p>
<p>Step 4 illustrates Java array operations. The two key functions are .jarray to create an array object and .jevalArray to return an array object. We create three array objects monthsArray, yearsArray, and calArray using the .jarray function. When we print the array object using print(monthsArray), we get the object type of each of the array elements. However, when we execute .jevalArray(monthsArray), we get the contents of the array. The calArray object is a list of two Java array objects, and we also see how to extract array elements in this step.</p>
<p>Step 5 shows how to instantiate a custom Java object and invoke methods on it. If you have not already compiled the Java code, refer to Getting Ready at the beginning of this recipe for the instructions. We used .jnew to instantiate a HelloWorld object called hw. We always pass the classname along with the package to the .jnew function. Once the object is created, we can invoke methods. An example of invoking the getString method is shown here.</p>
<p>Step 6 shows the instantiation of another custom object Greeting and the invocation of a method. The arguments to the method follow the method name as in .jcall(greet,”S”, “getString”, “Shanthi”). Here, the string “Shanthi” is an argument passed to the getString method.</p>
<h3 id="There’s-more…-42"><a href="#There’s-more…-42" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The following are a few key additional useful commands to invoke Java objects from the R environment.</p>
<h4 id="Checking-JVM-properties"><a href="#Checking-JVM-properties" class="headerlink" title="Checking JVM properties"></a>Checking JVM properties</h4><p>You may want to check the Java Virtual Machine properties if you encounter issues in executing Java commands in the R console:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; jvm = .jnew(&quot;java.lang.System&quot;)</span><br><span class="line">&gt; jvm.props = jvm$getProperties()$toString()</span><br><span class="line">&gt; jvm.props &lt;- strsplit(gsub(&quot;\\&#123;(.*)&#125;&quot;, &quot;\\1&quot;, jvm.props), &quot;, &quot;)[[1]]</span><br><span class="line">&gt; jvm.props</span><br><span class="line"> [1] &quot;java.runtime.name=Java(TM) SE Runtime Environment&quot;</span><br><span class="line"> [2] &quot;sun.boot.library.path=/System/Library/Java/JavaVirtualMachines/1.6.0.jdk/Contents/Libraries&quot;</span><br><span class="line"> [3] &quot;java.vm.version=20.65-b04-462&quot;</span><br><span class="line"> [4] &quot;awt.nativeDoubleBuffering=true&quot;</span><br><span class="line"> [5] &quot;gopherProxySet=false&quot;</span><br><span class="line"> [6] &quot;mrj.build=11M4609&quot;</span><br><span class="line"> [7] &quot;java.vm.vendor=Apple Inc.&quot;</span><br><span class="line"> [8] &quot;java.vendor.url=http://www.apple.com/&quot;</span><br><span class="line"> [9] &quot;path.separator=:&quot;</span><br><span class="line">[10] &quot;java.vm.name=Java HotSpot(TM) 64-Bit Server VM&quot;</span><br><span class="line">……….</span><br></pre></td></tr></table></figure>
<h4 id="Displaying-available-methods"><a href="#Displaying-available-methods" class="headerlink" title="Displaying available methods"></a>Displaying available methods</h4><p>The following commands are useful to get a list of available methods or to get the method signature:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; .jmethods(s,<span class="string">"trim"</span>)</span><br><span class="line">[<span class="number">1</span>] <span class="string">"public java.lang.String java.lang.String.trim()"</span></span><br></pre></td></tr></table></figure>
<p>The preceding command indicates that the trim method can be invoked on a String object and it returns a String object:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># To get the list of available methods for an object</span></span><br><span class="line">&gt; .jmethods(s)</span><br><span class="line"> [<span class="number">1</span>] <span class="string">"public boolean java.lang.String.equals(java.lang.Object)"</span></span><br><span class="line"> [<span class="number">2</span>] <span class="string">"public java.lang.String java.lang.String.toString()"</span></span><br><span class="line"> [<span class="number">3</span>] <span class="string">"public int java.lang.String.hashCode()"</span></span><br><span class="line"> [<span class="number">4</span>] <span class="string">"public int java.lang.String.compareTo(java.lang.String)"</span></span><br><span class="line"> [<span class="number">5</span>] <span class="string">"public int java.lang.String.compareTo(java.lang.Object)"</span></span><br><span class="line"> [<span class="number">6</span>] <span class="string">"public int java.lang.String.indexOf(int)"</span></span><br><span class="line">…..</span><br></pre></td></tr></table></figure>
<h2 id="Using-JRI-to-call-R-functions-from-Java"><a href="#Using-JRI-to-call-R-functions-from-Java" class="headerlink" title="Using JRI to call R functions from Java"></a>Using JRI to call R functions from Java</h2><p>The JRI allows you to execute R commands inside Java applications as a single thread. JRI loads R libraries into Java and thus provides a Java API to R functions.</p>
<h3 id="Getting-ready-76"><a href="#Getting-ready-76" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Make sure all the steps in the earlier recipe Using Java objects in R are completed.</p>
<h3 id="How-to-do-it…-77"><a href="#How-to-do-it…-77" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To use JRI to call R functions from Java, follow these steps:</p>
<ol>
<li>Set up environment variables R_HOME to where R has been installed and add the R bin directory to the environment variable PATH.</li>
<li><p>Open a new terminal window (on OS X and Linux systems) or open a command prompt window on Windows. Make sure to change the values according to your environment. The following commands help to set up environment variables on OS X and Linux systems. Make sure to change your directory location:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export R_HOME=/Library/Frameworks/R.framework/Resources</span><br><span class="line"></span><br><span class="line">export PATH=$PATH:/Library/Frameworks/R.framework/Resources/bin/</span><br></pre></td></tr></table></figure>
</li>
<li><p>Execute the Java command as follows from the javasamples directory. Make sure to change the values according to your environment. Also, there is no space between –D and java.library.path:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd javasamples</span><br><span class="line">java  -Djava.library.path=/Library/Frameworks/R.framework/Resources/library/rJava/jri -cp ..:../lib/* javasamples.SimpleJRIStat</span><br><span class="line"></span><br><span class="line">1520.15</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-73"><a href="#How-it-works…-73" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1, we set up the environment variables R_HOME to where R has been installed and add the R bin directory to the environment variable PATH. If these environment variables are not set, then you will see the following error message:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;R_HOME is not set. Please set all required environment variables before running this program.</span><br><span class="line">Unable to start R.&quot;</span><br></pre></td></tr></table></figure>
<p>In step 2, we run the SimpleJRIStat Java program. Open the SimpleJRIStat.java code:</p>
<ul>
<li>In the main method, we first create an instance of Rengine to begin an R session.</li>
<li>We check to make sure that the R session is active with the waitForR method.</li>
<li>We create an array of doubles in Java and assign it to a variable called “values”. The values variable exists in the R environment and not in our Java environment.</li>
<li>The eval method of Rengine is equivalent to executing commands in the R console. The output from the eval method is an org.rosuda.JRI.REXP object. Depending on the content of REXP, methods such as asString(), asDouble() can be executed to extract the result returned by R. In our Java code, we use the R function mean to calculate the average of the array and assign it to a Java REXP variable mean.</li>
<li>We then use the asDouble method to get the value from mean and print it out.</li>
<li>We finally close the R session by calling the end method.</li>
</ul>
<p>To execute the Java code, we need to add the -Djava.library.path switch (there is no space between –D and java.library.path) and point to the rJava location. To use REngine from Java, we add the appropriate JAR files to the classpath. Since we are executing the command from the javasamples folder, we add .. to the classpath to refer to the parent folder where our library files are located under the lib folder.</p>
<h3 id="There’s-more…-43"><a href="#There’s-more…-43" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>It is possible to create graphs using R from a Java program. Let’s look at SimplePlot.java:</p>
<ul>
<li>In the main method, first we create an Rengine instance and check if the R session is created successfully.</li>
<li>We set the working directory in R either from the last argument that was passed while executing the command or from the current user directory from where the Java command was executed. The args.length == 0 expression indicates that no argument is passed during the execution of the code and hence we use the user directory as the R working directory.</li>
<li>We use the read.csv function to read the file in R and load it into an R variable auto.</li>
<li>We use the nrow function to get the number of rows in auto and print the value.</li>
<li>We set png as device and use auto.png as filename to be created.</li>
<li>We then use the plot function to plot weight vs mpg.</li>
<li>We turn the device off to flush the file contents.</li>
<li>We finally end the R session.</li>
</ul>
<p>To execute the Java code, use the following command. Change the argument to the call to reflect your R working directory where the auto-mpg.csv file resides:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=/Library/Frameworks/R.framework/Resources/library/rJava/jri/ -cp ..:../lib/* javasamples.SimplePlot /Users/sv/book/Chapter11</span><br></pre></td></tr></table></figure>
<h2 id="Using-Rserve-to-call-R-functions-from-Java"><a href="#Using-Rserve-to-call-R-functions-from-Java" class="headerlink" title="Using Rserve to call R functions from Java"></a>Using Rserve to call R functions from Java</h2><p>The Rserve package is a TCP/IP server that accepts requests from clients. RServe allows other technologies to access R. Every connection has a separate workspace and working directory.</p>
<h3 id="Getting-ready-77"><a href="#Getting-ready-77" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do so now and ensure that the files are in your R working directory:</p>
<ul>
<li>Create a javasamples folder and move all the files with extension Java and class into this folder under your working directory.</li>
<li>Install Rserve using install.packages(‘Rserve’).</li>
<li>Load the package using library(Rserve).</li>
<li>Download the three JAR files JRI.jar, REngine.jar, and JRIEngine.jar from <a href="http://www.rforge.net/JRI/files/" target="_blank" rel="external">http://www.rforge.net/JRI/files/</a> and the RserveEngine.jar from <a href="http://www.rforge.net/Rserve/files/" target="_blank" rel="external">http://www.rforge.net/Rserve/files/</a>. Copy the four downloaded JAR files to the lib folder under your R working directory.</li>
<li>You can either use the class files provided or compile the Java code. These class files are created with JDK 1.8.0_25 and, if your JDK version is different, follow the next step to compile all the Java programs.</li>
<li>To compile the downloaded Java programs, go to the javasamples folder and execute the javac -cp .:../lib/<em> </em>java command. You should see files with the class extensions for each of the downloaded Java programs.</li>
</ul>
<h3 id="How-to-do-it…-78"><a href="#How-to-do-it…-78" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To use Rserve to call R functions from Java, follow these steps:</p>
<ol>
<li><p>Start the Rserve server to accept client connections.</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; Rserve(args=<span class="string">"--no-save"</span>)  - On Mac and Linux</span><br><span class="line">&gt; Rserve() – on windows</span><br><span class="line">Rserv started <span class="keyword">in</span> daemon mode.</span><br></pre></td></tr></table></figure>
</li>
<li><p>Execute the Java program to draw ggplot in R and display the image. Change the argument to the call to reflect your R working directory where the auto-mpg.csv file resides:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ..:../lib/* javasamples.SimpleGGPlot /Users/sv/book/Chapter11</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-74"><a href="#How-it-works…-74" class="headerlink" title="How it works…"></a>How it works…</h3><p>In step 1, we start the RServe server from R. If the server is already up and running, you will see the: <code>##&gt; SOCK_ERROR: bind error #48(address already in use)</code> message.</p>
<p>You can remove the current RServe process by killing it at the OS level. We can also start Rserve as a daemon process from the command line by executing R CMD Rserve.</p>
<p>Rserve can run locally or on a remote server accessible by multiple clients. To access the remote Rserve server, provide the hostname or the IP address of the server while creating the RConnection.</p>
<p>In step 2, we run the SimpleGGPlot Java program. To connect to RServe from Java, we add the appropriate jars to classpath. Since we are executing the command from the javasamples folder, we add .. to the classpath to refer to the parent folder where our library files are located under the lib folder. We also pass the folder name where the auto-mpg.csv file resides, since that folder is our R working directory.</p>
<p>We now explain the code in SimpleGGPlot.java:</p>
<ol>
<li>In the main method, first we create an RConnection object.</li>
<li>We invoke the eval method on the RConnection object to execute commands in R.</li>
<li>The RConnection object throws the REngineException and hence we add try and catch blocks to catch the exception.</li>
<li>We evaluate the following functions in R from Java:</li>
</ol>
<ul>
<li>We first load the ggplot2 package in R.</li>
<li>We set the working directory in R using the argument passed. If no argument is passed, then the user’s current directory is used to set the R working directory.</li>
<li>We read the contents of the auto-mpg.csv file using read.csv.</li>
<li>We create a device to save the graph and then generate ggplot for weight vs mpg.</li>
<li>We close the device to flush out the contents to the file.</li>
<li>We then read the binary content of the file.</li>
<li>The output of the eval or parseAndEval methods is the org.rosuda.REngine.REXP objects and, depending on the content of the REXP methods such as asString(), asBytes() can be executed to extract the result returned by R. In our Java code, we read the binary content of the file from the REXP object xp using asBytes().</li>
</ul>
<ol>
<li>We create an image object that we finally display in a JFrame as follows:</li>
</ol>
<p><img src="img/11_1_1.jpeg" alt=""></p>
<ol>
<li>We close the connection after the user closes the JFrame image window</li>
<li>If RServe is not running, then you will see a message:</li>
</ol>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> org.rosuda.REngine.Rserve.RserveException: Cannot connect: Connection refused<span class="string">".</span></span><br></pre></td></tr></table></figure>
<h3 id="There’s-more…-44"><a href="#There’s-more…-44" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>In the recipe, Using JRI to call R functions from Java, we showed how to execute a function in R and retrieve the value from R in Java. Here, we show how to retrieve an array from R into Java.</p>
<h4 id="Retrieving-an-array-from-R"><a href="#Retrieving-an-array-from-R" class="headerlink" title="Retrieving an array from R"></a>Retrieving an array from R</h4><p>The following steps help in retrieving an array from R:</p>
<ol>
<li>Open the Java program SimpleRservStat.java:</li>
</ol>
<ul>
<li>We instantiate a new RConnection object.</li>
<li>We assign a Java array of doubles to an R variable</li>
<li>We calculate the mean of this array in R and print it in Java</li>
<li>We then calculate the range and, since range is an array, we invoke a method asDoubles() on the REXP object that is returned from the eval method</li>
<li>We then print the array of doubles after converting it into a string</li>
</ul>
<ol>
<li>Execute the following Java code command line from the javasamples directory—be sure to pass your own R working directory in place of the last part of the command:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ..:../lib<span class="comment">/* javasamples.SimpleRservStat /Users/sv/book/Chapter11</span></span><br></pre></td></tr></table></figure>
<h2 id="Executing-R-scripts-from-Java"><a href="#Executing-R-scripts-from-Java" class="headerlink" title="Executing R scripts from Java"></a>Executing R scripts from Java</h2><p>In earlier recipes, we executed R functions from within Java. In this recipe, we execute an R script from Java and read the results from R into Java for further processing.</p>
<h3 id="Getting-ready-78"><a href="#Getting-ready-78" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Make sure all the steps in the first recipe, Using Java objects in R, in this chapter are completed. Also make sure the auto-mpg.csv and corr.R files are in your R working directory.</p>
<h3 id="How-to-do-it…-79"><a href="#How-to-do-it…-79" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>Execute the Java program from your command prompt to invoke an R script from a Java program. Be sure to change the last part to reflect your R working directory:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path=/Library/Frameworks/R.framework/Resources/<span class="keyword">library</span>/rJava/jri/ -cp ..:../lib/* javasamples.InvokeRScript mpg weight /Users/sv/book/Chapter11</span><br></pre></td></tr></table></figure>
<h3 id="How-it-works…-75"><a href="#How-it-works…-75" class="headerlink" title="How it works…"></a>How it works…</h3><p>We execute the Java program InvokeScript with three arguments. The first two arguments mention the columns of the auto table for which correlation is computed and the optional third argument is the working directory, where the auto-mpg.csv file and the R script reside.</p>
<p>Let’s look at the InvokeScript.java code:</p>
<ul>
<li>In the main method, first we create an Rengine instance and check if the R session is created successfully.</li>
<li><p>We check if there are at least two arguments passed to the InvokeScript Java program. If not, we display an error message:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">To execute, please provide 2 variable names from auto-mpg dataset.</span><br></pre></td></tr></table></figure>
</li>
<li><p>If the length of the arguments array, args.length, is equal to 2, we know that the user did not provide the R working directory; hence, take the user’s current directory as the working directory and set it in R.</p>
</li>
<li>We set two variables var1 and var2 from the arguments using the method assign. These variables are created in the R environment.</li>
<li>We then invoke the eval method to source the R script file corr.R.</li>
<li>We get the “result” into a REXP object.</li>
<li>We print the value by invoking the asDouble method on the REXP object.</li>
<li>Finally, we close the Rengine object to release the R session.</li>
</ul>
<p>Let’s look at the R script corr.R:</p>
<ul>
<li>Load the contents of the auto-mpg.csv file into an R object auto</li>
<li>Execute the cor function to calculate the correlation between the two variables that were passed as an argument to the Java program InvokeScript</li>
</ul>
<h2 id="Using-the-xlsx-package-to-connect-to-Excel"><a href="#Using-the-xlsx-package-to-connect-to-Excel" class="headerlink" title="Using the xlsx package to connect to Excel"></a>Using the xlsx package to connect to Excel</h2><p>There are multiple packages to connect Excel with R; in this recipe, we discuss the xlsx package. Other commonly used packages are RExcel and XLConnect.</p>
<h3 id="Getting-ready-79"><a href="#Getting-ready-79" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>If you have not already downloaded the files for this chapter, do it now and ensure that the files are in your R working directory:</p>
<ul>
<li>Install xlsx using install.packages(“xlsx”)</li>
<li>Load the library using library(xlsx)</li>
<li><p>Read the data:</p>
  <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto &lt;- read.csv(<span class="string">"auto-mpg.csv"</span>, stringsAsFactors=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="How-to-do-it…-80"><a href="#How-to-do-it…-80" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To connect to Excel using the xlsx package, follow the steps:</p>
<ol>
<li><p>Save a data frame to an Excel workbook:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; write.xlsx(auto, file = <span class="string">"auto.xlsx"</span>, sheetName = <span class="string">"autobase"</span>, row.names = <span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add two new columns to the auto data frame:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto$kmpg &lt;- auto$mpg * <span class="number">1.6</span></span><br><span class="line">&gt; auto$mpg_deviation &lt;- (auto$mpg - mean(auto$mpg))/auto$mpg</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create Excel objects such as workbooks, worksheets, rows, and cells:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; auto.wb &lt;- createWorkbook()</span><br><span class="line">&gt; sheet1 &lt;- createSheet(auto.wb,<span class="string">"auto1"</span>)</span><br><span class="line">&gt; rows &lt;- createRow(sheet1, rowIndex=<span class="number">1</span>)</span><br><span class="line">&gt; cell.1 &lt;- createCell(rows, colIndex=<span class="number">1</span>)[[<span class="number">1</span>,<span class="number">1</span>]]</span><br><span class="line">&gt; setCellValue(cell.1, <span class="string">"Hello Auto Data!"</span>)</span><br><span class="line">&gt; addDataFrame(auto, sheet1, startRow=<span class="number">3</span>, row.names=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Assign styles to cells:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; cs &lt;- CellStyle(auto.wb) + Font(auto.wb, isBold=<span class="literal">TRUE</span>, color=<span class="string">"red"</span>)</span><br><span class="line">&gt; setCellStyle(cell.1, cs)</span><br><span class="line">&gt; saveWorkbook(auto.wb,<span class="string">"auto_wb.xlsx"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add another sheet to an Excel workbook:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; wb &lt;- loadWorkbook(<span class="string">"auto_wb.xlsx"</span>)</span><br><span class="line">&gt; sheet2 &lt;- createSheet(auto.wb,<span class="string">"auto2"</span>)</span><br><span class="line">&gt; addDataFrame(auto[,<span class="number">1</span>:<span class="number">9</span>], sheet2, row.names=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; saveWorkbook(auto.wb, <span class="string">"auto_wb.xlsx"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add columns to a worksheet and save the workbook:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; wb &lt;- loadWorkbook(<span class="string">"auto_wb.xlsx"</span>)</span><br><span class="line">&gt; sheets &lt;- getSheets(wb)</span><br><span class="line">&gt; sheet &lt;- sheets[[<span class="number">2</span>]]</span><br><span class="line">&gt; addDataFrame(auto[,<span class="number">10</span>:<span class="number">11</span>], sheet, startColumn=<span class="number">10</span>, row.names=<span class="literal">FALSE</span>)</span><br><span class="line">&gt; saveWorkbook(wb, <span class="string">"newauto.xlsx"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read from an Excel workbook:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; new.auto &lt;- read.xlsx(<span class="string">"newauto.xlsx"</span>, sheetIndex=<span class="number">2</span>)</span><br><span class="line">&gt; head(new.auto)</span><br><span class="line">&gt; new.auto &lt;- read.xlsx(<span class="string">"newauto.xlsx"</span>, sheetName=<span class="string">"auto2"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read a specific region from an Excel workbook:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; sub.auto &lt;- read.xlsx(<span class="string">"newauto.xlsx"</span>, sheetName=<span class="string">"autobase"</span>, rowIndex=<span class="number">1</span>:<span class="number">4</span>, colIndex=<span class="number">1</span>:<span class="number">9</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-76"><a href="#How-it-works…-76" class="headerlink" title="How it works…"></a>How it works…</h3><p>There are multiple options for reading and saving a worksheet. We see a few examples.</p>
<p>Step 1 saves the auto data frame to a new worksheet called “autobase” and creates the Excel file. If we do not include row.names=FALSE, the row numbers are displayed as the first column in the spreadsheet.</p>
<p>Step 2 adds two additional columns to the auto data frame. The first column kmpg is kilometers per gallon and the second new column is the mean mpg deviation. We used vector operations to compute the columns.</p>
<p>Step 3 shows the following functions to create workbooks, worksheets, rows, and cells:</p>
<ul>
<li>createWorkbook: This creates a workbook object and returns a reference to the object.</li>
<li>createSheet: This creates a worksheet and gives it the name passed in. If a sheet name is not provided, a default sheet name sheetx is used.</li>
<li>createRow: This creates a row within the sheet. rowIndex specifies the row number.</li>
<li>createCell: This creates a cell in the given row at a specific column index.</li>
<li>setCellValue: This assigns a value to the specified cell.</li>
<li>addDataFrame: This includes a data frame to the specified sheet. By default, row.names are included and the starting row and column is 1. However, these can be passed as an argument to specify a different row and column index. In our example, we used startRow=3 since we manually created the first row to hold the heading followed by an empty row. We defaulted the column to 1.</li>
</ul>
<p>Step 4 shows how styles can be added to a cell. We can add styles while creating the row, column, or adding a data frame. Whatever you can do in Excel by way of styling can be done from within R. Here, we see an example of adding a color and font to our heading row cell.</p>
<p>Step 5 shows the addition of a new sheet. We use addDataFrame to add a data frame. Once again we use row.names=FALSE so as not to include the row numbers as a column. Since we did not specify the startRow, it is taken as 1. We save the workbook with the two new sheets as auto_wb.xlsx.</p>
<p>Step 6 uses the addDataFrame function to add a data frame to a worksheet. We first read the previously saved workbook file auto.xlsx using loadWorkbook and save it in a variable wb. We then call the getSheets function to get all the worksheets in this workbook. The getSheets function returns an array and we can get a specific sheet by mentioning its index. Hence, sheets[[2]] returns the second sheet in the workbook.</p>
<p>We add the two new columns that we created in step 2 to the sheet. We finally save the workbook.</p>
<p>Step 7 shows how to read directly from an Excel file using read.xlsx. We can refer to a specific sheet either using sheetIndex or sheetName. The sheetIndex attribute starts from 1.</p>
<p>Step 8 shows how to load a specific region from an Excel sheet. The rowIndex attribute is set to 1:4 and extracts the header row and the first three data rows.</p>
<h2 id="Reading-data-from-relational-databases-–-MySQL"><a href="#Reading-data-from-relational-databases-–-MySQL" class="headerlink" title="Reading data from relational databases – MySQL"></a>Reading data from relational databases – MySQL</h2><p>You can connect to relational databases using several different approaches.</p>
<p>The RODBC package provides access to most relational databases through the ODBC (Open Database Connectivity) interface. The RJDBC package provides access to databases through the JDBC interface and hence needs a Java environment.</p>
<p>There are database packages such as ROracle, RMySQL, and so on to provide connectivity to the specific relational databases.</p>
<p>Each of the aforementioned options performs differently and has different requirements. You should benchmark and select the package that performs best for your specific needs. In general, RJDBC performs poorly and hence you will likely choose RODBC or your database-specific R package. In this recipe, we describe the steps to work with the MySQL database.</p>
<h3 id="Getting-ready-80"><a href="#Getting-ready-80" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>First create a data frame to work with as follows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; customer &lt;- c(<span class="string">"John"</span>, <span class="string">"Peter"</span>, <span class="string">"Jane"</span>)</span><br><span class="line">&gt; orddt &lt;- as.Date(c(<span class="string">'2014-10-1'</span>,<span class="string">'2014-1-2'</span>,<span class="string">'2014-7-6'</span>))</span><br><span class="line">&gt; ordamt &lt;- c(<span class="number">280</span>, <span class="number">100.50</span>, <span class="number">40.25</span>)</span><br><span class="line">&gt; order &lt;- data.frame(customer,orddt,ordamt)</span><br></pre></td></tr></table></figure>
<p>Then install the MySQL server and create in it a database called Customer.</p>
<p>To use the RODBC package:</p>
<ol>
<li>Download and install MySQL Connector/ODBC for your operating system.</li>
<li>Create a DSN called order_dsn in the ODBC Configuration Manager by selecting the correct driver for your platform.</li>
<li>In R, execute install.packages(“RODBC”).</li>
</ol>
<p>To use the RJDBC package:</p>
<ol>
<li>Download and install MySQL Connector/J for your operating system.</li>
<li>Install Java Runtime and set the JAVA_HOME environment variable accordingly.</li>
<li>In R, execute install.packages(“RJDBC”).</li>
</ol>
<p>To use the RMySQL package:</p>
<ol>
<li>Download and install MySQL Connector/J for your operating system.</li>
<li>Create an environment variable MYSQL_HOME pointing to the folder where MySQL is installed.</li>
<li>Only on Windows: Copy libmysql.dll from the lib directory of your MySQL installation to the bin directory.</li>
<li>In R, execute install.packages(“RMySQL”).</li>
</ol>
<h3 id="How-to-do-it…-81"><a href="#How-to-do-it…-81" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>We show how to use each of the preceding packages to connect to the database.</p>
<h4 id="Using-RODBC"><a href="#Using-RODBC" class="headerlink" title="Using RODBC"></a>Using RODBC</h4><p>To use the RODBC package to connect to the database follow these steps:</p>
<ol>
<li><p>Load the RODBC library and create a connection object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(RODBC)</span><br><span class="line">&gt; con &lt;- odbcConnect(<span class="string">"order_dsn"</span>, uid=<span class="string">"user"</span>, pwd=<span class="string">"pwd"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Save the order object into a table in the database:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; sqlSave(con,order, <span class="string">"orders"</span>,append=<span class="literal">FALSE</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get all orders from the database table:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; custData &lt;- sqlQuery(con, <span class="string">"select * from orders"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Close the connection object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; close(con)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Using-RMySQL"><a href="#Using-RMySQL" class="headerlink" title="Using RMySQL"></a>Using RMySQL</h4><p>To use the RMySQL package, follow these steps:</p>
<ol>
<li><p>Load the RMySQL library and create a connection object:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(RMySQL)</span><br><span class="line">&gt; con &lt;- dbConnect(<span class="string">"MySQL"</span>, dbname=<span class="string">"Customer"</span>, host=<span class="string">"127.0.0.1"</span>, port=<span class="number">8889</span>, username=<span class="string">"root"</span>, password=<span class="string">"root"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Save the order object into a table in the database:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dbWriteTable(con,<span class="string">"orders"</span>, order)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get all orders from the database table:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; dbReadTable(con,<span class="string">"Orders"</span>)</span><br><span class="line">&gt; dbGetQuery(con,<span class="string">"select * from orders"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get all orders from the database table using a loop:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; rs &lt;- dbSendQuery(con, <span class="string">"select * from orders"</span>)</span><br><span class="line">&gt; <span class="keyword">while</span>(!dbHasCompleted(rs)) &#123;</span><br><span class="line">   fetch(rs,n=<span class="number">2</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&gt; dbClearResult(rs)</span><br><span class="line">&gt; dbDisconnect(con)</span><br><span class="line">&gt; dbListConnections(dbDriver(<span class="string">"MySQL"</span>))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Using-RJDBC"><a href="#Using-RJDBC" class="headerlink" title="Using RJDBC"></a>Using RJDBC</h4><p>To use the RJDBC package follow these steps:</p>
<ol>
<li><p>Load the RJDBC library and create a connection object. Make sure to point to the correct location of the downloaded .jar file.</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(RJDBC)</span><br><span class="line">&gt; driver &lt;- JDBC(<span class="string">"com.mysql.jdbc.Driver"</span>, classpath= <span class="string">"/etc/jdbc/mysql-connector-java-5.1.34-bin.jar"</span>, <span class="string">"'"</span>)</span><br><span class="line">&gt; con &lt;- dbConnect(driver, <span class="string">"jdbc:mysql://host:port/Customer"</span> , <span class="string">"username"</span>,<span class="string">"password"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>The remaining operations are identical to those in the Using RMySQL section.</p>
</li>
</ol>
<h3 id="How-it-works…-77"><a href="#How-it-works…-77" class="headerlink" title="How it works…"></a>How it works…</h3><p>The preceding code first creates a data frame called order with three rows. It then connects to a MySQL database using different methods.</p>
<h4 id="Using-RODBC-1"><a href="#Using-RODBC-1" class="headerlink" title="Using RODBC"></a>Using RODBC</h4><p>In this method we executed the following command:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; con &lt;- odbcConnect(<span class="string">"cust_dsn"</span>, uid=<span class="string">"user"</span>, pwd=<span class="string">"pwd"</span>)</span><br></pre></td></tr></table></figure>
<p>The con variable now has a connection to the database associated to the DSN. All subsequent database calls use this connection object. When all database operations are done, we close the connection.</p>
<p>Although we will typically not create tables or insert data from R, we have shown the code for this just for illustration. The sqlSave function saves the data in the R data object to the specified table. We used append=FALSE because the table does not already exist and hence we will want R to create the table first and then insert the data. If the table already exists, you can use append=TRUE.</p>
<p>The sqlQuery function executes the supplied query and returns the result set as a data frame.</p>
<h4 id="Using-RMySQL-1"><a href="#Using-RMySQL-1" class="headerlink" title="Using RMySQL"></a>Using RMySQL</h4><p>The RMySQL package uses the MYSQL_HOME environment variable to get to the needed libraries:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dbWriteTable(con, <span class="string">"orders"</span>, order)</span><br></pre></td></tr></table></figure>
<p>The dbWriteTable function inserts records into the table. If the table does not exist, it creates the table. By default, row.names of the data frame is added as a column to the table; if it is not needed, remember to set it to FALSE:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dbReadTable(con,<span class="string">"Orders"</span>)</span><br></pre></td></tr></table></figure>
<p>The dbReadTable function reads the table and creates a data frame:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dbGetQuery(con,<span class="string">"select * from orders"</span>)</span><br></pre></td></tr></table></figure>
<p>The dbGetQuery function executes the query and returns all the results as a data frame. When the table is large, it is better to use dbSendQuery and fetch results as needed:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; rs &lt;- dbSendQuery(con, <span class="string">"select * from orders"</span>)</span><br><span class="line">&gt; <span class="keyword">while</span>(!dbHasCompleted(rs)) &#123;</span><br><span class="line">+    fetch(rs,n=<span class="number">2</span>)</span><br><span class="line">+ &#125;</span><br><span class="line">&gt; dbClearResult(rs)</span><br><span class="line">&gt; dbDisconnect(con)</span><br></pre></td></tr></table></figure>
<p>The dbSendQuery function returns rs, a result set object. When you fetch rows with this object, since n=2, two records are returned from the database. While using dbSendQuery, it is a good idea to use a loop until dbHasCompleted is TRUE. Remember to clear the pointer with dbClearResult and close the connection using dbDisconnect:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; dbListConnections(dbDriver(<span class="string">"MySQL"</span>))</span><br></pre></td></tr></table></figure>
<p>The dbListConnections function lists all the open connections.</p>
<h4 id="Using-RJDBC-1"><a href="#Using-RJDBC-1" class="headerlink" title="Using RJDBC"></a>Using RJDBC</h4><p>With JDBC, we can connect to any database. Hence, we need to tell R which driver to use. Once the driver is assigned in R, we use this later to create a connection to the database using the appropriate .jar files.</p>
<p>If connecting to a MySQL database, all the statements after getting the connection object are identical to those in the RMySQL scenario.</p>
<h3 id="There’s-more…-45"><a href="#There’s-more…-45" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The database-specific packages provide a lot of functionality, and pretty much most of what can be done within a SQL client can also be done from within an R environment. We show a few examples as follows.</p>
<h4 id="Fetching-all-rows"><a href="#Fetching-all-rows" class="headerlink" title="Fetching all rows"></a>Fetching all rows</h4><p>The following command is used to fetch all rows:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; fetch(rs,n=-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>Use n=-1 to fetch all rows.</p>
<h4 id="When-the-SQL-query-is-long"><a href="#When-the-SQL-query-is-long" class="headerlink" title="When the SQL query is long"></a>When the SQL query is long</h4><p>When the SQL query is long, it becomes unwieldy to specify the whole query as one long string spanning several lines. Use the paste() function to break the query over multiple lines and make it more readable:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; dbSendQuery(con, statement=paste(</span><br><span class="line">   <span class="string">"select ordernumber, orderdate, customername"</span>,</span><br><span class="line">   <span class="string">"from orders o, customers c"</span>,</span><br><span class="line">   <span class="string">"where o.customer = c.customer"</span>,</span><br><span class="line">   <span class="string">"and c.state = 'NJ'"</span>,</span><br><span class="line">   <span class="string">"ORDER BY ordernumber"</span>))</span><br></pre></td></tr></table></figure>
<p><strong>Tip</strong></p>
<p>Note the use of the single quotes to specify a string literal.</p>
<h2 id="Reading-data-from-NoSQL-databases-–-MongoDB"><a href="#Reading-data-from-NoSQL-databases-–-MongoDB" class="headerlink" title="Reading data from NoSQL databases – MongoDB"></a>Reading data from NoSQL databases – MongoDB</h2><p>Unlike relational databases for which a somewhat standard approach works across all relational databases, the fluid state of NoSQL databases means that no such standard approach has yet evolved. We illustrate this with MongoDB using the rmongodb package.</p>
<h3 id="Getting-ready-81"><a href="#Getting-ready-81" class="headerlink" title="Getting ready"></a>Getting ready</h3><p>Prepare the environment by following these steps:</p>
<ol>
<li>Download and install MongoDB.</li>
<li>Start mongod as a background process and then start mongo.</li>
<li><p>Create a new database customer and a collection called orders:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; use customer</span><br><span class="line">&gt; db.orders.save(&#123;customername:<span class="string">"John"</span>, orderdate:ISODate(<span class="string">"2014-11-01"</span>),orderamount:<span class="number">1000</span>&#125;)</span><br><span class="line">&gt; db.orders.find()</span><br><span class="line">&gt; db.save</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-to-do-it…-82"><a href="#How-to-do-it…-82" class="headerlink" title="How to do it…"></a>How to do it…</h3><p>To read data from MongoDB, follow these steps:</p>
<ol>
<li><p>Install the rmongodb package and create a connection:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; install.packages(<span class="string">"rmongodb"</span>)</span><br><span class="line">&gt; <span class="keyword">library</span>(rmongodb)</span><br><span class="line">&gt; mongo &lt;- mongo.create()</span><br><span class="line">&gt; mongo.create(host = <span class="string">"127.0.0.1"</span>, db = <span class="string">"customer"</span>)</span><br><span class="line">&gt; mongo.is.connected(mongo)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Get all the collections in the MongoDB database:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; coll&lt;- mongo.get.database.collections(mongo,<span class="string">"customer"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Find all records matching search criteria:</p>
 <figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; json &lt;- <span class="string">"&#123;\"orderamount\":&#123;\"$lte\":25000&#125;, \"orderamount\":&#123;\"$gte\":1000&#125;&#125;"</span></span><br><span class="line">&gt; dat &lt;- mongo.find.all(mongo,coll,json)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="How-it-works…-78"><a href="#How-it-works…-78" class="headerlink" title="How it works…"></a>How it works…</h3><p>The mongo_create function creates a mongo session. If no argument is passed, it connects to the localhost at the default port 27017, where mongod is running.</p>
<p>Ensure that R has a valid mongo session using mongo.is.connected(mongo).</p>
<p>The mongo.get.database.collections function lists all the collections in that database.</p>
<p>The mongo.find.all function lists all the rows in that collection. By passing in a valid JSON object, the query results are limited by the search condition specified in the JSON object. If a JSON object is not passed, all rows are returned. R creates a data frame with the returned result.</p>
<h3 id="There’s-more…-46"><a href="#There’s-more…-46" class="headerlink" title="There’s more…"></a>There’s more…</h3><p>The fluidity of the NoSQL environment and the newness of MongoDB mean that the rmongodb package changes frequently. You should update the rmongodb package to get the latest enhancements into your R environment. You should consider validating JSON expressions before using them in code.</p>
<h4 id="Validating-your-JSON"><a href="#Validating-your-JSON" class="headerlink" title="Validating your JSON"></a>Validating your JSON</h4><p>Creating a JSON structure in R can get quite complex due to its special characters. Use the validate() function to ensure that the JSON structure is error-free:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">library</span>(jsonlite)</span><br><span class="line">&gt; json &lt;- <span class="string">"&#123;\"orderamount\":&#123;\"$lte\":25000&#125;, \"orderamount\":&#123;\"$gte\":1500&#125;&#125;"</span></span><br><span class="line">&gt; validate(json)</span><br></pre></td></tr></table></figure>
</div></article><div class="tags"></div><div class="paginator"><a id="prev" href="/2016/09/05/regularexp/" data-title="R package" class="prev"><i class="iconfont icon-left"></i><span>Prev</span></a><a id="next" href="/2016/08/06/R-advanced-english/" data-title="R advanced(english edition)" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div id="disqus_thread"></div></section><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://yoursite.com/2016/08/07/R-data-analysis/';
    this.page.identifier = '2016/08/07/R-data-analysis/';
    this.page.title = 'R data analysis';
};
(function() {
var d = document, s = d.createElement('script');

s.src = '//Your disqus ID.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></section><footer><div class="social"><a href="mailto:xiangpan2011@163.com" title="email" class="iconfont icon-email"></a><a href="/atom.xml" title="rss" class="iconfont icon-rss"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Xiang</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>